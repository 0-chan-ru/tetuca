{"version":3,"sources":["node_modules/browser-pack/_prelude.js","main.js","client/main/amusement.js","client/main/client.js","client/main/connection.js","client/main/extract.js","client/main/fsm.js","client/main/hide.js","client/main/history.js","client/main/loop.js","client/main/memory.js","client/main/options/index.js","client/main/options/opts.js","client/main/options/render.js","client/main/posts/article.js","client/main/posts/common.js","client/main/posts/embed.js","client/main/posts/identity.js","client/main/posts/imager.js","client/main/posts/index.js","client/main/posts/menu.js","client/main/posts/models.js","client/main/posts/nonce.js","client/main/posts/posting.js","client/main/posts/section.js","client/main/scroll.js","client/main/state.js","client/main/time.js","client/main/util.js","client/main/main.js"],"names":["require","e","t","n","r","s","o","u","a","i","f","Error","code","l","exports","call","length",1,"module","_slicedToArray","sliceIterator","arr","_arr","_n","_d","_e","undefined","_s","_i","Symbol","iterator","next","done","push","value","err","Array","isArray","Object","TypeError","main","$","common","state","oneeSama","hook","imouto","queueRoll","bit","number","this","allRolls","sent","info","$tag","callback","strong","dice","readable_dice","seen","_ref","postForm","request","rolls","lim","html","dispatcher","EXECUTE_JS","_ref2","_ref3","js","eval","console","error","./main",2,"_defineProperty","obj","key","defineProperty","enumerable","configurable","writable","checkRepliedToMe","links","sourceNum","mine","readAll","num","modelHandler","func","model","posts","get","_$extend","_","util","online","document","query","extend","INSERT_POST","message","_message","msg","bump","page","isThread","op","syncs","editing","el","nonce","myNonce","tab","ownPosts","trigger","postSM","feed","write","addLinks","models","view","id","render","insertIntoDOM","clientInit","parent","dispatch","INSERT_IMAGE","_msg","img","postModel","toPostForm","insertUploaded","setImage","UPDATE_POST","frag","_ref2$","extra","update","FINISH_POST","_msg2","set","DELETE_POSTS","deletePost","LOCK_THREAD","toggleLocked","UNLOCK_THREAD","DELETE_IMAGES","removeImage","SPOILER_IMAGES","setSpoiler","BAN","_msg3","JSON","parse","setBan","BACKLINK","addBacklink","ONLINE_COUNT","textContent","HOT_INJECTION","_msg4","force","hash","hotConfig","configHash","send","SYNCHRONIZE","connSM","feeder","INVALID","listener","event","spoilt","target","classList","toggle",3,"socket","readyState","SockJS","OPEN","warn","stringify","config","DEBUG","log","on_message","data","shift","type","isPubSub","is_pubsub","handler","follow","sync_status","sync","connect","onclose","onmessage","window","location","protocol","new_socket","onopen","transports","USE_WEBSOCKETS","unshift","SOCKET_URL","SOCKET_PATH","reset_attempts","attemptTimer","clearTimeout","attempts","window_focused","rs","CONNECTING","navigator","onLine","lang","reply","getElementById","act","connecting","syncing","connID","randomID","cookie","synced","setTimeout","DESYNC","dropped","wait","Math","pow","min","floor","reconnecting","close","addEventListener","hidden",4,"_classCallCheck","instance","Constructor","_createClass","defineProperties","props","descriptor","protoProps","staticProps","prototype","options","Extract","catalog","$threads","json","innerHTML","title","extractReplies","extractThreads","post","articles","getElementsByTagName","article","Article","Post","extractModel","sections","section","Section","Thread","renderOmit","hctr","getNum",5,"FSM","start","spec","acts","ons","wilds","preflights","second","pres","trans_spec","on_func","halves","split","parts","dest","match","tok","part","m","src","on","ev","param","from","to","ps","fs","_this",6,"Memory","count","remove","purgeAll","defer","size",7,"readingSteiner","url","nextState","read","isMatch","attributes","preventDefault","address","test","$loading","show","xhr","XMLHttpRequest","open","onload","status","hide","alert","baseURL","responseURL","response","thread","RESYNC","board","live","history","pushState","href","scrollTo","$doc","ctrlKey","onpopstate",8,"reRenderImages","workMode","queryAll","forEach","style","display","getImages","image","each","toggleSpoilers","spoiler","toggleAutoGIF","ext","toggleAnonymisation","source","command","_model$attributes","name","trip","change:thumbs","change:spoilers","change:autogif","change:anonymise","workModeTOG",9,"Cookie","expiry","needCookie","purgeExpired","bind","object","nums","keys","sort","b","parseInt","join","Date","now","localStorage","removeItem","getItem","val","isObject","isEmpty","setItem","bakeCookie","writeAll","limit","expired","time",10,"_interopRequireDefault","__esModule","default","_main","_opts","_opts2","Backbone","Model","OptionsCollection","Collection","persist","opts","getValue","optionsCollection","OptionModel","initialize","load","setValue","exec","listenTo","execListen","execOnStart","add","validate","valid","fadeout","$el","filter","fadeOut","fadein","fadeIn","addClass","click","removeClass","OptionsView","View","setElement","parseEl","body","append","find","prop","String","fromCharCode","toUpperCase","$hidden","renderHidden","events","click .option_tab_sel>li>a","change","click #export","click #import","click #hidden","switchTab","$a","children","$li","applyChange","$target","attr","charCodeAt","export","setAttribute","URL","createObjectURL","Blob","import","$input","one","reader","FileReader","readAsText","files","result","clear","reload","text","replace","clearHidden","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","./opts","./render",11,"toggleHeadStyle","css","head","appendChild","disabled","notMobile","isMobile","enabled","langApplied","thumbStyles","notifToggle","Notification","permission","requestPermission","radio","engine","illyaDance","defaultCSS","theme","MEDIA_URL","cssHash","upload","validation","resonableLastN","lastN","shorts","short",12,"_taggedTemplateLiteral","strings","raw","freeze","tabs","_loop","opt","renderTab","_opt","renderOption","renderExtras","isShortcut","isList","isCheckbox","isNumber","isImage","_lang$opt$id","label","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","item","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","_lang$id","ln","attrs","parseHTML","_templateObject",13,"PostCommon","tagName","last","after","autoExpandImage","fun","../main","./common",14,"imager","Hidamari","className","redirect","anonymise","_len","arguments","args","_key","apply","updateBody","blockquote","setModel","renderTime","outerHTML","renderBacklinks","backlinks","anon","renderName","renderModerationInfo","getContainer","before","parseDOM","modInfo","renderBan","banned","renderEditing","normalize","./imager",15,"make_video","params","allowFullScreen","allowScriptAccess","autohide","modestbranding","origin","rel","showinfo","autoplay","loop","playlist","encodeURI","frameborder","video_dims","class","screen","width","height","fetchSoundcloud","cb","encodeURIComponent","getAttribute","responseType","youtube_url_re","youtube_short_re","youtube_time_re","youtube_short_time_re","timeCall","timeRex","which","metaKey","altKey","shiftKey","is","$video","siblings","andSelf","gotInfo","node","orig","color","accessControl","embed","contents","nodeType","ajax","v","alt","dataType","success","soundcloud_url_re","iframe","previousElementSibling","round","innerWidth","createElement","firstChild","pastebin_re","$obj","$window","innerHeight",16,"ident","$name","email","$email","propagate","renderIdentity","save","$script","debounce","LOGIN_KEYWORD","clientHash",17,"_templateObject2","renderImage","arg","manual","reveal","figure","scrollTop","getBoundingClientRect","top","thumbnailRevealed","imageExpanded","tallImage","massExpander","indexOf","toggleImageExpansion","expand","fit","fitImage","imagePaths","renderAudio","newWidth","newHeight","dims","expandImage","both","widthFlag","heightFlag","aspect","fullWidth","fullHeight","maxWidth","imageMaxWidth","maxHeight","offsetHeight","closest","left","outerWidth","noMargin","isVideo","cls","controls","lastChild","ExpanderModel","massToggle","expander","unset","getModel",18,"Menu","posting","./article","./embed","./menu","./models","./nonce","./posting","./section",19,"MenuView","actions","_popup_menu","action","offsetWidth","handleClick","stopPropagation","stopListening",20,"idAttribute","concat","updates","silent","moderationInfo","mod","defaults","replies","omit","image_omit","getImageOmit",21,"nonces","postNonces","nonceCache","save_nonces","today_id","create","day","destroy","changed","yesterday","random",22,"handle_shortcut","prevent","stopImmediatePropagation","aside","togglespoiler","onToggle","$submit","finish","textSpoiler","postState","state2","sp","expandAll","banner","querySelector","thumbStyle","openPostBox","inputMinSize","ComposerModel","ComposerView","destination","preflight","matches","onAllocation","IMAGE_STATUS","parentNode","$buffer","$ref","postRef","refText","click #cancel","change #imageInput","input #trans","keydown #trans","click #done","click #toggle","renderButtons","change:spoiler","renderSpoilerPane","nextSpoiler","pending","line_count","char_count","OneeSama","inject","blockqoute","eLinkify","tamashii","desc","you","input","rows","autocomplete","form","method","enctype","cancel","imageInput","accept","els","parsed","parse_name","haveTrip","tetxContent","trim","removeAttribute","resizeInput","sizer","INPUT_ROOM","max","uploading","uploaded","uploadStatus","sentAllocRequest","allocWait","submit","marginLeft","background","backgroundImage","S_BOL","touchable_spoiler_tag","$lineBuffer","$meta","$subject","maxlength","SUBJECT_MAX_LENGTH","$blockquote","$sizer","appendTo","subject","$uploadForm","renderUploadForm","focus","$b","first","removeAttr","d","margin-left","$cancel","$imageInput","$uploadStatus","$toggle","$form","proxy","WEBM","$iframe","uploadError","cancelled","onImageChosen","prepareUpload","k","uploadURL","doc","contentWindow","contentDocument","unknownUpload","uploadFallbackMessage","notifyUploading","stat","unknownResult","offset","onInput","embedRewrite","rw","old","newVal","substr","index","diff","end","Event","video","selectionStart","selectionEnd","findTimeArg","sc","pbin","nl","lastIndexOf","ok","commit","reverse","setSelectionRange","MAX_POST_CHARS","len","pair","lines","breach","MAX_POST_LINES","pop","allocationMessage","fragment","createTextNode","onKeyDown","slice","_this2","flushPending","replaceWith","padding-left","preserve","replyBox","missing","checkAgain","pick","pick_spoiler","header","onbeforeunload","$img","onImageAllocation","addReference","sel","isInside","gsel","parentElement","getSelection","toString","./identity",23,"nextElementSibling","renderLocked","locked","shiftReplies","_state$page$attribute","abbrev_msg","bumpThread",24,"cacheState","lockIndicator","checkBottom","atBottom","scrollHeight","scrollY","visibility","followDOM","previous","referenceDistance","ret","elExists","referenceEl","delta","topDistance","scrollBy","contains","skipCheck","_el$getBoundingClient","bounds","selector","aboveBanner","$anchor","_document",25,"addition","reset",26,"batcTimeRender","rtime","renderTimer","timer_from_el","serverTimeOffset","maxh","pad","maxm","maxs","moumouikkai","serverTime","finished","countdown","hour","sec","mouikkai","setInterval","GET_TIME","seconds","cursor","removeEventListener","readableUTCTime",27,"_toArray","del","imageUploadURL","hard","HTTP","getID","parseEls","string","childNodes","once","getComputedStyle","isSage","imports","isNode","cachedOffset","inner","EIGHT_BALL","escape","readableSyncwatch","readableRegularDice","bias","eq","sum","roll","metaIndex","imgs","readable_filesize","action_link_html","Number","isInteger","tripcode","secure","EXCLUDE_REGEXP","char","callSite","formatHTML","output","map","elementAttributes","str","m1","commaList","items","checkAuth","staff","classes","auth","rights","_fsm","_fsm2","NativeView","channel","_deferred","execDefered","cookieVersion","paths","boards","path","debug","tuneIn","scroll","thread_locked","amusement","client","conection","./amusement","./client","./connection","./extract","./fsm","./hide","./history","./loop","./memory","./options","./posts","./scroll","./state","./time","./util","backbone","backbone.nativeview","backbone.radio","core-js","dom4","js-cookie","scriptjs","sockjs-client","underscore"],"mappings":"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","file":"main.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","require=(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n'use strict';var _slicedToArray=(function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err) {_d=true;_e=err;}finally {try{if(!_n&&_i[\"return\"])_i[\"return\"]();}finally {if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else {throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");}};})();var main=require('./main');var $=main.$;var common=main.common;var state=main.state;var oneeSama=main.oneeSama;oneeSama.hook('imouto',function(imouto){imouto.queueRoll=function(bit){var number=this.allRolls.sent++;var info=this.allRolls[number];if(!info)info=this.allRolls[number]={};info.bit=bit;info.$tag=$(this.callback('<strong>'));this.strong=true;this.callback(info.dice?common.readable_dice(bit,info.dice):bit);this.strong=false;this.callback('</strong>');};imouto.allRolls={sent:0,seen:0};});oneeSama.hook('insertOwnPost',function(_ref){var dice=_ref.dice;var postForm=main.request('postForm');if(!postForm||!postForm.imouto||!dice)return;var rolls=postForm.imouto.allRolls;for(var i=0,lim=dice.length;i<lim;i++){var n=rolls.seen++;var info=rolls[n];if(!info)info=rolls[n]={};info.dice=dice[i];if(info.$tag){var r=common.readable_dice(info.bit,info.dice);info.$tag.html(r);}}});main.dispatcher[common.EXECUTE_JS]=function(_ref2){var _ref3=_slicedToArray(_ref2,1);var js=_ref3[0];try{eval(js);}catch(e) {console.error(e);}};\n\n},{\"./main\":\"main\"}],2:[function(require,module,exports){\n'use strict';var _$extend;var _slicedToArray=(function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err) {_d=true;_e=err;}finally {try{if(!_n&&_i[\"return\"])_i[\"return\"]();}finally {if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else {throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");}};})();function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj;}var main=require('./main');var _=main._;var common=main.common;var dispatcher=main.dispatcher;var util=main.util;var posts=main.posts;var state=main.state;var online=document.query('#onlineCount');_.extend(dispatcher,(_$extend={},_defineProperty(_$extend,common.INSERT_POST,function(message){var _message=_slicedToArray(message,2);var msg=_message[0];var bump=_message[1];bump=bump&&state.page.get('live');var isThread=!msg.op;var num=msg.num;if(isThread)state.syncs[num]=1;msg.editing=true;var el=undefined;var nonce=msg.nonce;delete msg.nonce;var myNonce=main.request('nonce:get')[nonce];if(myNonce&&myNonce.tab===state.page.get('tabID')){state.ownPosts[num]=true;main.oneeSama.trigger('insertOwnPost',msg);main.postSM.feed('alloc',msg);bump=false;main.request('nonce:destroy',nonce);var postForm=main.request('postForm');if(postForm&&postForm.el)el=postForm.el;}if(myNonce){msg.mine=true;state.mine.write(num);}state.addLinks(msg.links);var model=new posts.models[isThread?'Thread':'Post'](msg);var view=new posts[isThread?'Section':'Article']({model:model,el:el,id:num});if(!el)view.render().insertIntoDOM();view.clientInit();checkRepliedToMe(msg.links,num);main.request('post:inserted',model);if(isThread)return;var parent=state.posts.get(msg.op);if(!parent)return;parent.get('replies').push(num);if(state.page.get('thread'))return;parent.dispatch('shiftReplies');if(bump)parent.dispatch('bumpThread');}),_defineProperty(_$extend,common.INSERT_IMAGE,function(msg){var _msg=_slicedToArray(msg,2);var num=_msg[0];var img=_msg[1];var postModel=main.request('postModel'),toPostForm=postModel&&postModel.get('num')==num;if(toPostForm)main.request('postForm').insertUploaded(img);modelHandler(num,function(model){return model.setImage(img,toPostForm);});}),_defineProperty(_$extend,common.UPDATE_POST,function(_ref){var _ref2=_slicedToArray(_ref,3);var num=_ref2[0];var frag=_ref2[1];var _ref2$=_ref2[2];var extra=_ref2$===undefined?{}:_ref2$;modelHandler(num,function(model){state.addLinks(extra.links);model.update(frag,extra);checkRepliedToMe(extra.links,num);if(num in state.ownPosts)main.oneeSama.trigger('insertOwnPost',extra);else model.dispatch('updateBody',frag);});}),_defineProperty(_$extend,common.FINISH_POST,function(msg){var _msg2=_slicedToArray(msg,1);var num=_msg2[0];delete state.ownPosts[num];modelHandler(num,function(model){model.set('editing',false);model.dispatch('renderEditing',false);});}),_defineProperty(_$extend,common.DELETE_POSTS,function(msg){modelHandler(msg[0],function(model){return model.deletePost(msg[1]);});}),_defineProperty(_$extend,common.LOCK_THREAD,function(msg){modelHandler(msg[0],function(model){return model.toggleLocked(true,msg[1]);});}),_defineProperty(_$extend,common.UNLOCK_THREAD,function(msg){modelHandler(msg[0],function(model){return model.toggleLocked(false,msg[1]);});}),_defineProperty(_$extend,common.DELETE_IMAGES,function(msg){modelHandler(msg[0],function(model){return model.removeImage(msg[1]);});}),_defineProperty(_$extend,common.SPOILER_IMAGES,function(msg){modelHandler(msg[0],function(model){return model.setSpoiler(msg[1],msg[2]);});}),_defineProperty(_$extend,common.BAN,function(msg){var _msg3=_slicedToArray(msg,2);var num=_msg3[0];var info=_msg3[1];if(!num){if(!info)return;info=JSON.parse(info);num=info.num;}modelHandler(num,function(model){return model.setBan(num,info);});}),_defineProperty(_$extend,common.BACKLINK,function(msg){modelHandler(msg[0],function(model){return model.addBacklink(msg[1],msg[2]);});}),_defineProperty(_$extend,common.ONLINE_COUNT,function(msg){online.textContent='['+msg[0]+']';}),_defineProperty(_$extend,common.HOT_INJECTION,function(msg){var _msg4=_slicedToArray(msg,3);var force=_msg4[0];var hash=_msg4[1];var hotConfig=_msg4[2];if(!force&&hash!==state.configHash)main.send([common.HOT_INJECTION,true]);else if(force){state.configHash=hash;state.hotConfig.set(hotConfig);}}),_$extend));dispatcher[common.SYNCHRONIZE]=main.connSM.feeder('sync');dispatcher[common.INVALID]=main.connSM.feeder('invalid');function checkRepliedToMe(links,sourceNum){if(!links)return;var mine=state.mine.readAll();for(var num in links){if(num in mine)main.request('repliedToMe',sourceNum);}}function modelHandler(num,func){var model=state.posts.get(num);if(model)func(model);}util.listener(document,'click','del',function(event){if(event.spoilt)return;event.spoilt=true;event.target.classList.toggle('reveal');});\n\n},{\"./main\":\"main\"}],3:[function(require,module,exports){\n'use strict';var main=require('./main');var _=main._;var common=main.common;var config=main.config;var connSM=main.connSM;var state=main.state;var SockJS=main.SockJS;var lang=main.lang.sync;var socket=undefined,attempts=undefined,attemptTimer=undefined;function send(msg){if(connSM.state!='synced'&&connSM.state!='syncing')return;if(socket.readyState!=SockJS.OPEN){if(console)console.warn(\"Attempting to send while socket closed\");return;}msg=JSON.stringify(msg);if(config.DEBUG)console.log('<',msg);socket.send(msg);}main.reply('send',send);function on_message(e){if(config.DEBUG)console.log('>',e.data);var msg=JSON.parse(e.data)[0],op=msg.shift(),type=msg.shift(),isPubSub=common.is_pubsub(type);if(isPubSub&&connSM.state==='locked')return;var handler=main.dispatcher[type];if(!handler)return;if(isPubSub&&op in state.syncs)state.syncs[op]++;main.follow(function(){return handler(msg,op);});}var sync=document.getElementById('sync');function sync_status(msg){sync.textContent=msg;}connSM.act('load + start -> conn',function(){sync_status(lang.connecting);attempts=0;connect();});function connect(){if(socket){socket.onclose=null;socket.onmessage=null;}if(window.location.protocol=='file:'){console.log(\"Page downloaded locally; refusing to sync.\");return;}socket=new_socket();socket.onopen=connSM.feeder('open');socket.onclose=connSM.feeder('close');socket.onmessage=on_message;if(config.DEBUG)window.socket=socket;}function new_socket(){var transports=['xdr-streaming','xhr-streaming','iframe-eventsource','iframe-htmlfile','xdr-polling','xhr-polling','iframe-xhr-polling','jsonp-polling'];if(config.USE_WEBSOCKETS)transports.unshift('websocket');return new SockJS(config.SOCKET_URL||config.SOCKET_PATH,null,{transports:transports});}connSM.act('conn, reconn + open -> syncing',function(){sync_status(lang.syncing);var connID=common.randomID(32);var page=state.page;page.set('connID',connID);send([common.SYNCHRONIZE,connID,page.get('board'),state.syncs,page.get('live'),document.cookie]);});connSM.act('syncing + sync -> synced',function(){sync_status(lang.synced);attemptTimer=setTimeout(function(){attemptTimer=0;reset_attempts();},10000);});function reset_attempts(){if(attemptTimer){clearTimeout(attemptTimer);attemptTimer=0;}attempts=0;}connSM.act('synced, syncing + lock -> locked');connSM.act('locked + unlock -> synced');main.reply('connection:lock',function(){return send([common.DESYNC]);},connSM.feed('lock'));main.reply('connection:unlock',function(msg){return send(msg);},connSM.feed('unlock'));connSM.act('* + close -> dropped',function(error){if(socket){socket.onclose=null;socket.onmessage=null;}if(config.DEBUG)console.error('E:',error);if(attemptTimer){clearTimeout(attemptTimer);attemptTimer=0;}sync_status(lang.dropped);var wait=500*Math.pow(1.5,Math.min(Math.floor(++attempts/2),12));setTimeout(connSM.feeder('retry'),wait);});connSM.act('dropped + retry -> reconn',function(){connect();setTimeout(function(){if(connSM.state=='reconn')sync_status(lang.reconnecting);},100);});connSM.act('* + invalid, desynced + close -> desynced',function(msg){msg=msg&&msg[0]?'Out of sync: '+msg[0]:'Out of sync';sync_status(msg);if(attemptTimer){clearTimeout(attemptTimer);attemptTimer=0;}socket.onclose=null;socket.onmessage=null;socket.close();socket=null;if(config.DEBUG)window.socket=null;});function window_focused(){switch(connSM.state){case 'desynced':return;case 'synced':case 'syncing':case 'conn':var rs=socket.readyState;if(rs!=SockJS.OPEN&&rs!=SockJS.CONNECTING){connSM.feed('close');return;}else if(navigator.onLine===false){connSM.feed('close');return;}break;}connSM.feed('retry');}connSM.feed('start');document.addEventListener('visibilitychange',function(e){if(e.target.hidden)return;setTimeout(window_focused,20);});window.addEventListener('online',function(){return reset_attempts();},connSM.feed('retry'));window.addEventListener('offline',connSM.feeder('close'));\n\n},{\"./main\":\"main\"}],4:[function(require,module,exports){\n'use strict';var _createClass=(function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if(\"value\" in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};})();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError(\"Cannot call a class as a function\");}}var main=require('./main');var _=main._;var util=main.util;var options=main.options;var state=main.state;var posts=main.posts;var Extract=(function(){function Extract(catalog){_classCallCheck(this,Extract);var el=main.$threads[0];var json=JSON.parse(document.getElementById('postData').innerHTML);main.request('notify:title',json.title);if(catalog)return;var mine=this.mine=state.mine.readAll(),posts=this.posts=json.posts;this.extractReplies(el);this.extractThreads(el);state.addLinks(json.links);for(var post in posts){var links=posts[post].links;if(!links)continue;for(var num in links){if(num in mine)main.request('repliedToMe',posts[post].num);}}if(options.get('anonymise'))main.request('loop:anonymise');main.request('time:render');}_createClass(Extract,[{key:'extractReplies',value:function extractReplies(el){var articles=el.getElementsByTagName('article');for(var i=0,l=articles.length;i<l;i++){var article=articles[i];new posts.Article({model:new posts.models.Post(this.extractModel(article)),el:article});}}},{key:'extractThreads',value:function extractThreads(el){var sections=el.getElementsByTagName('section');for(var i=0;i<sections.length;i++){var section=sections[i];var model=this.extractModel(section);new posts.Section({model:new posts.models.Thread(model),el:section}).renderOmit();state.syncs[model.num]=model.hctr;}}},{key:'extractModel',value:function extractModel(el){var info=this.posts[util.getNum(el)];if(info.num in this.mine)info.mine=true;return info;}}]);return Extract;})();module.exports=Extract;new Extract(state.page.get('catalog'));\n\n},{\"./main\":\"main\"}],5:[function(require,module,exports){\n'use strict';var _createClass=(function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if(\"value\" in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};})();Object.defineProperty(exports,\"__esModule\",{value:true});function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError(\"Cannot call a class as a function\");}}3;var FSM=(function(){function FSM(start){_classCallCheck(this,FSM);this.state=start;this.spec={acts:{},ons:{},wilds:{},preflights:{}};}_createClass(FSM,[{key:'clone',value:function clone(){var second=new FSM(this.state);second.spec=this.spec;return second;}},{key:'on',value:function on(key,f){var ons=this.spec.ons[key];if(ons){ons.push(f);}else {this.spec.ons[key]=[f];}}},{key:'preflight',value:function preflight(key,f){var pres=this.spec.preflights[key];if(pres){pres.push(f);}else {this.spec.preflights[key]=[f];}}},{key:'act',value:function act(trans_spec,on_func){var halves=trans_spec.split('->');if(halves.length!=2){throw new Error(\"Bad FSM spec: \"+trans_spec);}var parts=halves[0].split(','),dest=halves[1].match(/^\\s*(\\w+)\\s*$/)[1];var tok=undefined;for(var i=parts.length-1;i>=0;i--){var part=parts[i],m=part.match(/^\\s*(\\*|\\w+)\\s*(?:\\+\\s*(\\w+)\\s*)?$/);if(!m){throw new Error(\"Bad FSM spec portion: \"+part);}if(m[2]){tok=m[2];}if(!tok){throw new Error(\"Tokenless FSM action: \"+part);}var src=m[1];if(src=='*'){this.spec.wilds[tok]=dest;}else {var acts=this.spec.acts[src];if(!acts){this.spec.acts[src]=acts={};}acts[tok]=dest;}}if(on_func){this.on(dest,on_func);}}},{key:'feed',value:function feed(ev,param){var spec=this.spec;var from=this.state;var acts=spec.acts[from];var to=acts&&acts[ev]||spec.wilds[ev];if(to&&from!=to){var ps=spec.preflights[to];for(var i=0;ps&&i<ps.length;i++){if(!ps[i].call(this,param)){return false;}}this.state=to;var fs=spec.ons[to];for(var i=0;fs&&i<fs.length;i++){fs[i].call(this,param);}}return true;}},{key:'feeder',value:function feeder(ev){var _this=this;return function(param){return _this.feed(ev,param);};}}]);return FSM;})();exports.default=FSM;\n\n},{}],6:[function(require,module,exports){\n'use strict';var main=require('./main');var hidden=new main.Memory('hide',7,true);main.reply('hide',function(model){if(model.get('mine'))return;var count=hidden.write(model.get('num'));model.remove();main.request('hide:render',count);});main.reply('hide:clear',function(){return hidden.purgeAll();});main.defer(function(){return main.request('hide:render',hidden.size());});\n\n},{\"./main\":\"main\"}],7:[function(require,module,exports){\n'use strict';var main=require('./main');var $=main.$;var _=main._;var common=main.common;var Extract=main.Extract;var state=main.state;main.$doc.on('click','a.history',function(event){if(event.ctrlKey)return;readingSteiner(this.href,event);});var $loading=$('#loadingImage');main.reply('loading:show',function(){return $loading.show();});main.reply('loading:hide',function(){return $loading.hide();});function readingSteiner(url,event){var nextState=state.read(url);if(_.isMatch(state.page.attributes,nextState))return;main.request('connection:lock');if(event)event.preventDefault();var split=url.split('#');var address=split[0]+(/\\?/.test(split[0])?'&':'?')+'minimal=true';if(split.length!==1)address+='#'+split[1];$loading.show();var xhr=new XMLHttpRequest();xhr.open('GET',address);xhr.onload=function(){if(this.status!==200){$loading.hide();return alert(this.status);}if(baseURL(url)!==baseURL(this.responseURL))nextState=state.read(this.responseURL);main.request('postSM:feed','done');main.trigger('state:clear');main.$threads[0].innerHTML=this.response;state.page.set(nextState);main.oneeSama.op=nextState.thread;new Extract(nextState.catalog);if(!nextState.catalog){main.request('connection:unlock',[common.RESYNC,nextState.board,state.syncs,nextState.live]);}if(event){history.pushState(null,null,nextState.href);if(location.hash)main.request('scroll:aboveBanner');else window.scrollTo(0,0);}$loading.hide();};xhr.send();}function baseURL(url){return url.split(/[\\?#]/)[0];}window.onpopstate=function(event){readingSteiner(event.target.location.href);main.request('scroll:aboveBanner');};\n\n},{\"./main\":\"main\"}],8:[function(require,module,exports){\n'use strict';var main=require('./main');var util=main.util;var follow=main.follow;var options=main.options;var oneeSama=main.oneeSama;var posts=main.state.posts;options.on({'change:thumbs':reRenderImages,'change:spoilers':toggleSpoilers,'change:autogif':toggleAutoGIF,'change:anonymise':toggleAnonymisation,'workModeTOG':reRenderImages});function reRenderImages(){if(main.state.page.get('catalog')){(function(){var show=options.get(\"thumbs\")!=='hide'&&!main.oneeSama.workMode?'':'none';document.queryAll(\".expanded\").forEach(function(el){return el.style.display=show;});})();}else follow(function(){return getImages(function(image,model){return image&&model.dispatch('renderImage',image);});});}function getImages(func){posts.each(function(model){return func(model.get('image'),model);});}function toggleSpoilers(){follow(function(){return getImages(function(image,model){return image&&image.spoiler&&model.dispatch('renderImage',image);});});}function toggleAutoGIF(){follow(function(){return getImages(function(image,model){return image&&image.ext==='.gif'&&model.dispatch('renderImage',image);});});}function toggleAnonymisation(source,toggle){follow(function(){var command=toggle?'anonymise':'renderName';posts.each(function(model){var _model$attributes=model.attributes;var name=_model$attributes.name;var trip=_model$attributes.trip;if(name||trip)model.dispatch(command);});});}main.reply('loop:anonymise',function(){return options.get('anonymise')&&toggleAnonymisation(null,true);});\n\n},{\"./main\":\"main\"}],9:[function(require,module,exports){\n'use strict';var _createClass=(function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if(\"value\" in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};})();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError(\"Cannot call a class as a function\");}}var main=require('./main');var _=main._;var Cookie=main.Cookie;var Memory=(function(){function Memory(key,expiry,needCookie){_classCallCheck(this,Memory);this.key=key;this.expiry=expiry;this.needCookie=needCookie;main.defer(this.purgeExpired.bind(this));}_createClass(Memory,[{key:'bakeCookie',value:function bakeCookie(object){if(!this.needCookie)return;var nums=Object.keys(object);nums.sort(function(a,b){return parseInt(a,10)-parseInt(b,10);});Cookie.set(this.key,nums.join('/'));}},{key:'now',value:function now(){return Math.floor(Date.now()/1000);}},{key:'purgeAll',value:function purgeAll(){localStorage.removeItem(this.key);if(this.needCookie)Cookie.remove(this.key);}},{key:'readAll',value:function readAll(){var key=localStorage.getItem(this.key);if(!key)return {};var val=undefined;try{val=JSON.parse(key);}catch(e) {}return _.isObject(val)?val:{};}},{key:'writeAll',value:function writeAll(object){if(_.isEmpty(object))return this.purgeAll();localStorage.setItem(this.key,JSON.stringify(object));this.bakeCookie(object);}},{key:'write',value:function write(key){var object=this.readAll();object[key]=this.now();this.writeAll(object);return _.size(object);}},{key:'size',value:function size(){return _.size(this.readAll());}},{key:'purgeExpired',value:function purgeExpired(){if(!this.expiry)return;var object=this.readAll();var now=this.now(),limit=86400*this.expiry;var expired=[];for(var key in object){var time=object[key];if(time&&now>time+limit)expired.push(key);}if(!expired.length)return;for(var i=0,lim=expired.length;i<lim;i++){delete object[expired[i]];}this.writeAll(object);}}]);return Memory;})();module.exports=Memory;\n\n},{\"./main\":\"main\"}],10:[function(require,module,exports){\n'use strict';Object.defineProperty(exports,\"__esModule\",{value:true});var _main=require('main');var _opts=require('./opts');var _opts2=_interopRequireDefault(_opts);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var options=undefined;try{options=JSON.parse(localStorage.options);}catch(e) {}if(!options)options={};exports.default=options=new _main.Backbone.Model(options);var OptionsCollection=_main.Backbone.Collection.extend({persist:function persist(){var opts={};this.forEach(function(model){var val=model.getValue();if(val===model.get('default'))return;opts[model.get('id')]=val;});localStorage.options=JSON.stringify(opts);}});var optionsCollection=new OptionsCollection();var OptionModel=_main.Backbone.Model.extend({initialize:function initialize(opts){if(opts.load!==undefined&&!opts.load)return;if(!opts.type)this.set('type','checkbox');var val=this.getValue();this.setValue(val);if(opts.exec!==undefined){this.listenTo(options,'change:'+opts.id,this.execListen);if(opts.execOnStart!==false)opts.exec(val);}optionsCollection.add(this);},setValue:function setValue(val){options.set(this.get('id'),val);},getValue:function getValue(){var val=options.get(this.get('id'));return val===undefined?this.get('default'):val;},validate:function validate(val){var valid=this.get('validation');return valid?valid(val):true;},execListen:function execListen(model,val){this.get('exec')(val);}});(function(){if(localStorage.getItem('options'))return;var $el=$('#options');$el.addClass('noOptions');function fadeout(){$el.filter('.noOptions').fadeOut(fadein);}function fadein(){$el.fadeIn();if($el.filter('.noOptions').length)fadeout();}fadeout();$el.click(function(){$el.removeClass('noOptions');});})();var OptionsView=_main.Backbone.View.extend({initialize:function initialize(){var _this=this;this.setElement(util.parseEl(require('./render')()));document.body.append(this.el);optionsCollection.each(function(model){var $el=_this.$el.find('#'+model.get('id'));if(!$el.length)return;var type=model.get('type'),val=model.getValue();if(type=='checkbox')$el.prop('checked',val);else if(type=='number'||type instanceof Array)$el.val(val);else if(type=='shortcut')$el.val(String.fromCharCode(val).toUpperCase());});this.$hidden=this.$el.find('#hidden');main.reply('hide:render',this.renderHidden,this);},events:{'click .option_tab_sel>li>a':'switchTab','change':'applyChange','click #export':'export','click #import':'import','click #hidden':'clearHidden'},switchTab:function switchTab(event){event.preventDefault();var $a=$(event.target);this.$el.children('.option_tab_sel').find('a').removeClass('tab_sel');$a.addClass('tab_sel');var $li=this.$el.children('.option_tab_cont').children('li');$li.removeClass('tab_sel');$li.filter('.'+$a.data('content')).addClass('tab_sel');},applyChange:function applyChange(event){var $target=$(event.target),model=optionsCollection.get($target.attr('id')),val;if(!model)return;var type=model.get('type');if(type=='checkbox')val=$target.prop('checked');else if(type=='number')val=parseInt($target.val());else if(type=='image')return main.request('background:store',event.target);else if(type=='shortcut')val=$target.val().toUpperCase().charCodeAt(0);else val=$target.val();if(!model.validate(val))return $target.val('');model.setValue(val);optionsCollection.persist();},export:function _export(){var a=document.getElementById('export');a.setAttribute('href',window.URL.createObjectURL(new Blob([JSON.stringify(localStorage)],{type:'octet/stream'})));a.setAttribute('download','meguca-config.json');},import:function _import(event){event.preventDefault();var $input=this.$el.find('#importSettings');$input.click();$input.one('change',function(){var reader=new FileReader();reader.readAsText($input[0].files[0]);reader.onload=function(e){var json;try{json=JSON.parse(e.target.result);}catch(e) {alert('Import failed. File corrupt');}if(!json)return;localStorage.clear();for(var key in json){localStorage[key]=json[key];}alert('Import successfull. The page will now reload.');location.reload(true);};});},renderHidden:function renderHidden(count){var $el=this.$hidden;$el.text($el.text().replace(/\\d+$/,count));},clearHidden:function clearHidden(){main.request('hide:clear');this.renderHidden(0);}});var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=_opts2.default[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var spec=_step.value;new OptionModel(spec);}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}main.defer(function(){new OptionsView();});\n\n},{\"./opts\":11,\"./render\":12,\"main\":\"main\"}],11:[function(require,module,exports){\n'use strict';Object.defineProperty(exports,\"__esModule\",{value:true});var _main=require('main');var notMobile=!_main.isMobile;exports.default=opts=[{id:'lang',type:_main.config.lang.enabled,tab:0,default:_main.config.lang.default,execOnStart:false,exec:function exec(type){alert(_main.lang.langApplied);location.reload();}},{id:'inlinefit',type:['none','full','width','height','both'],tab:1,default:'width'},{id:'thumbs',type:_main.util.thumbStyles,tab:1,default:'small'},{id:'imageHover',default:true,load:notMobile,tab:0},{id:'webmHover',load:notMobile,tab:0},{id:'autogif',load:notMobile,tab:1},{id:'spoilers',tab:1,default:true},{id:'linkify',tab:0,default:true},{id:'notification',load:notMobile,tab:0,exec:function exec(notifToggle){if(notifToggle&&Notification.permission!==\"granted\")Notification.requestPermission();}},{id:'anonymise',tab:0},{id:'relativeTime',tab:0,default:true},{id:'nowPlaying',load:notMobile&&_main.config.radio,tab:3,default:true,exec:function exec(toggle){if(toggle){main.send({type:'radio'});}else {main.request('banner:radio:clear');}}}];var _arr=['google','iqdb','saucenao','desustorage','exhentai'];for(var _i=0;_i<_arr.length;_i++){var engine=_arr[_i];opts.push({id:engine,lang:'imageSearch',tab:2,default:engine==='google',exec:toggleHeadStyle(engine+'Toggle','.'+engine+'{display:initial;}')});}opts.push({id:'illyaBGToggle',load:notMobile&&_main.config.illyaDance,tab:3},{id:'illyaMuteToggle',load:notMobile&&_main.config.illyaDance,tab:3},{id:'horizontalPosting',tab:3,exec:toggleHeadStyle('horizontal','article,aside{display:inline-block;}')},{id:'replyright',tab:1,exec:toggleHeadStyle('reply-at-right','section>aside{margin: -26px 0 2px auto;}')},{id:'theme',type:['moe','gar','mawaru','moon','ashita','console','tea','higan','ocean','rave','tavern','glass'],tab:1,default:_main.config.defaultCSS,exec:function exec(theme){if(!theme){return;}document.getElementById('theme').setAttribute('href',_main.config.MEDIA_URL+'css/'+theme+'.css?v='+main.cssHash);}},{id:'userBG',load:notMobile,tab:1},{id:'userBGimage',load:notMobile,type:'image',tab:1,execOnStart:false,exec:function exec(upload){main.request('background:store',upload);}},{id:'lastn',type:'number',tab:0,validation:_main.util.resonableLastN,default:_main.config.posts.lastN},{id:'alwaysLock',tab:0});var shorts=[{id:'new',default:78},{id:'togglespoiler',default:73},{id:'textSpoiler',default:68},{id:'done',default:83},{id:'expandAll',default:69},{id:'workMode',default:66}];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=shorts[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var short=_step.value;short.type='shortcut';short.tab=4;short.load=notMobile;opts.push(short);}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}function toggleHeadStyle(id,css){return function(toggle){if(!document.getElementById(id)){document.head.appendChild(_main.util.parseEl('<style id=\"'+id+'\">'+css+'</style>'));}document.getElementById(id).disabled=!toggle;};}\n\n},{\"main\":\"main\"}],12:[function(require,module,exports){\n'use strict';var _slicedToArray=(function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err) {_d=true;_e=err;}finally {try{if(!_n&&_i[\"return\"])_i[\"return\"]();}finally {if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else {throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");}};})();var _templateObject=_taggedTemplateLiteral(['<input ','>'],['<input ','>']);Object.defineProperty(exports,\"__esModule\",{value:true});exports.default=render;var _main=require('main');function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}var lang=main.lang.opts;function render(){var html='<div class=\"bmodal glass\" id=\"options-panel\">'+'<ul class=\"option_tab_sel\">';var tabs=lang.tabs;var opts=[];var _loop=function _loop(i){opts[i]=_main._.filter(_main.options,function(opt){return opt.tab===i&&(opt.load===undefined||opt.load)&&!opt.hidden;});if(!opts[i].length){return 'continue';}html+='<li><a data-content=\"tab-'+i+'\"';if(i===0){html+=' class=\"tab_sel\"';}html+='>'+tabs[i]+'</a></li>';};for(var i=0;i<tabs.length;i++){var _ret=_loop(i);if(_ret==='continue')continue;}html+='</ul><ul class=\"option_tab_cont\">';for(var i=0;i<opts.length;i++){html+=renderTab(opt,i);}html+='</ul></div>';return html;}function renderTab(opt,i){if(!opts[i].length){return '';}var html=\"\";html+='<li class=\"tab-'+i;if(i===0){html+=' tab_sel';}html+='\">';var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=opts[i][Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var _opt=_step.value;html+=renderOption(_opt);}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}if(i===0){html+=renderExtras();}html+='</li>';return html;}function renderOption(opt){var html='';var isShortcut=opt.type==='shortcut',isList=opt.type instanceof Array,isCheckbox=opt.type==='checkbox'||opt.type===undefined,isNumber=opt.type==='number',isImage=opt.type==='image';if(isShortcut){html+='Alt+';}if(!isList){html+='<input';if(isCheckbox||isImage)html+=' type=\"'+(isCheckbox?'checkbox':'file')+'\"';else if(isNumber)html+=' style=\"width: 4em;\" maxlength=\"4\"';else if(isShortcut)html+=' maxlength=\"1\"';}else {html+='<select';}var _lang$opt$id=_slicedToArray(lang[opt.id],2);var label=_lang$opt$id[0];var title=_lang$opt$id[1];html+=' id=\"'+opt.id+'\" title=\"'+title+'\">';if(isList){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=opt.type[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var item=_step2.value;html+='<option value=\"'+item+'\">'+(lang[item]||item)+'</option>';}}catch(err) {_didIteratorError2=true;_iteratorError2=err;}finally {try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally {if(_didIteratorError2){throw _iteratorError2;}}}html+='</select>';}html+='<label for=\"'+opt.id+'\" title=\"'+title+'\">'+label+'</label><br>';return html;}function renderExtras(){var html='<br>';var links=['export','import','hidden'];var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=links[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var id=_step3.value;var _lang$id=_slicedToArray(lang[id],2);var label=_lang$id[0];var title=_lang$id[1];html+='<a id=\"'+id+'\" title=\"'+ln[1]+'\">'+ln[0]+'</a> ';}}catch(err) {_didIteratorError3=true;_iteratorError3=err;}finally {try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return();}}finally {if(_didIteratorError3){throw _iteratorError3;}}}var attrs={type:'file',id:'importSettings',name:\"Import Settings\"};html+=common.parseHTML(_templateObject,attrs);return html;}\n\n},{\"main\":\"main\"}],13:[function(require,module,exports){\n'use strict';var main=require('../main');var PostCommon=require('./common');var _=main._;var Backbone=main.Backbone;module.exports=PostCommon.extend({tagName:'article',render:function render(){this.setElement(main.oneeSama.article(this.model.attributes));return this;},insertIntoDOM:function insertIntoDOM(){_.last(document.query('#p'+this.model.get('op')).queryAll('article')).after(this.el);this.autoExpandImage().fun();}});\n\n},{\"../main\":\"main\",\"./common\":14}],14:[function(require,module,exports){\n'use strict';var main=require('../main');var imager=require('./imager');var _=main._;var Backbone=main.Backbone;var common=main.common;var util=main.util;var lang=main.lang;var oneeSama=main.oneeSama;var options=main.options;var state=main.state;module.exports=imager.Hidamari.extend({className:'glass',initialize:function initialize(){this.listenTo(this.model,'dispatch',this.redirect);},clientInit:function clientInit(){if(options.get('anonymise'))this.anonymise();return this;},redirect:function redirect(command){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}this[command].apply(this,args);},updateBody:function updateBody(frag){if(!this.blockquote)this.blockquote=this.el.query('blockquote');var model=this.model.attributes;this.blockquote.innerHTML=oneeSama.setModel(model).body(model.body);},renderTime:function renderTime(){this.el.query('time').outerHTML=oneeSama.time(this.model.get('time'));},renderBacklinks:function renderBacklinks(links){this.el.query('small').innerHTML=oneeSama.backlinks(links);},fun:function fun(){},anonymise:function anonymise(){this.el.query('.name').innerHTML='<b class=\"name\">'+lang.anon+'<b>';},renderName:function renderName(){this.el.query('.name').outerHTML=oneeSama.name(this.model.attributes);},renderModerationInfo:function renderModerationInfo(info){var el=this.getContainer();el.query('.modLog').remove();el.query('blockquote').before(util.parseDOM(oneeSama.modInfo(info)));},getContainer:function getContainer(){return this.el.query('.container');},renderBan:function renderBan(){var el=this.getContainer();el.query('.banMessage').remove();el.query('blockquote').after(util.parseDOM(oneeSama.banned()));},renderEditing:function renderEditing(editing){var el=this.el;if(editing)el.classList.add('editing');else {el.classList.remove('editing');el.query('blockquote').normalize();}}});\n\n},{\"../main\":\"main\",\"./imager\":17}],15:[function(require,module,exports){\n'use strict';var main=require('../main');var $=main.$;var util=main.util;var youtube_url_re=exports.youtube_url_re=/(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?youtube\\.com\\/watch\\/?\\?((?:[^\\s#&=]+=[^\\s#&]*&)*)?v=([\\w-]{11})((?:&[^\\s#&=]+=[^\\s#&]*)*)&?(#t=[\\dhms]{1,9})?/,youtube_short_re=exports.youtube_short_re=/(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?youtu.be\\/([\\w-]{11})\\??(t=[\\dhms]{1,9})?/,youtube_time_re=exports.youtube_time_re=/^#t=(?:(\\d\\d?)h)?(?:(\\d{1,3})m)?(?:(\\d{1,3})s)?$/,youtube_short_time_re=exports.youtube_short_time_re=/^t=(?:(\\d\\d?)h)?(?:(\\d{1,3})m)?(?:(\\d{1,3})s)?$/;function make_video(id,params,start){if(!params)params={allowFullScreen:'true'};params.allowScriptAccess='always';var query={autohide:1,fs:1,modestbranding:1,origin:document.location.origin,rel:0,showinfo:0};if(start)query.start=start;if(params.autoplay)query.autoplay=params.autoplay;if(params.loop){query.loop='1';query.playlist=id;}return $('<iframe></iframe>',{type:'text/html',src:encodeURI('https://www.youtube.com/embed/'+id)+'?'+$.param(query),frameborder:'0',attr:video_dims(),class:'youtube-player'});}function video_dims(){if(window.screen&&screen.width<=320)return {width:250,height:150};else return {width:560,height:340};}main.$threads.on('click','.watch',function(e){if(e.which>1||e.metaKey||e.ctrlKey||e.altKey||e.shiftKey)return;var $target=$(e.target);if(!$target.is('a'))return;var $video=$target.find('iframe');if($video.length){$video.siblings('br').andSelf().remove();$target.css('width','auto');return false;}if($target.data('noembed'))return;var m=$target.attr('href').match(youtube_url_re);if(!m){m=$target.attr('href').match(youtube_short_re);if(!m)return;timeCall(m[1],m[2],youtube_short_time_re);}timeCall(m[2],m[4],youtube_time_re);function timeCall(url,time,timeRex){var start=0;if(time){var t=time.match(timeRex);if(t){if(t[1])start+=parseInt(t[1],10)*3600;if(t[2])start+=parseInt(t[2],10)*60;if(t[3])start+=parseInt(t[3],10);}}$target.css('width',video_dims().width).append('<br>',make_video(url,null,start));}return false;});main.$threads.on('mouseenter','.watch',function(event){var $target=$(event.target);if($target.data('requestedTitle'))return;$target.data('requestedTitle',true);var node=$target.contents().filter(function(){return this.nodeType===3;})[0];if(!node)return;var orig=node.textContent;node.textContent=orig+'...';var m=$target.attr('href').match(youtube_url_re);if(!m){m=$target.attr('href').match(youtube_short_re);if(!m)return;$.ajax({url:'//gdata.youtube.com/feeds/api/videos/'+m[1],data:{v:'2',alt:'jsonc'},dataType:'json',success:gotInfo,error:function error(){node.textContent=orig+'???';}});}$.ajax({url:'//gdata.youtube.com/feeds/api/videos/'+m[2],data:{v:'2',alt:'jsonc'},dataType:'json',success:gotInfo,error:function error(){node.textContent=orig+'???';}});function gotInfo(data){var title=data&&data.data&&data.data.title;if(title){node.textContent=orig+': '+title;$target.css({color:'black'});}else node.textContent=orig+' (gone?)';if(data&&data.data&&data.data.accessControl&&data.data.accessControl.embed==='denied'){node.textContent+=' (EMBEDDING DISABLED)';$target.data('noembed',true);}}});function make_embed(uri,params,dims){var $obj=$('<object/>',{attr:dims});for(var name in params){$('<param/>',{attr:{name:name,value:params[name]}}).appendTo($obj);}$('<embed/>',{src:uri,type:'application/x-shockwave-flash'}).attr(dims).attr(params).appendTo($obj);return $obj;}var soundcloud_url_re=exports.soundcloud_url_re=/(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.)?soundcloud\\.com\\/([\\w-]{1,40}\\/[\\w-]{1,80})\\/?/;function fetchSoundcloud(target,width,cb){var url='https://soundcloud.com/oembed?url='+encodeURIComponent(target.getAttribute('href'))+('&maxwidth='+width+'&maxheight=166&auto_play=true&format=json')+'&show_comments=false';var xhr=new XMLHttpRequest();xhr.open('GET',url);xhr.responseType='json';xhr.onload=function(){if(this.status!==200)return cb(this.status);cb(null,this.response);};xhr.send();}main.$threads.on('click','.soundcloud',function(e){if(e.which>1||e.ctrlKey||e.altKey||e.shiftKey||e.metaKey)return;var target=e.target;var iframe=target.query('iframe');e.preventDefault();if(iframe){iframe.previousElementSibling.remove();iframe.remove();return;}var width=Math.round(window.innerWidth*0.75);fetchSoundcloud(target,width,function(err,json){if(err)return alert(err);target.append(document.createElement('br'));target.append(util.parseDOM(json.html));target.style.width=width+'px';});});main.$threads.on('mouseenter','.soundcloud:not(.fetched)',function(event){var target=event.target;var node=target.firstChild;var text=node.textContent;node.textContent=text+' ...';fetchSoundcloud(target,1000,function(err,json){if(err)return node.textContent=text+': Error: '+err;node.textContent=text+': '+json.title;target.style.color='black';target.classList.add('fetched');});});var pastebin_re=exports.pastebin_re=/(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?pastebin\\.com\\/(.*)/;$(document).on('click','.pastebin',function(event){if(event.which>1||event.ctrlKey||event.altKey||event.shiftKey||event.metaKey)return;var $target=$(event.target);var $obj=$target.find('iframe');if($obj.length){$obj.siblings('br').andSelf().remove();$target.css({width:'auto',height:'auto'});return false;}var m=$target.attr('href').match(pastebin_re);if(!m)return;var $window=$(window),width=Math.round($window.innerWidth()*0.65),height=Math.round($window.innerHeight()*0.65);$target.css({width:width,height:height}).append('<br>',$('<iframe></iframe>',{type:'text/html',src:'https://pastebin.com/embed_iframe.php?i='+m[1],frameborder:'0',width:width,height:height}));return false;});\n\n},{\"../main\":\"main\"}],16:[function(require,module,exports){\n'use strict';var main=require('../main');var $=main.$;var $script=main.$script;var $email=main.$email;var $name=main.$name;var _=main._;var common=main.common;var config=main.config;function load(){try{var id=JSON.parse(localStorage.ident);if(id.name)$name.val(id.name);if(id.email)$email.val(id.email);}catch(e) {}}var save=_.debounce(function(){try{var name=$name.val();var email=$email.val();if(email===config.LOGIN_KEYWORD){$email.val('');$script(config.MEDIA_URL+'js/login.js?v='+main.clientHash);email=false;}if(name||email){var id={};if(name)id.name=name;if(email)id.email=email;localStorage.ident=JSON.stringify(id);}else localStorage.removeItem('ident');}catch(e) {}},1000);function propagate(){var postForm=main.request('postForm');if(postForm)postForm.renderIdentity();save();}main.defer(function(){load();$name.on('input',propagate);$email.on('input',propagate);});\n\n},{\"../main\":\"main\"}],17:[function(require,module,exports){\n'use strict';var _templateObject=_taggedTemplateLiteral(['<',' ','>'],['<',' ','>']),_templateObject2=_taggedTemplateLiteral(['<audio src=\"','\"\\n\\t\\t\\t\\twidth=\"300\"\\n\\t\\t\\t\\theight=\"3em\"\\n\\t\\t\\t\\tautoplay loop controls\\n\\t\\t\\t>\\n\\t\\t\\t</audio>'],['<audio src=\"','\"\\n\\t\\t\\t\\twidth=\"300\"\\n\\t\\t\\t\\theight=\"3em\"\\n\\t\\t\\t\\tautoplay loop controls\\n\\t\\t\\t>\\n\\t\\t\\t</audio>']);function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}var main=require('../main');var $threads=main.$threads;var _=main._;var Backbone=main.Backbone;var common=main.common;var util=main.util;var oneeSama=main.oneeSama;var options=main.options;var state=main.state;exports.Hidamari=Backbone.View.extend({renderImage:function renderImage(arg,image,manual){var reveal=arg===true;var model=this.model;var el=this.el;if(!image||!image.src)image=model.get('image');var figure=el.query('figure');if(figure)figure.remove();if(!image)return;el.query('blockquote').before(util.parseDOM(oneeSama.image(image,reveal)));if(manual&&model.get('tallImage')){window.scrollTop=el.getBoundingClientRect().top+document.body.scrollTop-document.query('#banner').height;}model.set({thumbnailRevealed:reveal,imageExpanded:false,tallImage:false});},autoExpandImage:function autoExpandImage(){var img=this.model.get('image');if(!img||!massExpander.get('expand')||['.webm','.pdf','.mp3'].indexOf(img.ext)>-1)return this;this.toggleImageExpansion(true,img);return this;},toggleImageExpansion:function toggleImageExpansion(expand,img,manual){var fit=options.get('inlinefit');if(!img||fit==='none')return;if(expand)this.fitImage(img,fit);else this.renderImage(null,img,manual);},fitImage:function fitImage(img,fit){if(img.ext==='.pdf')return window.open(oneeSama.imagePaths().src+img.src,'_blank');if(img.ext==='.mp3')return this.renderAudio(img);var newWidth=undefined,newHeight=undefined,width=newWidth=img.dims[0],height=newHeight=img.dims[1];if(fit==='full')return this.expandImage(img,{width:width,height:height});var both=fit==='both',widthFlag=both||fit==='width',heightFlag=both||fit==='height',aspect=width/height;var fullWidth=undefined,fullHeight=undefined;if(widthFlag){var maxWidth=this.imageMaxWidth();if(newWidth>maxWidth){newWidth=maxWidth;newHeight=newWidth/aspect;fullWidth=true;}}if(heightFlag){var maxHeight=window.innerHeight-document.query('#banner').offsetHeight;if(newHeight>maxHeight){newHeight=maxHeight;newWidth=newHeight*aspect;fullHeight=true;}}if(newWidth>50&&newHeight>50){width=newWidth;height=newHeight;}this.expandImage(img,width,height,fullHeight&&!fullWidth);},imageMaxWidth:function imageMaxWidth(){var el=this.el;var model=this.model;return window.innerWidth-parseInt(el.closest('section').getBoundingClientRect().left)*2-util.outerWidth(model.get('op')?el:el.query('.background'));},expandImage:function expandImage(img,width,height,noMargin){var isVideo=img.ext==='.webm';var attrs={src:oneeSama.imagePaths().src+img.src,width:width,height:height};var cls='expanded';if(noMargin)cls+=' noMargin';attrs.class=cls;if(isVideo)attrs.autoplay=attrs.loop=attrs.controls=true;this.el.query('figure').lastChild.innerHTML=common.parseHTML(_templateObject,isVideo?'video':'img',attrs);this.model.set({imageExpanded:true,tallImage:height>window.innerHeight});},renderAudio:function renderAudio(img){this.el.query('figure').append(util.parseDOM(common.parseHTML(_templateObject2,oneeSama.imagePaths().src+img.src)));this.model.set('imageExpanded',true);}});var ExpanderModel=Backbone.Model.extend({initialize:function initialize(){var _this=this;$threads.on('click','#expandImages',function(e){e.preventDefault();_this.toggle();});},toggle:function toggle(){var expand=!this.get('expand');this.set('expand',expand).massToggle(expand);$threads.find('#expandImages').text(main.lang.expander[+expand]);},massToggle:function massToggle(expand){var fit=options.get('inlinefit');if(fit==='none')return;var models=state.posts.models;for(var i=0,l=models.length;i<l;i++){var model=models[i],img=model.get('image');if(!img)continue;if(expand)model.dispatch('fitImage',img,fit);else model.dispatch('renderImage',null,img);}}});var massExpander=exports.massExpander=new ExpanderModel();main.reply('massExpander:unset',function(){return massExpander.unset();});$threads.on('click','img, video',function(e){if(options.get('inlinefit')=='none'||e.which!==1)return;var model=util.getModel(e.target);if(!model)return;e.preventDefault();main.request('imager:clicked');model.dispatch('toggleImageExpansion',!model.get('imageExpanded'),model.get('image'),true);});$threads.on('click','.imageToggle',function(e){e.preventDefault();var model=util.getModel(e.target);if(!model)return;main.follow(function(){return model.dispatch('renderImage',!model.get('thumbnailRevealed'));});});\n\n},{\"../main\":\"main\"}],18:[function(require,module,exports){\n'use strict';module.exports={imager:require('./imager'),Menu:require('./menu'),common:require('./common'),Article:require('./article'),Section:require('./section'),models:require('./models'),nonce:require('./nonce'),embed:require('./embed'),posting:require('./posting')};\n\n},{\"./article\":13,\"./common\":14,\"./embed\":15,\"./imager\":17,\"./menu\":19,\"./models\":20,\"./nonce\":21,\"./posting\":22,\"./section\":23}],19:[function(require,module,exports){\n'use strict';var main=require('../main');var $=main.$;var _=main._;var Backbone=main.Backbone;var common=main.common;var util=main.util;var lang=main.lang;var state=main.state;var MenuView=module.exports=Backbone.View.extend({className:'popup-menu glass',tagName:'ul',actions:['report','hide'],events:{click:'handleClick'},initialize:function initialize(_ref){var parent=_ref.parent;parent._popup_menu=this;this.parent=parent;this.render();},render:function render(){var html='';var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.actions[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var action=_step.value;html+='<li data-type=\"'+action+'\">'+lang[action]+'</li>';}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}var el=this.el;var parent=this.parent;el.innerHTML=html;parent.append(el);el.style.left=el.getBoundingClientRect().left-(util.outerWidth(el)+el.offsetWidth)*0.6+'px';},handleClick:function handleClick(e){e.stopPropagation();main.request(e.target.getAttribute('data-type'),this.model);this.remove();},remove:function remove(){this.parent._popup_menu=null;this.el.remove();this.stopListening();}});main.reply('menu:extend',function(action){return _.extend(MenuView.prototype.actions,action);});main.$threads.on('click','.control',function(event){var target=event.target;if(target._popup_menu)return target._popup_menu.remove();var model=util.getModel(target);if(model)new MenuView({parent:target,model:model});});\n\n},{\"../main\":\"main\"}],20:[function(require,module,exports){\n'use strict';var main=require('../main');var _=main._;var Backbone=main.Backbone;var state=main.state;exports.Post=Backbone.Model.extend({idAttribute:'num',initialize:function initialize(){state.posts.add(this);},dispatch:function dispatch(command){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}this.trigger.apply(this,['dispatch',command].concat(args));},remove:function remove(){this.stopListening().dispatch('remove');state.posts.remove(this);},update:function update(frag,links,dice){var updates={body:this.get('body')+frag};if(links)_.extend(this.get('links'),links);if(dice)updates.dice=(this.get('dice')||[]).concat(dice);this.set(updates);},setImage:function setImage(image,silent){this.set('image',image);if(!silent)this.dispatch('renderImage',image);},setSpoiler:function setSpoiler(spoiler,info){var image=this.get('image');image.spoiler=spoiler;this.dispatch('renderImage',image);this.moderationInfo(info);},removeImage:function removeImage(info){this.moderationInfo(info)||this.unset('image').dispatch('renderImage');},deletePost:function deletePost(info){this.moderationInfo(info)||this.remove();},setBan:function setBan(display,info){if(display)this.set('ban',true).dispatch('renderBan');this.moderationInfo(info);},addBacklink:function addBacklink(num,op){var backlinks=this.get('backlinks')||{};backlinks[num]=op;this.set({backlinks:backlinks}).dispatch('renderBacklinks',backlinks);},moderationInfo:function moderationInfo(info){if(!info)return false;var mod=this.get('mod')||[];mod.push(info);this.set('mod',mod).dispatch('renderModerationInfo',mod);return true;}});exports.Thread=exports.Post.extend({defaults:{replies:[],omit:0,image_omit:0},initialize:function initialize(){if(this.get('omit'))this.getImageOmit();state.posts.add(this);},remove:function remove(){this.stopListening().dispatch('remove');state.posts.remove(this);var replies=this.get('replies');for(var i=0,lim=replies.length;i<lim;i++){var model=state.posts.get(replies[i]);if(model)model.remove();}},getImageOmit:function getImageOmit(){var image_omit=this.get('imgctr')-1;var replies=this.get('replies');for(var i=0,lim=replies.length;i<lim;i++){var model=state.posts.get(replies[i]);if(!model)continue;if(model.get('image'))image_omit--;}this.set('image_omit',image_omit);},toggleLocked:function toggleLocked(val,info){this.moderationInfo(info);this.set('locked',val).dispatch('renderLocked',val);}});\n\n},{\"../main\":\"main\"}],21:[function(require,module,exports){\n'use strict';var main=require('../main');var common=main.common;var state=main.state;var nonceCache={};function get(){var nonces;if(window.localStorage){try{nonces=JSON.parse(localStorage.postNonces);}catch(e) {}}else nonces=nonceCache;return nonces||{};}main.reply('nonce:get',get);function save_nonces(nonces){if(window.localStorage)localStorage.postNonces=JSON.stringify(nonces);else nonceCache=nonces;}function today_id(){return Math.floor(Date.now()/(1000*60*60*24));}function create(){var nonces=get(),nonce=common.randomID(32);nonces[nonce]={tab:state.page.get('tabID'),day:today_id()};save_nonces(nonces);return nonce;}main.reply('nonce:create',create);setTimeout(function(){if(!window.localStorage)return;var nonces=get();var changed=undefined;var yesterday=today_id()-1;for(var nonce in nonces){if(nonces[nonce].day>=yesterday)continue;delete nonces[nonce];changed=true;}if(changed)save_nonces(nonces);},Math.floor(Math.random()*5000));function destroy(nonce){setTimeout(function(){var nonces=get();if(!nonces[nonce])return;delete nonces[nonce];save_nonces(nonces);},10000);}main.reply('nonce:destroy',destroy);\n\n},{\"../main\":\"main\"}],22:[function(require,module,exports){\n'use strict';var _templateObject=_taggedTemplateLiteral(['<header>\\n\\t\\t\\t\\t<a class=\"name nope\" target=\"_blank\">\\n\\t\\t\\t\\t\\t<b></b>\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t</header>\\n\\t\\t\\t<span class=\"oi control\" data-glyph=\"chevron-bottom\"></span>\\n\\t\\t\\t<div class=\"container\">\\n\\t\\t\\t\\t<blockquote>\\n\\t\\t\\t\\t\\t<p id=\"buffer\" class=\"exclude\"></p>\\n\\t\\t\\t\\t\\t<p id=\"lineBuffer\" class=\"exclude\"></p>\\n\\t\\t\\t\\t\\t<textarea ','></textarea>\\n\\t\\t\\t\\t</blockquote>\\n\\t\\t\\t\\t<form ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<strong id=\"uploadStatus\"></strong>\\n\\t\\t\\t\\t</form>\\n\\t\\t\\t\\t<small></small>\\n\\t\\t\\t</div>'],['<header>\\n\\t\\t\\t\\t<a class=\"name nope\" target=\"_blank\">\\n\\t\\t\\t\\t\\t<b></b>\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t</header>\\n\\t\\t\\t<span class=\"oi control\" data-glyph=\"chevron-bottom\"></span>\\n\\t\\t\\t<div class=\"container\">\\n\\t\\t\\t\\t<blockquote>\\n\\t\\t\\t\\t\\t<p id=\"buffer\" class=\"exclude\"></p>\\n\\t\\t\\t\\t\\t<p id=\"lineBuffer\" class=\"exclude\"></p>\\n\\t\\t\\t\\t\\t<textarea ','></textarea>\\n\\t\\t\\t\\t</blockquote>\\n\\t\\t\\t\\t<form ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<strong id=\"uploadStatus\"></strong>\\n\\t\\t\\t\\t</form>\\n\\t\\t\\t\\t<small></small>\\n\\t\\t\\t</div>']);function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}var Article=require('./article');var main=require('../main');var embed=require('./embed');var ident=require('./identity');var imager=require('./imager');var $=main.$;var _=main._;var Backbone=main.Backbone;var Cookie=main.Cookie;var common=main.common;var config=main.config;var connSM=main.connSM;var util=main.util;var lang=main.lang;var oneeSama=main.oneeSama;var options=main.options;var postSM=main.postSM;var state=main.state;var postForm=undefined,postModel=undefined;main.reply('postForm',function(){return postForm;}).reply('postModel',function(){return postModel;}).reply('postForm:indentity',function(){return postForm&&postForm.renderIdentity();});var inputMinSize=300;if(window.screen&&screen.width<=320)inputMinSize=50;var ComposerModel=Backbone.Model.extend({idAttribute:'num'});connSM.on('synced',postSM.feeder('sync'));connSM.on('dropped',postSM.feeder('desync'));connSM.on('desynced',postSM.feeder('desync'));main.reply('postSM:feed',function(state){return postSM.feed(state);});postSM.act('* + desync -> none',function(){if(postForm){postForm.el.classList.remove('editing');postForm.$input.val('');postForm.finish();}main.$threads.find('aside.posting').hide();});postSM.act('none + sync, draft, alloc + done -> ready',function(){if(postForm){postForm.remove();postForm=postModel=null;}var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=main.$threads[0].queryAll('aside.posting')[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var el=_step.value;el.style.display='';}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}});postSM.act('ready + new -> draft',function(aside){var op=undefined,section=aside.closest('section');if(section)op=util.getNum(section);else section=document.createElement('section');if(op&&!state.page.get('thread'))state.posts.get(op).dispatch('shiftReplies',true);postForm=new ComposerView({model:postModel=new ComposerModel({op:op}),destination:aside,section:section});});postSM.preflight('draft',function(aside){return aside.matches('aside');});postSM.act('draft + alloc -> alloc',function(msg){return postForm.onAllocation(msg);});main.dispatcher[common.IMAGE_STATUS]=function(msg){return postForm&&postForm.dispatch(msg[0]);};main.$doc.on('click','aside.posting a',function(){postSM.feed('new',this.parentNode);});main.$doc.on('keydown',handle_shortcut);function handle_shortcut(event){if(!event.altKey)return;var opts=options.attributes;switch(event.which){case opts.new:var aside=document.query('aside.posting');if(aside){postSM.feed('new',aside);prevent();}break;case opts.togglespoiler:if(postForm){postForm.onToggle(event);prevent();}break;case opts.done:if(postForm&&!postForm.$submit.attr('disabled')){postForm.finish();prevent();}break;case opts.textSpoiler:if(postForm){var postState=this.imouto.state2.spoiler;var sp=(postState?'[/':' [')+'spoiler]';this.imouto.state2.spoiler=!postState;this.$input.val(this.$input.val()+sp);prevent();}break;case opts.expandAll:imager.massExpander.toggle();prevent();break;case opts.workMode:var val=main.oneeSama.workMode=!main.oneeSama.workMode;Cookie.set('workModeTOG',val);var banner=document.querySelector(\"h1 > img\");if(banner!=null)banner.style.display=val?'none':'';document.getElementById('theme').setAttribute('href',config.MEDIA_URL+'css/'+(val?state.hotConfig.get('DEFAULT_CSS'):main.options.get(\"theme\"))+'.css?v='+main.cssHash);oneeSama.thumbStyle=val?'hide':main.options.get('thumbs');main.options.trigger(\"workModeTOG\");window.addEventListener('beforeunload',function(){Cookie.set(\"workModeTOG\",false);});prevent();break;}function prevent(){event.stopImmediatePropagation();event.preventDefault();}}main.oneeSama.hook('insertOwnPost',function(_ref){var links=_ref.links;if(!postForm||!links)return;postForm.$buffer.find('.nope').each(function(){var $a=$(this);var text=$a.text(),m=text.match(/^>>(\\d+)/);if(!m)return;var num=m[1],op=links[num];if(!op)return;var $ref=$(common.join([postForm.imouto.postRef(num,op,false)]));$a.attr('href',$ref.attr('href')).attr('class','history');var refText=$ref.text();if(refText!=text)$a.text(refText);});});var ArticleComposer=Article.extend({events:{'click #cancel':'cancel','change #imageInput':'onImageChosen','input #trans':'onInput','keydown #trans':'onKeyDown','click #done':'finish','click #toggle':'onToggle'},initialize:function initialize(args){Article.prototype.initialize.call(this);this.listenTo(this.model,{'change':this.renderButtons,'change:spoiler':this.renderSpoilerPane});this.render(args).insertIntoDOM(args);this.model.set({spoiler:0,nextSpoiler:-1});this.pending='';this.line_count=1;this.char_count=0;var imouto=this.imouto=new common.OneeSama({callback:inject,op:state.page.get('thread'),blockqoute:this.blockqoute,eLinkify:main.oneeSama.eLinkify,lang:main.lang,tamashii:function tamashii(num){var section=document.query('#p'+num);section=section&&section.closest('section');if(section){var desc=num in state.mine.readAll()&&lang.you;return this.postRef(num,util.getNum(section),desc);}else return '<a class=\"nope\">&gt;&gt;'+num+'</a>';}});imouto.setModel(this.model);},render:function render(){var attrs={input:{name:'body',id:'input',rows:1,class:'themed exclude',autocomplete:main.isMobile},form:{method:'post',enctype:'multipart/form-data',target:'upload',id:'uploadForm'},cancel:{type:'buttom',value:lang.cancel,id:'cancel'},imageInput:{type:'file',id:'imageInput',name:'image',accept:'image/*;.webm;.pdf;.mp3'},toggle:{type:'button',id:'toggle'}};this.el.innerHTML=parseHTML(_templateObject,attrs.input,attrs.form,attrs.cancel,attrs.imageInput,attrs.toggle);var els=['buffer','lineBuffer','input','uploadForm','cancel','imageInput','toggle','uploadStatus','hiddenUpload','sizer'];var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=els[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var el=_step2.value;this[el]=document.query('#'+el);}}catch(err) {_didIteratorError2=true;_iteratorError2=err;}finally {try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally {if(_didIteratorError2){throw _iteratorError2;}}}this.renderIdentity();return this;},renderIdentity:function renderIdentity(){if(this.model.get('num'))return;var parsed=common.parse_name(main.$name.val(),main.$email.val()),haveTrip=!!(parsed[1]||parsed[2]);var el=this.el.query('.name'),name=el.query('a');if(parsed[0])name.textContent=parsed[0]+' ';else name.tetxContent=haveTrip?'':lang.anon;if(haveTrip)util.parseDOM(' <code>!?</code>').forEach(function(el){return name.after(el);});main.oneeSama.trigger('fillMyName',name);var email=main.$email.val().trim();if(email){el.setAttribute('href','mailto:'+email);el.classList.remove('nope');el.classList.add('email');}else {el.removeAttribute('href');el.classList.add('nope');el.classList.remove('email');}},insertIntoDOM:function insertIntoDOM(_ref2){var destination=_ref2.destination;destination.before(this.el);this.resizeInput();main.$threads.queryAll('aside.postsing').forEach(function(el){return el.style.display='none';});this.fun();},resizeInput:function resizeInput(val){var sizer=this.sizer;var input=this.input;if(typeof val!=='string')val=input.value;sizer.textContent=val;var size=sizer.width+common.INPUT_ROOM;size=Math.max(size,inputMinSize-input.getBoundingClientRect().left-this.el.getBoundingClientRect().left);this.input.style.width=size+'px';},renderButtons:function renderButtons(){var _model$attributes=this.model.attributes;var num=_model$attributes.num;var uploading=_model$attributes.uploading;var uploaded=_model$attributes.uploaded;var uploadStatus=_model$attributes.uploadStatus;var sentAllocRequest=_model$attributes.sentAllocRequest;var allocWait=sentAllocRequest&&!num;this.submit.disabled=!!(uploading||allocWait);if(uploaded)this.submit.style.marginLeft=0;this.cancel.disabled=!!allocWait;this.cancel.style.display=!num||uploading?'':'none';this.imageInput.disabled=!!uploading;this.uploadStatus.innerHTML=uploadStatus;},renderSpoilerPane:function renderSpoilerPane(model,spoiler){var background=spoiler?config.MEDIA_URL+'spoil/spoil'+spoiler+'.png':config.MEDIA_URL+'css/ui/pane.png';this.toggle.style.backgroundImage='url(\"'+background+'\")';}});var ComposerView=Backbone.View.extend({events:{'input #trans':'onInput','keydown #trans':'onKeyDown','click #done':'finish','click #toggle':'onToggle'},initialize:function initialize(args){this.listenTo(this.model,{'change':this.renderButtons,'change:spoiler':this.renderSpoilerPane});this.render(args);this.pending='';this.line_count=1;this.char_count=0;var imouto=this.imouto=new common.OneeSama({callback:inject,op:state.page.get('thread'),state:[common.S_BOL,0],state2:{spoiler:0},$buffer:this.$buffer,eLinkify:main.oneeSama.eLinkify,lang:main.lang,tamashii:function tamashii(num){var section=document.query('#p'+num);section=section&&section.closest('section');if(section){var desc=num in state.mine.readAll()&&this.lang.you;return this.postRef(num,util.getNum(section),desc);}else return '<a class=\"nope\">&gt;&gt;'+num+'</a>';}});imouto.hook('spoilerTag',util.touchable_spoiler_tag);main.oneeSama.trigger('imouto',imouto);},render:function render(_ref3){var destination=_ref3.destination;var section=_ref3.section;var op=this.model.get('op');this.setElement(op?document.createElement('article'):section);this.isThread=!op;this.$buffer=$('<p/>');this.$lineBuffer=$('<p/>');this.$meta=$('<header><a class=\"nope\"><b/></a> <time/></header>');this.$input=$('<textarea/>',{name:'body',id:'trans',rows:'1',class:'themed',autocomplete:main.isMobile});this.$submit=$('<input/>',{id:'done',type:'button',value:main.lang.done});this.$subject=$('<input/>',{id:'subject',class:'themed',maxlength:state.hotConfig.SUBJECT_MAX_LENGTH,width:'80%'});this.$blockquote=$('<blockquote/>');this.$sizer=$('<pre/>').appendTo('body');this.$blockquote.append(this.$buffer,this.$lineBuffer,this.$input);this.$el.append(this.$meta,this.$blockquote,'<small/>');if(this.isThread){this.$el.append('<label for=\"subject\">'+lang.subject+': </label>',this.$subject);this.$blockquote.hide();}this.$uploadForm=this.renderUploadForm();this.$el.append(this.$uploadForm);main.oneeSama.trigger('draft',this.$el);this.renderIdentity();destination.style.display='none';if(this.isThread){destination.after(this.el);this.el.after(document.createElement('hr'));this.$subject.focus();}else {destination.before(this.el);this.resizeInput();this.$input.focus();}main.$threads.find('aside.posting').hide();this.fun();},renderIdentity:function renderIdentity(){if(this.model.get('num'))return;var parsed=common.parse_name(main.$name.val(),main.$email.val()),haveTrip=!!(parsed[1]||parsed[2]);var $b=this.$meta.find('b');if(parsed[0])$b.text(parsed[0]+' ');else $b.text(haveTrip?'':main.lang.anon);if(haveTrip)$b.append(' <code>!?</code>');main.oneeSama.trigger('fillMyName',$b);var email=main.$email.val().trim();var $tag=this.$meta.children('a').first();if(email){$tag.attr({href:'mailto:'+email,target:'_blank',class:'email'});}else $tag.removeAttr('href').removeAttr('target').attr('class','nope');},renderButtons:function renderButtons(){var attrs=this.model.attributes,allocWait=attrs.sentAllocRequest&&!attrs.num,d=attrs.uploading||allocWait;this.$submit.prop('disabled',!!d);if(attrs.uploaded)this.$submit.css({'margin-left':'0'});this.$cancel.prop('disabled',!!allocWait);this.$cancel.toggle(!!(!attrs.num||attrs.uploading));this.$imageInput.prop('disabled',!!attrs.uploading);this.$uploadStatus.html(attrs.uploadStatus);},renderSpoilerPane:function renderSpoilerPane(model,sp){var background=sp?config.MEDIA_URL+'spoil/spoil'+sp+'.png':config.MEDIA_URL+'css/ui/pane.png';this.$toggle.css('background-image','url(\"'+background+'\")');},renderUploadForm:function renderUploadForm(){var $form=$('<form method=\"post\" enctype=\"multipart/form-data\" '+'target=\"upload\"></form>');this.$cancel=$('<input/>',{type:'button',value:lang.cancel,click:$.proxy(this,'cancel')});this.$imageInput=$('<input/>',{type:'file',id:'image',name:'image',accept:config.WEBM?'imager/*;.webm':'image/*',change:$.proxy(this,'onImageChosen')});this.$toggle=$('<input/>',{type:'button',id:'toggle'});this.$uploadStatus=$('<strong/>');$form.append(this.$cancel,this.$imageInput,this.$toggle,' ',this.$uploadStatus);this.$iframe=$('<iframe/>',{src:'',name:'upload',id:'hidden-upload'}).appendTo('body');this.model.set({spoiler:0,nextSpoiler:-1});return $form;},cancel:function cancel(){if(this.model.get('uploading')){this.$iframe.remove();this.$iframe=$('<iframe></iframe>',{src:'',name:'upload',id:'hidden-upload'}).appendTo('body');this.uploadError('');this.model.set({cancelled:true});}else this.finish();},onImageChosen:function onImageChosen(){if(this.model.get('uploading')||this.model.get('uploaded'))return;if(!this.$imageInput.val()){this.model.set('uploadStatus','');return;}var extra=this.prepareUpload();for(var k in extra){$('<input type=hidden>').attr('name',k).val(extra[k]).appendTo(this.$uploadForm);}this.$uploadForm.prop('action',util.uploadURL());this.$uploadForm.submit();this.$iframe.load(function(){if(!postForm)return;var doc=this.contentWindow||this.contentDocument;if(!doc)return;try{var error=$(doc.document||doc).text();if(/legitimate imager response/.test(error))return;if(error.length<5||error.length>100)error=lang.unknownUpload;postForm.uploadError(error);}catch(e) {setTimeout(function(){postForm.uploadFallbackMessage();},500);}});this.notifyUploading();},prepareUpload:function prepareUpload(){this.model.set('uploadStatus',lang.uploading);this.$input.focus();var attrs=this.model.attributes;return {spoiler:attrs.spoiler,op:attrs.op||0};},uploadFallbackMessage:function uploadFallbackMessage(){var a=this.model.attributes,stat=a.uploadStatus;if(!a.cancelled&&a.uploading&&(!stat||stat==lang.uploading))this.model.set('uploadStatus',lang.unknownResult);},notifyUploading:function notifyUploading(){this.model.set({uploading:true,cancelled:false});this.$input.focus();},resizeInput:function resizeInput(val){if(typeof val!=='string')val=this.$input.val();this.$sizer.text(val);var size=this.$sizer.width()+common.INPUT_ROOM;size=Math.max(size,inputMinSize-this.$input.offset().left-this.$el.offset().left);this.$input.css('width',size+'px');},onInput:function onInput(val){if(val===undefined||val instanceof $.Event)val=this.$input.val();var start=this.$input[0].selectionStart,end=this.$input[0].selectionEnd;var changed=false,m,time,video;while(true){m=val.match(embed.youtube_url_re);if(!m)break;time=this.findTimeArg(m[3])||this.findTimeArg(m[1])||m[4]||'';video='>>>/watch?v='+m[2]+time;val=embedRewrite(m,video);}while(true){m=val.match(embed.youtube_short_re);if(!m)break;time=this.findTimeArg(m[2])||'';video='>>>/watch?v='+m[1]+time;val=embedRewrite(m,video);}while(true){m=val.match(embed.soundcloud_url_re);if(!m)break;var sc='>>>/soundcloud/'+m[1];val=embedRewrite(m,sc);}while(true){m=val.match(embed.pastebin_re);if(!m)break;var pbin='>>>/pastebin/'+m[1];val=embedRewrite(m,pbin);}function embedRewrite(m,rw){var old=m[0].length;var newVal=val.substr(0,m.index)+rw+val.substr(m.index+old);changed=true;if(m.index<start){var diff=old-rw.length;start-=diff;end-=diff;}return newVal;}if(changed)this.$input.val(val);var nl=val.lastIndexOf('\\n');if(nl>=0){var ok=val.substr(0,nl);val=val.substr(nl+1);this.$input.val(val);if(this.model.get('sentAllocRequest')||/[^ ]/.test(ok))this.commit(ok+'\\n');}else {m=val.split('').reverse().join('').match(/^(\\s*\\S+\\s+\\S+)\\s+(?=\\S)/);if(m){var lim=val.length-m[1].length;this.commit(val.substr(0,lim));val=val.substr(lim);start-=lim;end-=lim;this.$input.val(val);this.$input[0].setSelectionRange(start,end);}}this.$input.attr('maxlength',common.MAX_POST_CHARS-this.char_count);this.resizeInput(val);},findTimeArg:function findTimeArg(params){if(!params||params.indexOf('t=')<0)return false;params=params.split('&');for(var i=0,len=params.length;i<len;i++){var pair='#p'+params[i];if(embed.youtube_time_re.test(pair))return pair;}return false;},commit:function commit(text){var lines;if(text.indexOf('\\n')>=0){lines=text.split('\\n');this.line_count+=lines.length-1;var breach=this.line_count-common.MAX_POST_LINES+1;if(breach>0){for(var i=0;i<breach;i++){lines.pop();}text=lines.join('\\n');this.line_count=common.MAX_POST_LINES;}}var left=common.MAX_POST_CHARS-this.char_count;if(left<text.length)text=text.substr(0,left);if(!text)return;this.char_count+=text.length;var attrs=this.model.attributes;if(!attrs.num&&!attrs.sentAllocRequest){main.send([common.INSERT_POST,this.allocationMessage(text,null)]);this.model.set({sentAllocRequest:true});}else if(attrs.num)main.send(text);else this.pending+=text;if(lines){lines[0]=this.$lineBuffer.text()+lines[0];this.$lineBuffer.text(lines.pop());for(var o=0,len=lines.length;o<len;o++){this.imouto.fragment(lines[o]+'\\n');}}else {this.$lineBuffer.append(document.createTextNode(text));this.$lineBuffer[0].normalize();}},allocationMessage:function allocationMessage(text,image){var msg={nonce:main.request('nonce:create')};function opt(key,val){if(val)msg[key]=val;}opt('name',main.$name.val().trim());opt('email',main.$email.val().trim());opt('subject',this.$subject.val().trim());opt('frag',text);opt('image',image);opt('op',this.model.get('op'));return msg;},onKeyDown:function onKeyDown(event){var _this=this;main.follow(function(){switch(event.which){case 13:event.preventDefault();case 32:var input=_this.$input[0];var val=_this.$input.val();val=val.slice(0,input.selectionStart)+(event.which==13?'\\n':' ')+val.slice(input.selectionEnd);_this.onInput(val);break;default:handle_shortcut.bind(_this)(event);}});},finish:function finish(){var _this2=this;if(this.model.get('num')){this.flushPending();this.commit(this.$input.val());this.$input.remove();this.$submit.remove();if(this.$uploadForm)this.$uploadForm.remove();if(this.$iframe){this.$iframe.remove();this.$iframe=null;}this.imouto.fragment(this.$lineBuffer.text());this.$buffer.replaceWith(this.$buffer.contents());this.$lineBuffer.remove();this.$blockquote.css({'margin-left':'','padding-left':''});main.send([common.FINISH_POST]);this.preserve=true;if(this.isThread)this.$el.append(main.oneeSama.replyBox());var missing=this.imouto.allRolls.sent-this.imouto.allRolls.seen;if(missing>0){(function(){var checkAgain=undefined;(checkAgain=function(n){setTimeout(function(){if(_this2.imouto.allRolls.seen==_this2.imouto.allRolls.sent||n==0)postSM.feed('done');else checkAgain(n-1);},100);})(5);})();}else postSM.feed('done');}else postSM.feed('done');},flushPending:function flushPending(){if(this.pending){main.send(this.pending);this.pending='';}},onToggle:function onToggle(event){var attrs=this.model.attributes;if(attrs.uploading||attrs.uploaded)return;event.preventDefault();event.stopImmediatePropagation();if(attrs.spoiler){this.model.set({spoiler:0});return;}var pick=common.pick_spoiler(attrs.nextSpoiler);this.model.set({spoiler:pick.index,nextSpoiler:pick.next});},onAllocation:function onAllocation(msg){var num=msg.num;state.ownPosts[num]=num;this.model.set({num:num});this.flushPending();var header=$(main.oneeSama.header(msg));this.$meta.replaceWith(header);this.$meta=header;if(!this.isThread)this.$el.addClass('editing');this.$el.attr('id','p'+num);if(msg.image)this.insertUploaded(msg.image);if(this.$uploadForm)this.$uploadForm.append(this.$submit);else this.$blockquote.after(this.$submit);if(this.isThread){this.$subject.siblings('label').andSelf().remove();this.$blockquote.show();this.resizeInput();this.$input.focus();}window.onbeforeunload=function(){return \"You have an unfinished post.\";};},insertUploaded:function insertUploaded(info){this.renderImage(null,info);this.$imageInput.siblings('strong').andSelf().remove();this.$cancel.remove();this.$uploadForm.find('#toggle').remove();this.flushPending();this.model.set({uploading:false,uploaded:true,sentAllocRequest:true});var $img=this.$el.find('img');this.$blockquote.css({'margin-left':$img.css('margin-right'),'padding-left':$img.width()});this.resizeInput();},dispatch:function dispatch(msg){var a=msg.arg;switch(msg.t){case 'alloc':this.onImageAllocation(a);break;case 'error':this.uploadError(a);break;case 'status':this.uploadStatus(a);break;}},onImageAllocation:function onImageAllocation(msg){var attrs=this.model.attributes;if(attrs.cancelled)return;if(!attrs.num&&!attrs.sentAllocRequest){main.send([common.INSERT_POST,this.allocationMessage(null,msg)]);this.model.set({sentAllocRequest:true});}else main.send([common.INSERT_IMAGE,msg]);},uploadError:function uploadError(msg){if(this.model.get('cancelled'))return;this.model.set({uploadStatus:msg,uploading:false});if(this.$uploadForm)this.$uploadForm.find('input[name=alloc]').remove();},uploadStatus:function uploadStatus(msg){if(this.model.get('cancelled'))return;this.model.set('uploadStatus',msg);},addReference:function addReference(num,sel){var val=this.$input.val();if(/^>>\\d+$/.test(val)){this.$input.val(val+'\\n');this.onInput();val=this.$input.val();}if(sel){sel=sel.split('\\n');for(var i=0,len=sel.length;i<len;i++){sel[i]='>'+sel[i];}num+='\\n'+sel.join('\\n')+'\\n';}this.$input.val(val+'>>'+num);this.$input[0].selectionStart=this.$input.val().length;this.onInput();this.$input.focus();},remove:function remove(){if(!this.preserve){if(this.isThread)this.$el.next('hr').remove();this.$el.remove();}this.$sizer.remove();if(this.$iframe){this.$iframe.remove();this.$iframe=null;}this.stopListening();window.onbeforeunload=null;},renderImage:imager.Hidamari.renderImage,autoExpandImage:function autoExpandImage(){return this;},fun:function fun(){}});exports.ComposerView=ComposerView;function openPostBox(num){postSM.feed('new',document.query('#p'+num+' aside.posting'));}main.reply('openPostBox',openPostBox);window.addEventListener('message',function(event){var msg=event.data;if(msg!=='OK'&&postForm)postForm.uploadError(msg);},false);main.$threads.on('click','a.quote',function(e){e.preventDefault();var post=e.target.closest('article, section'),gsel=getSelection(),num=util.getNum(post);function isInside(prop){var el=gsel[prop]&&gsel[prop].parentElement;return el&&el.closest('blockquote')&&el.closest('article, section')===post;}var sel=undefined;if(isInside('baseNode')&&isInside('focusNode'))sel=gsel.toString();openPostBox(util.getNum(post.closest('section')));postForm.addReference(num,sel);});\n\n},{\"../main\":\"main\",\"./article\":13,\"./embed\":15,\"./identity\":16,\"./imager\":17}],23:[function(require,module,exports){\n'use strict';var main=require('../main');var PostCommon=require('./common');var $=main.$;var _=main._;var Backbone=main.Backbone;var util=main.util;var oneeSama=main.oneeSama;var state=main.state;module.exports=PostCommon.extend({tagName:'section',render:function render(){var attrs=this.model.attributes;this.setElement(oneeSama.section(attrs)).insertIntoDOM();var reply=util.parseDOM(oneeSama.replyBox());if(attrs.num in state.ownPosts||!!main.request('postForm'))reply.style.display='none';this.el.append(reply);this.el.nextElementSibling.remove();return this;},insertIntoDOM:function insertIntoDOM(){main.$threads[0].query('aside').after(this.el,document.createElement('hr'));this.fun();},renderLocked:function renderLocked(locked){this.el.classList[locked?'add':'remove']('locked');},remove:function remove(){this.el.nextElementSibling.remove();this.el.remove();this.stopListening();return this;},shiftReplies:function shiftReplies(postForm){var attrs=this.model.attributes;var replies=attrs.replies;var lim=state.hotConfig.get('ABBREVIATED_REPLIES'),changed=undefined;if(postForm)lim--;var len=replies.slice().length;for(var i=len;i>lim;i--){var post=state.posts.get(replies.shift());if(!post)continue;if(post.get('image'))attrs.image_omit++;attrs.omit++;changed=true;post.remove();}if(changed)this.renderOmit(attrs.omit,attrs.image_omit);},renderOmit:function renderOmit(){var omit=arguments.length<=0||arguments[0]===undefined?this.model.get('omit'):arguments[0];var image_omit=arguments.length<=1||arguments[1]===undefined?this.model.get('image_omit'):arguments[1];if(omit===0)return;var _state$page$attribute=state.page.attributes;var thread=_state$page$attribute.thread;var href=_state$page$attribute.href;this.el.query('.omit').innerHTML=oneeSama.lang.abbrev_msg(omit,this.model.get('image_omit'),thread&&href.split('?')[0]);},bumpThread:function bumpThread(){this.el.nextElementSibling.remove();this.el.remove();this.insertIntoDOM();}});\n\n},{\"../main\":\"main\",\"./common\":14}],24:[function(require,module,exports){\n'use strict';var main=require('./main');var $=main.$;var Backbone=main.Backbone;var options=main.options;var state=main.state;var _document=document;var body=_document.body;var atBottom=undefined,lockIndicator=undefined,isThread=undefined;function cacheState(){lockIndicator=document.query('#lock');isThread=!!state.posts.get('thread');}state.page.on('change',cacheState);cacheState();function checkBottom(){atBottom=body.scrollHeight-window.innerHeight<=window.scrollY;if(lockIndicator)lockIndicator.style.visibility=atBottom?'visible':'hidden';}checkBottom();document.addEventListener('scroll',checkBottom);var referenceEl=undefined;function followDOM(func){var previous=referenceDistance(),ret=func();if(atBottom&&(!document.hidden||options.get('alwaysLock')))window.scrollTo(0,body.scrollHeight);else {if(!elExists(referenceEl))return ret;var delta=topDistance(referenceEl,true)-previous;if(delta)window.scrollBy(0,delta);}return ret;}main.follow=followDOM;function elExists(el){return el&&document.contains(el);}function topDistance(el,skipCheck){var _el$getBoundingClient=el.getBoundingClientRect();var top=_el$getBoundingClient.top;if(skipCheck||top>=0&&top<window.innerHeight)return top;return null;}function referenceDistance(){if(elExists(referenceEl)){var bounds=topDistance(referenceEl);if(bounds!==null)return bounds;}var _arr=['article','section','threads'];for(var _i=0;_i<_arr.length;_i++){var selector=_arr[_i];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=main.$threads[0].queryAll(selector)[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var el=_step.value;var bounds=topDistance(el);if(bounds!==null){referenceEl=el;return bounds;}}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}}}function aboveBanner(){if(!/^#p\\d+$/.test(location.hash))return;var $anchor=$(location.hash);if(!$anchor.length)return;$(window).scrollTop($anchor.offset().top-$('#banner').height());}main.reply('scroll:aboveBanner',aboveBanner);window.onload=aboveBanner;\n\n},{\"./main\":\"main\"}],25:[function(require,module,exports){\n'use strict';Object.defineProperty(exports,\"__esModule\",{value:true});exports.links=exports.posts=exports.mine=exports.ownPosts=exports.syncs=exports.page=undefined;exports.read=read;exports.addLinks=addLinks;var _main=require('main');function read(href){var state={board:href.match(/\\/([a-zA-Z0-9]+?)\\//)[1],thread:href.match(/\\/(\\d+)(:?#\\d+)?(?:[\\?&]\\w+=\\w+)*$/),lastN:href.match(/[\\?&]last=(\\d+)/)};var _arr=['thread','lastN'];for(var _i=0;_i<_arr.length;_i++){var key=_arr[_i];var val=state[key];state[key]=val?parseInt(val[1]):0;}return state;}var page=exports.page=new _main.Backbone.Model(read(location.href));var syncs=exports.syncs={};var ownPosts=exports.ownPosts={};var mine=exports.mine=new main.Memory('mine',2,true);var posts=exports.posts=new _main.Backbone.Collection();main.on('state:clear',function(){main.$threads.innerHTML='';models.each(function(model){return model.dispatch('stopListening');});posts.reset();exports.syncs={};main.request('massExpander:unset');});var links=exports.links={};function addLinks(addition){if(addition){_main._.extend(links,addition);}}\n\n},{\"main\":\"main\"}],26:[function(require,module,exports){\n'use strict';var main=require('./main');var $=main.$;var Backbone=main.Backbone;var common=main.common;var oneeSama=main.oneeSama;var options=main.options;var state=main.state;var serverTimeOffset=0;main.dispatcher[common.GET_TIME]=function(msg){if(!msg[0])return;serverTimeOffset=msg[0]-Date.now();};main.reply('time:offset',function(){return serverTimeOffset;});var renderTimer=undefined;function batcTimeRender(source){var rtime=arguments.length<=1||arguments[1]===undefined?options.get('relativeTime'):arguments[1];state.posts.each(function(model){return model.dispatch('renderTime');});if(renderTimer)clearTimeout(renderTimer);if(rtime)renderTimer=setTimeout(batcTimeRender,60000);}main.reply('time:render',batcTimeRender);options.on('change:relativeTime',batcTimeRender);function timer_from_el(el){if(!serverTimeOffset)return;el.classList.add('timerTicking');var start=el.getAttribute('start'),end=el.getAttribute('end'),maxh=common.pad(el.getAttribute('hour')),maxm=common.pad(el.getAttribute('min')),maxs=common.pad(el.getAttribute('sec'));(function moumouikkai(){if(!document.body.contains(el))return;var now=common.serverTime();if(now>end)return el.textContent=main.lang.finished;if(start>now){var countdown=Math.round((start-now)/1000);if(countdown===10)main.request('time:syncwatch');el.textContent='Countdown: '+countdown;return setTimeout(moumouikkai,1000);}var diff=now-start;var hour=Math.floor(diff/1000/60/60);diff-=hour*1000*60*60;var min=Math.floor(diff/1000/60);diff-=min*1000*60;var sec=Math.floor(diff/1000);el.textContent=common.pad(hour)+\":\"+common.pad(min)+\":\"+common.pad(sec)+\" / \"+maxh+\":\"+maxm+\":\"+maxs;return setTimeout(moumouikkai,1000);})();}function mouikkai(){setInterval(function(){var els=document.getElementsByTagName('syncwatch');for(var i=0;i<els.length;i++){if(els[i].classList.contains('timerTicking'))continue;timer_from_el(els[i]);}},1000);}main.defer(batcTimeRender).defer(mouikkai).defer(function(){var seconds=undefined;var el=document.getElementById('UTCClock').firstChild;el.addEventListener('click',handler);function handler(){seconds=true;this.removeAttribute('title');this.style.cursor='default';this.removeEventListener('click',handler);render();}function render(){if(!serverTimeOffset)return setTimeout(render,1000);el.innerHTML=oneeSama.readableUTCTime(new Date(common.serverTime()),seconds);setTimeout(render,seconds?1000:60000);}render();});\n\n},{\"./main\":\"main\"}],27:[function(require,module,exports){\n'use strict';var _templateObject=_taggedTemplateLiteral(['<syncwatch ','>\\n\\t\\t\\tsyncwatch\\n\\t\\t</syncwatch>'],['<syncwatch ','>\\n\\t\\t\\tsyncwatch\\n\\t\\t</syncwatch>']),_templateObject2=_taggedTemplateLiteral(['<span class=\"act\">\\n\\t\\t\\t<a href=\"','\"\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t>\\n\\t\\t\\t\\t','\\n\\t\\t\\t</a>\\n\\t\\t</span>'],['<span class=\"act\">\\n\\t\\t\\t<a href=\"','\"\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t>\\n\\t\\t\\t\\t','\\n\\t\\t\\t</a>\\n\\t\\t</span>']);Object.defineProperty(exports,\"__esModule\",{value:true});exports.thumbStyles=undefined;exports.touchable_spoiler_tag=touchable_spoiler_tag;exports.imageUploadURL=imageUploadURL;exports.getNum=getNum;exports.getID=getID;exports.getModel=getModel;exports.parseEls=parseEls;exports.parseEl=parseEl;exports.listener=listener;exports.once=once;exports.outerWidth=outerWidth;exports.isSage=isSage;exports.serverTime=serverTime;exports.readable_dice=readable_dice;exports.pick_spoiler=pick_spoiler;exports.readable_filesize=readable_filesize;exports.pad=pad;exports.action_link_html=action_link_html;exports.resonableLastN=resonableLastN;exports.parse_name=parse_name;exports.randomID=randomID;exports.parseHTML=parseHTML;exports.commaList=commaList;exports.checkAuth=checkAuth;var _main=require('main');function _toArray(arr){return Array.isArray(arr)?arr:Array.from(arr);}function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}function touchable_spoiler_tag(del){del.html='<del onclick=\"void(0)\">';}function imageUploadURL(){return (_main.config.hard.HTTP.upload||'../upload/')+'?id='+_main.state.page.get('connID');}function getNum(el){if(!el){return 0;}return parseInt(el.getAttribute('id').slice(1),10);}function getID(el){if(!el){return 0;}return getNum(el.closest('article, section'));}function getModel(el){var id=getID(el);if(!id)return null;return _main.state.posts.get(id);}function parseEls(string){var el=document.createElement('div');el.innerHTML=string;var children=el.childNodes;return Array.from(children);}function parseEl(string){var el=document.createElement('div');el.innerHTML=string;return el.firstChild;}function listener(el,type,selector,handler){el.addEventListener(type,function(event){if(event.target.matches(selector))handler.call(this,event);});}function once(el,type,handler){el.addEventListener(type,function(event){handler.call(this,event);el.removeEventListener(type,handler);});}function outerWidth(el){var style=getComputedStyle(el),props=['marginLeft','marginRight','paddingLeft','paddingRight'];var width=0;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=props[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var prop=_step.value;width+=parseInt(style[prop]);}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}return width;}function isSage(email){return email&&email.trim()==='sage';}var cachedOffset=undefined;function serverTime(){var d=Date.now();if(imports.isNode)return d;if(!cachedOffset)cachedOffset=imports.main.request('time:offset');return d+cachedOffset;}function readable_dice(bit,dice){var inner=undefined;switch(bit){case '#flip':inner=(dice[2]==2).toString();break;case '#8ball':inner=imports.hotConfig.EIGHT_BALL[dice[2]-1];break;case '#pyu':case '#pcount':case '#q':inner=dice[0];break;}if(inner!==undefined)return _main._.escape(bit+' ('+inner+')');if(/^#sw/.test(bit))return readableSyncwatch(dice[0]);return readableRegularDice(bit,dice);}function readableSyncwatch(dice){dice.class='embed';return parseHTML(_templateObject,dice);}function readableRegularDice(bit,_ref){var _ref2=_toArray(_ref);var max=_ref2[0];var bias=_ref2[1];var rolls=_ref2.slice(2);bit+=' (';var eq=rolls.length>1||bias;if(eq)bit+=rolls.join(', ');if(bias)bit+=bias<0?' - '+-bias:' + '+bias;var sum=bias;var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=rolls[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var roll=_step2.value;sum+=roll;}}catch(err) {_didIteratorError2=true;_iteratorError2=err;}finally {try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally {if(_didIteratorError2){throw _iteratorError2;}}}return bit+(eq?' = ':'')+sum+')';}function pick_spoiler(metaIndex){var imgs=imports.config.SPOILER_IMAGES,n=imgs.length;var i=undefined;if(metaIndex<0)i=Math.floor(Math.random()*n);else i=metaIndex%n;return {index:imgs[i],next:(i+1)%n};}var thumbStyles=exports.thumbStyles=['small','sharp','hide'];function readable_filesize(size){if(size<1024)return size+' B';if(size<1048576)return Math.round(size/1024)+' KB';size=Math.round(size/104857.6).toString();return size.slice(0,-1)+'.'+size.slice(-1)+' MB';}function pad(n){return (n<10?'0':'')+n;}function action_link_html(href,name,id,cls){return parseHTML(_templateObject2,href,id&&' id=\"'+id+'\"',cls&&' class=\"'+cls+'\"',name);}function resonableLastN(n){return Number.isInteger(n)&&n<=500;}function parse_name(name){var tripcode='',secure='';var hash=name.indexOf('#');if(hash>=0){tripcode=name.substr(hash+1);name=name.substr(0,hash);hash=tripcode.indexOf('#');if(hash>=0){secure=_main._.escape(tripcode.substr(hash+1));tripcode=tripcode.substr(0,hash);}tripcode=_main._.escape(tripcode);}name=name.trim().replace(imports.hotConfig.EXCLUDE_REGEXP,'');return [name.substr(0,100),tripcode.substr(0,128),secure.substr(0,128)];}function randomID(len){var id='';for(var i=0;i<len;i++){var char=(Math.random()*36).toString(36)[0];if(Math.random()<0.5)char=char.toUpperCase();id+=char;}return id;}function parseHTML(callSite){if(typeof callSite==='string')return formatHTML(callSite);if(typeof callSite==='function')return formatHTML(callSite(args));var len=arguments.length;var args=[];for(var i=1;i<len;i++){args[i-1]=arguments[i];}var output=callSite.slice(0,len).map(function(text,i){var arg=args[i-1];var result=undefined;if(i===0||!arg&&arg!==0)result='';else if(arg instanceof Object)result=elementAttributes(arg);else result=arg;return result+text;}).join('');return formatHTML(output);}function formatHTML(str){var size=-1;return str.replace(/\\n(\\s+)/g,function(m,m1){if(size<0)size=m1.replace(/\\t/g,'    ').length;return m1.slice(Math.min(m1.length,size));}).replace(/^\\s*\\n/gm,'');}function elementAttributes(attrs){var html='';for(var key in attrs){html+=' ';var val=attrs[key];if(val===true)html+=key;else if(val||val===0)html+=key+'=\"'+val+'\"';}return html;}function commaList(items){var html='';var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=items[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var item=_step3.value;if(!item&&item!==0)continue;if(html)html+=', ';html+=item;}}catch(err) {_didIteratorError3=true;_iteratorError3=err;}finally {try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return();}}finally {if(_didIteratorError3){throw _iteratorError3;}}}return html;}function checkAuth(action){var cls=_main.config.staff.classes[main.ident&&main.ident.auth];return cls&&!!cls.rights[action];}\n\n},{\"main\":\"main\"}],\"main\":[function(require,module,exports){\n'use strict';var _templateObject=_taggedTemplateLiteral(['<style>\\n\\t\\t.locked:after {\\n\\t\\t\\tcontent: \"','\";\\n\\t\\t}\\n\\t\\t.locked > header nav:after {\\n\\t\\t\\tcontent: \" (',')\";\\n\\t\\t}\\n\\t</style>'],['<style>\\n\\t\\t.locked:after {\\n\\t\\t\\tcontent: \"','\";\\n\\t\\t}\\n\\t\\t.locked > header nav:after {\\n\\t\\t\\tcontent: \" (',')\";\\n\\t\\t}\\n\\t</style>']);var _fsm=require('./fsm');var _fsm2=_interopRequireDefault(_fsm);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}var _=require('underscore'),Backbone=require('backbone'),Cookie=require('js-cookie'),radio=require('backbone.radio');require('core-js');require('dom4');require('backbone.nativeview');Backbone.View=Backbone.NativeView;var main=module.exports=radio.channel('main');_.extend(main,{_:_,Backbone:Backbone,Cookie:Cookie,FSM:_fsm2.default,$script:require('scriptjs'),SockJS:require('sockjs-client'),_deferred:[],defer:function defer(func){main._deferred.push(func);return main;},execDefered:function execDefered(){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this._deferred[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var func=_step.value;func();}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}},dispatcher:{}});_.extend(main,{config:config,configHash:configHash,clientHash:clientHash,isMobile:isMobile});var cookieVersion=3;if(localStorage.cookieVersion!=cookieVersion){for(var cookie in Cookie.get()){var paths=main.config.boards.enabled.slice();paths.push('');var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=paths[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var path=_step2.value;Cookie.remove(cookie,{path:path});}}catch(err) {_didIteratorError2=true;_iteratorError2=err;}finally {try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally {if(_didIteratorError2){throw _iteratorError2;}}}}localStorage.cookieVersion=cookieVersion;}if(/[&\\?]debug=true/.test(location.href))main.config.hard.debug=true;if(main.config.hard.debug){radio.DEBUG=true;window.Backbone=Backbone;radio.tuneIn('main');}main.send=main.request.bind(main,'send');main.Memory=require('./memory');var lang=main.lang=require('lang'),state=main.state=require('./state'),util=main.util=require('./util');main.options=require('./options');main.scroll=require('./scroll');state.page.set('tabID',common.randomID(32));document.head.appendChild(util.parseDOM(common.parseHTML(_templateObject,lang.thread_locked,lang.locked)));_.extend(main,{$threads:document.query('threads'),$name:document.query('input[name=name]'),$email:document.query('input[name=email]'),connSM:new _fsm2.default('load'),postSM:new _fsm2.default('none')});_.extend(main,{loop:require('./loop'),time:require('./time'),amusement:require('./amusement')});main.posts=require('./posts');main.Extract=require('./extract');main.client=require('./client');main.conection=require('./connection');_.extend(main,{history:require('./history'),hide:require('./hide')});main.execDefered();main.request('loading:hide');\n\n},{\"./amusement\":1,\"./client\":2,\"./connection\":3,\"./extract\":4,\"./fsm\":5,\"./hide\":6,\"./history\":7,\"./loop\":8,\"./memory\":9,\"./options\":10,\"./posts\":18,\"./scroll\":24,\"./state\":25,\"./time\":26,\"./util\":27,\"backbone\":undefined,\"backbone.nativeview\":undefined,\"backbone.radio\":undefined,\"core-js\":undefined,\"dom4\":undefined,\"js-cookie\":undefined,\"lang\":undefined,\"scriptjs\":undefined,\"sockjs-client\":undefined,\"underscore\":undefined}]},{},[\"main\"])\n\n","/*\n * Dice rolls and fun JS injections\n */\n\nconst main = require('./main'),\n\t{$, common, state, oneeSama} = main;\n\n// Render dice rolls and other hash commands\noneeSama.hook('imouto', function (imouto) {\n\timouto.queueRoll = function (bit) {\n\t\tconst number = this.allRolls.sent++;\n\t\tlet info = this.allRolls[number];\n\t\tif (!info)\n\t\t\tinfo = this.allRolls[number] = {};\n\t\tinfo.bit = bit;\n\t\tinfo.$tag = $(this.callback('<strong>'));\n\t\tthis.strong = true;\n\t\tthis.callback(info.dice ? common.readable_dice(bit, info.dice) : bit);\n\t\tthis.strong = false;\n\t\tthis.callback('</strong>');\n\t};\n\timouto.allRolls = {sent: 0, seen: 0};\n});\n\n// Handle dice in the postForm\noneeSama.hook('insertOwnPost', ({dice}) => {\n\tlet postForm = main.request('postForm');\n\tif (!postForm || !postForm.imouto || !dice)\n\t\treturn;\n\tlet rolls = postForm.imouto.allRolls;\n\tfor (let i = 0, lim = dice.length; i < lim; i++) {\n\t\tconst n = rolls.seen++;\n\t\tlet info = rolls[n];\n\t\tif (!info)\n\t\t\tinfo = rolls[n] = {};\n\t\tinfo.dice = dice[i];\n\t\tif (info.$tag) {\n\t\t\tconst r = common.readable_dice(info.bit, info.dice);\n\t\t\tinfo.$tag.html(r);\n\t\t}\n\t}\n});\n\n// Execute server-sent JS in fun threads\nmain.dispatcher[common.EXECUTE_JS] = ([js]) => {\n\ttry {\n\t\teval(js);\n\t}\n\tcatch (e) {\n\t\tconsole.error(e);\n\t}\n};\n","/*\n * Handles the brunt of the post-related websocket calls\n */\n\nconst main = require('./main'),\n\t{_, common, dispatcher, util, posts, state} = main;\n\nconst online = document.query('#onlineCount');\n\n_.extend(dispatcher, {\n\t[common.INSERT_POST](message) {\n\t\tlet [msg, bump] = message;\n\t\tbump = bump && state.page.get('live');\n\t\tconst isThread = !msg.op,\n\t\t\t{num} = msg;\n\t\tif (isThread)\n\t\t\tstate.syncs[num] = 1;\n\t\tmsg.editing = true;\n\n\t\t// Did I create this post?\n\t\tlet el;\n\t\tconst {nonce} = msg;\n\t\tdelete msg.nonce;\n\t\tconst myNonce = main.request('nonce:get')[nonce];\n\t\tif (myNonce && myNonce.tab === state.page.get('tabID')) {\n\t\t\t// posted in this tab; transform placeholder\n\t\t\tstate.ownPosts[num] = true;\n\t\t\tmain.oneeSama.trigger('insertOwnPost', msg);\n\t\t\tmain.postSM.feed('alloc', msg);\n\t\t\tbump = false;\n\t\t\tmain.request('nonce:destroy', nonce);\n\n\t\t\t// if we've already made a placeholder for this post, use it\n\t\t\tconst postForm = main.request('postForm');\n\t\t\tif (postForm && postForm.el)\n\t\t\t\tel = postForm.el;\n\t\t}\n\n\t\t// Add to my post set. Separate `if`, so posts form other tabs also\n\t\t// register.\n\t\tif (myNonce) {\n\t\t\tmsg.mine = true;\n\t\t\tstate.mine.write(num);\n\t\t}\n\t\tstate.addLinks(msg.links);\n\n\t\t// Create model\n\t\tconst model = new posts.models[isThread ? 'Thread' : 'Post'](msg);\n\t\tconst view = new posts[isThread ? 'Section' : 'Article']({model, el,\n\t\t\tid: num});\n\t\tif (!el)\n\t\t\tview.render().insertIntoDOM();\n\t\tview.clientInit();\n\n\t\tcheckRepliedToMe(msg.links, num);\n\t\tmain.request('post:inserted', model);\n\n\t\tif (isThread)\n\t\t\treturn;\n\t\tconst parent = state.posts.get(msg.op);\n\t\tif (!parent)\n\t\t\treturn;\n\t\tparent.get('replies').push(num);\n\t\tif (state.page.get('thread'))\n\t\t\treturn;\n\t\tparent.dispatch('shiftReplies');\n\n\t\t// Bump thread to page top\n\t\tif (bump)\n\t\t\tparent.dispatch('bumpThread');\n\t},\n\t[common.INSERT_IMAGE](msg) {\n\t\tconst [num, img] = msg;\n\n\t\t// Did I just upload this?\n\t\tconst postModel = main.request('postModel'),\n\t\t\ttoPostForm = postModel && postModel.get('num') == num;\n\t\tif (toPostForm)\n\t\t\tmain.request('postForm').insertUploaded(img);\n\n\t\t// If the image gets inseted into the postForm, we don't need the\n\t\t// generic model to fire a separate image render\n\t\tmodelHandler(num, model => model.setImage(img, toPostForm));\n\t},\n\t[common.UPDATE_POST]([num, frag, extra = {}]) {\n\t\tmodelHandler(num, model => {\n\t\t\tstate.addLinks(extra.links);\n\t\t\tmodel.update(frag, extra);\n\t\t\tcheckRepliedToMe(extra.links, num);\n\n\t\t\t// Am I updating my own post?\n\t\t\tif (num in state.ownPosts)\n\t\t\t\tmain.oneeSama.trigger('insertOwnPost', extra);\n\t\t\telse\n\t\t\t\tmodel.dispatch('updateBody', frag);\n\t\t});\n\t},\n\t[common.FINISH_POST](msg) {\n\t\tconst [num] = msg;\n\t\tdelete state.ownPosts[num];\n\t\tmodelHandler(num, function (model) {\n\t\t\t// No change event listener to avoid extra overhead\n\t\t\tmodel.set('editing', false);\n\t\t\tmodel.dispatch('renderEditing', false);\n\t\t});\n\t},\n\t[common.DELETE_POSTS](msg) {\n\t\tmodelHandler(msg[0], model => model.deletePost(msg[1]));\n\t},\n\t[common.LOCK_THREAD](msg) {\n\t\tmodelHandler(msg[0], model => model.toggleLocked(true, msg[1]));\n\t},\n\t[common.UNLOCK_THREAD](msg) {\n\t\tmodelHandler(msg[0], model => model.toggleLocked(false, msg[1]));\n\t},\n\t[common.DELETE_IMAGES](msg) {\n\t\tmodelHandler(msg[0], model => model.removeImage(msg[1]));\n\t},\n\t[common.SPOILER_IMAGES](msg) {\n\t\tmodelHandler(msg[0], model => model.setSpoiler(msg[1], msg[2]));\n\t},\n\t[common.BAN](msg) {\n\t\t// Only a 0 is passed to unauthenticated clients, if the ban was not\n\t\t// set to be displayed publicly. Otherwise a post number. A side\n\t\t// effect of complying to the existing pub/sub spec. Authenticated\n\t\t// staff receive either a post number or 0 and detailed ban information.\n\t\tlet [num, info] = msg;\n\t\tif (!num) {\n\t\t\tif (!info)\n\t\t\t\treturn;\n\t\t\tinfo = JSON.parse(info);\n\t\t\tnum = info.num;\n\t\t}\n\t\tmodelHandler(num, model => model.setBan(num, info));\n\t},\n\t[common.BACKLINK](msg) {\n\t\tmodelHandler(msg[0], model => model.addBacklink(msg[1], msg[2]));\n\t},\n\t[common.ONLINE_COUNT](msg) {\n\t\tonline.textContent = '['+msg[0]+']';\n\t},\n\t// Sync settings with server\n\t[common.HOT_INJECTION](msg) {\n\t\tconst [force, hash, hotConfig] = msg;\n\n\t\t// Request new varibles, if hashes don't match\n\t\tif (!force && hash !== state.configHash)\n\t\t\tmain.send([common.HOT_INJECTION, true]);\n\t\t// Update variables and hash\n\t\telse if (force) {\n\t\t\tstate.configHash = hash;\n\t\t\tstate.hotConfig.set(hotConfig);\n\t\t}\n\t}\n});\n\ndispatcher[common.SYNCHRONIZE] = main.connSM.feeder('sync');\ndispatcher[common.INVALID] = main.connSM.feeder('invalid');\n\n// Check if new posts links to one of my posts\nfunction checkRepliedToMe(links, sourceNum) {\n\tif (!links)\n\t\treturn;\n\tconst mine = state.mine.readAll();\n\tfor (let num in links) {\n\t\tif (num in mine)\n\t\t\tmain.request('repliedToMe', sourceNum);\n\t}\n}\n\n// Find model and pass it to function, if it exists\nfunction modelHandler(num, func) {\n\tconst model = state.posts.get(num);\n\tif (model)\n\t\tfunc(model);\n}\n\n// Make the text spoilers toggle revealing on click\nutil.listener(document, 'click', 'del', function (event) {\n\tif (event.spoilt)\n\t\treturn;\n\tevent.spoilt = true;\n\tevent.target.classList.toggle('reveal');\n});\n","/*\n * Websocket controller and connection notifier\n */\n\nconst main = require('./main'),\n\t{_, common, config, connSM, state, SockJS} = main,\n\tlang = main.lang.sync;\n\nlet socket, attempts, attemptTimer;\n\nfunction send(msg) {\n\t// need deferral or reporting on these lost messages...\n\tif (connSM.state != 'synced' && connSM.state != 'syncing')\n\t\treturn;\n\tif (socket.readyState != SockJS.OPEN) {\n\t\tif (console)\n\t\t\tconsole.warn(\"Attempting to send while socket closed\");\n\t\treturn;\n\t}\n\n\tmsg = JSON.stringify(msg);\n\tif (config.DEBUG)\n\t\tconsole.log('<', msg);\n\tsocket.send(msg);\n}\nmain.reply('send', send);\n\nfunction on_message(e) {\n\tif (config.DEBUG)\n\t\tconsole.log('>', e.data);\n\n\tconst msg = JSON.parse(e.data)[0],\n\t\top = msg.shift(),\n\t\ttype = msg.shift(),\n\t\tisPubSub = common.is_pubsub(type);\n\n\tif (isPubSub && connSM.state === 'locked')\n\t\treturn;\n\n\t// Some handlers are optional and/or dynamic. Ignore them silently.\n\tconst handler = main.dispatcher[type];\n\tif (!handler)\n\t\treturn;\n\tif (isPubSub && op in state.syncs)\n\t\tstate.syncs[op]++;\n\tmain.follow(() => handler(msg, op));\n}\n\nconst sync = document.getElementById('sync');\nfunction sync_status(msg) {\n\tsync.textContent = msg;\n}\n\nconnSM.act('load + start -> conn', function () {\n\tsync_status(lang.connecting);\n\tattempts = 0;\n\tconnect();\n});\n\nfunction connect() {\n\tif (socket) {\n\t\tsocket.onclose = null;\n\t\tsocket.onmessage = null;\n\t}\n\tif (window.location.protocol == 'file:') {\n\t\tconsole.log(\"Page downloaded locally; refusing to sync.\");\n\t\treturn;\n\t}\n\tsocket = new_socket();\n\tsocket.onopen = connSM.feeder('open');\n\tsocket.onclose = connSM.feeder('close');\n\tsocket.onmessage = on_message;\n\tif (config.DEBUG)\n\t\twindow.socket = socket;\n}\n\nfunction new_socket() {\n\tconst transports = ['xdr-streaming', 'xhr-streaming', 'iframe-eventsource',\n\t\t'iframe-htmlfile', 'xdr-polling', 'xhr-polling', 'iframe-xhr-polling',\n\t\t'jsonp-polling'];\n\tif (config.USE_WEBSOCKETS)\n\t\ttransports.unshift('websocket');\n\treturn new SockJS(config.SOCKET_URL || config.SOCKET_PATH, null, {\n\t\ttransports\n\t});\n}\n\nconnSM.act('conn, reconn + open -> syncing', () => {\n\tsync_status(lang.syncing);\n\tconst connID = common.randomID(32),\n\t\t{page} = state;\n\tpage.set('connID', connID);\n\tsend([common.SYNCHRONIZE, connID, page.get('board'), state.syncs,\n\t\tpage.get('live'), document.cookie]);\n});\n\nconnSM.act('syncing + sync -> synced', function () {\n\tsync_status(lang.synced);\n\tattemptTimer = setTimeout(function () {\n\t\tattemptTimer = 0;\n\t\treset_attempts();\n\t}, 10000);\n});\n\nfunction reset_attempts() {\n\tif (attemptTimer) {\n\t\tclearTimeout(attemptTimer);\n\t\tattemptTimer = 0;\n\t}\n\tattempts = 0;\n}\n\n// Prevent pub/sub mesages from being handled\nconnSM.act('synced, syncing + lock -> locked');\nconnSM.act('locked + unlock -> synced');\nmain.reply('connection:lock', () => send([common.DESYNC]), connSM.feed('lock'));\nmain.reply('connection:unlock', msg => send(msg), connSM.feed('unlock'));\n\nconnSM.act('* + close -> dropped',  error => {\n\tif (socket) {\n\t\tsocket.onclose = null;\n\t\tsocket.onmessage = null;\n\t}\n\tif (config.DEBUG)\n\t\tconsole.error('E:', error);\n\tif (attemptTimer) {\n\t\tclearTimeout(attemptTimer);\n\t\tattemptTimer = 0;\n\t}\n\tsync_status(lang.dropped);\n\n\t// Wait maxes out at ~1min\n\tconst wait = 500 * Math.pow(1.5, Math.min(Math.floor(++attempts / 2), 12));\n\tsetTimeout(connSM.feeder('retry'), wait);\n});\n\nconnSM.act('dropped + retry -> reconn', function () {\n\tconnect();\n\t/* Don't show this immediately so we don't thrash on network loss */\n\tsetTimeout(function () {\n\t\tif (connSM.state == 'reconn')\n\t\t\tsync_status(lang.reconnecting);\n\t}, 100);\n});\n\nconnSM.act('* + invalid, desynced + close -> desynced', msg => {\n\tmsg = (msg && msg[0]) ? 'Out of sync: ' + msg[0] : 'Out of sync';\n\tsync_status(msg);\n\tif (attemptTimer) {\n\t\tclearTimeout(attemptTimer);\n\t\tattemptTimer = 0;\n\t}\n\tsocket.onclose = null;\n\tsocket.onmessage = null;\n\tsocket.close();\n\tsocket = null;\n\tif (config.DEBUG)\n\t\twindow.socket = null;\n});\n\nfunction window_focused() {\n\tswitch (connSM.state) {\n\t\tcase 'desynced':\n\t\t\treturn;\n\t\t// might have just been suspended;\n\t\t// try to get our FSM up to date if possible\n\t\tcase 'synced':\n\t\tcase 'syncing':\n\t\tcase 'conn':\n\t\t\tconst rs = socket.readyState;\n\t\t\tif (rs != SockJS.OPEN && rs != SockJS.CONNECTING) {\n\t\t\t\tconnSM.feed('close');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\telse if (navigator.onLine === false) {\n\t\t\t\tconnSM.feed('close');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tbreak;\n\t}\n\tconnSM.feed('retry');\n}\n\n// Connect to server\nconnSM.feed('start');\n\n// Check for connectivity each time tab visibility changes to visible\n// A bit of an overhead, but should prevent unregistered disconnects,\n// especially on mobile.\ndocument.addEventListener('visibilitychange', e => {\n\tif (e.target.hidden)\n\t\treturn;\n\tsetTimeout(window_focused, 20);\n});\nwindow.addEventListener('online', () => reset_attempts(), connSM.feed('retry'));\nwindow.addEventListener('offline', connSM.feeder('close'));\n","/*\n * Extact model data from the thread tree HTML and populate models and views\n */\n\nconst main = require('./main'),\n\t{_, util, options, state, posts} = main;\n\nclass Extract {\n\tconstructor(catalog) {\n\t\tconst el = main.$threads[0];\n\n\t\t// Read serialised model data\n\t\tconst json = JSON.parse(document.getElementById('postData').innerHTML);\n\t\tmain.request('notify:title', json.title);\n\n\t\t// We don't need models on catalog pages\n\t\tif (catalog)\n\t\t\treturn;\n\n\t\tconst mine = this.mine = state.mine.readAll(),\n\t\t\tposts = this.posts = json.posts;\n\t\tthis.extractReplies(el);\n\t\tthis.extractThreads(el);\n\n\t\tstate.addLinks(json.links);\n\t\t// Forward posts that replied to my post\n\t\tfor (let post in posts) {\n\t\t\tconst links = posts[post].links;\n\t\t\tif (!links)\n\t\t\t\tcontinue;\n\t\t\tfor (let num in links) {\n\t\t\t\tif (num in mine)\n\t\t\t\t\tmain.request('repliedToMe', posts[post].num);\n\t\t\t}\n\t\t}\n\n\t\t// Apply various client-only DOM modifications\n\t\tif (options.get('anonymise'))\n\t\t\tmain.request('loop:anonymise');\n\t\tmain.request('time:render');\n\t}\n\textractReplies(el) {\n\t\tlet articles = el.getElementsByTagName('article');\n\t\tfor (let i = 0, l = articles.length; i < l; i++) {\n\t\t\tlet article = articles[i];\n\t\t\tnew posts.Article({\n\t\t\t\tmodel: new posts.models.Post(this.extractModel(article)),\n\t\t\t\tel: article\n\t\t\t});\n\t\t}\n\t}\n\textractThreads(el) {\n\t\tlet sections = el.getElementsByTagName('section');\n\t\tfor (let i = 0; i < sections.length ; i++) {\n\t\t\tlet section = sections[i];\n\t\t\tconst model = this.extractModel(section);\n\t\t\tnew posts.Section({\n\t\t\t\tmodel: new posts.models.Thread(model),\n\t\t\t\tel: section\n\t\t\t})\n\t\t\t\t .renderOmit();\n\t\t\t// Read the sync ID of the thread. Used later for syncronising\n\t\t\t// with the server.\n\t\t\tstate.syncs[model.num] = model.hctr;\n\t\t}\n\t}\n\textractModel(el) {\n\t\tlet info = this.posts[util.getNum(el)];\n\t\t// Did I make this post?\n\t\tif (info.num in this.mine)\n\t\t\tinfo.mine = true;\n\t\treturn info;\n\t}\n}\nmodule.exports = Extract;\n\n// Initial extraction. No need to defer, as we actually want it to hit ASAP.\nnew Extract(state.page.get('catalog'));\n","3/**\n * Finite State Machine\n */\nexport default class FSM {\n    /**\n     * Create a new finite state machine\n     * @param {string} start - Initial state\n     */\n    constructor(start) {\n        this.state = start\n        this.spec = {\n            acts: {},\n            ons: {},\n            wilds: {},\n            preflights: {}\n        }\n    }\n\n    /**\n     * Clone the current FSM\n     * @returns {FSM}\n     */\n    clone() {\n        const second = new FSM(this.state)\n        second.spec = this.spec\n        return second\n    }\n\n    /**\n     * Assign a handler to be execute on arrival to a new state\n     * @param {string} key - Target state\n     * @param {function} f - Handler\n     */\n    on(key, f) {\n        const ons = this.spec.ons[key]\n        if (ons) {\n            ons.push(f)\n        } else {\n            this.spec.ons[key] = [f]\n        }\n    }\n\n    /**\n     * Assign sanity check to perform before transition to a new state\n     * @param {string} key - Target state\n     * @param {function} f - Handler\n     */\n    preflight(key, f) {\n        const pres = this.spec.preflights[key]\n        if (pres) {\n            pres.push(f)\n        } else {\n            this.spec.preflights[key] = [f]\n        }\n    }\n\n    /**\n     * Specify transition and an optional handler to execute on it\n     * @param {string} trans_spec - Transition specification\n     * @param {function=} on_func - Handler\n     */\n    act(trans_spec, on_func) {\n        const halves = trans_spec.split('->')\n        if (halves.length != 2) {\n            throw new Error(\"Bad FSM spec: \" + trans_spec)\n        }\n        const parts = halves[0].split(','),\n            dest = halves[1].match(/^\\s*(\\w+)\\s*$/)[1]\n        let tok\n        for (let i = parts.length - 1; i >= 0; i--) {\n            const part = parts[i],\n                m = part.match(/^\\s*(\\*|\\w+)\\s*(?:\\+\\s*(\\w+)\\s*)?$/)\n            if (!m) {\n                throw new Error(\"Bad FSM spec portion: \" + part)\n            }\n            if (m[2]) {\n                tok = m[2]\n            }\n            if (!tok) {\n                throw new Error(\"Tokenless FSM action: \" + part)\n            }\n            const src = m[1]\n            if (src == '*') {\n                this.spec.wilds[tok] = dest\n            } else {\n                let acts = this.spec.acts[src]\n                if (!acts) {\n                    this.spec.acts[src] = acts = {}\n                }\n                acts[tok] = dest\n            }\n        }\n        if (on_func) {\n            this.on(dest, on_func)\n        }\n    }\n\n    /**\n     * Transition the FSM to a new state\n     * @param {string} ev - Target state\n     * @param {*} param - Argument for the handler functions\n     * @returns {bool} - Passed preflight sanity check, if any\n     */\n    feed(ev, param) {\n        const {spec} = this,\n            from = this.state,\n            acts = spec.acts[from],\n            to = (acts && acts[ev]) || spec.wilds[ev]\n        if (to && from != to) {\n            const ps = spec.preflights[to]\n            for (let i = 0; ps && i < ps.length; i++) {\n                if (!ps[i].call(this, param)) {\n                    return false\n                }\n            }\n            this.state = to\n            const fs = spec.ons[to]\n            for (let i = 0; fs && i < fs.length; i++) {\n                fs[i].call(this, param)\n            }\n        }\n        return true\n    }\n\n    /**\n     * Returns a function that executes FSM.prototype.feed with the suplied\n     * argument\n     * @param {string} ev - Target state\n     * @returns {function}\n     */\n    feeder(ev) {\n        return param =>  this.feed(ev, param)\n    }\n}\n","/*\n Hide posts you don't like\n */\n\nlet main = require('./main');\n\n// Remember hidden posts for 7 days only to prevent the cookie from\n// eclipsing the Sun\nlet hidden = new main.Memory('hide', 7, true);\n\nmain.reply('hide', function(model) {\n\t// Hiding your own posts would open up the gates for a ton of bugs. Fuck\n\t// that.\n\tif (model.get('mine'))\n\t\treturn;\n\tconst count = hidden.write(model.get('num'));\n\tmodel.remove();\n\n\t// Forward number to options menu\n\tmain.request('hide:render', count);\n});\n\nmain.reply('hide:clear', () => hidden.purgeAll());\n\n// Initial render\nmain.defer(() => main.request('hide:render', hidden.size()));\n","/*\n * Inter board/page/thread navigation with HTML5 history\n */\n\nlet main = require('./main'),\n\t{$, _, common, Extract, state} = main;\n\n// Click handler for post/thread/board links\nmain.$doc.on ('click', 'a.history', function(event) {\n\tif (event.ctrlKey)\n\t\treturn;\n\treadingSteiner(this.href, event);\n});\n\n// Loading status GIF\nlet $loading = $('#loadingImage');\nmain.reply('loading:show', () => $loading.show());\nmain.reply('loading:hide', () => $loading.hide());\n\n// Navigate to the URL\nfunction readingSteiner(url, event) {\n\tlet nextState = state.read(url);\n\t// Does the link point to the same page as this one?\n\tif (_.isMatch(state.page.attributes, nextState))\n\t\treturn;\n\n\t// Disconnect server-side Yakusoku in preparation for navigating away.\n\t// This helps avoid duplicate messages mid-navigation.\n\tmain.request('connection:lock');\n\n\tif (event)\n\t\tevent.preventDefault();\n\n\t// Deal with hashes and query strings\n\tconst split = url.split('#');\n\tlet address = split[0] + (/\\?/.test(split[0]) ? '&' : '?') + 'minimal=true';\n\tif (split.length !== 1)\n\t\taddress += '#' + split[1];\n\n\t/*\n\t * Fetch new DOM from the server\n\t * Decided to go withthout dedicated caching and use etags for browser\n\t * cache verification.\n\t */\n\t$loading.show();\n\tconst xhr = new XMLHttpRequest();\n\txhr.open('GET', address);\n\txhr.onload = function () {\n\t\t// In case the thread is dead, moderatator cookie expired or some\n\t\t// other shenanigans\n\t\tif (this.status !== 200) {\n\t\t\t$loading.hide()\n\t\t\treturn alert(this.status)\n\t\t}\n\n\t\t// Was redirected to different thread/board\n\t\tif (baseURL(url) !== baseURL(this.responseURL))\n\t\t\tnextState = state.read(this.responseURL);\n\t\tmain.request('postSM:feed', 'done');\n\t\tmain.trigger('state:clear');\n\n\t\t// Apply new DOM and load models\n\t\tmain.$threads[0].innerHTML = this.response;\n\n\t\t// Set new page state\n\t\tstate.page.set(nextState);\n\n\t\t// Reconfigure rendering singleton\n\t\tmain.oneeSama.op = nextState.thread;\n\t\tnew Extract(nextState.catalog);\n\n\t\t// Swap the database controller server-side. Catalog does not use a\n\t\t// Yakusoku(), so not needed.\n\t\tif (!nextState.catalog) {\n\t\t\tmain.request('connection:unlock', [common.RESYNC, nextState.board,\n\t\t\t\tstate.syncs, nextState.live]);\n\t\t}\n\n\t\tif (event) {\n\t\t\thistory.pushState(null, null, nextState.href);\n\n\t\t\t// Scroll to top on new pages with no hashes\n\t\t\tif (location.hash)\n\t\t\t\tmain.request('scroll:aboveBanner');\n\t\t\telse\n\t\t\t\twindow.scrollTo(0, 0);\n\t\t}\n\t\t$loading.hide();\n\t};\n\txhr.send();\n}\n\nfunction baseURL(url) {\n\treturn url.split(/[\\?#]/)[0];\n}\n\n// For back and forward history events\nwindow.onpopstate = function(event) {\n\treadingSteiner(event.target.location.href);\n\tmain.request('scroll:aboveBanner');\n};\n","/*\n It is not very efficient to spam liteners to the options object. This\n module loops through the post models and calls the appropriate methods in\n batch.\n */\n\nconst main = require('./main'),\n\t{util, follow, options, oneeSama} = main,\n\t{posts} = main.state;\n\noptions.on({\n\t'change:thumbs': reRenderImages,\n\t'change:spoilers': toggleSpoilers,\n\t'change:autogif': toggleAutoGIF,\n\t'change:anonymise': toggleAnonymisation,\n\t'workModeTOG': reRenderImages\n});\nfunction reRenderImages() {\n\tif(main.state.page.get('catalog')){\n\t\t//quick render, because we don't have models in the catalog\n\t\tconst show = (options.get(\"thumbs\")!=='hide' && !main.oneeSama.workMode)? '':'none';\n\t\tdocument.queryAll(\".expanded\").forEach(el => el.style.display=show);\n\t}else\n\t\tfollow(() => getImages((image, model) =>\n\t\t\timage && model.dispatch('renderImage', image)));\n}\n\nfunction getImages(func) {\n\tposts.each(model => func(model.get('image'), model));\n}\n\nfunction toggleSpoilers() {\n\tfollow(() => getImages((image, model) =>\n\t\timage && image.spoiler && model.dispatch('renderImage', image)));\n}\n\n// Toggle animated GIF thumbnails\nfunction toggleAutoGIF() {\n\tfollow(() => getImages((image, model) =>\n\t\timage && image.ext === '.gif' && model.dispatch('renderImage', image)));\n}\n\nfunction toggleAnonymisation(source, toggle) {\n\tfollow(() => {\n\t\tconst command = toggle ? 'anonymise' : 'renderName';\n\t\tposts.each(function(model) {\n\t\t\tconst {name, trip} = model.attributes;\n\t\t\tif (name || trip)\n\t\t\t\tmodel.dispatch(command);\n\t\t});\n\t});\n}\nmain.reply('loop:anonymise', () =>\n\toptions.get('anonymise') && toggleAnonymisation(null, true));\n","/*\n * Self-expiring localStorage key controller\n */\n\nlet main = require('./main'),\n\t{_, Cookie} = main;\n\nclass Memory {\n\tconstructor(key, expiry, needCookie) {\n\t\tthis.key = key;\n\t\tthis.expiry = expiry;\n\t\tthis.needCookie = needCookie;\n\t\tmain.defer(this.purgeExpired.bind(this));\n\t}\n\tbakeCookie(object) {\n\t\tif (!this.needCookie)\n\t\t\treturn;\n\t\tlet nums = Object.keys(object);\n\t\tnums.sort(function(a, b) {\n\t\t\treturn parseInt(a, 10) - parseInt(b, 10);\n\t\t});\n\t\tCookie.set(this.key, nums.join('/'));\n\t}\n\tnow() {\n\t\treturn Math.floor(Date.now() / 1000);\n\t}\n\tpurgeAll() {\n\t\tlocalStorage.removeItem(this.key);\n\t\tif (this.needCookie)\n\t\t\tCookie.remove(this.key);\n\t}\n\treadAll() {\n\t\tconst key = localStorage.getItem(this.key);\n\t\tif (!key)\n\t\t\treturn {};\n\t\tlet val;\n\t\ttry {\n\t\t\tval = JSON.parse(key);\n\t\t}\n\t\tcatch(e) {}\n\t\treturn _.isObject(val) ? val : {};\n\t}\n\twriteAll(object) {\n\t\tif (_.isEmpty(object))\n\t\t\treturn this.purgeAll();\n\t\tlocalStorage.setItem(this.key, JSON.stringify(object));\n\t\tthis.bakeCookie(object)\n\t}\n\twrite(key) {\n\t\tlet object = this.readAll();\n\t\tobject[key] = this.now();\n\t\tthis.writeAll(object);\n\t\t// Return number of keys\n\t\treturn _.size(object);\n\t}\n\tsize() {\n\t\treturn _.size(this.readAll());\n\t}\n\tpurgeExpired() {\n\t\tif (!this.expiry)\n\t\t\treturn;\n\t\tlet object = this.readAll();\n\t\tconst now = this.now(),\n\t\t\tlimit = 86400 * this.expiry;\n\t\tlet expired = [];\n\t\tfor (let key in object) {\n\t\t\tconst time = object[key];\n\t\t\tif (time && now > time + limit)\n\t\t\t\texpired.push(key);\n\t\t}\n\t\tif (!expired.length)\n\t\t\treturn;\n\t\tfor (let i = 0, lim = expired.length; i < lim; i++) {\n\t\t\tdelete object[expired[i]];\n\t\t}\n\t\tthis.writeAll(object);\n\t}\n}\nmodule.exports = Memory;\n","/*\n * Houses both the actual options controler and the options panel renderring\n * logic\n */\n\nimport {_, Backbone, state} from 'main'\nimport opts from './opts'\n\n// Try to get options from local storage\nlet options\ntry {\n\toptions = JSON.parse(localStorage.options)\n}\ncatch(e) {}\nif (!options)\n\toptions = {};\nexport default options = new Backbone.Model(options)\n\nvar OptionsCollection = Backbone.Collection.extend({\n\tpersist() {\n\t\tvar opts = {};\n\t\tthis.forEach(function(model) {\n\t\t\tconst val = model.getValue();\n\t\t\tif (val === model.get('default'))\n\t\t\t\treturn;\n\t\t\topts[model.get('id')] = val;\n\t\t});\n\t\tlocalStorage.options = JSON.stringify(opts);\n\t}\n});\n\nvar optionsCollection = new OptionsCollection();\n\n// Controller template for each individual option\nvar OptionModel = Backbone.Model.extend({\n\tinitialize(opts) {\n\t\t// Condition for loading option. Optional.\n\t\tif (opts.load !== undefined && !opts.load)\n\t\t\treturn;\n\n\t\t// No type = checkbox + default false\n\t\tif (!opts.type)\n\t\t\tthis.set('type', 'checkbox');\n\n\t\tconst val = this.getValue();\n\t\tthis.setValue(val);\n\t\tif (opts.exec !== undefined) {\n\t\t\tthis.listenTo(options, 'change:' + opts.id, this.execListen);\n\t\t\t// Execute with current value\n\t\t\tif (opts.execOnStart !== false)\n\t\t\t\topts.exec(val);\n\t\t}\n\t\toptionsCollection.add(this);\n\t},\n\t// Set the option, taking into acount board specifics\n\tsetValue(val) {\n\t\toptions.set(this.get('id'), val);\n\t},\n\t// Return default, if unset\n\tgetValue() {\n\t\tconst val = options.get(this.get('id'));\n\t\treturn val === undefined ? this.get('default') : val;\n\t},\n\tvalidate(val) {\n\t\tconst valid = this.get('validation');\n\t\treturn valid ? valid(val) : true;\n\t},\n\t// Exec wrapper for listening events\n\texecListen(model, val) {\n\t\tthis.get('exec')(val);\n\t}\n});\n\n// Highlight options button, if no options are set\n(function() {\n\tif (localStorage.getItem('options'))\n\t\treturn;\n\tvar $el = $('#options');\n\t$el.addClass('noOptions');\n\n\tfunction fadeout() {\n\t\t$el.filter('.noOptions').fadeOut(fadein);\n\t}\n\n\tfunction fadein() {\n\t\t$el.fadeIn();\n\t\t// Stop animation, if options pannel is opened\n\t\tif ($el.filter('.noOptions').length)\n\t\t\tfadeout();\n\t}\n\n\tfadeout();\n\n\t$el.click(function() {\n\t\t$el.removeClass('noOptions');\n\t});\n})();\n\n// View of the options panel\nvar OptionsView = Backbone.View.extend({\n\tinitialize() {\n\t\t// Render the options panel\n\t\tthis.setElement(util.parseEl(require('./render')()))\n\t\tdocument.body.append(this.el)\n\n\t\t// Set the options in the panel to their appropriate values\n\t\toptionsCollection.each(model => {\n\t\t\tlet $el = this.$el.find('#' + model.get('id'));\n\t\t\t/*\n\t\t\t * No corresponding element in panel. Can be caused by config\n\t\t\t * mismatches.\n\t\t\t */\n\t\t\tif (!$el.length)\n\t\t\t\treturn;\n\t\t\tconst type = model.get('type'),\n\t\t\t\tval = model.getValue();\n\t\t\tif (type == 'checkbox')\n\t\t\t\t$el.prop('checked', val);\n\t\t\telse if (type == 'number' || type instanceof Array)\n\t\t\t\t$el.val(val);\n\t\t\telse if (type == 'shortcut')\n\t\t\t\t$el.val(String.fromCharCode(val).toUpperCase());\n\t\t\t// 'image' type simply falls through, as those don't need to be set\n\t\t});\n\t\tthis.$hidden = this.$el.find('#hidden');\n\t\tmain.reply('hide:render', this.renderHidden, this);\n\t},\n\tevents: {\n\t\t'click .option_tab_sel>li>a': 'switchTab',\n\t\t'change': 'applyChange',\n\t\t'click #export': 'export',\n\t\t'click #import': 'import',\n\t\t'click #hidden': 'clearHidden'\n\t},\n\tswitchTab(event) {\n\t\tevent.preventDefault();\n\t\tvar $a = $(event.target);\n\t\t// Unhighight all tabs\n\t\tthis.$el.children('.option_tab_sel').find('a').removeClass('tab_sel');\n\t\t// Hightlight the new one\n\t\t$a.addClass('tab_sel');\n\t\t// Switch tabs\n\t\tvar $li = this.$el.children('.option_tab_cont').children('li');\n\t\t$li.removeClass('tab_sel');\n\t\t$li.filter('.' + $a.data('content')).addClass('tab_sel');\n\t},\n\t// Propagate options panel changes to the models and localStorage\n\tapplyChange(event) {\n\t\tvar $target = $(event.target),\n\t\t\tmodel = optionsCollection.get($target.attr('id')),\n\t\t\tval;\n\t\tif (!model)\n\t\t\treturn;\n\t\tconst type = model.get('type');\n\t\tif (type == 'checkbox')\n\t\t\tval = $target.prop('checked');\n\t\telse if (type == 'number')\n\t\t\tval = parseInt($target.val());\n\t\t// Not recorded; extracted directly by the background handler\n\t\telse if (type == 'image')\n\t\t\treturn main.request('background:store', event.target);\n\t\telse if (type == 'shortcut')\n\t\t\tval = $target.val().toUpperCase().charCodeAt(0);\n\t\telse\n\t\t\tval = $target.val();\n\n\t\tif (!model.validate(val))\n\t\t\treturn $target.val('');\n\t\tmodel.setValue(val);\n\t\toptionsCollection.persist();\n\t},\n\t// Dump options to file\n\texport() {\n\t\tvar a = document.getElementById('export')\n\t\ta.setAttribute('href', window.URL\n\t\t\t.createObjectURL(new Blob([JSON.stringify(localStorage)], {\n\t\t\t\ttype: 'octet/stream'\n\t\t\t}))\n\t\t);\n\t\ta.setAttribute('download', 'meguca-config.json');\n\t},\n\t// Import options from file\n\timport(event) {\n\t\t// Proxy to hidden file input\n\t\tevent.preventDefault();\n\t\tvar $input = this.$el.find('#importSettings');\n\t\t$input.click();\n\t\t$input.one('change', function() {\n\t\t\tvar reader = new FileReader();\n\t\t\treader.readAsText($input[0].files[0]);\n\t\t\treader.onload = function(e) {\n\t\t\t\tvar json;\n\t\t\t\t// In case of curruption\n\t\t\t\ttry {\n\t\t\t\t\tjson = JSON.parse(e.target.result);\n\t\t\t\t}\n\t\t\t\tcatch(e) {\n\t\t\t\t\talert('Import failed. File corrupt');\n\t\t\t\t}\n\t\t\t\tif (!json)\n\t\t\t\t\treturn;\n\t\t\t\tlocalStorage.clear();\n\t\t\t\tfor (let key in json) {\n\t\t\t\t\tlocalStorage[key] = json[key];\n\t\t\t\t}\n\t\t\t\talert('Import successfull. The page will now reload.');\n\t\t\t\tlocation.reload(true);\n\t\t\t};\n\t\t});\n\t},\n\t// Hiden posts counter and reset link\n\trenderHidden(count) {\n\t\tlet $el = this.$hidden;\n\t\t$el.text($el.text().replace(/\\d+$/, count));\n\t},\n\tclearHidden() {\n\t\tmain.request('hide:clear');\n\t\tthis.renderHidden(0);\n\t}\n});\n\n// Create and option model for each object in the array\nfor (let spec of opts) {\n\tnew OptionModel(spec);\n}\n\nmain.defer(function() {\n\tnew OptionsView()\n});\n","/*\n * This file is used by both the client to populate the Backbone models and the\n * server to render the actual options panel.\n */\n\nimport {Cookie, util, state, config, isMobile, lang} from 'main'\n\n/*\n * Full schema of the option interface\n *\n * - id: Identifier of the option. Used for DOM element and localStorage tagging\n * - type: 'checkbox'/'number'/'image'/'shortCut'/array of options\n *\tarrays become a selection list. Defaults to 'checkbox', if omitted.\n * - default: Default value. false, if omitted.\n * - tab: Index of the tab the option belong to.\n * - exec: Function to execute on option change.\n * - execOnStart: Boolean. Should the function be executed on model population?\n *\tDefaults to true.\n * - load: Condition to display and execute the option. Defaults to true(always)\n * - validation: Function that validates the users input. Returns a boolean.\n * - hidden: If true this option won't be shown to the user. Defaults to false\n *\n * Tooltips and lables are defined per language in `lang/`.\n * All arguments except for `id` and `tab` are optional.\n */\n\nconst notMobile = !isMobile\n\nexport default opts = [\n\t// LANGUAGE SELECTION\n\t{\n\t\tid: 'lang',\n\t\ttype: config.lang.enabled,\n\t\ttab: 0,\n\t\tdefault: config.lang.default,\n\t\texecOnStart: false,\n\t\texec(type) {\n\t\t\talert(lang.langApplied)\n\t\t\tlocation.reload()\n\t\t}\n\t},\n\t// INLINE EXPANSION\n\t{\n\t\tid: 'inlinefit',\n\t\ttype: ['none', 'full', 'width', 'height', 'both'],\n\t\ttab: 1,\n\t\tdefault: 'width'\n\t},\n\t// THUMBNAIL MODE\n\t{\n\t\tid: 'thumbs',\n\t\ttype: util.thumbStyles,\n\t\ttab: 1,\n\t\tdefault: 'small'\n\t},\n\t// IMAGE HOVER EXPANSION\n\t{\n\t\tid: 'imageHover',\n\t\tdefault: true,\n\t\tload: notMobile,\n\t\ttab: 0\n\t},\n\t{\n\t\tid: 'webmHover',\n\t\tload: notMobile,\n\t\ttab: 0\n\t},\n\t// Autogif TOGGLE\n\t{\n\t\tid: 'autogif',\n\t\tload: notMobile,\n\t\ttab: 1\n\t},\n\t// SPOILER TOGGLE\n\t{\n\t\tid: 'spoilers',\n\t\ttab: 1,\n\t\tdefault: true\n\t},\n\t// LINKIFY TEXT URLS\n\t{\n\t\tid: 'linkify',\n\t\ttab: 0,\n\t\tdefault: true\n\t},\n\t// DESKTOP NOTIFICATIONS\n\t{\n\t\tid: 'notification',\n\t\tload: notMobile,\n\t\ttab: 0,\n\t\texec(notifToggle) {\n\t\t\tif (notifToggle && (Notification.permission !== \"granted\"))\n\t\t\t\tNotification.requestPermission()\n\t\t}\n\t},\n\t// ANONIMISE ALL POSTER NAMES\n\t{\n\t\tid: 'anonymise',\n\t\ttab: 0\n\t},\n\t// RELATIVE POST TIMESTAMPS\n\t{\n\t\tid: 'relativeTime',\n\t\ttab: 0,\n\t\tdefault: true\n\t},\n\t// R/A/DIO NOW PLAYING BANNER\n\t{\n\t\tid: 'nowPlaying',\n\t\tload: notMobile && config.radio,\n\t\ttab: 3,\n\t\tdefault: true,\n\t\texec(toggle) {\n\t\t\tif (toggle) {\n\t\t\t\t// Query the server for current stream info\n\t\t\t\tmain.send({type: 'radio'})\n\t\t\t} else {\n\t\t\t\tmain.request('banner:radio:clear');\n\t\t\t}\n\t\t}\n\t}\n];\n\n// IMAGE SEARCH LINK TOGGLE\nfor (let engine of ['google', 'iqdb', 'saucenao', 'desustorage', 'exhentai']) {\n\topts.push({\n\t\tid: engine,\n\t\t// Use a custom internatiolisation function\n\t\tlang: 'imageSearch',\n\t\ttab: 2,\n\t\tdefault: engine === 'google',\n\t\texec: toggleHeadStyle(engine + 'Toggle', `.${engine}{display:initial;}`)\n\t})\n}\n\nopts.push(\n\t// ILLYA DANCE\n\t{\n\t\tid: 'illyaBGToggle',\n\t\tload: notMobile && config.illyaDance,\n\t\ttab: 3\n\t},\n\t{\n\t\tid: 'illyaMuteToggle',\n\t\tload: notMobile && config.illyaDance,\n\t\ttab: 3\n\t},\n\t// HORIZONTAL POSTING\n\t{\n\t\tid: 'horizontalPosting',\n\t\ttab: 3,\n\t\texec: toggleHeadStyle(\n\t\t\t'horizontal',\n\t\t\t'article,aside{display:inline-block;}'\n\t\t)\n\t},\n\t// REPLY AT RIGHT\n\t{\n\t\tid: 'replyright',\n\t\ttab: 1,\n\t\texec: toggleHeadStyle(\n\t\t\t'reply-at-right',\n\t\t\t'section>aside{margin: -26px 0 2px auto;}'\n\t\t)\n\t},\n\t// THEMES\n\t{\n\t\tid: 'theme',\n\t\ttype: [\n\t\t\t'moe', 'gar', 'mawaru', 'moon', 'ashita', 'console', 'tea',\n\t\t\t'higan', 'ocean', 'rave', 'tavern', 'glass'\n\t\t],\n\t\ttab: 1,\n\t\tdefault: config.defaultCSS,\n\t\texec(theme) {\n\t\t\tif (!theme) {\n\t\t\t    return\n\t\t\t}\n\t\t\tdocument.getElementById('theme')\n\t\t\t\t.setAttribute(\n\t\t\t\t\t'href',\n\t\t\t\t\t`${config.MEDIA_URL}css/${theme}.css?v=${main.cssHash}`\n\t\t\t\t)\n\t\t}\n\t},\n\t// CUSTOM USER-SET BACKGROUND\n\t{\n\t\tid: 'userBG',\n\t\tload: notMobile,\n\t\ttab: 1\n\t},\n\t{\n\t\tid: 'userBGimage',\n\t\tload: notMobile,\n\t\ttype: 'image',\n\t\ttab: 1,\n\t\texecOnStart: false,\n\t\texec(upload) {\n\t\t\tmain.request('background:store', upload)\n\t\t}\n\t},\n\t// LAST N CONFIG\n\t{\n\t\tid: 'lastn',\n\t\ttype: 'number',\n\t\ttab: 0,\n\t\tvalidation: util.resonableLastN,\n\t\tdefault: config.posts.lastN\n\t},\n\t// KEEP THREAD LENGTH WITHIN LASTN\n\t/*\n\t Disabled, until dependancy features are implemnted (see issue #280)\n\t{\n\t\tid: 'postUnloading',\n\t\ttab: 0\n\t},*/\n\t// LOCK TO BOTTOM EVEN WHEN DOCUMENT HIDDEN\n\t{\n\t\tid: 'alwaysLock',\n\t\ttab: 0\n\t}\n);\n\n// SHORTCUT KEYS\nconst shorts = [\n\t{id: 'new', default: 78},\n\t{id: 'togglespoiler', default: 73},\n\t{id: 'textSpoiler', default: 68},\n\t{id: 'done', default: 83},\n\t{id: 'expandAll', default: 69},\n\t{id: 'workMode', default: 66}\n]\nfor (let short of shorts) {\n\tshort.type = 'shortcut'\n\tshort.tab = 4\n\tshort.load = notMobile\n\topts.push(short)\n}\n\n/**\n * Create a function to append and toggle a style element in <head>\n */\nfunction toggleHeadStyle(id, css) {\n\treturn function (toggle) {\n\t\tif (!document.getElementById(id)) {\n\t\t\tdocument.head.appendChild(\n\t\t\t\tutil.parseEl(`<style id=\"${id}\">${css}</style>`)\n\t\t\t)\n\t\t}\n\n\t\t// The disabled property only exists on elements in the DOM, so we do\n\t\t// another query\n\t\tdocument.getElementById(id).disabled = !toggle;\n\t}\n}\n","import {_, isMobile, options} from 'main'\n\nconst lang = main.lang.opts\n\n/**\n * Render the options panel\n */\nexport default function render() {\n    let html = `<div class=\"bmodal glass\" id=\"options-panel\">`\n        + `<ul class=\"option_tab_sel\">`\n    const {tabs} = lang,\n        opts = []\n\n    // Render tab butts\n    for (let i = 0; i < tabs.length; i++) {\n        // Pick the options for this specific tab, according to current\n        // template and server configuration\n        opts[i] = _.filter(options, opt =>\n            opt.tab === i\n                && (opt.load === undefined  || opt.load)\n                && !opt.hidden)\n\n        if (!opts[i].length) {\n            continue\n        }\n        html += `<li><a data-content=\"tab-${i}\"`\n\n        // Highlight the first tabButt by default\n        if (i === 0) {\n            html += ' class=\"tab_sel\"'\n        }\n\n        html += `>${tabs[i]}</a></li>`;\n    }\n\n    html += '</ul><ul class=\"option_tab_cont\">'\n    for (let i = 0; i < opts.length; i++) {\n        html += renderTab(opt, i)\n    }\n    html += '</ul></div>'\n\n    return html\n}\n\n/**\n * Render tab contents\n */\nfunction renderTab(opt, i) {\n    if (!opts[i].length) {\n        return ''\n    }\n    let html = \"\"\n    html += `<li class=\"tab-${i}`\n\n    // Show the first tab by default\n    if (i === 0) {\n        html += ' tab_sel'\n    }\n    html += '\">'\n\n    // Render the actual options\n    for (let opt of opts[i]) {\n        html += renderOption(opt)\n    }\n\n    if (i === 0) {\n        html += renderExtras()\n    }\n    html += '</li>'\n\n    return html\n}\n\n/**\n * Render a single option from it's schema\n */\nfunction renderOption(opt) {\n\tlet html = ''\n\tconst isShortcut = opt.type === 'shortcut',\n\t\tisList = opt.type instanceof Array,\n\t\tisCheckbox = opt.type === 'checkbox' || opt.type === undefined,\n\t\tisNumber = opt.type === 'number',\n\t\tisImage = opt.type === 'image'\n\tif (isShortcut) {\n        html += 'Alt+'\n    }\n\tif (!isList) {\n\t\thtml += '<input'\n\t\tif (isCheckbox || isImage)\n\t\t\thtml += ` type=\"${(isCheckbox ? 'checkbox' : 'file')}\"`\n\t\telse if (isNumber)\n\t\t\thtml += ' style=\"width: 4em;\" maxlength=\"4\"'\n\t\telse if (isShortcut)\n\t\t\thtml += ' maxlength=\"1\"'\n\t} else {\n        html += '<select'\n    }\n\n\tconst [label,title] = lang[opt.id]\n\thtml += ` id=\"${opt.id}\" title=\"${title}\">`\n\n\tif (isList) {\n\t\tfor (let item of opt.type) {\n\t\t\thtml += `<option value=\"${item}\">${lang[item] || item}</option>`\n\t\t}\n\t\thtml += '</select>'\n\t}\n\thtml += `<label for=\"${opt.id}\" title=\"${title}\">${label}</label><br>`\n\n\treturn html\n}\n\n/**\n * Hidden post reset, Export and Import links to first tab\n */\nfunction renderExtras() {\n\tlet html = '<br>'\n\tconst links = ['export', 'import', 'hidden']\n    for (let id of links) {\n        const [label, title] = lang[id]\n        html += `<a id=\"${id}\" title=\"${ln[1]}\">${ln[0]}</a> `\n    }\n\n    // Hidden file input for uploading the JSON\n    const attrs = {\n        type: 'file',\n        id: 'importSettings',\n        name: \"Import Settings\"\n    }\n\thtml += common.parseHTML`<input ${attrs}>`\n\n    return html\n}\n","/*\n * Reply posts\n */\n\nconst main = require('../main'),\n\tPostCommon = require('./common'),\n\t{_, Backbone} = main;\n\nmodule.exports = PostCommon.extend({\n\ttagName: 'article',\n\trender() {\n\t\tthis.setElement(main.oneeSama.article(this.model.attributes));\n\t\treturn this;\n\t},\n\tinsertIntoDOM() {\n\t\t_.last(document.query('#p' + this.model.get('op')).queryAll('article'))\n\t\t\t.after(this.el);\n\t\tthis.autoExpandImage().fun();\n\t}\n});\n","/*\n * Common methods to both OP and regular posts\n */\n\nconst main = require('../main'),\n\timager = require('./imager'),\n\t{_, Backbone, common, util, lang, oneeSama, options, state} = main;\n\nmodule.exports = imager.Hidamari.extend({\n\tclassName: 'glass',\n\t// One-way communication channel to the model\n\tinitialize() {\n\t\tthis.listenTo(this.model, 'dispatch', this.redirect);\n\t},\n\t// Extra initialisation logic for posts renderred client-side\n\tclientInit() {\n\t\tif (options.get('anonymise'))\n\t\t\tthis.anonymise();\n\t\treturn this;\n\t},\n\t// Proxy to the appropriate method\n\tredirect(command, ...args) {\n\t\tthis[command](...args);\n\t},\n\t// Update the post's text body\n\tupdateBody(frag) {\n\t\tif (!this.blockquote)\n\t\t\tthis.blockquote = this.el.query('blockquote');\n\n\t\t// This will rerender the HTML content on each update. Might be\n\t\t// some overhead involved, but simplifies live updates greatly.\n\t\tconst model = this.model.attributes;\n\t\tthis.blockquote.innerHTML = oneeSama.setModel(model).body(model.body);\n\t},\n\trenderTime() {\n\t\tthis.el.query('time').outerHTML = oneeSama.time(this.model.get('time'));\n\t},\n\trenderBacklinks(links) {\n\t\tthis.el.query('small').innerHTML = oneeSama.backlinks(links);\n\t},\n\t// Admin JS injections\n\tfun() {\n\t\t// Fun goes here\n\t},\n\t// Self-delusion tripfag filter\n\tanonymise() {\n\t\tthis.el.query('.name').innerHTML = `<b class=\"name\">${lang.anon}<b>`;\n\t},\n\t// Restore regular name\n\trenderName() {\n\t\tthis.el.query('.name').outerHTML = oneeSama.name(this.model.attributes);\n\t},\n\trenderModerationInfo(info) {\n\t\tconst el = this.getContainer();\n\t\tel.query('.modLog').remove();\n\t\tel.query('blockquote').before(util.parseDOM(oneeSama.modInfo(info)));\n\t},\n\tgetContainer() {\n\t\treturn this.el.query('.container');\n\t},\n\trenderBan() {\n\t\tconst el = this.getContainer();\n\t\tel.query('.banMessage').remove();\n\t\tel.query('blockquote').after(util.parseDOM(oneeSama.banned()));\n\t},\n\trenderEditing(editing) {\n\t\tconst {el} = this;\n\t\tif (editing)\n\t\t\tel.classList.add('editing');\n\t\telse {\n\t\t\tel.classList.remove('editing');\n\t\t\tel.query('blockquote').normalize();\n\t\t}\n\t}\n});\n","/*\nYoutube, soundcloud and pastebin link embeding\n */\n\n// TODO: DRY this shit\n\nlet main = require('../main'),\n\t{$, util} = main;\n\n// >80 char rule\nconst youtube_url_re = exports.youtube_url_re = /(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?youtube\\.com\\/watch\\/?\\?((?:[^\\s#&=]+=[^\\s#&]*&)*)?v=([\\w-]{11})((?:&[^\\s#&=]+=[^\\s#&]*)*)&?(#t=[\\dhms]{1,9})?/,\n\tyoutube_short_re = exports.youtube_short_re = /(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?youtu.be\\/([\\w-]{11})\\??(t=[\\dhms]{1,9})?/,\n\tyoutube_time_re = exports.youtube_time_re = /^#t=(?:(\\d\\d?)h)?(?:(\\d{1,3})m)?(?:(\\d{1,3})s)?$/,\n\tyoutube_short_time_re = exports.youtube_short_time_re = /^t=(?:(\\d\\d?)h)?(?:(\\d{1,3})m)?(?:(\\d{1,3})s)?$/;\n\nfunction make_video(id, params, start) {\n\tif (!params)\n\t\tparams = {allowFullScreen: 'true'};\n\tparams.allowScriptAccess = 'always';\n\tvar query = {\n\t\tautohide: 1,\n\t\tfs: 1,\n\t\tmodestbranding: 1,\n\t\torigin: document.location.origin,\n\t\trel: 0,\n\t\tshowinfo: 0\n\t};\n\tif (start)\n\t\tquery.start = start;\n\tif (params.autoplay)\n\t\tquery.autoplay = params.autoplay;\n\tif (params.loop) {\n\t\tquery.loop = '1';\n\t\tquery.playlist = id;\n\t}\n\n\treturn $('<iframe></iframe>', {\n\t\ttype: 'text/html',\n\t\tsrc: encodeURI('https://www.youtube.com/embed/' + id) + '?'\n\t\t\t+ $.param(query),\n\t\tframeborder: '0',\n\t\tattr: video_dims(),\n\t\tclass: 'youtube-player'\n\t});\n}\n\nfunction video_dims() {\n\tif (window.screen && screen.width <= 320)\n\t\treturn {width: 250, height: 150};\n\telse\n\t\treturn {width: 560, height: 340};\n}\n\nmain.$threads.on('click', '.watch', function(e) {\n\tif (e.which > 1 || e.metaKey || e.ctrlKey || e.altKey || e.shiftKey)\n\t\treturn;\n\tvar $target = $(e.target);\n\n\t// maybe squash that double-play bug? ugh, really\n\tif (!$target.is('a'))\n\t\treturn;\n\n\tvar $video = $target.find('iframe');\n\tif ($video.length) {\n\t\t$video.siblings('br').andSelf().remove();\n\t\t$target.css('width', 'auto');\n\t\treturn false;\n\t}\n\tif ($target.data('noembed'))\n\t\treturn;\n\t//check if longURL, if that fails, check if shortURL\n\tvar m = $target.attr('href').match(youtube_url_re);\n\tif (!m) {\n\t\tm = $target.attr('href').match(youtube_short_re);\n\t\tif (!m)\n\t\t// Shouldn't happen, but degrade to normal click action\n\t\t\treturn;\n\t\ttimeCall(m[1],m[2],youtube_short_time_re);\n\t}\n\ttimeCall(m[2],m[4],youtube_time_re);\n\tfunction timeCall(url, time, timeRex){\n\t\tvar start = 0;\n\t\tif (time){\n\t\t\tvar t = time.match(timeRex);\n\t\t\tif (t) {\n\t\t\t\tif (t[1])\n\t\t\t\t\tstart += parseInt(t[1], 10) * 3600;\n\t\t\t\tif (t[2])\n\t\t\t\t\tstart += parseInt(t[2], 10) * 60;\n\t\t\t\tif (t[3])\n\t\t\t\t\tstart += parseInt(t[3], 10);\n\t\t\t}\n\t\t}\n\t\t$target\n\t\t\t.css('width', video_dims().width)\n\t\t\t.append('<br>', make_video(url, null, start))\n\t}\n\treturn false;\n});\n\nmain.$threads.on('mouseenter', '.watch', function (event) {\n\tvar $target = $(event.target);\n\tif ($target.data('requestedTitle'))\n\t\treturn;\n\t$target.data('requestedTitle', true);\n\t// Edit textNode in place so that we don't mess with the embed\n\tvar node = $target.contents().filter(function () {\n\t\treturn this.nodeType === 3;\n\t})[0];\n\tif (!node)\n\t\treturn;\n\tconst orig = node.textContent;\n\tnode.textContent = orig + '...';\n\tvar m = $target.attr('href').match(youtube_url_re);\n\tif (!m){\n\t\tm = $target.attr('href').match(youtube_short_re);\n\t\tif(!m)\n\t\t\treturn;\n\t\t$.ajax({\n\t\t\turl: '//gdata.youtube.com/feeds/api/videos/' + m[1],\n\t\t\tdata: {v: '2', alt: 'jsonc'},\n\t\t\tdataType: 'json',\n\t\t\tsuccess: gotInfo,\n\t\t\terror() {\n\t\t\t\tnode.textContent = orig + '???';\n\t\t\t}\n\t\t});\n\t}\n\n\t$.ajax({\n\t\turl: '//gdata.youtube.com/feeds/api/videos/' + m[2],\n\t\tdata: {v: '2', alt: 'jsonc'},\n\t\tdataType: 'json',\n\t\tsuccess: gotInfo,\n\t\terror() {\n\t\t\tnode.textContent = orig + '???';\n\t\t}\n\t});\n\t// Creates the Titles upon hover\n\t// NOTE: Condense gotInfos into single function\n\tfunction gotInfo(data) {\n\t\tvar title = data && data.data && data.data.title;\n\t\tif (title) {\n\t\t\tnode.textContent = orig + ': ' + title;\n\t\t\t$target.css({color: 'black'});\n\t\t}\n\t\telse\n\t\t\tnode.textContent = orig + ' (gone?)';\n\n\t\tif (data\n\t\t\t&& data.data\n\t\t\t&& data.data.accessControl\n\t\t\t&& data.data.accessControl.embed === 'denied'\n\t\t) {\n\t\t\tnode.textContent += ' (EMBEDDING DISABLED)';\n\t\t\t$target.data('noembed', true);\n\t\t}\n\t}\n});\n\nfunction make_embed(uri, params, dims) {\n\tvar $obj = $('<object/>', {attr: dims});\n\tfor (var name in params) {\n\t\t$('<param/>', {\n\t\t\tattr: {\n\t\t\t\tname: name,\n\t\t\t\tvalue: params[name]\n\t\t\t}\n\t\t}).appendTo($obj);\n\t}\n\t$('<embed/>', {\n\t\tsrc: uri,\n\t\ttype: 'application/x-shockwave-flash'\n\t})\n\t\t.attr(dims)\n\t\t.attr(params)\n\t\t.appendTo($obj);\n\treturn $obj;\n}\n\n/* SOUNDCLOUD */\n\nconst soundcloud_url_re = exports.soundcloud_url_re = /(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.)?soundcloud\\.com\\/([\\w-]{1,40}\\/[\\w-]{1,80})\\/?/;\n\nfunction fetchSoundcloud(target, width, cb) {\n\tconst url = 'https://soundcloud.com/oembed?url='\n\t\t+ encodeURIComponent(target.getAttribute('href'))\n\t\t+ `&maxwidth=${width}&maxheight=166&auto_play=true&format=json`\n\t\t+ '&show_comments=false';\n\tconst xhr = new XMLHttpRequest();\n\txhr.open('GET', url);\n\txhr.responseType = 'json';\n\txhr.onload = function () {\n\t\tif (this.status !== 200)\n\t\t\treturn cb(this.status);\n\t\tcb(null, this.response);\n\t};\n\txhr.send();\n}\n\nmain.$threads.on('click', '.soundcloud', function (e) {\n\tif (e.which > 1 || e.ctrlKey || e.altKey || e.shiftKey || e.metaKey)\n\t\treturn;\n\tconst {target} = e,\n\t\tiframe = target.query('iframe');\n\te.preventDefault();\n\tif (iframe) {\n\t\tiframe.previousElementSibling.remove();\n\t\tiframe.remove();\n\t\treturn;\n\t}\n\n\tconst width = Math.round(window.innerWidth * 0.75);\n\tfetchSoundcloud(target, width, (err, json) => {\n\t\tif (err)\n\t\t\treturn alert(err);\n\t\ttarget.append(document.createElement('br'));\n\t\ttarget.append(util.parseDOM(json.html));\n\t\ttarget.style.width = width + 'px';\n\t});\n});\n\nmain.$threads.on('mouseenter', '.soundcloud:not(.fetched)', function (event) {\n\tconst {target} = event,\n\t\tnode = target.firstChild,\n\t\ttext = node.textContent;\n\tnode.textContent = text + ' ...';\n\n\t// We should not be doing 2 separate fetches on mouseover and click, but\n\t// what if the user manages to click without mouseenter somehow?\n\tfetchSoundcloud(target, 1000, (err, json) => {\n\t\tif (err)\n\t\t\treturn node.textContent = `${text}: Error: ${err}`;\n\t\tnode.textContent = `${text}: ${json.title}`;\n\t\ttarget.style.color = 'black';\n\t\ttarget.classList.add('fetched');\n\t});\n});\n\n// PASTEBIN\nconst pastebin_re = exports.pastebin_re = /(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?pastebin\\.com\\/(.*)/;\n//Pastebin's API seems built for MAKING pastebins but not sharing them\n\n$(document).on('click', '.pastebin', function(event){\n\tif (event.which > 1 || event.ctrlKey || event.altKey || event.shiftKey || event.metaKey)\n\t\treturn;\n\tvar $target = $(event.target);\n\n\tvar $obj = $target.find('iframe');\n\tif ($obj.length) {\n\t\t$obj.siblings('br').andSelf().remove();\n\t\t$target.css({\n\t\t\twidth: 'auto',\n\t\t\theight: 'auto'\n\t\t});\n\t\treturn false;\n\t}\n\n\tvar m = $target.attr('href').match(pastebin_re);\n\tif (!m)\n\t\treturn;\n\tvar $window = $(window),\n\t\twidth = Math.round($window.innerWidth() * 0.65),\n\t\theight = Math.round($window.innerHeight() * 0.65);\n\t$target\n\t\t.css({\n\t\t\twidth: width,\n\t\t\theight: height\n\t\t})\n\t\t.append('<br>', $('<iframe></iframe>', {\n\t\t\ttype: 'text/html',\n\t\t\tsrc: 'https://pastebin.com/embed_iframe.php?i='+ m[1],\n\t\t\tframeborder: '0',\n\t\t\twidth: width,\n\t\t\theight: height\n\t\t}))\n\treturn false;\n});\n","/*\n Name, email, tripcode and staff title persistence and postform propagation\n */\n\nlet main = require('../main'),\n\t{$, $script, $email, $name, _, common, config} = main;\n\nfunction load() {\n\ttry {\n\t\tconst id = JSON.parse(localStorage.ident);\n\t\tif (id.name)\n\t\t\t$name.val(id.name);\n\t\tif (id.email)\n\t\t\t$email.val(id.email);\n\t}\n\tcatch(e) {}\n}\n\nlet save = _.debounce(function() {\n\ttry {\n\t\tconst name = $name.val();\n\t\tlet email = $email.val();\n\t\t// Staff login method\n\t\tif (email === config.LOGIN_KEYWORD) {\n\t\t\t$email.val('');\n\t\t\t$script(config.MEDIA_URL + 'js/login.js?v=' + main.clientHash);\n\t\t\temail = false;\n\t\t}\n\n\t\tif (name || email) {\n\t\t\tlet id = {};\n\t\t\tif (name)\n\t\t\t\tid.name = name;\n\t\t\tif (email)\n\t\t\t\tid.email = email;\n\t\t\tlocalStorage.ident = JSON.stringify(id);\n\t\t}\n\t\telse\n\t\t\tlocalStorage.removeItem('ident');\n\t}\n\tcatch(e) {}\n}, 1000);\n\n// Sync persistance and postForm with input changes\nfunction propagate() {\n\tlet postForm = main.request('postForm');\n\tif (postForm)\n\t\tpostForm.renderIdentity();\n\tsave();\n}\n\nmain.defer(function() {\n\tload();\n\t$name.on('input', propagate);\n\t$email.on('input', propagate);\n});\n","/*\n * Thumbnail and image renderring\n */\n\nconst main = require('../main'),\n\t{$threads, _, Backbone, common, util, oneeSama, options, state} = main;\n\nexports.Hidamari = Backbone.View.extend({\n\t/*\n\t Render entire <figure>. Rerenderring completely each time is considerable\n\t overhed, but the alternative is very convoluted logic. I don't really want\n\t to attach a FSM to each view, just for image renderring.\n\t */\n\trenderImage(arg, image, manual) {\n\t\t/*\n\t\t All kinds of listeners call this method, so we need to ensure we\n\t\t always get the appropriate image object.\n\t\t */\n\t\tconst reveal = arg === true,\n\t\t\t{model, el} = this;\n\t\tif (!image || !image.src)\n\t\t\timage = model.get('image');\n\t\tconst figure = el.query('figure');\n\t\tif (figure)\n\t\t\tfigure.remove();\n\n\t\t// Remove image on mod deletion\n\t\tif (!image)\n\t\t\treturn;\n\t\tel.query('blockquote')\n\t\t\t.before(util.parseDOM(oneeSama.image(image, reveal)));\n\n\t\t// Scroll the post back into view, if contracting images taller than\n\t\t// the viewport\n\t\tif (manual && model.get('tallImage')) {\n\t\t\twindow.scrollTop = el.getBoundingClientRect().top\n\t\t\t\t+ document.body.scrollTop\n\t\t\t\t- document.query('#banner').height;\n\t\t}\n\n\t\tmodel.set({\n\t\t\t// Only used in hidden thumbnail mode\n\t\t\tthumbnailRevealed: reveal,\n\t\t\timageExpanded: false,\n\t\t\ttallImage: false\n\t\t});\n\t},\n\tautoExpandImage() {\n\t\tconst img = this.model.get('image');\n\t\tif (!img\n\t\t\t|| !massExpander.get('expand')\n\t\t\t// Don't auto expand webm/PDF/MP3\n\t\t\t|| ['.webm', '.pdf', '.mp3'].indexOf(img.ext) > -1\n\t\t)\n\t\t\treturn this;\n\t\tthis.toggleImageExpansion(true, img);\n\t\treturn this;\n\t},\n\ttoggleImageExpansion(expand, img, manual) {\n\t\tconst fit = options.get('inlinefit');\n\t\tif (!img || fit === 'none')\n\t\t\treturn;\n\t\tif (expand)\n\t\t\tthis.fitImage(img, fit);\n\t\telse\n\t\t\tthis.renderImage(null, img, manual);\n\t},\n\tfitImage(img, fit){\n\t\t// Open PDF in a new tab on click\n\t\tif (img.ext === '.pdf')\n\t\t\treturn window.open(oneeSama.imagePaths().src + img.src, '_blank');\n\n\t\t// Audio controls are always the same height and do not need to be\n\t\t// fitted\n\t\tif (img.ext === '.mp3')\n\t\t\treturn this.renderAudio(img);\n\n\t\tlet newWidth, newHeight,\n\t\t\twidth = newWidth = img.dims[0],\n\t\t\theight = newHeight = img.dims[1];\n\t\tif (fit === 'full')\n\t\t\treturn this.expandImage(img, {width, height});\n\n\t\tconst both = fit === 'both',\n\t\t\twidthFlag = both || fit === 'width',\n\t\t\theightFlag = both || fit === 'height',\n\t\t\taspect = width / height;\n\t\tlet fullWidth, fullHeight;\n\t\tif (widthFlag) {\n\t\t\tconst maxWidth = this.imageMaxWidth();\n\t\t\tif (newWidth > maxWidth) {\n\t\t\t\tnewWidth = maxWidth;\n\t\t\t\tnewHeight = newWidth / aspect;\n\t\t\t\tfullWidth = true;\n\t\t\t}\n\t\t}\n\t\tif (heightFlag) {\n\t\t\tlet maxHeight = window.innerHeight\n\t\t\t\t- document.query('#banner').offsetHeight;\n\t\t\tif (newHeight > maxHeight) {\n\t\t\t\tnewHeight = maxHeight;\n\t\t\t\tnewWidth = newHeight * aspect;\n\t\t\t\tfullHeight = true;\n\t\t\t}\n\t\t}\n\t\tif (newWidth > 50 && newHeight > 50) {\n\t\t\twidth = newWidth;\n\t\t\theight = newHeight;\n\t\t}\n\t\tthis.expandImage(img, width, height, fullHeight && !fullWidth);\n\t},\n\t// Calculate maximum horizontal dimension an image can be expanded to\n\timageMaxWidth() {\n\t\tconst {el, model} = this;\n\t\treturn window.innerWidth\n\t\t\t- parseInt(el.closest('section').getBoundingClientRect().left) * 2\n\t\t\t- util.outerWidth(model.get('op') ? el : el.query('.background'));\n\t},\n\texpandImage(img, width, height, noMargin) {\n\t\tconst isVideo = img.ext === '.webm';\n\t\tconst attrs = {\n\t\t\tsrc: oneeSama.imagePaths().src + img.src,\n\t\t\twidth,\n\t\t\theight\n\t\t};\n\t\tlet cls = 'expanded';\n\t\tif (noMargin)\n\t\t\tcls += ' noMargin';\n\t\tattrs.class = cls;\n\n\t\tif (isVideo)\n\t\t\tattrs.autoplay = attrs.loop = attrs.controls = true\n\n\t\tthis.el.query('figure').lastChild.innerHTML = common.parseHTML\n\t\t\t`<${isVideo ? 'video' : 'img'} ${attrs}>`;\n\t\tthis.model.set({\n\t\t\timageExpanded: true,\n\t\t\ttallImage: height > window.innerHeight\n\t\t});\n\t},\n\trenderAudio(img) {\n\t\tthis.el.query('figure').append(util.parseDOM(common.parseHTML\n\t\t\t`<audio src=\"${oneeSama.imagePaths().src + img.src}\"\n\t\t\t\twidth=\"300\"\n\t\t\t\theight=\"3em\"\n\t\t\t\tautoplay loop controls\n\t\t\t>\n\t\t\t</audio>`));\n\t\tthis.model.set('imageExpanded', true);\n\t}\n});\n\n// Expand all images\nconst ExpanderModel = Backbone.Model.extend({\n\tinitialize() {\n\t\t$threads.on('click', '#expandImages', e => {\n\t\t\te.preventDefault();\n\t\t\tthis.toggle();\n\t\t});\n\t},\n\ttoggle() {\n\t\tconst expand = !this.get('expand');\n\t\tthis.set('expand', expand).massToggle(expand);\n\t\t$threads\n\t\t\t.find('#expandImages')\n\t\t\t.text(main.lang.expander[+expand]);\n\t},\n\t// More efficent than individual listeners\n\tmassToggle(expand) {\n\t\tconst fit = options.get('inlinefit');\n\t\tif (fit === 'none')\n\t\t\treturn;\n\t\tlet models = state.posts.models;\n\t\tfor (let i = 0, l = models.length; i < l; i++) {\n\t\t\tlet model = models[i],\n\t\t\t\timg = model.get('image');\n\t\t\tif (!img)\n\t\t\t\tcontinue;\n\t\t\tif (expand)\n\t\t\t\tmodel.dispatch('fitImage', img, fit);\n\t\t\telse\n\t\t\t\tmodel.dispatch('renderImage', null, img);\n\t\t}\n\t}\n});\n\nconst massExpander = exports.massExpander = new ExpanderModel();\nmain.reply('massExpander:unset', () => massExpander.unset());\n\n// Proxy image clicks to views. More performant than dedicated listeners for\n// each view.\n$threads.on('click', 'img, video', function(e) {\n\tif (options.get('inlinefit') == 'none' || e.which !== 1)\n\t\treturn;\n\tlet model = util.getModel(e.target);\n\tif (!model)\n\t\treturn;\n\te.preventDefault();\n\n\t// Remove image hover preview, if any\n\tmain.request('imager:clicked');\n\tmodel.dispatch('toggleImageExpansion', !model.get('imageExpanded'),\n\t\tmodel.get('image'), true);\n});\n\n// Reveal/hide thumbnail by clicking [Show]/[Hide] in hidden thumbnail mode\n$threads.on('click', '.imageToggle', function(e) {\n\te.preventDefault();\n\tlet model = util.getModel(e.target);\n\tif (!model)\n\t\treturn;\n\tmain.follow(() =>\n\t\tmodel.dispatch('renderImage', !model.get('thumbnailRevealed')));\n});\n","/*\nExports submodules from the posts module\n */\n\nmodule.exports = {\n\timager: require('./imager'),\n\tMenu: require('./menu'),\n\tcommon: require('./common'),\n\tArticle: require('./article'),\n\tSection: require('./section'),\n\tmodels: require('./models'),\n\tnonce: require('./nonce'),\n\tembed: require('./embed'),\n\tposting: require('./posting')\n};\n","/*\n Post action header dropdown menu\n */\n\nconst main = require('../main'),\n\t{$, _, Backbone, common, util, lang, state} = main;\n\nconst MenuView = module.exports = Backbone.View.extend({\n\tclassName: 'popup-menu glass',\n\ttagName: 'ul',\n\t// Post menu items\n\tactions: ['report', 'hide'],\n\tevents: {\n\t\tclick: 'handleClick'\n\t},\n\tinitialize({parent}) {\n\t\tparent._popup_menu = this;\n\t\tthis.parent = parent;\n\t\tthis.render();\n\t},\n\trender() {\n\t\tlet html = '';\n\t\tfor (let action of this.actions) {\n\t\t\thtml += `<li data-type=\"${action}\">${lang[action]}</li>`\n\t\t}\n\t\tconst {el, parent} = this;\n\t\tel.innerHTML = html;\n\t\tparent.append(el);\n\n\t\t// Calculate position. Can't use CSS translate, because it shifts\n\t\t// the background.\n\t\tel.style.left = el.getBoundingClientRect().left\n\t\t\t- (util.outerWidth(el) + el.offsetWidth) * 0.6\n\t\t\t+ 'px';\n\t},\n\t// Forward post model to appropriate handler\n\thandleClick(e) {\n\t\te.stopPropagation();\n\t\tmain.request(e.target.getAttribute('data-type'), this.model);\n\t\tthis.remove();\n\t},\n\tremove() {\n\t\tthis.parent._popup_menu = null;\n\t\tthis.el.remove();\n\t\tthis.stopListening();\n\t}\n});\n\nmain.reply('menu:extend', action =>\n\t_.extend(MenuView.prototype.actions, action));\n\nmain.$threads.on('click', '.control', event => {\n\tconst {target} = event;\n\n\t// Menu already exists on the element. Remove it instead.\n\tif (target._popup_menu)\n\t\treturn target._popup_menu.remove();\n\n\tconst model = util.getModel(target);\n\tif (model)\n\t\tnew MenuView({parent: target, model});\n});\n","/*\nGeneral post backbone models\n */\n\nlet main = require('../main'),\n\t{_, Backbone, state} = main;\n\nexports.Post = Backbone.Model.extend({\n\tidAttribute: 'num',\n\tinitialize() {\n\t\tstate.posts.add(this);\n\t},\n\t// Proxy commands to the view(s). Using a central channel helps us reduce\n\t// listener count overhead.\n\tdispatch(command, ...args) {\n\t\tthis.trigger('dispatch', command, ...args);\n\t},\n\tremove() {\n\t\t// Remove view\n\t\tthis.stopListening().dispatch('remove');\n\t\t// Remove from post collection\n\t\tstate.posts.remove(this);\n\t},\n\tupdate(frag, links, dice) {\n\t\tconst updates = {\n\t\t\tbody: this.get('body') + frag\n\t\t};\n\t\tif (links)\n\t\t\t_.extend(this.get('links'), links);\n\t\tif (dice)\n\t\t\tupdates.dice = (this.get('dice') || []).concat(dice);\n\t\tthis.set(updates);\n\t},\n\t// Calling a method is always less overhead than binding a dedicated\n\t// listener for each post's image\n\tsetImage(image, silent) {\n\t\tthis.set('image', image);\n\t\tif (!silent)\n\t\t\tthis.dispatch('renderImage', image);\n\t},\n\tsetSpoiler(spoiler, info) {\n\t\tlet image = this.get('image');\n\t\timage.spoiler = spoiler;\n\t\tthis.dispatch('renderImage', image);\n\t\tthis.moderationInfo(info);\n\t},\n\tremoveImage(info) {\n\t\t// Staff won't have the image removed, but rerendered with\n\t\t// indication, that it has been deleted and extra information\n\t\tthis.moderationInfo(info) \n\t\t\t|| this.unset('image').dispatch('renderImage');\n\t},\n\tdeletePost(info) {\n\t\tthis.moderationInfo(info) || this.remove();\n\t},\n\tsetBan(display, info) {\n\t\t// Displaying the 'USER WAS BANNED FOR THIS POST' message and\n\t\t// renderring the moderation info are independant actions\n\t\tif (display)\n\t\t\tthis.set('ban', true).dispatch('renderBan');\n\t\tthis.moderationInfo(info);\n\t},\n\taddBacklink(num, op) {\n\t\tlet backlinks = this.get('backlinks') || {};\n\t\tbacklinks[num] = op;\n\t\tthis.set({backlinks})\n\t\t\t.dispatch('renderBacklinks', backlinks);\n\t},\n\t// Add info about the moderation action taken. This is only used on\n\t// authenticated staff clients, but for sanity, lets keep it here in\n\t// common model methods.\n\tmoderationInfo(info) { \n\t\tif (!info)\n\t\t\treturn false;\n\t\tconst mod = this.get('mod') || [];\n\t\tmod.push(info);\n\t\tthis.set('mod', mod)\n\t\t\t.dispatch('renderModerationInfo', mod);\n\t\treturn true;\n\t}\n});\n\nexports.Thread = exports.Post.extend({\n\tdefaults: {\n\t\treplies: [],\n\t\tomit: 0,\n\t\timage_omit: 0\n\t},\n\tinitialize() {\n\t\t// Omitted images can only be calculated, if there are omitted posts\n\t\tif (this.get('omit'))\n\t\t\tthis.getImageOmit();\n\t\tstate.posts.add(this);\n\t},\n\tremove() {\n\t\tthis.stopListening().dispatch('remove');\n\t\tstate.posts.remove(this);\n\n\t\t// Propagate model removal to all replies\n\t\tconst replies = this.get('replies');\n\t\tfor (let i = 0, lim = replies.length; i < lim; i++) {\n\t\t\tlet model = state.posts.get(replies[i]);\n\t\t\tif (model)\n\t\t\t\tmodel.remove();\n\t\t}\n\t},\n\t/*\n\t With the current renderring and storage implementations we can not get the\n\t image omit count during the server-side render.\n\t */\n\tgetImageOmit() {\n\t\tlet image_omit = this.get('imgctr') -1;\n\t\tconst replies = this.get('replies');\n\n\t\tfor (let i = 0, lim = replies.length; i < lim; i++) {\n\t\t\tlet model = state.posts.get(replies[i]);\n\t\t\tif (!model)\n\t\t\t\tcontinue;\n\t\t\tif (model.get('image'))\n\t\t\t\timage_omit--;\n\t\t}\n\t\tthis.set('image_omit', image_omit);\n\t},\n\ttoggleLocked(val, info) {\n\t\tthis.moderationInfo(info);\n\t\tthis.set('locked', val).dispatch('renderLocked', val);\n\t}\n});\n","/*\nCryptographic nonces for websocket transactions\n */\n\nlet main = require('../main'),\n\t{common, state} = main;\n\nlet nonceCache = {};\n\nfunction get() {\n\tvar nonces;\n\tif (window.localStorage) {\n\t\ttry {\n\t\t\tnonces = JSON.parse(localStorage.postNonces);\n\t\t}\n\t\tcatch (e) {}\n\t}\n\telse\n\t\tnonces = nonceCache;\n\treturn nonces || {};\n}\nmain.reply('nonce:get', get);\n\nfunction save_nonces(nonces) {\n\tif (window.localStorage)\n\t\tlocalStorage.postNonces = JSON.stringify(nonces);\n\telse\n\t\tnonceCache = nonces;\n}\n\nfunction today_id() {\n\treturn Math.floor(Date.now() / (1000*60*60*24));\n}\n\nfunction create() {\n\tconst nonces = get(),\n\t\tnonce = common.randomID(32);\n\tnonces[nonce] = {\n\t\ttab: state.page.get('tabID'),\n\t\tday: today_id()\n\t};\n\tsave_nonces(nonces);\n\treturn nonce;\n}\nmain.reply('nonce:create', create);\n\n// Expire old nonces\nsetTimeout(function() {\n\tif (!window.localStorage)\n\t\treturn;\n\t// we need a lock on postNonces really\n\tlet nonces = get();\n\n\t// people messing with their system clock will mess with expiry, doh\n\tlet changed;\n\tconst yesterday = today_id() - 1;\n\tfor (let nonce in nonces) {\n\t\tif (nonces[nonce].day >= yesterday)\n\t\t\tcontinue;\n\t\tdelete nonces[nonce];\n\t\tchanged = true;\n\t}\n\n\tif (changed)\n\t\tsave_nonces(nonces);\n}, Math.floor(Math.random()*5000));\n\nfunction destroy(nonce) {\n\t// delete only after a delay so all tabs notice that it's ours\n\tsetTimeout(function() {\n\t\tlet nonces = get();\n\t\tif (!nonces[nonce])\n\t\t\treturn;\n\t\tdelete nonces[nonce];\n\t\tsave_nonces(nonces);\n\t}, 10000);\n}\nmain.reply('nonce:destroy', destroy);\n","/*\n * Evertything related to writing and commiting posts\n */\n\nconst Article = require('./article'),\n\tmain = require('../main'),\n\tembed = require('./embed'),\n\tident = require('./identity'),\n\timager = require('./imager'),\n\t{$, _, Backbone, Cookie, common, config, connSM, util, lang, oneeSama,\n\t\toptions, postSM, state} = main;\n\nlet postForm, postModel;\n/*\n The variable gets overwritten, so a simple refference will not do. Calling a\n fucntion to retrieve the var each time solves the problem.\n */\nmain.reply('postForm', () => postForm)\n\t.reply('postModel', () => postModel)\n\t.reply('postForm:indentity', () => postForm && postForm.renderIdentity());\n\n// Minimal size of the input buffer\nlet\tinputMinSize = 300;\n// For mobile\nif (window.screen && screen.width <= 320)\n\tinputMinSize = 50;\n\nconst ComposerModel = Backbone.Model.extend({idAttribute: 'num'});\n\n// Synchronyse postform state with websocket connectivity\nconnSM.on('synced', postSM.feeder('sync'));\nconnSM.on('dropped', postSM.feeder('desync'));\nconnSM.on('desynced', postSM.feeder('desync'));\n\n// Allow remotely altering posting FSM state\nmain.reply('postSM:feed', state => postSM.feed(state));\n\npostSM.act('* + desync -> none', () => {\n\t// TODO: Desync logic\n\tif (postForm) {\n\t\tpostForm.el.classList.remove('editing');\n\t\tpostForm.$input.val('');\n\t\tpostForm.finish();\n\t}\n\tmain.$threads.find('aside.posting').hide();\n});\n\npostSM.act('none + sync, draft, alloc + done -> ready', () => {\n\t// TODO: Add unfinished post checking\n\n\tif (postForm) {\n\t\tpostForm.remove();\n\t\tpostForm = postModel = null;\n\t}\n\tfor (let el of main.$threads[0].queryAll('aside.posting')) {\n\t\tel.style.display = '';\n\t}\n});\n\n// Make new postform\npostSM.act('ready + new -> draft', aside => {\n\tlet op,\n\t\tsection = aside.closest('section');\n\tif (section)\n\t\top = util.getNum(section);\n\telse\n\t\tsection = document.createElement('section');\n\n\t// Shift OP's replies on board pages\n\tif (op && !state.page.get('thread'))\n\t\tstate.posts.get(op).dispatch('shiftReplies', true);\n\n\tpostForm = new ComposerView({\n\t\tmodel: postModel = new ComposerModel({op}),\n\t\tdestination: aside,\n\t\tsection\n\t});\n});\n\npostSM.preflight('draft', aside => aside.matches('aside'));\n\npostSM.act('draft + alloc -> alloc', msg => postForm.onAllocation(msg));\n\n// Render image upload status messages\nmain.dispatcher[common.IMAGE_STATUS] = msg =>\n\tpostForm && postForm.dispatch(msg[0]);\n\nmain.$doc.on('click', 'aside.posting a', function () {\n\tpostSM.feed('new', this.parentNode);\n});\n\nmain.$doc.on('keydown', handle_shortcut);\n\nfunction handle_shortcut(event) {\n\tif (!event.altKey)\n\t\treturn;\n\n\tconst opts = options.attributes;\n\tswitch(event.which) {\n\t\tcase opts.new:\n\t\t\tconst aside = document.query('aside.posting');\n\t\t\tif (aside) {\n\t\t\t\tpostSM.feed('new', aside);\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\tcase opts.togglespoiler:\n\t\t\tif (postForm) {\n\t\t\t\tpostForm.onToggle(event);\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\tcase opts.done:\n\t\t\tif (postForm && !postForm.$submit.attr('disabled')) {\n\t\t\t\tpostForm.finish();\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\t// Insert text spoiler\n\t\tcase opts.textSpoiler:\n\t\t\tif (postForm) {\n\t\t\t\tvar postState = this.imouto.state2.spoiler;\n\t\t\t\t// Was spoiler already started?\n\t\t\t\tvar sp = (postState ? '[/' : ' [') + 'spoiler]';\n\t\t\t\tthis.imouto.state2.spoiler = !postState;\n\t\t\t\tthis.$input.val(this.$input.val() + sp);\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\tcase opts.expandAll:\n\t\t\timager.massExpander.toggle();\n\t\t\tprevent();\n\t\t\tbreak;\n\t\tcase opts.workMode:\n\t\t\tconst val = main.oneeSama.workMode = !main.oneeSama.workMode;\n\t\t\tCookie.set('workModeTOG', val);\n\t\t\tconst banner = document.querySelector(\"h1 > img\");\n\t\t\tif(banner!=null)\n\t\t\t\tbanner.style.display =  val? 'none':'';\n\t\t\tdocument.getElementById('theme').setAttribute('href',\n\t\t\t\t\t`${config.MEDIA_URL}css/${val? state.hotConfig.get('DEFAULT_CSS'): main.options.get(\"theme\")}.css?v=${main.cssHash}`);\n\t\t\toneeSama.thumbStyle = val? 'hide': main.options.get('thumbs');\n\t\t\tmain.options.trigger(\"workModeTOG\");\n\t\t\twindow.addEventListener('beforeunload', function () {\n\t\t\t\tCookie.set(\"workModeTOG\",false);\n\t\t\t});\n\t\t\tprevent()\n\t\t\tbreak;\n\t}\n\n\tfunction prevent() {\n\t\tevent.stopImmediatePropagation();\n\t\tevent.preventDefault();\n\t}\n}\n\n// TODO: Unify self-updates with OneeSama; this is redundant\nmain.oneeSama.hook('insertOwnPost', ({links}) => {\n\tif (!postForm || !links)\n\t\treturn;\n\tpostForm.$buffer.find('.nope').each(function () {\n\t\tvar $a = $(this);\n\t\tconst text = $a.text(),\n\t\t\tm = text.match(/^>>(\\d+)/);\n\t\tif (!m)\n\t\t\treturn;\n\t\tconst num = m[1],\n\t\t\top = links[num];\n\t\tif (!op)\n\t\t\treturn;\n\t\tlet $ref = $(common.join([postForm.imouto.postRef(num, op, false)]));\n\t\t$a.attr('href', $ref.attr('href')).attr('class', 'history');\n\t\tconst refText = $ref.text();\n\t\tif (refText != text)\n\t\t\t$a.text(refText);\n\t});\n});\n\nconst ArticleComposer = Article.extend({\n\tevents: {\n\t\t'click #cancel': 'cancel',\n\t\t'change #imageInput': 'onImageChosen',\n\t\t'input #trans': 'onInput',\n\t\t'keydown #trans': 'onKeyDown',\n\t\t'click #done': 'finish',\n\t\t'click #toggle': 'onToggle'\n\t},\n\tinitialize(args) {\n\t\t// super() call\n\t\tArticle.prototype.initialize.call(this);\n\t\tthis.listenTo(this.model, {\n\t\t\t'change': this.renderButtons,\n\t\t\t'change:spoiler': this.renderSpoilerPane\n\t\t});\n\t\tthis.render(args).insertIntoDOM(args);\n\t\tthis.model.set({\n\t\t\tspoiler: 0,\n\t\t\tnextSpoiler: -1\n\t\t});\n\n\t\tthis.pending = '';\n\t\tthis.line_count = 1;\n\t\tthis.char_count = 0;\n\n\t\t// Initialize the form's private rendering singleton instance\n\t\tconst imouto = this.imouto = new common.OneeSama({\n\t\t\tcallback: inject,\n\t\t\top: state.page.get('thread'),\n\t\t\tblockqoute: this.blockqoute,\n\t\t\teLinkify: main.oneeSama.eLinkify,\n\t\t\tlang: main.lang,\n\t\t\ttamashii(num) {\n\t\t\t\tlet section = document.query('#p' + num);\n\t\t\t\tsection = section && section.closest('section');\n\t\t\t\tif (section) {\n\t\t\t\t\tconst desc = num in state.mine.readAll() && lang.you;\n\t\t\t\t\treturn this.postRef(num, util.getNum(section), desc);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\treturn `<a class=\"nope\">&gt;&gt;${num}</a>`;\n\t\t\t}\n\t\t});\n\t\timouto.setModel(this.model);\n\t},\n\t// Initial render\n\trender() {\n\t\t// Define attributes separatly for readbility\n\t\tconst attrs = {\n\t\t\tinput: {\n\t\t\t\tname: 'body',\n\t\t\t\tid: 'input',\n\t\t\t\trows: 1,\n\t\t\t\tclass: 'themed exclude',\n\t\t\t\tautocomplete: main.isMobile\n\t\t\t},\n\t\t\tform: {\n\t\t\t\tmethod: 'post',\n\t\t\t\tenctype: 'multipart/form-data',\n\t\t\t\ttarget: 'upload',\n\t\t\t\tid: 'uploadForm'\n\t\t\t},\n\t\t\tcancel: {\n\t\t\t\ttype: 'buttom',\n\t\t\t\tvalue: lang.cancel,\n\t\t\t\tid: 'cancel'\n\t\t\t},\n\t\t\timageInput: {\n\t\t\t\ttype:'file',\n\t\t\t\tid: 'imageInput',\n\t\t\t\tname: 'image',\n\t\t\t\taccept: 'image/*;.webm;.pdf;.mp3'\n\t\t\t},\n\t\t\ttoggle: {\n\t\t\t\ttype: 'button',\n\t\t\t\tid: 'toggle'\n\t\t\t}\n\t\t};\n\n\t\tthis.el.innerHTML = parseHTML\n\t\t\t`<header>\n\t\t\t\t<a class=\"name nope\" target=\"_blank\">\n\t\t\t\t\t<b></b>\n\t\t\t\t</a>\n\t\t\t</header>\n\t\t\t<span class=\"oi control\" data-glyph=\"chevron-bottom\"></span>\n\t\t\t<div class=\"container\">\n\t\t\t\t<blockquote>\n\t\t\t\t\t<p id=\"buffer\" class=\"exclude\"></p>\n\t\t\t\t\t<p id=\"lineBuffer\" class=\"exclude\"></p>\n\t\t\t\t\t<textarea ${attrs.input}></textarea>\n\t\t\t\t</blockquote>\n\t\t\t\t<form ${attrs.form}>\n\t\t\t\t\t<input ${attrs.cancel}>\n\t\t\t\t\t<input ${attrs.imageInput}>\n\t\t\t\t\t<input ${attrs.toggle}>\n\t\t\t\t\t<strong id=\"uploadStatus\"></strong>\n\t\t\t\t</form>\n\t\t\t\t<small></small>\n\t\t\t</div>`;\n\n\t\t// Cache elements to avoid lookup\n\t\tconst els = ['buffer', 'lineBuffer', 'input', 'uploadForm', 'cancel',\n\t\t\t'imageInput', 'toggle', 'uploadStatus', 'hiddenUpload', 'sizer'];\n\t\tfor (let el of els) {\n\t\t\tthis[el] = document.query('#' + el);\n\t\t}\n\t\tthis.renderIdentity();\n\t\treturn this;\n\t},\n\t// Name, emaail and tripcode field\n\trenderIdentity() {\n\t\t// Model has already been alocated and has a proper identity rendered\n\t\tif (this.model.get('num'))\n\t\t\treturn;\n\t\tconst parsed = common.parse_name(main.$name.val(), main.$email.val()),\n\t\t\thaveTrip = !!(parsed[1] || parsed[2]);\n\t\tconst el = this.el.query('.name'),\n\t\t\tname = el.query('a');\n\t\tif (parsed[0])\n\t\t\tname.textContent = parsed[0] + ' ';\n\t\telse\n\t\t\tname.tetxContent = haveTrip ? '' : lang.anon;\n\t\tif (haveTrip)\n\t\t\tutil.parseDOM(' <code>!?</code>').forEach(el => name.after(el));\n\n\t\t// Insert staff title\n\t\tmain.oneeSama.trigger('fillMyName', name);\n\t\tconst email = main.$email.val().trim();\n\t\tif (email) {\n\t\t\tel.setAttribute('href', 'mailto:' + email);\n\t\t\tel.classList.remove('nope');\n\t\t\tel.classList.add('email');\n\t\t}\n\t\telse {\n\t\t\tel.removeAttribute('href');\n\t\t\tel.classList.add('nope');\n\t\t\tel.classList.remove('email');\n\t\t}\n\t},\n\tinsertIntoDOM({destination}) {\n\t\tdestination.before(this.el);\n\t\tthis.resizeInput();\n\t\tmain.$threads.queryAll('aside.postsing').forEach(el =>\n\t\t\tel.style.display = 'none');\n\t\tthis.fun();\n\t},\n\t/*\n\t Allows keeping the input buffer sized as if the text was monospace,\n\t without actually displaying monospace font. Keeps the input buffer from\n\t shifting around needlessly.\n\t */\n\tresizeInput(val) {\n\t\tconst {sizer, input} = this;\n\t\tif (typeof val !== 'string')\n\t\t\tval = input.value;\n\t\tsizer.textContent = val;\n\t\tlet size = sizer.width + common.INPUT_ROOM;\n\t\tsize = Math.max(size, inputMinSize\n\t\t\t- input.getBoundingClientRect().left\n\t\t\t- this.el.getBoundingClientRect().left);\n\t\tthis.input.style.width = size + 'px';\n\t},\n\trenderButtons() {\n\t\tconst {num, uploading, uploaded, uploadStatus, sentAllocRequest}\n\t\t\t= this.model.attributes;\n\t\tconst allocWait = sentAllocRequest && !num;\n\t\tthis.submit.disabled = !!(uploading || allocWait);\n\t\tif (uploaded)\n\t\t\tthis.submit.style.marginLeft = 0;\n\t\tthis.cancel.disabled = !!allocWait;\n\t\tthis.cancel.style.display = (!num || uploading) ? '' : 'none';\n\t\tthis.imageInput.disabled = !!uploading;\n\t\tthis.uploadStatus.innerHTML = uploadStatus;\n\t},\n\trenderSpoilerPane(model, spoiler) {\n\t\tconst background = spoiler\n\t\t\t? `${config.MEDIA_URL}spoil/spoil${spoiler}.png`\n\t\t\t: config.MEDIA_URL + 'css/ui/pane.png';\n\t\tthis.toggle.style.backgroundImage = `url(\"${background}\")`;\n\t}\n});\n\nconst ComposerView = Backbone.View.extend({\n\tevents: {\n\t\t'input #trans': 'onInput',\n\t\t'keydown #trans': 'onKeyDown',\n\t\t'click #done': 'finish',\n\t\t'click #toggle': 'onToggle'\n\t},\n\tinitialize(args) {\n\t\tthis.listenTo(this.model, {\n\t\t\t'change': this.renderButtons,\n\t\t\t'change:spoiler': this.renderSpoilerPane\n\t\t});\n\n\t\tthis.render(args);\n\n\t\tthis.pending = '';\n\t\tthis.line_count = 1;\n\t\tthis.char_count = 0;\n\n\t\t// Initialize the form's private rendering singleton instance\n\t\tlet imouto = this.imouto = new common.OneeSama({\n\t\t\tcallback: inject,\n\t\t\top: state.page.get('thread'),\n\t\t\tstate: [common.S_BOL, 0],\n\n\t\t\t// TODO: Convert current OneeSama.state array to more flexible\n\t\t\t// object\n\t\t\tstate2: {spoiler: 0},\n\t\t\t$buffer: this.$buffer,\n\t\t\teLinkify: main.oneeSama.eLinkify,\n\t\t\tlang: main.lang,\n\t\t\ttamashii(num) {\n\t\t\t\tlet section = document.query('#p' + num);\n\t\t\t\tsection = section && section.closest('section');\n\t\t\t\tif (section) {\n\t\t\t\t\tconst desc = num in state.mine.readAll() && this.lang.you;\n\t\t\t\t\treturn this.postRef(num, util.getNum(section), desc);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\treturn `<a class=\"nope\">&gt;&gt;${num}</a>`;\n\t\t\t}\n\t\t});\n\t\timouto.hook('spoilerTag', util.touchable_spoiler_tag);\n\t\tmain.oneeSama.trigger('imouto', imouto);\n\t},\n\t// Initial render\n\trender({destination, section}) {\n\t\tconst op = this.model.get('op');\n\t\tthis.setElement((op ? document.createElement('article') : section));\n\n\t\t// A defined op means the post is a reply, not a new thread\n\t\tthis.isThread = !op;\n\n\t\tthis.$buffer = $('<p/>');\n\t\tthis.$lineBuffer = $('<p/>');\n\t\tthis.$meta = $('<header><a class=\"nope\"><b/></a> <time/></header>');\n\t\tthis.$input = $('<textarea/>', {\n\t\t\tname: 'body',\n\t\t\tid: 'trans',\n\t\t\trows: '1',\n\t\t\tclass: 'themed',\n\t\t\tautocomplete: main.isMobile\n\t\t});\n\t\tthis.$submit = $('<input/>', {\n\t\t\tid: 'done',\n\t\t\ttype: 'button',\n\t\t\tvalue: main.lang.done\n\t\t});\n\t\tthis.$subject = $('<input/>', {\n\t\t\tid: 'subject',\n\t\t\tclass: 'themed',\n\t\t\tmaxlength: state.hotConfig.SUBJECT_MAX_LENGTH,\n\t\t\twidth: '80%'\n\t\t});\n\t\tthis.$blockquote = $('<blockquote/>');\n\n\t\t/*\n\t\t Allows keeping the input buffer sized as if the text was monospace,\n\t\t without actually displaying monospace font. Keeps the input buffer from\n\t\t shifting around needlessly.\n\t\t */\n\t\tthis.$sizer = $('<pre/>').appendTo('body');\n\n\t\tthis.$blockquote.append(this.$buffer, this.$lineBuffer, this.$input);\n\t\tthis.$el.append(this.$meta, this.$blockquote, '<small/>');\n\t\tif (this.isThread) {\n\t\t\tthis.$el.append(`<label for=\"subject\">${lang.subject}: </label>`,\n\t\t\t\tthis.$subject);\n\t\t\tthis.$blockquote.hide();\n\t\t}\n\t\tthis.$uploadForm = this.renderUploadForm();\n\t\tthis.$el.append(this.$uploadForm);\n\n\t\t// Add a menu to the postform\n\t\tmain.oneeSama.trigger('draft', this.$el);\n\t\tthis.renderIdentity();\n\n\t\t// Insert into the DOM\n\t\tdestination.style.display = 'none';\n\t\tif (this.isThread) {\n\t\t\tdestination.after(this.el);\n\t\t\tthis.el.after(document.createElement('hr'));\n\t\t\tthis.$subject.focus();\n\t\t}\n\t\telse {\n\t\t\tdestination.before(this.el);\n\t\t\tthis.resizeInput();\n\t\t\tthis.$input.focus();\n\t\t}\n\n\t\tmain.$threads.find('aside.posting').hide();\n\t\tthis.fun();\n\t},\n\t// Render the name, email, and admin title, if any\n\trenderIdentity() {\n\t\t// Model has already been alocated and has a proper identity rendered\n\t\tif (this.model.get('num'))\n\t\t\treturn;\n\t\tconst parsed = common.parse_name(main.$name.val(), main.$email.val()),\n\t\t\thaveTrip = !!(parsed[1] || parsed[2]);\n\t\tlet $b = this.$meta.find('b');\n\t\tif (parsed[0])\n\t\t\t$b.text(parsed[0] + ' ');\n\t\telse\n\t\t\t$b.text(haveTrip ? '' : main.lang.anon);\n\t\tif (haveTrip)\n\t\t\t$b.append(' <code>!?</code>');\n\t\t\n\t\t// Insert staff title\n\t\tmain.oneeSama.trigger('fillMyName', $b);\n\t\tconst email = main.$email.val().trim();\n\t\tlet $tag = this.$meta.children('a').first();\n\t\tif (email) {\n\t\t\t$tag.attr({\n\t\t\t\thref: 'mailto:' + email,\n\t\t\t\ttarget: '_blank',\n\t\t\t\tclass: 'email'\n\t\t\t});\n\t\t}\n\t\telse\n\t\t\t$tag.removeAttr('href').removeAttr('target').attr('class', 'nope');\n\t},\n\trenderButtons() {\n\t\tconst attrs = this.model.attributes,\n\t\t\tallocWait = attrs.sentAllocRequest && !attrs.num,\n\t\t\td = attrs.uploading || allocWait;\n\t\t// Beware of undefined!\n\t\tthis.$submit.prop('disabled', !!d);\n\t\tif (attrs.uploaded)\n\t\t\tthis.$submit.css({'margin-left': '0'});\n\t\tthis.$cancel.prop('disabled', !!allocWait);\n\t\tthis.$cancel.toggle(!!(!attrs.num || attrs.uploading));\n\t\tthis.$imageInput.prop('disabled', !!attrs.uploading);\n\t\tthis.$uploadStatus.html(attrs.uploadStatus);\n\t},\n\trenderSpoilerPane(model, sp) {\n\t\tconst background = sp ? `${config.MEDIA_URL}spoil/spoil${sp}.png`\n\t\t\t: config.MEDIA_URL + 'css/ui/pane.png';\n\t\tthis.$toggle.css('background-image', `url(\"${background}\")`);\n\t},\n\trenderUploadForm() {\n\t\tvar $form = $('<form method=\"post\" enctype=\"multipart/form-data\" '\n\t\t\t+ 'target=\"upload\"></form>');\n\t\tthis.$cancel = $('<input/>', {\n\t\t\ttype: 'button',\n\t\t\tvalue: lang.cancel,\n\t\t\tclick: $.proxy(this, 'cancel')\n\t\t});\n\t\tthis.$imageInput = $('<input/>', {\n\t\t\ttype: 'file',\n\t\t\tid: 'image',\n\t\t\tname: 'image',\n\t\t\taccept: config.WEBM ? 'imager/*;.webm' : 'image/*',\n\t\t\tchange: $.proxy(this, 'onImageChosen')\n\t\t});\n\t\tthis.$toggle = $('<input/>', {\n\t\t\ttype: 'button',\n\t\t\tid: 'toggle'\n\t\t});\n\t\tthis.$uploadStatus = $('<strong/>');\n\t\t$form.append(this.$cancel,\n\t\t\tthis.$imageInput,\n\t\t\tthis.$toggle, ' ',\n\t\t\tthis.$uploadStatus);\n\t\tthis.$iframe = $('<iframe/>', {\n\t\t\tsrc: '',\n\t\t\tname: 'upload',\n\t\t\tid: 'hidden-upload'\n\t\t}).appendTo('body');\n\t\tthis.model.set({\n\t\t\tspoiler: 0,\n\t\t\tnextSpoiler: -1\n\t\t});\n\t\treturn $form;\n\t},\n\t// Cancel file upload\n\tcancel() {\n\t\tif (this.model.get('uploading')) {\n\t\t\tthis.$iframe.remove();\n\t\t\tthis.$iframe = $('<iframe></iframe>', {\n\t\t\t\tsrc: '',\n\t\t\t\tname: 'upload',\n\t\t\t\tid: 'hidden-upload'\n\t\t\t}).appendTo('body');\n\t\t\tthis.uploadError('');\n\t\t\tthis.model.set({cancelled: true});\n\t\t}\n\t\telse\n\t\t\tthis.finish();\n\t},\n\tonImageChosen() {\n\t\tif (this.model.get('uploading') || this.model.get('uploaded'))\n\t\t\treturn;\n\t\tif (!this.$imageInput.val()) {\n\t\t\tthis.model.set('uploadStatus', '');\n\t\t\treturn;\n\t\t}\n\t\tconst extra = this.prepareUpload();\n\t\tfor (var k in extra) {\n\t\t\t$('<input type=hidden>')\n\t\t\t\t.attr('name', k)\n\t\t\t\t.val(extra[k])\n\t\t\t\t.appendTo(this.$uploadForm);\n\t\t}\n\t\tthis.$uploadForm.prop('action', util.uploadURL());\n\t\tthis.$uploadForm.submit();\n\t\tthis.$iframe.load(function() {\n\t\t\tif (!postForm)\n\t\t\t\treturn;\n\t\t\tvar doc = this.contentWindow || this.contentDocument;\n\t\t\tif (!doc)\n\t\t\t\treturn;\n\t\t\ttry {\n\t\t\t\tvar error = $(doc.document || doc).text();\n\t\t\t\t/*\n\t\t\t\t if it's a real response, it'll postMessage to us, so we don't have\n\t\t\t\t to do anything.\n\t\t\t\t */\n\t\t\t\tif (/legitimate imager response/.test(error))\n\t\t\t\t\treturn;\n\t\t\t\t// sanity check for weird browser responses\n\t\t\t\tif (error.length < 5 || error.length > 100)\n\t\t\t\t\terror = lang.unknownUpload;\n\t\t\t\tpostForm.uploadError(error);\n\t\t\t}\n\t\t\tcatch(e) {\n\t\t\t\t/*\n\t\t\t\t likely cross-origin restriction\n\t\t\t\t wait before erroring in case the message shows up\n\t\t\t\t */\n\t\t\t\tsetTimeout(function() {\n\t\t\t\t\tpostForm.uploadFallbackMessage();\n\t\t\t\t}, 500);\n\t\t\t}\n\t\t});\n\t\tthis.notifyUploading();\n\t},\n\tprepareUpload() {\n\t\tthis.model.set('uploadStatus', lang.uploading);\n\t\tthis.$input.focus();\n\t\tconst attrs = this.model.attributes;\n\t\treturn {spoiler: attrs.spoiler, op: attrs.op || 0};\n\t},\n\t/*\n\t this is just a fallback message for when we can't tell, if there was an\n\t error due to cross-origin restrictions\n\t */\n\tuploadFallbackMessage() {\n\t\tvar a = this.model.attributes,\n\t\t\tstat = a.uploadStatus;\n\t\tif (!a.cancelled && a.uploading && (!stat || stat == lang.uploading))\n\t\t\tthis.model.set('uploadStatus', lang.unknownResult);\n\t},\n\tnotifyUploading() {\n\t\tthis.model.set({uploading: true, cancelled: false});\n\t\tthis.$input.focus();\n\t},\n\tresizeInput(val) {\n\t\tif (typeof val !== 'string')\n\t\t\tval = this.$input.val();\n\t\tthis.$sizer.text(val);\n\t\tvar size = this.$sizer.width() + common.INPUT_ROOM;\n\t\tsize = Math.max(size, inputMinSize\n\t\t\t- this.$input.offset().left - this.$el.offset().left);\n\t\tthis.$input.css('width', size + 'px');\n\t},\n\tonInput(val) {\n\t\tif (val === undefined || val instanceof $.Event)\n\t\t\tval = this.$input.val();\n\t\tvar start = this.$input[0].selectionStart,\n\t\t\tend = this.$input[0].selectionEnd;\n\n\t\tvar changed = false,\n\t\t\tm, time, video;\n\n\t\t// Turn YouTube links into proper refs\n\t\twhile(true) {\n\t\t\tm = val.match(embed.youtube_url_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\t// Substitute\n\t\t\ttime = this.findTimeArg(m[3])\n\t\t\t\t|| this.findTimeArg(m[1])\n\t\t\t\t|| m[4]\n\t\t\t\t|| '';\n\t\t\tvideo = '>>>/watch?v=' + m[2] + time;\n\t\t\tval = embedRewrite(m, video);\n\t\t}\n\n\t\t//Youtu.be links\n\t\twhile(true) {\n\t\t\tm = val.match(embed.youtube_short_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\t// Substitute\n\t\t\ttime = this.findTimeArg(m[2]) || '';\n\t\t\tvideo = '>>>/watch?v=' + m[1] + time;\n\t\t\tval = embedRewrite(m, video);\n\t\t}\n\n\t\t// SoundCloud links\n\t\twhile(true) {\n\t\t\tm = val.match(embed.soundcloud_url_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\tvar sc = '>>>/soundcloud/' + m[1];\n\t\t\tval = embedRewrite(m, sc);\n\t\t}\n\n\t\t// Pastebin links\n\t\twhile(true) {\n\t\t\tm = val.match(embed.pastebin_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\tvar pbin = '>>>/pastebin/' + m[1];\n\t\t\tval = embedRewrite(m, pbin);\n\t\t}\n\n\t\t// Rewite embedable URLs to native embed URL syntax\n\t\tfunction embedRewrite(m, rw) {\n\t\t\tvar old = m[0].length;\n\t\t\tvar newVal = val.substr(0, m.index) + rw + val.substr(m.index + old);\n\t\t\tchanged = true;\n\t\t\tif (m.index < start) {\n\t\t\t\tvar diff = old - rw.length;\n\t\t\t\tstart -= diff;\n\t\t\t\tend -= diff;\n\t\t\t}\n\t\t\treturn newVal;\n\t\t}\n\n\t\tif (changed)\n\t\t\tthis.$input.val(val);\n\n\t\tvar nl = val.lastIndexOf('\\n');\n\t\tif (nl >= 0) {\n\t\t\tvar ok = val.substr(0, nl);\n\t\t\tval = val.substr(nl + 1);\n\t\t\tthis.$input.val(val);\n\t\t\tif (this.model.get('sentAllocRequest') || /[^ ]/.test(ok))\n\t\t\t\tthis.commit(ok + '\\n');\n\t\t}\n\t\telse {\n\t\t\tm = val\n\t\t\t\t.split('')\n\t\t\t\t.reverse()\n\t\t\t\t.join('')\n\t\t\t\t.match(/^(\\s*\\S+\\s+\\S+)\\s+(?=\\S)/);\n\t\t\tif (m) {\n\t\t\t\tvar lim = val.length - m[1].length;\n\t\t\t\tthis.commit(val.substr(0, lim));\n\t\t\t\tval = val.substr(lim);\n\t\t\t\tstart -= lim;\n\t\t\t\tend -= lim;\n\t\t\t\tthis.$input.val(val);\n\t\t\t\tthis.$input[0].setSelectionRange(start, end);\n\t\t\t}\n\t\t}\n\n\t\tthis.$input.attr('maxlength', common.MAX_POST_CHARS - this.char_count);\n\t\tthis.resizeInput(val);\n\t},\n\tfindTimeArg(params) {\n\t\tif (!params || params.indexOf('t=') < 0)\n\t\t\treturn false;\n\t\tparams = params.split('&');\n\t\tfor (let i = 0, len = params.length; i < len; i++) {\n\t\t\tlet pair = '#p' + params[i];\n\t\t\tif (embed.youtube_time_re.test(pair))\n\t\t\t\treturn pair;\n\t\t}\n\t\treturn false;\n\t},\n\t// Commit any staged words to the server\n\tcommit(text) {\n\t\tvar lines;\n\t\tif (text.indexOf('\\n') >= 0) {\n\t\t\tlines = text.split('\\n');\n\t\t\tthis.line_count += lines.length - 1;\n\t\t\tconst breach = this.line_count - common.MAX_POST_LINES + 1;\n\t\t\tif (breach > 0) {\n\t\t\t\tfor (var i = 0; i < breach; i++)\n\t\t\t\t\tlines.pop();\n\t\t\t\ttext = lines.join('\\n');\n\t\t\t\tthis.line_count = common.MAX_POST_LINES;\n\t\t\t}\n\t\t}\n\t\tconst left = common.MAX_POST_CHARS - this.char_count;\n\t\tif (left < text.length)\n\t\t\ttext = text.substr(0, left);\n\t\tif (!text)\n\t\t\treturn;\n\t\tthis.char_count += text.length;\n\n\t\t// Either get an allocation or send the committed text\n\t\tconst attrs = this.model.attributes;\n\t\tif (!attrs.num && !attrs.sentAllocRequest) {\n\t\t\tmain.send([common.INSERT_POST, this.allocationMessage(text, null)]);\n\t\t\tthis.model.set({sentAllocRequest: true});\n\t\t}\n\t\telse if (attrs.num)\n\t\t\tmain.send(text);\n\t\telse\n\t\t\tthis.pending += text;\n\n\t\t// Add it to the user's display\n\t\tif (lines) {\n\t\t\tlines[0] = this.$lineBuffer.text() + lines[0];\n\t\t\tthis.$lineBuffer.text(lines.pop());\n\t\t\tfor (let o = 0, len = lines.length; o < len; o++)\n\t\t\t\tthis.imouto.fragment(lines[o] + '\\n');\n\t\t}\n\t\telse {\n\t\t\tthis.$lineBuffer.append(document.createTextNode(text));\n\t\t\tthis.$lineBuffer[0].normalize();\n\t\t}\n\t},\n\t// Construct the message for post allocation in the database\n\tallocationMessage(text, image) {\n\t\tvar msg = {nonce: main.request('nonce:create')};\n\n\t\tfunction opt(key, val) {\n\t\t\tif (val)\n\t\t\t\tmsg[key] = val;\n\t\t}\n\n\t\topt('name', main.$name.val().trim());\n\t\topt('email', main.$email.val().trim());\n\t\topt('subject', this.$subject.val().trim());\n\t\topt('frag', text);\n\t\topt('image', image);\n\t\topt('op', this.model.get('op'));\n\n\t\treturn msg;\n\t},\n\tonKeyDown(event) {\n\t\tmain.follow(() => {\n\t\t\tswitch(event.which) {\n\t\t\t\tcase 13:\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t// fall-through\n\t\t\t\tcase 32:\n\t\t\t\t\t// predict result\n\t\t\t\t\tvar input = this.$input[0];\n\t\t\t\t\tvar val = this.$input.val();\n\t\t\t\t\tval = val.slice(0, input.selectionStart)\n\t\t\t\t\t\t+ (event.which == 13 ? '\\n' : ' ')\n\t\t\t\t\t\t+ val.slice(input.selectionEnd);\n\t\t\t\t\tthis.onInput(val);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\thandle_shortcut.bind(this)(event);\n\t\t\t}\n\t\t});\n\t},\n\tfinish() {\n\t\tif (this.model.get('num')) {\n\t\t\tthis.flushPending();\n\t\t\tthis.commit(this.$input.val());\n\t\t\tthis.$input.remove();\n\t\t\tthis.$submit.remove();\n\t\t\tif (this.$uploadForm)\n\t\t\t\tthis.$uploadForm.remove();\n\t\t\tif (this.$iframe) {\n\t\t\t\tthis.$iframe.remove();\n\t\t\t\tthis.$iframe = null;\n\t\t\t}\n\t\t\tthis.imouto.fragment(this.$lineBuffer.text());\n\t\t\tthis.$buffer.replaceWith(this.$buffer.contents());\n\t\t\tthis.$lineBuffer.remove();\n\t\t\tthis.$blockquote.css({\n\t\t\t\t'margin-left': '', 'padding-left': ''\n\t\t\t}\n\t\t\t);\n\t\t\tmain.send([common.FINISH_POST]);\n\t\t\tthis.preserve = true;\n\t\t\tif (this.isThread)\n\t\t\t\tthis.$el.append(main.oneeSama.replyBox());\n\n\t\t\tlet missing = this.imouto.allRolls.sent - this.imouto.allRolls.seen;\n\t\t\t//if missing>0 we have to wait until insertOwnPosts \"sees\" the\n\t\t\t// dice\n\t\t\tif (missing > 0) {\n\t\t\t\tlet checkAgain;\n\t\t\t\t(checkAgain= (n) => {\n\t\t\t\t\tsetTimeout(()=> {\n\t\t\t\t\t\tif (this.imouto.allRolls.seen == this.imouto.allRolls.sent || n ==0)\n\t\t\t\t\t\t\tpostSM.feed('done');\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tcheckAgain(n - 1);\n\t\t\t\t\t}, 100);\n\t\t\t\t})(5); //retry 5 times\n\t\t\t}\n\t\t\telse\n\t\t\t\tpostSM.feed('done');\n\t\t}else\n\t\t\tpostSM.feed('done');\n\t},\n\t// Send any unstaged words\n\tflushPending() {\n\t\tif (this.pending) {\n\t\t\tmain.send(this.pending);\n\t\t\tthis.pending = '';\n\t\t}\n\t},\n\tonToggle(event) {\n\t\tconst attrs = this.model.attributes;\n\t\tif (attrs.uploading || attrs.uploaded)\n\t\t\treturn;\n\t\tevent.preventDefault();\n\t\tevent.stopImmediatePropagation();\n\t\tif (attrs.spoiler) {\n\t\t\tthis.model.set({spoiler: 0});\n\t\t\treturn;\n\t\t}\n\t\tconst pick = common.pick_spoiler(attrs.nextSpoiler);\n\t\tthis.model.set({\n\t\t\tspoiler: pick.index,\n\t\t\tnextSpoiler: pick.next\n\t\t});\n\t},\n\tonAllocation(msg) {\n\t\tconst num = msg.num;\n\t\tstate.ownPosts[num] = num;\n\t\tthis.model.set({num: num});\n\t\tthis.flushPending();\n\t\tvar header = $(main.oneeSama.header(msg));\n\t\tthis.$meta.replaceWith(header);\n\t\tthis.$meta = header;\n\t\tif (!this.isThread)\n\t\t\tthis.$el.addClass('editing');\n\n\t\t/*\n\t\t TODO: Hide threads that are over THREADS_PER_PAGE. Also would need to be\n\t\t removed from syncs client and server-side. Hmm.\n\t\t */\n\n\t\tthis.$el.attr('id', 'p' + num);\n\n\t\tif (msg.image)\n\t\t\tthis.insertUploaded(msg.image);\n\n\t\tif (this.$uploadForm)\n\t\t\tthis.$uploadForm.append(this.$submit);\n\t\telse\n\t\t\tthis.$blockquote.after(this.$submit);\n\t\tif (this.isThread) {\n\t\t\tthis.$subject.siblings('label').andSelf().remove();\n\t\t\tthis.$blockquote.show();\n\t\t\tthis.resizeInput();\n\t\t\tthis.$input.focus();\n\t\t}\n\n\t\t/*\n\t\t Ensures you are nagged at by the browser, when navigating away from an\n\t\t unfinished allocated post.\n\t\t */\n\t\twindow.onbeforeunload = function() {\n\t\t\treturn \"You have an unfinished post.\";\n\t\t};\n\t},\n\t// Insert an image that has been uploaded and processed by the server\n\tinsertUploaded(info) {\n\t\tthis.renderImage(null, info);\n\t\tthis.$imageInput\n\t\t\t.siblings('strong')\n\t\t\t.andSelf()\n\t\t\t.remove();\n\t\tthis.$cancel.remove();\n\t\tthis.$uploadForm.find('#toggle').remove();\n\t\tthis.flushPending();\n\t\tthis.model.set({\n\t\t\tuploading: false,\n\t\t\tuploaded: true,\n\t\t\tsentAllocRequest: true\n\t\t});\n\n\t\t// Stop obnoxious wrap-around-image behaviour\n\t\tvar $img = this.$el.find('img');\n\t\tthis.$blockquote.css({\n\t\t\t'margin-left': $img.css('margin-right'),\n\t\t\t'padding-left': $img.width()\n\t\t});\n\n\t\tthis.resizeInput();\n\t},\n\t// Handle image upload status\n\tdispatch(msg) {\n\t\tconst a = msg.arg;\n\t\tswitch(msg.t) {\n\t\t\tcase 'alloc':\n\t\t\t\tthis.onImageAllocation(a);\n\t\t\t\tbreak;\n\t\t\tcase 'error':\n\t\t\t\tthis.uploadError(a);\n\t\t\t\tbreak;\n\t\t\tcase 'status':\n\t\t\t\tthis.uploadStatus(a);\n\t\t\t\tbreak;\n\t\t}\n\t},\n\tonImageAllocation(msg) {\n\t\tconst attrs = this.model.attributes;\n\t\tif (attrs.cancelled)\n\t\t\treturn;\n\t\tif (!attrs.num && !attrs.sentAllocRequest) {\n\t\t\tmain.send([common.INSERT_POST, this.allocationMessage(null, msg)]);\n\t\t\tthis.model.set({sentAllocRequest: true});\n\t\t}\n\t\telse\n\t\t\tmain.send([common.INSERT_IMAGE, msg]);\n\t},\n\tuploadError(msg) {\n\t\tif (this.model.get('cancelled'))\n\t\t\treturn;\n\t\tthis.model.set({\n\t\t\tuploadStatus: msg,\n\t\t\tuploading: false\n\t\t});\n\t\tif (this.$uploadForm)\n\t\t\tthis.$uploadForm.find('input[name=alloc]').remove();\n\t},\n\tuploadStatus(msg) {\n\t\tif (this.model.get('cancelled'))\n\t\t\treturn;\n\t\tthis.model.set('uploadStatus', msg);\n\t},\n\taddReference(num, sel) {\n\t\t// If a >>link exists, put this one on the next line\n\t\tvar val = this.$input.val();\n\t\tif (/^>>\\d+$/.test(val)) {\n\t\t\tthis.$input.val(val + '\\n');\n\t\t\tthis.onInput();\n\t\t\tval = this.$input.val();\n\t\t}\n\t\t// Quote selected text automatically\n\t\tif (sel) {\n\t\t\tsel = sel.split('\\n');\n\t\t\t// Prepend > to each line\n\t\t\tfor (let i = 0, len = sel.length; i < len; i++)\n\t\t\t\tsel[i] = '>' + sel[i];\n\t\t\tnum += '\\n' + sel.join('\\n') + '\\n';\n\t\t}\n\t\tthis.$input.val(val + '>>' + num);\n\t\tthis.$input[0].selectionStart = this.$input.val().length;\n\t\tthis.onInput();\n\t\tthis.$input.focus();\n\t},\n\tremove() {\n\t\tif (!this.preserve) {\n\t\t\tif (this.isThread)\n\t\t\t\tthis.$el.next('hr').remove();\n\t\t\tthis.$el.remove();\n\t\t}\n\t\tthis.$sizer.remove();\n\t\tif (this.$iframe) {\n\t\t\tthis.$iframe.remove();\n\t\t\tthis.$iframe = null;\n\t\t}\n\t\tthis.stopListening();\n\t\twindow.onbeforeunload = null;\n\t},\n\t// Extend with imager.js methods\n\trenderImage: imager.Hidamari.renderImage,\n\t// Overrides automatic image expansion, if any\n\tautoExpandImage() {\n\t\treturn this;\n\t},\n\tfun() {\n\t\t\n\t}\n});\nexports.ComposerView = ComposerView;\n\nfunction openPostBox(num) {\n\tpostSM.feed('new', document.query(`#p${num} aside.posting`));\n}\nmain.reply('openPostBox', openPostBox);\n\nwindow.addEventListener('message', function(event) {\n\tconst msg = event.data;\n\tif (msg !== 'OK' && postForm)\n\t\tpostForm.uploadError(msg);\n}, false);\n\nmain.$threads.on('click', 'a.quote', function(e) {\n\te.preventDefault();\n\n\t// TODO: Set highlighted post\n\n\t/*\n\t Make sure the selection both starts and ends in the quoted post's\n\t blockquote\n\t */\n\tconst post = e.target.closest('article, section'),\n\t\tgsel = getSelection(),\n\t\tnum = util.getNum(post);\n\n\tfunction isInside(prop) {\n\t\tconst el = gsel[prop] && gsel[prop].parentElement;\n\t\treturn  el\n\t\t\t&& el.closest('blockquote')\n\t\t\t&& el.closest('article, section') === post;\n\t}\n\n\tlet sel;\n\tif (isInside('baseNode') && isInside('focusNode'))\n\t\tsel = gsel.toString();\n\topenPostBox(util.getNum(post.closest('section')));\n\tpostForm.addReference(num, sel);\n});\n","/*\n * OP and thread related logic\n */\n\nconst main = require('../main'),\n\tPostCommon = require('./common'),\n\t{$, _, Backbone, util, oneeSama, state} = main;\n\nmodule.exports = PostCommon.extend({\n\ttagName: 'section',\n\trender() {\n\t\tconst attrs = this.model.attributes;\n\t\tthis.setElement(oneeSama.section(attrs)).insertIntoDOM();\n\n\t\t// Insert reply box into the new thread\n\t\tconst reply = util.parseDOM(oneeSama.replyBox());\n\t\tif (attrs.num in state.ownPosts || !!main.request('postForm'))\n\t\t\treply.style.display = 'none';\n\t\tthis.el.append(reply);\n\n\t\t// Remove next <hr>\n\t\tthis.el.nextElementSibling.remove();\n\t\treturn this;\n\t},\n\tinsertIntoDOM() {\n\t\tmain.$threads[0].query('aside')\n\t\t\t.after(this.el, document.createElement('hr'));\n\t\tthis.fun();\n\t},\n\trenderLocked(locked) {\n\t\tthis.el.classList[locked ? 'add' : 'remove']('locked');\n\t},\n\tremove() {\n\t\t// Remove next <hr>\n\t\tthis.el.nextElementSibling.remove();\n\t\tthis.el.remove();\n\t\tthis.stopListening();\n\t\treturn this;\n\t},\n\t/*\n\t Remove the top reply on board pages, if over limit, when a new reply is\n\t added\n\t */\n\tshiftReplies(postForm) {\n\t\tconst attrs = this.model.attributes,\n\t\t\t{replies} = attrs;\n\t\tlet lim = state.hotConfig.get('ABBREVIATED_REPLIES'),\n\t\t\tchanged;\n\t\tif (postForm)\n\t\t\tlim--;\n\t\t// Need a static length, because the original array get's modified\n\t\tconst len = replies.slice().length;\n\t\tfor (let i = len; i > lim; i--) {\n\t\t\tconst post = state.posts.get(replies.shift());\n\t\t\tif (!post)\n\t\t\t\tcontinue;\n\t\t\tif (post.get('image'))\n\t\t\t\tattrs.image_omit++;\n\t\t\tattrs.omit++;\n\t\t\tchanged = true;\n\t\t\tpost.remove();\n\t\t}\n\t\tif (changed)\n\t\t\tthis.renderOmit(attrs.omit, attrs.image_omit)\n\t},\n\t// Posts and images omited indicator\n\trenderOmit(omit = this.model.get('omit'),\n\t\timage_omit = this.model.get('image_omit')\n\t) {\n\t\tif (omit === 0)\n\t\t\treturn;\n\t\tconst {thread, href} = state.page.attributes;\n\t\tthis.el.query('.omit').innerHTML = oneeSama.lang.abbrev_msg(omit,\n\t\t\tthis.model.get('image_omit'), thread && href.split('?')[0]);\n\t},\n\t// Move thread to the top of the page\n\tbumpThread() {\n\t\tthis.el.nextElementSibling.remove();\n\t\tthis.el.remove();\n\t\tthis.insertIntoDOM();\n\t}\n});\n","/*\n * Various page scrolling logic\n */\n\nconst main = require('./main'),\n\t{$, Backbone, options, state} = main;\n\nconst {body} = document;\nlet atBottom, lockIndicator, isThread;\n\nfunction cacheState() {\n\tlockIndicator = document.query('#lock');\n\tisThread = !!state.posts.get('thread');\n}\n\n// Recache state on page change\nstate.page.on('change', cacheState);\ncacheState();\n\n// Sets the scroll lock position to a post or to bottom of the document\nfunction checkBottom() {\n\tatBottom = (body.scrollHeight - window.innerHeight) <= window.scrollY;\n\tif (lockIndicator)\n\t\tlockIndicator.style.visibility = atBottom ? 'visible' : 'hidden';\n}\n\ncheckBottom();\ndocument.addEventListener('scroll', checkBottom);\n\n/*\n Lock position to the bottom of a thread or keep the viewport from bumping\n on out of sight DOM mutation.\n */\n// Cache previous reference element to minimize DOM lookup\nlet referenceEl;\n\nfunction followDOM(func) {\n\tconst previous = referenceDistance(),\n\t\tret = func();\n\n\t// Prevent scrolling with new posts, if page isn't visible\n\tif (atBottom && (!document.hidden || options.get('alwaysLock')))\n\t\twindow.scrollTo(0,  body.scrollHeight);\n\telse {\n\t\t// Element was removed or something\n\t\tif (!elExists(referenceEl))\n\t\t\treturn ret;\n\n\t\t// Only compensate, if the height increased ~above the viewport\n\t\tconst delta = topDistance(referenceEl, true) - previous;\n\t\tif (delta)\n\t\t\twindow.scrollBy(0, delta);\n\t}\n\treturn ret;\n}\nmain.follow = followDOM;\n\n// Check if element reference exists and is in the DOM\nfunction elExists(el) {\n\treturn el && document.contains(el);\n}\n\n// Return element position dimentions against the viewport, if the element\n// is withing the viewport\nfunction topDistance(el, skipCheck) {\n\tconst {top} = el.getBoundingClientRect();\n\tif (skipCheck || (top >= 0 && top < window.innerHeight))\n\t\treturn top;\n\treturn null;\n}\n\nfunction referenceDistance() {\n\tif (elExists(referenceEl)) {\n\t\tconst bounds = topDistance(referenceEl);\n\t\tif (bounds !== null)\n\t\t\treturn bounds;\n\t}\n\n\t// Find new reference element (first inside viewport). Account for empty\n\t// threads and boards with no artciles or sections.\n\tfor (let selector of ['article', 'section', 'threads']) {\n\t\tfor (let el of main.$threads[0].queryAll(selector)) {\n\t\t\tconst bounds = topDistance(el);\n\t\t\tif (bounds !== null) {\n\t\t\t\treferenceEl = el;\n\t\t\t\treturn bounds;\n\t\t\t}\n\t\t}\n\t}\n}\n\n// Account for banner height, when scrolling to an anchor\nfunction aboveBanner (){\n\tif (!/^#p\\d+$/.test(location.hash))\n\t\treturn;\n\tlet $anchor = $(location.hash);\n\tif (!$anchor.length)\n\t\treturn;\n\t$(window).scrollTop($anchor.offset().top - $('#banner').height());\n}\nmain.reply('scroll:aboveBanner', aboveBanner);\nwindow.onload = aboveBanner;\n","/*\n * Central model keeping the state of the page\n */\n\nimport {_, Backbone} from 'main'\n\n// Read page state by parsing a URL\nexport function read(href) {\n\tconst state = {\n\t\tboard: href.match(/\\/([a-zA-Z0-9]+?)\\//)[1],\n\t\tthread: href.match(/\\/(\\d+)(:?#\\d+)?(?:[\\?&]\\w+=\\w+)*$/),\n\t\t// Displayed last N posts setting on thread pages\n\t\tlastN: href.match(/[\\?&]last=(\\d+)/)\n\t}\n\tfor (let key of ['thread', 'lastN']) {\n\t\tconst val = state[key]\n\t    state[key] = val ? parseInt(val[1]) : 0\n\t}\n\treturn state\n}\n\n// Initial page state\nexport const page = new Backbone.Model(read(location.href))\n\n// Hot-reloadable configuration\n\n// TODO: We need actual listeners to this model for hot reloads\n\n// Tracks the synchronisation counter of each thread\nexport let syncs = {}\n\n// Posts I made in this tab\nexport const ownPosts = {}\n\n// remember which posts are mine for two days\nexport const mine = new main.Memory('mine', 2, true)\n\n// All posts currently displayed\nexport const posts = new Backbone.Collection()\n\nmain.on('state:clear', () => {\n\t/*\n\t * Emptying the whole element should be faster than removing each post\n\t * individually through models and listeners\n\t */\n\tmain.$threads.innerHTML = ''\n\n\t// The <threads> tag has already been emptied, no need to perform\n\t// element removal with the default `.remove()` method\n\tmodels.each(model =>\n\t\tmodel.dispatch('stopListening'))\n\n\tposts.reset()\n\n\t// Prevent old threads from syncing\n\texports.syncs = {}\n\tmain.request('massExpander:unset')\n})\n\n// Post links verified server-side\nexport const links = {}\n\nexport function addLinks(addition) {\n\tif (addition) {\n\t\t_.extend(links, addition);\n\t}\n}\n","/*\nTimezone corrections, batch timestamp updates, syncwatch, util.\n */\n\nlet main = require('./main'),\n\t{$, Backbone, common, oneeSama, options, state} = main;\n\n// Get a more accurate server-client time offset, for interclient syncing\n// Does not account for latency, but good enough for our purposes\nvar serverTimeOffset = 0;\nmain.dispatcher[common.GET_TIME] = function(msg){\n\tif (!msg[0])\n\t\treturn;\n\tserverTimeOffset = msg[0] - Date.now();\n};\nmain.reply('time:offset', () => serverTimeOffset);\n\nlet renderTimer;\nfunction batcTimeRender(source, rtime = options.get('relativeTime')) {\n\tstate.posts.each(model => model.dispatch('renderTime'));\n\tif (renderTimer)\n\t\tclearTimeout(renderTimer);\n\tif (rtime)\n\t\trenderTimer = setTimeout(batcTimeRender, 60000)\n}\nmain.reply('time:render', batcTimeRender);\noptions.on('change:relativeTime', batcTimeRender);\n\n/* syncwatch */\nfunction timer_from_el(el) {\n\tif (!serverTimeOffset)\n\t\treturn;\n\tel.classList.add('timerTicking');\n\tconst start = el.getAttribute('start'),\n\t\tend = el.getAttribute('end'),\n\t\tmaxh = common.pad(el.getAttribute('hour')),\n\t\tmaxm = common.pad(el.getAttribute('min')),\n\t\tmaxs = common.pad(el.getAttribute('sec'));\n\n\t(function moumouikkai() {\n\t\t// Prevent memory leak\n\t\tif (!document.body.contains(el))\n\t\t\treturn;\n\t\tconst now = common.serverTime();\n\t\tif (now > end)\n\t\t\treturn el.textContent = main.lang.finished;\n\n\t\t// If the start time is in the future\n\t\tif (start > now) {\n\t\t\tconst countdown = Math.round((start - now) / 1000);\n\t\t\tif(countdown === 10)\n\t\t\t\tmain.request('time:syncwatch');\n\t\t\tel.textContent = 'Countdown: ' + countdown;\n\t\t\treturn setTimeout(moumouikkai, 1000);\n\t\t}\n\n\t\tlet diff = now - start;\n\t\tconst hour = Math.floor(diff / 1000 /60 / 60);\n\t\tdiff -= hour * 1000 * 60 * 60;\n\t\tconst min = Math.floor( diff / 1000 / 60);\n\t\tdiff -= min * 1000 * 60;\n\t\tconst sec = Math.floor(diff / 1000);\n\t\tel.textContent = common.pad(hour) + \":\" + common.pad(min) + \":\"\n\t\t\t+ common.pad(sec) + \" / \" + maxh + \":\" + maxm + \":\" + maxs;\n\t\treturn setTimeout(moumouikkai, 1000);\n\t})();\n}\n\nfunction mouikkai() {\n\tsetInterval(function() {\n\t\tconst els = document.getElementsByTagName('syncwatch');\n\t\tfor (let i = 0; i < els.length; i++) {\n\t\t\tif (els[i].classList.contains('timerTicking'))\n\t\t\t\tcontinue;\n\t\t\ttimer_from_el(els[i]);\n\t\t}\n\t}, 1000);\n}\n\nmain.defer(batcTimeRender)\n\t.defer(mouikkai)\n\t.defer(function() {\n\t\t// Append UTC clock to the top of the schedule\n\t\tlet seconds;\n\t\tlet el = document.getElementById('UTCClock').firstChild;\n\t\tel.addEventListener('click', handler);\n\n\t\tfunction handler() {\n\t\t\tseconds = true;\n\t\t\tthis.removeAttribute('title');\n\t\t\tthis.style.cursor = 'default';\n\t\t\tthis.removeEventListener('click', handler);\n\t\t\trender();\n\t\t}\n\n\t\tfunction render() {\n\t\t\tif (!serverTimeOffset)\n\t\t\t\treturn setTimeout(render, 1000);\n\t\t\tel.innerHTML = oneeSama\n\t\t\t\t.readableUTCTime(new Date(common.serverTime()), seconds);\n\t\t\tsetTimeout(render, seconds ? 1000 : 60000);\n\t\t}\n\n\t\trender();\n\t});\n","/*\n Client-side helper functions\n */\n\nimport {_, config, state} from 'main'\n\n/**\n * Make spoiler tags toggleable on mobile\n * @param {Element}\n */\nexport function touchable_spoiler_tag(del) {\n\tdel.html = '<del onclick=\"void(0)\">'\n}\n\n/**\n * Return image upload URL\n * @returns {string}\n */\nexport function imageUploadURL() {\n\treturn (config.hard.HTTP.upload || '../upload/') + '?id='\n\t\t+ state.page.get('connID')\n}\n\n/**\n * Retrieve post number of post element\n * @param {Element} el\n * @returns {int}\n */\nexport function getNum(el) {\n\tif (!el) {\n\t    return 0\n\t}\n\treturn parseInt(el.getAttribute('id').slice(1), 10)\n}\n\n/**\n * Retrieve post number of closest parent post\n * @param {Element} el\n * @returns {int}\n */\nexport function getID(el) {\n\tif (!el) {\n    \treturn 0\n\t}\n\treturn getNum(el.closest('article, section'))\n}\n\n/**\n * Retrieve model of closest parent post\n * @param {Element} el\n * @returns {(Backbone.Model|null)}\n */\nexport function getModel(el) {\n\tconst id = getID(el)\n\tif (!id)\n\t\treturn null\n\treturn state.posts.get(id)\n}\n\n/**\n * Parse HTML string to node array\n * @param {string} string\n * @returns {Element[]}\n */\nexport function parseEls(string) {\n\tconst el = document.createElement('div')\n\tel.innerHTML = string\n\tconst children = el.childNodes\n\treturn Array.from(children)\n}\n\n/**\n * Parse HTML string to Element\n * @param {string} string\n * @returns {Element}\n */\nexport function parseEl(string) {\n\tconst el = document.createElement('div')\n\tel.innerHTML = string\n\treturn el.firstChild\n}\n\n/**\n * Add an event listener that filters targets according to a CSS selector\n * @param {Element} el - Target element\n * @param {string} type - Event type\n * @param {string} selector - CSS selector\n * @param {function} handler - Callback function\n */\nexport function listener(el, type, selector, handler) {\n\tel.addEventListener(type, function (event) {\n\t\tif (event.target.matches(selector))\n\t\t\thandler.call(this, event)\n\t})\n}\n\n/**\n * Add event listener to element, that will only be executed once\n * @param {Element} el - Target element\n * @param {string} type\t- Event type\n * @param {function} handler - Callback function\n */\nexport function once(el, type, handler) {\n\tel.addEventListener(type, function (event) {\n\t\thandler.call(this, event)\n\t\tel.removeEventListener(type, handler)\n\t})\n}\n\n/**\n * Return width of element with padding and margin\n * @param {Element} el\n * @returns {int}\n */\nexport function outerWidth(el) {\n\tconst style =  getComputedStyle(el),\n\t\tprops = ['marginLeft', 'marginRight', 'paddingLeft','paddingRight']\n\tlet width = 0\n\tfor (let prop of props) {\n\t\twidth += parseInt(style[prop]);\n\t}\n\treturn width\n}\n\n/**\n * Confirms email is saging\n * @param {string} email\n * @returns {bool}\n */\nexport function isSage(email) {\n\treturn email && email.trim() === 'sage'\n}\n\n\n// TODO: Refactor server time syncronisation\nlet cachedOffset;\nexport function serverTime() {\n\tconst d = Date.now();\n\tif (imports.isNode)\n\t\treturn d;\n\n\t// The offset is intialised as 0, so there is something to return, until\n\t// we get a propper number from the server.\n\tif (!cachedOffset)\n\t\tcachedOffset = imports.main.request('time:offset');\n\treturn d + cachedOffset;\n}\n\nexport function readable_dice(bit, dice) {\n\tlet inner;\n\tswitch (bit) {\n\t\tcase '#flip':\n\t\t\tinner = (dice[2] == 2).toString();\n\t\t\tbreak;\n\t\tcase '#8ball':\n\t\t\tinner = imports.hotConfig.EIGHT_BALL[dice[2] - 1];\n\t\t\tbreak;\n\t\tcase '#pyu':\n\t\tcase '#pcount':\n\t\tcase '#q':\n\t\t\tinner = dice[0];\n\t\t\tbreak;\n\t}\n\tif (inner !== undefined)\n\t\treturn _.escape(`${bit} (${inner})`);\n\tif (/^#sw/.test(bit))\n\t\treturn readableSyncwatch(dice[0]);\n\treturn readableRegularDice(bit, dice);\n}\n\nfunction readableSyncwatch(dice) {\n\tdice.class = 'embed';\n\treturn parseHTML\n\t\t`<syncwatch ${dice}>\n\t\t\tsyncwatch\n\t\t</syncwatch>`;\n}\n\nfunction readableRegularDice(bit, [max, bias, ...rolls]) {\n\tbit += ' (';\n\tconst eq = rolls.length > 1 || bias;\n\tif (eq)\n\t\tbit += rolls.join(', ');\n\tif (bias)\n\t\tbit += (bias < 0 ? ' - ' + (-bias) : ' + ' + bias);\n\tlet sum = bias;\n\tfor (let roll of rolls) {\n\t\tsum += roll;\n\t}\n\treturn bit + (eq ? ' = ' : '') + sum + ')';\n}\n\nexport function pick_spoiler(metaIndex) {\n\tconst imgs = imports.config.SPOILER_IMAGES,\n\t\tn = imgs.length;\n\tlet i;\n\tif (metaIndex < 0)\n\t\ti = Math.floor(Math.random() * n);\n\telse\n\t\ti = metaIndex % n;\n\treturn {\n\t\tindex: imgs[i],\n\t\tnext: (i + 1) % n\n\t};\n}\n\nexport const thumbStyles = ['small', 'sharp', 'hide']\n\nexport function readable_filesize(size) {\n\t/* Dealt with it. */\n\tif (size < 1024)\n\t\treturn size + ' B';\n\tif (size < 1048576)\n\t\treturn Math.round(size / 1024) + ' KB';\n\tsize = Math.round(size / 104857.6).toString();\n\treturn size.slice(0, -1) + '.' + size.slice(-1) + ' MB';\n}\n\nexport function pad(n) {\n\treturn (n < 10 ? '0' : '') + n;\n}\n\n// Various UI-related links wrapped in []\nexport function action_link_html(href, name, id, cls) {\n\treturn parseHTML\n\t\t`<span class=\"act\">\n\t\t\t<a href=\"${href}\"\n\t\t\t\t${id && ` id=\"${id}\"`}\n\t\t\t\t${cls && ` class=\"${cls}\"`}\n\t\t\t>\n\t\t\t\t${name}\n\t\t\t</a>\n\t\t</span>`;\n}\n\n/**\n * Confirm last N posts to view setting matches bounds\n * @param {int} n\n * @returns {bool}\n */\nexport function resonableLastN(n) {\n\treturn Number.isInteger(n) && n <= 500\n}\n\nexport function parse_name(name) {\n\tvar tripcode = '', secure = '';\n\tvar hash = name.indexOf('#');\n\tif (hash >= 0) {\n\t\ttripcode = name.substr(hash + 1);\n\t\tname = name.substr(0, hash);\n\t\thash = tripcode.indexOf('#');\n\t\tif (hash >= 0) {\n\t\t\tsecure = _.escape(tripcode.substr(hash + 1));\n\t\t\ttripcode = tripcode.substr(0, hash);\n\t\t}\n\t\ttripcode = _.escape(tripcode);\n\t}\n\tname = name.trim().replace(imports.hotConfig.EXCLUDE_REGEXP, '');\n\treturn [\n\t\tname.substr(0, 100), tripcode.substr(0, 128),\n\t\tsecure.substr(0, 128)\n\t];\n}\n\n/**\n * Generate a random alphannumeric string of lower and upper case hexadecimal\n * characters\n * @param {int} len\t- String length\n * @returns {string}\n */\nexport function randomID(len) {\n\tlet id = ''\n\tfor (let i = 0; i < len; i++) {\n\t\tlet char = (Math.random() * 36).toString(36)[0]\n\t\tif (Math.random() < 0.5)\n\t\t\tchar = char.toUpperCase()\n\t\tid += char\n\t}\n\treturn id\n}\n\n/**\n * Template string tag function for HTML. Strips indentation and trailing\n * newlines. Based on https://gist.github.com/zenparsing/5dffde82d9acef19e43c\n * @param {*}\n * @returns {string}\n */\nexport function parseHTML(callSite) {\n\t// if argumennts.length === 1\n\tif (typeof callSite === 'string')\n\t\treturn formatHTML(callSite);\n\tif (typeof callSite === 'function')\n\t\treturn formatHTML(callSite(args))\n\n\t/*\n\t Slicing the arguments object is deoptimising, so we construct a new array\n\t instead.\n\t */\n\tconst len = arguments.length;\n\tlet args = [];\n\tfor (let i = 1; i < len; i++) {\n\t\targs[i - 1] = arguments[i]\n\t}\n\n\tconst output = callSite\n\t\t.slice(0, len)\n\t\t.map((text, i) => {\n\t\t\tconst arg = args[i - 1]\n\t\t\tlet result;\n\t\t\t/*\n\t\t\t Simplifies conditionals. If the placeholder returns a non-zero\n\t\t\t falsy value, it is ommitted.\n\t\t\t */\n\t\t\tif (i === 0 || (!arg && arg !== 0))\n\t\t\t\tresult = ''\n\t\t\telse if (arg instanceof Object)\n\t\t\t\tresult = elementAttributes(arg)\n\t\t\telse\n\t\t\t\tresult = arg\n\n\t\t\treturn result + text\n\t\t})\n\t\t.join('')\n\n\treturn formatHTML(output)\n}\n\n/**\n * Strip leading indentation from HTML string\n */\nfunction formatHTML(str) {\n\tlet size = -1;\n\treturn str\n\t\t.replace(/\\n(\\s+)/g, (m, m1) => {\n\t\t\tif (size < 0)\n\t\t\t\tsize = m1.replace(/\\t/g, '    ').length\n\t\t\treturn m1.slice(Math.min(m1.length, size))\n\t\t})\n\t\t// Remove empty lines\n\t\t.replace(/^\\s*\\n/gm, '')\n}\n\n/**\n * Generate an HTML element attribute list\n */\nfunction elementAttributes(attrs) {\n\tlet html = '';\n\tfor (let key in attrs) {\n\t\thtml += ' '\n\t\tconst val = attrs[key]\n\t\tif (val === true)\n\t\t\thtml += key\n\t\telse if (val || val === 0)\n\t\t\thtml += `${key}=\"${val}\"`\n\t}\n\treturn html\n}\n\n/**\n * Makes a ', ' seperated list out of on array of strings\n * @param {string[]} items\n * @returns {string}\n */\nexport function commaList(items) {\n\tlet html = ''\n\tfor (let item of items) {\n\t\t// Falsy value. Skip item.\n\t\tif (!item && item !== 0)\n\t\t\tcontinue\n\t\tif (html)\n\t\t\thtml += ', '\n\t\thtml += item\n\t}\n\treturn html\n}\n\n/**\n * Acertains client has the proper authorisation to perfrom task. This is only\n * for rendering. The same validation is performed server-side.\n * @param {string} action - Privilidged action to check permission for\n * @returns {bool}\n */\nexport function checkAuth(action) {\n\tconst cls = config.staff.classes[main.ident && main.ident.auth]\n    return cls && !!cls.rights[action]\n}\n","/*\n * Loads the depandancies in order and aggregates exports from various modules\n */\n\n// NOTE: The entire bundle uses strict mode through the Babel transpiler\n\n/*\n * Because we are going to attach listeners to these all over the place, have\n * to load soome core modules in specific order. Also avoids nasty circular\n * dependancy, by placing some of the exports here and not in child modules.\n */\nconst _ = require('underscore'),\n\tBackbone = require('backbone'),\n\tCookie = require('js-cookie'),\n\tradio = require('backbone.radio')\n\nimport FSM from './fsm'\n\n// Load standard library ES6 polyfills\nrequire('core-js')\n// Load DOM level 4 polyfill\nrequire('dom4')\n// Load Backbone.View native JS replacement\nrequire('backbone.nativeview')\nBackbone.View = Backbone.NativeView\n\n// Central aplication object and message bus\nlet main = module.exports = radio.channel('main')\n\n_.extend(main, {\n\t// Bind dependancies to main object for pretier destructuring requires\n\t_, Backbone, Cookie, FSM,\n\t$script: require('scriptjs'),\n\tSockJS: require('sockjs-client'),\n\n\t/*\n\t Ofload expensive and not that neccessary initialisation logic till\n\t after the core modules are started\n\t */\n\t_deferred: [],\n\tdefer(func) {\n\t\tmain._deferred.push(func)\n\t\treturn main\n\t},\n\texecDefered() {\n\t\tfor (let func of this._deferred) {\n\t\t\tfunc()\n\t\t}\n\t},\n\n\t// Websocket call handler map. Store them here, to avoid requiring\n\t// modules in the wrong order.\n\tdispatcher: {}\n})\n\n// Import configuration variables from the template HTML\n_.extend(main, {config, configHash, clientHash, isMobile})\n\n// Clear cookies, if versions mismatch. Get regenerated each client start\n// anyway.\nconst cookieVersion = 3\nif (localStorage.cookieVersion != cookieVersion) {\n\tfor (let cookie in Cookie.get()) {\n\n\t\t// Clear legacy cookies that were set for each board separatly.\n\t\t// Otherwise, they would override the new ones.\n\t\tconst paths = main.config.boards.enabled.slice()\n\t\tpaths.push('')\n\t\tfor (let path of paths) {\n\t\t\tCookie.remove(cookie, {path})\n\t\t}\n\t}\n\tlocalStorage.cookieVersion = cookieVersion\n}\n\n// You can invoke the client-side debug mode with the `debug=true` query string\nif (/[&\\?]debug=true/.test(location.href))\n\tmain.config.hard.debug = true\nif (main.config.hard.debug) {\n\tradio.DEBUG = true\n\twindow.Backbone = Backbone // Export Backbone instance for easier debugging\n\tradio.tuneIn('main') // Log all channel traffic\n}\n\nmain.send = main.request.bind(main, 'send') // Shorthand\n\n/*\n Core modules. The other will be more or less decoupled, but these are the\n monolithic foundation.\n */\nmain.Memory = require('./memory')\nconst lang = main.lang = require('lang'),\n\tstate = main.state = require('./state'),\n\tutil = main.util = require('./util')\n\n/*\n// Initialise main rendering object\nlet oneeSama = main.oneeSama = new common.OneeSama({\n\top: state.page.get('thread'),\n\tlang,\n\t// Core post link handler\n\ttamashii(num) {\n\t\tlet frag;\n\t\tconst op = state.links[num];\n\t\tif (op) {\n\t\t\tconst desc = num in state.mine.readAll() && this.lang.you;\n\t\t\tfrag = this.postRef(num, op, desc);\n\t\t}\n\t\telse\n\t\t\tfrag = '>>' + num;\n\t\treturn frag;\n\t}\n});\n*/\nmain.options = require('./options')\nmain.scroll = require('./scroll')\nstate.page.set('tabID', common.randomID(32))\n\n// Load language-specific CSS\ndocument.head.appendChild(util.parseDOM(common.parseHTML\n\t`<style>\n\t\t.locked:after {\n\t\t\tcontent: \"${lang.thread_locked}\";\n\t\t}\n\t\t.locked > header nav:after {\n\t\t\tcontent: \" (${lang.locked})\";\n\t\t}\n\t</style>`));\n\n_.extend(main, {\n\t// Cached DOM elements\n\t$threads: document.query('threads'),\n\t$name: document.query('input[name=name]'),\n\t$email: document.query('input[name=email]'),\n\n\tconnSM: new FSM('load'),\n\tpostSM: new FSM('none')\n});\n\n// 2nd tier dependacy modules. These are needed before the websocket\n// connection is opened, because they populate the dispatcher handler object.\n_.extend(main, {\n\tloop: require('./loop'),\n\ttime: require('./time'),\n\tamusement: require('./amusement')\n});\n\n// Load post models and views\nmain.posts = require('./posts')\nmain.Extract = require('./extract')\n// Start the client\nmain.client = require('./client')\nmain.conection = require('./connection')\n\n// Load independant auxilary modules\n_.extend(main, {\n\thistory: require('./history'),\n\thide: require('./hide')\n})\n\nmain.execDefered()\nmain.request('loading:hide')\n"],"sourceRoot":"/source/"}