"use strict";System.register([],function(e,n){function o(e){if("synced"==y.state||"syncing"==y.state){if(E.readyState!=m.OPEN)return void(console&&console.warn("Attempting to send while socket closed"));e=JSON.stringify(e),g.DEBUG&&console.log("<",e),E.send(e)}}function t(e){g.DEBUG&&console.log(">",e.data);var n=JSON.parse(e.data)[0],o=n.shift(),t=n.shift(),c=f.is_pubsub(t);if(!c||"locked"!==y.state){var i=a.dispatcher[t];i&&(c&&o in p.syncs&&p.syncs[o]++,a.follow(function(){return i(n,o)}))}}function c(e){k.textContent=e}function i(){return E&&(E.onclose=null,E.onmessage=null),"file:"==window.location.protocol?void console.log("Page downloaded locally; refusing to sync."):(E=s(),E.onopen=y.feeder("open"),E.onclose=y.feeder("close"),E.onmessage=t,void(g.DEBUG&&(window.socket=E)))}function s(){var e=["xdr-streaming","xhr-streaming","iframe-eventsource","iframe-htmlfile","xdr-polling","xhr-polling","iframe-xhr-polling","jsonp-polling"];return g.USE_WEBSOCKETS&&e.unshift("websocket"),new m(g.SOCKET_URL||g.SOCKET_PATH,null,{transports:e})}function r(){w&&(clearTimeout(w),w=0),h=0}function l(){switch(y.state){case"desynced":return;case"synced":case"syncing":case"conn":var e=E.readyState;if(e!=m.OPEN&&e!=m.CONNECTING)return void y.feed("close");if(navigator.onLine===!1)return void y.feed("close")}y.feed("retry")}var d,a,u,f,g,y,p,m,v,E,h,w,k;return{setters:[],execute:function(){function n(){return(g.hard.HTTP.upload||"../upload/")+"?id="+page.get("connID")}e("dispatcher",d={}),e("dispatcher",d),a=require("./main"),u=a._,f=a.common,g=a.config,y=a.connSM,p=a.state,m=a.SockJS,v=a.lang.sync,E=void 0,h=void 0,w=void 0,e("imageUploadURL",n),a.reply("send",o),k=document.getElementById("sync"),y.act("load + start -> conn",function(){c(v.connecting),h=0,i()}),y.act("conn, reconn + open -> syncing",function(){c(v.syncing);var e=f.randomID(32),n=p.page;n.set("connID",e),o([f.SYNCHRONIZE,e,n.get("board"),p.syncs,n.get("live"),document.cookie])}),y.act("syncing + sync -> synced",function(){c(v.synced),w=setTimeout(function(){w=0,r()},1e4)}),y.act("synced, syncing + lock -> locked"),y.act("locked + unlock -> synced"),a.reply("connection:lock",function(){return o([f.DESYNC])},y.feed("lock")),a.reply("connection:unlock",function(e){return o(e)},y.feed("unlock")),y.act("* + close -> dropped",function(e){E&&(E.onclose=null,E.onmessage=null),g.DEBUG&&console.error("E:",e),w&&(clearTimeout(w),w=0),c(v.dropped);var n=500*Math.pow(1.5,Math.min(Math.floor(++h/2),12));setTimeout(y.feeder("retry"),n)}),y.act("dropped + retry -> reconn",function(){i(),setTimeout(function(){"reconn"==y.state&&c(v.reconnecting)},100)}),y.act("* + invalid, desynced + close -> desynced",function(e){e=e&&e[0]?"Out of sync: "+e[0]:"Out of sync",c(e),w&&(clearTimeout(w),w=0),E.onclose=null,E.onmessage=null,E.close(),E=null,g.DEBUG&&(window.socket=null)}),y.feed("start"),document.addEventListener("visibilitychange",function(e){e.target.hidden||setTimeout(l,20)}),window.addEventListener("online",function(){return r()},y.feed("retry")),window.addEventListener("offline",y.feeder("close"))}}});
//# sourceMappingURL=maps/connection.js.map
