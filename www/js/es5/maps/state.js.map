{"version":3,"sources":["state.js"],"names":["System","register","_export","_context","extend","Memory","randomID","getID","Model","Collection","initial","page","syncs","ownPosts","config","configHash","clientHash","isMobile","$threads","$name","$email","$banner","mine","posts","links","setters","_vendorUnderscore","_memory","_util","_model","_collection","execute","read","href","state","board","match","thread","lastN","_arr","_i","length","key","val","parseInt","clear","innerHTML","models","each","model","dispatch","reset","exports","events","request","addLinks","addition","getModel","el","id","get","location","tabID","window","mediaURL","hard","HTTP","media","document","query"],"mappings":"AAAA,YAAaA,QAAOC,UAAU,uBAAuB,WAAW,SAAS,UAAU,gBAAgB,SAASC,EAAQC,GAAU,GAAIC,GAAOC,EAAOC,EAASC,EAAMC,EAAMC,EAAWC,EAAQC,EAAKC,EAAMC,EAASC,EAAOC,EAAWC,EAAWC,EAASC,EAASC,EAAMC,EAAOC,EAAQC,EAAKC,EAAMC,CAAM,QAAQC,SAAS,SAASC,GAAmBtB,EAAOsB,EAAkBtB,QAAS,SAASuB,GAAStB,EAAOsB,EAAAA,YAAkB,SAASC,GAAOtB,EAASsB,EAAMtB,SAASC,EAAMqB,EAAMrB,OAAQ,SAASsB,GAAQrB,EAAMqB,EAAAA,YAAiB,SAASC,GAAarB,EAAWqB,EAAAA,aAAuBC,QAAQ,WAAW,QAASC,GAAKC,GAAqL,IAAI,GAA/KC,IAAOC,MAAMF,EAAKG,MAAM,uBAAuB,GAAGC,OAAOJ,EAAKG,MAAM,sCAAsCE,MAAML,EAAKG,MAAM,oBAAwBG,GAAM,SAAS,SAAiBC,EAAG,EAAEA,EAAGD,EAAKE,OAAOD,IAkBnwB,CAAhC,GAAIE,GAAGH,EAAAC,GACLG,EAAMT,EAAMQ,EAAIR,GACbQ,GAAOC,EAAMC,SAASD,EAAI,IAAM,EACzC,MAAAT,GAAA,QAAAW,KAAA3B,EAAA4B,UAAA,GAAAC,OAAAC,KAAA,SAAAC,GAAA,MAAAA,GAAAC,SAAA,mBAAA3B,EAAA4B,QAAAC,QAAAxC,SAAAyC,OAAAC,QAAA,sBAAA,QAAAC,GAAAC,GAAAA,GAAApD,EAAAoB,EAAAgC,GAAA,QAAAC,GAAAC,GAAA,GAAAC,GAAApD,EAAAmD,EAAA,OAAAC,GAAApC,EAAAqC,IAAAD,GAAA,KAAAzD,EAAA,OAAA8B,GAAAtB,EAAAsB,EAAA6B,SAAA5B,MAAAvB,EAAAoD,MAAAxD,EAAA,IAAAJ,EAAA,OAAAS,EAAA,GAAAH,GAAAE,IAAAR,EAAA,OAAAS,GAAAT,EAAA,QAAAU,MAAAV,EAAA,QAAAU,GAAAV,EAAA,WAAAW,MAAAX,EAAA,WAAAW,GAAAX,EAAA,SAAAY,EAAAiD,OAAAjD,QAAAZ,EAAA,SAAAY,GAAAA,EAAAkD,SAAAlD,EAAAmD,KAAAC,KAAAC,MAAAjE,EAAA,aAAAa,EAAAgD,OAAAhD,YAAAb,EAAA,aAAAa,GAAAb,EAAA,aAAAc,EAAA+C,OAAA/C,YAAAd,EAAA,aAAAc,GAAAd,EAAA,WAAAe,EAAA8C,OAAA9C,UAAAf,EAAA,WAAAe,GAAAf,EAAA,WAAAgB,EAAAkD,SAAAC,MAAA,YAAAnE,EAAA,WAAAgB,GAAAhB,EAAA,QAAAiB,EAAAiD,SAAAC,MAAA,UAAAnE,EAAA,QAAAiB,GAAAjB,EAAA,SAAAkB,EAAAgD,SAAAC,MAAA,WAAAnE,EAAA,SAAAkB,GAAAlB,EAAA,UAAAmB,EAAA+C,SAAAC,MAAA,YAAAnE,EAAA,UAAAmB,GAAAnB,EAAA,OAAAoB,EAAA,GAAAjB,GAAA,OAAA,IAAAH,EAAA,OAAAoB,GAAApB,EAAA,QAAAqB,EAAA,GAAAd,IAAAP,EAAA,QAAAqB,GAAArB,EAAA,QAAA2C,GAAA3C,EAAA,QAAAsB,MAAAtB,EAAA,QAAAsB,GAAAtB,EAAA,WAAAqD,GAAArD,EAAA,WAAAuD","file":"state.js","sourcesContent":["/*\n * Central model keeping the state of the page\n */\n\nimport {extend} from '../vendor/underscore'\nimport Memory from './memory'\nimport {randomID, getID} from './util'\nimport Model from './model'\nimport Collection from './collection'\n\n// Read page state by parsing a URL\nexport function read(href) {\n\tconst state = {\n\t\tboard: href.match(/\\/([a-zA-Z0-9]+?)\\//)[1],\n\t\tthread: href.match(/\\/(\\d+)(:?#\\d+)?(?:[\\?&]\\w+=\\w+)*$/),\n\t\t// Displayed last N posts setting on thread pages\n\t\tlastN: href.match(/[\\?&]last=(\\d+)/)\n\t}\n\tfor (let key of ['thread', 'lastN']) {\n\t\tconst val = state[key]\n\t    state[key] = val ? parseInt(val[1]) : 0\n\t}\n\treturn state\n}\n\n// Initial page state\nconst initial = read(location.href)\ninitial.tabID = randomID(32)\nexport let page = new Model(initial)\n\n// Hot-reloadable configuration\n\n// TODO: We need actual listeners to this model for hot reloads\n\n// Tracks the synchronisation counter of each thread\nexport let syncs = {}\n\n// Posts I made in this tab\nexport const ownPosts = {}\n\n// Configuration object, passed from the server\nexport const config = window.config\nconfig.mediaURL = config.hard.HTTP.media // Shorthand\n\n// Hash of the the configuration object\nexport const configHash = window.configHash\n\n// Combined hash of the current client-side files. Used for transparent\n// versioning.\nexport const clientHash = window.clientHash\n\n// Indicates, if in mobile mode. Determined server-side.\nexport const isMobile = window.isMobile\n\n// Cached DOM elements\nexport const $threads = document.query('threads')\nexport const $name = document.query('#name')\nexport const $email = document.query('#email')\nexport const $banner = document.query('#banner')\n\n// Remember which posts are mine for two days\nexport const mine = new Memory('mine', 2)\n\n// All posts currently displayed\nexport const posts = new Collection()\n\n/**\n * Clear the current post state and HTML\n */\nexport function clear() {\n\t/*\n\t * Emptying the whole element should be faster than removing each post\n\t * individually through models and listeners\n\t */\n\t$threads.innerHTML = ''\n\n\t// The <threads> tag has already been emptied, no need to perform\n\t// element removal with the default `.remove()` method\n\tmodels.each(model =>\n\t\tmodel.dispatch('stopListening'))\n\n\tposts.reset()\n\n\t// Prevent old threads from syncing\n\texports.syncs = {}\n\tevents.request('massExpander:unset')\n}\n\n// Post links verified server-side\nexport const links = {}\n\nexport function addLinks(addition) {\n\tif (addition) {\n\t\textend(links, addition);\n\t}\n}\n\n/**\n * Retrieve model of closest parent post\n * @param {Element} el\n * @returns {(Backbone.Model|null)}\n */\nexport function getModel(el) {\n\tconst id = getID(el)\n\tif (!id) {\n\t\treturn null\n\t}\n\treturn posts.get(id)\n}\n"],"sourceRoot":"/source/"}