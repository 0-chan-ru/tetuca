{"version":3,"sources":["notify.js"],"names":["System","register","_export","_context","main","$","_","Backbone","config","connSM","etc","state","options","mediaURL","discoFavicon","xhr","NotifyModel","notify","replies","setters","execute","require","MEDIA_URL","XMLHttpRequest","open","responseType","onload","this","status","window","URL","createObjectURL","response","send","Model","extend","initialize","_this","$favicon","check","listenTo","reply","model","get","document","hidden","set","title","addEventListener","e","target","unreadCount","dropped","on","_model$attributes","attributes","alert","icon","render","prefix","attr","Memory","num","post","posts","readAll","isMobile","n","Notification","lang","quoted","image","oneeSama","workMode","thumbPath","body","onclick","focus","location","hash","write","syncwatchStarting"],"mappings":"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","file":"notify.js","sourcesContent":["'use strict';System.register([],function(_export,_context){var main,$,_,Backbone,config,connSM,etc,state,options,mediaURL,discoFavicon,xhr,NotifyModel,notify,replies;return {setters:[],execute:function(){main=require('./main');$=main.$;_=main._;Backbone=main.Backbone;config=main.config;connSM=main.connSM;etc=main.etc;state=main.state;options=main.options;mediaURL=main.config.MEDIA_URL;discoFavicon='';xhr=new XMLHttpRequest();xhr.open('GET',mediaURL+'css/ui/disconnected.ico');xhr.responseType='blob';xhr.onload=function(){if(this.status===200)discoFavicon=window.URL.createObjectURL(this.response);};xhr.send();NotifyModel=Backbone.Model.extend({initialize:function initialize(){var _this=this;this.$favicon=$('#favicon');this.check(this);this.listenTo(this,'change',this.check);main.reply('post:inserted',function(model){if(model.get('mine'))return;if(document.hidden)_this.set('unreadCount',_this.get('unreadCount')+1);});main.reply('notify:title',function(title){return _this.set('title',title);});document.addEventListener('visibilitychange',function(e){var hidden=e.target.hidden;_this.set({hidden:hidden,unreadCount:0,reply:!hidden});},false);var dropped=function dropped(){return _this.set('alert',true);};connSM.on('dropped',dropped);connSM.on('desynced',dropped);connSM.on('synced',function(){return notify.set('alert',false);});},check:function check(model){var _model$attributes=model.attributes;var hidden=_model$attributes.hidden;var unreadCount=_model$attributes.unreadCount;var reply=_model$attributes.reply;var alert=_model$attributes.alert;var icon=mediaURL+'favicon.ico';if(alert)return this.render(discoFavicon,'--- ');else if(!hidden)return this.render(icon,'');var prefix='';if(unreadCount){prefix+='('+unreadCount+') ';icon=mediaURL+'css/ui/unreadFavicon.ico';}if(reply){prefix='>> '+prefix;icon=mediaURL+'css/ui/replyFavicon.ico';}this.render(icon,prefix);},render:function render(icon,prefix){document.title=prefix+this.get('title');this.$favicon.attr('href',icon);}});notify=new NotifyModel({unreadCount:0,title:document.title});replies=new main.Memory('replies',3);main.reply('repliedToMe',function(num){var post=state.posts.get(num);if(!post)return;post=post.attributes;if(num in replies.readAll())return;if(options.get('notification')&&document.hidden&&!main.isMobile){var n=new Notification(main.lang.quoted,{icon:post.image&&options.get('thumbs')!=='hide'&&!main.oneeSama.workMode?main.oneeSama.thumbPath(post.image):mediaURL+'css/ui/favbig.png',body:post.body});n.onclick=function(){window.focus();location.hash='#p'+num;};}notify.set({reply:true});replies.write(num);});main.reply('time:syncwatch',function(){if(!options.get('notification')||!document.hidden)return;new Notification(main.lang.syncwatchStarting).onclick=function(){return window.focus();};});}};});"],"sourceRoot":"/source/"}