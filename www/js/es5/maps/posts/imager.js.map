{"version":3,"sources":["posts/imager.js"],"names":["System","register","_export","_context","_taggedTemplateLiteral","strings","raw","Object","freeze","defineProperties","value","_templateObject","_templateObject2","main","$threads","_","Backbone","common","util","oneeSama","options","state","ExpanderModel","massExpander","setters","execute","require","exports","Hidamari","View","extend","renderImage","arg","image","manual","reveal","model","this","el","src","get","figure","query","remove","before","parseDOM","window","scrollTop","getBoundingClientRect","top","document","body","height","set","thumbnailRevealed","imageExpanded","tallImage","autoExpandImage","img","indexOf","ext","toggleImageExpansion","expand","fit","fitImage","open","imagePaths","renderAudio","newWidth","undefined","newHeight","width","dims","expandImage","both","widthFlag","heightFlag","aspect","fullWidth","fullHeight","maxWidth","imageMaxWidth","maxHeight","innerHeight","offsetHeight","innerWidth","parseInt","closest","left","outerWidth","noMargin","isVideo","attrs","cls","autoplay","loop","controls","lastChild","innerHTML","parseHTML","append","Model","initialize","_this","on","e","preventDefault","toggle","massToggle","find","text","lang","expander","models","posts","i","l","length","dispatch","reply","unset","which","getModel","target","request","follow"],"mappings":"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","file":"posts/imager.js","sourcesContent":["'use strict';System.register([],function(_export,_context){var _templateObject,_templateObject2,main,$threads,_,Backbone,common,util,oneeSama,options,state,ExpanderModel,massExpander;function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}return {setters:[],execute:function(){_templateObject=_taggedTemplateLiteral(['<',' ','>'],['<',' ','>']);_templateObject2=_taggedTemplateLiteral(['<audio src=\"','\"\\n\\t\\t\\t\\twidth=\"300\"\\n\\t\\t\\t\\theight=\"3em\"\\n\\t\\t\\t\\tautoplay loop controls\\n\\t\\t\\t>\\n\\t\\t\\t</audio>'],['<audio src=\"','\"\\n\\t\\t\\t\\twidth=\"300\"\\n\\t\\t\\t\\theight=\"3em\"\\n\\t\\t\\t\\tautoplay loop controls\\n\\t\\t\\t>\\n\\t\\t\\t</audio>']);main=require('../main');$threads=main.$threads;_=main._;Backbone=main.Backbone;common=main.common;util=main.util;oneeSama=main.oneeSama;options=main.options;state=main.state;exports.Hidamari=Backbone.View.extend({renderImage:function renderImage(arg,image,manual){var reveal=arg===true;var model=this.model;var el=this.el;if(!image||!image.src)image=model.get('image');var figure=el.query('figure');if(figure)figure.remove();if(!image)return;el.query('blockquote').before(util.parseDOM(oneeSama.image(image,reveal)));if(manual&&model.get('tallImage')){window.scrollTop=el.getBoundingClientRect().top+document.body.scrollTop-document.query('#banner').height;}model.set({thumbnailRevealed:reveal,imageExpanded:false,tallImage:false});},autoExpandImage:function autoExpandImage(){var img=this.model.get('image');if(!img||!massExpander.get('expand')||['.webm','.pdf','.mp3'].indexOf(img.ext)>-1)return this;this.toggleImageExpansion(true,img);return this;},toggleImageExpansion:function toggleImageExpansion(expand,img,manual){var fit=options.get('inlinefit');if(!img||fit==='none')return;if(expand)this.fitImage(img,fit);else this.renderImage(null,img,manual);},fitImage:function fitImage(img,fit){if(img.ext==='.pdf')return window.open(oneeSama.imagePaths().src+img.src,'_blank');if(img.ext==='.mp3')return this.renderAudio(img);var newWidth=undefined,newHeight=undefined,width=newWidth=img.dims[0],height=newHeight=img.dims[1];if(fit==='full')return this.expandImage(img,{width:width,height:height});var both=fit==='both',widthFlag=both||fit==='width',heightFlag=both||fit==='height',aspect=width/height;var fullWidth=undefined,fullHeight=undefined;if(widthFlag){var maxWidth=this.imageMaxWidth();if(newWidth>maxWidth){newWidth=maxWidth;newHeight=newWidth/aspect;fullWidth=true;}}if(heightFlag){var maxHeight=window.innerHeight-document.query('#banner').offsetHeight;if(newHeight>maxHeight){newHeight=maxHeight;newWidth=newHeight*aspect;fullHeight=true;}}if(newWidth>50&&newHeight>50){width=newWidth;height=newHeight;}this.expandImage(img,width,height,fullHeight&&!fullWidth);},imageMaxWidth:function imageMaxWidth(){var el=this.el;var model=this.model;return window.innerWidth-parseInt(el.closest('section').getBoundingClientRect().left)*2-util.outerWidth(model.get('op')?el:el.query('.background'));},expandImage:function expandImage(img,width,height,noMargin){var isVideo=img.ext==='.webm';var attrs={src:oneeSama.imagePaths().src+img.src,width:width,height:height};var cls='expanded';if(noMargin)cls+=' noMargin';attrs.class=cls;if(isVideo)attrs.autoplay=attrs.loop=attrs.controls=true;this.el.query('figure').lastChild.innerHTML=common.parseHTML(_templateObject,isVideo?'video':'img',attrs);this.model.set({imageExpanded:true,tallImage:height>window.innerHeight});},renderAudio:function renderAudio(img){this.el.query('figure').append(util.parseDOM(common.parseHTML(_templateObject2,oneeSama.imagePaths().src+img.src)));this.model.set('imageExpanded',true);}});ExpanderModel=Backbone.Model.extend({initialize:function initialize(){var _this=this;$threads.on('click','#expandImages',function(e){e.preventDefault();_this.toggle();});},toggle:function toggle(){var expand=!this.get('expand');this.set('expand',expand).massToggle(expand);$threads.find('#expandImages').text(main.lang.expander[+expand]);},massToggle:function massToggle(expand){var fit=options.get('inlinefit');if(fit==='none')return;var models=state.posts.models;for(var i=0,l=models.length;i<l;i++){var model=models[i],img=model.get('image');if(!img)continue;if(expand)model.dispatch('fitImage',img,fit);else model.dispatch('renderImage',null,img);}}});massExpander=exports.massExpander=new ExpanderModel();main.reply('massExpander:unset',function(){return massExpander.unset();});$threads.on('click','img, video',function(e){if(options.get('inlinefit')=='none'||e.which!==1)return;var model=util.getModel(e.target);if(!model)return;e.preventDefault();main.request('imager:clicked');model.dispatch('toggleImageExpansion',!model.get('imageExpanded'),model.get('image'),true);});$threads.on('click','.imageToggle',function(e){e.preventDefault();var model=util.getModel(e.target);if(!model)return;main.follow(function(){return model.dispatch('renderImage',!model.get('thumbnailRevealed'));});});}};});"],"sourceRoot":"/source/"}