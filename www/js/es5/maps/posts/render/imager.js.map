{"version":3,"sources":["posts/render/imager.js"],"names":["System","register","_export","_taggedTemplateLiteral","strings","raw","Object","freeze","defineProperties","value","hiddenToggle","reveal","options","get","parseHTML","_templateObject3","lang","imageSearch","data","html","indexOf","ext","searchTemplates","google","_engine","thumbPath","mid","imagePaths","type","imageLink","name","imgnm","m","match","fullName","_","escape","tooLong","length","slice","attrs","href","config","SECONDARY_MEDIA_URL","src","rel","download","title","_templateObject5","spoilerInfo","_ref","large","spoiler","thumb","spoil","dims","images","_slicedToArray","_templateObject","_templateObject2","_templateObject4","_templateObject6","setters","_main","_underscore","execute","renderImage","showThumb","renderFigcaption","hat","renderThumbnail","list","commaList","audio","util","readable_filesize","size","apng","undefined","_data$dims","thumbWidth","thumbHeight","sp","this","linkAttrs","target","imgAttrs","width","height","thumbStyle","style","sliceIterator","arr","i","_arr","_n","_d","_e","_s","_i","Symbol","iterator","next","done","push","err","Array","isArray","TypeError","mediaURL","models","engine","url","symbol","templates","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_loop","_step$value","class","_iterator"],"mappings":"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","file":"posts/render/imager.js","sourcesContent":["/**\n * Image thumbnail rendering\n */\n\nimport {config, lang} from 'main'\nimport * as _ from 'underscore'\n\n/**\n * Render a thumbnail of an image, according to configuration settings\n * @param {Image} data - Image data object\n * @returns {bool} reveal - Reveal an image thumbnail, in \"hidden\"  thumbnail\n * mode\n * @returns {string}\n */\nexport function renderImage(data, reveal) {\n    const showThumb = options.get(\"thumbs\") !== 'hide' || reveal\n    return parseHTML\n        `<figure>\n            ${renderFigcaption(data, reveal)}\n            ${config.images.hat && showThumb ? '<span class=\"hat\"></span>': ''}\n            ${showThumb ? renderThumbnail(data) : ''}\n        </figure>`\n}\n\n/**\n * Render the information caption above the image\n * @param {Image} data - Image data object\n * @param {bool} reveal - Reveal an image thumbnail, in \"hidden\"  thumbnail\n * @returns {string}\n */\nexport function renderFigcaption(data, reveal) {\n    const list = commaList([\n        data.audio && '\\u266B',\n        data.length,\n        util.readable_filesize(data.size),\n        `${data.dims[0]}x${data.dims[1]}`,\n        data.apng && 'APNG'\n    ])\n    return parseHTML\n        `<figcaption>\n            ${hiddenToggle(reveal)}\n            ${imageSearch(data)}\n            <span>\n                (${list})\n            </span>\n            ${imageLink(data)}\n        </figcaption>`\n}\n\n/**\n * Render the button for toggling hidden thumbnails\n * @param {bool} reveal - Reveal an image thumbnail, in \"hidden\"  thumbnail\n * @returns {string}\n */\nfunction hiddenToggle(reveal) {\n    if (options.get('thumbs') !== 'hide') {\n        return ''\n    }\n    return parseHTML\n        `<a class=\"imageToggle\">\n            [${lang[reveal ? 'hide' : 'show']}]\n        </a>`\n}\n\n/**\n * Base URLs of image addresses\n */\nconst imagePaths = {\n    src: config.mediaURL + 'src/',\n    thumb: config.mediaURL + 'thumb/',\n    mid: config.mediaURL + 'mid/',\n    spoil: config.mediaURL + 'spoil/spoiler'\n}\n\n/**\n * Generate template functions for each image search engine\n */\nconst searchTemplates = (function() {\n\tconst models = [\n\t\t{\n\t\t\tengine: 'google',\n\t\t\turl: 'https://www.google.com/searchbyimage?image_url=',\n\t\t\ttype: 'thumb',\n\t\t\tsymbol: 'G'\n\t\t},\n\t\t{\n\t\t\tengine: 'iqdb',\n\t\t\turl: 'http://iqdb.org/?url=',\n\t\t\ttype: 'thumb',\n\t\t\tsymbol: 'Iq'\n\t\t},\n\t\t{\n\t\t\tengine: 'saucenao',\n\t\t\turl: 'http://saucenao.com/search.php?db=999&url=',\n\t\t\ttype: 'thumb',\n\t\t\tsymbol: 'Sn'\n\t\t},\n\t\t{\n\t\t\tengine: 'desustorage',\n\t\t\ttype: 'MD5',\n\t\t\turl: 'https://desustorage.org/_/search/image/',\n\t\t\tsymbol: 'Ds'\n\t\t},\n\t\t{\n\t\t\tengine: 'exhentai',\n\t\t\ttype: 'SHA1',\n\t\t\turl: 'http://exhentai.org/?fs_similar=1&fs_exp=1&f_shash=',\n\t\t\tsymbol: 'Ex'\n\t\t}\n\t]\n\n\tconst templates = {}\n    for (let {engine, url, type, symbol} of models) {\n        const attrs = {\n            target: '_blank',\n            rel: 'nofollow',\n            class: 'imageSearch ' + engine\n        }\n        templates[engine] = data => {\n            if (!options.get(engine)) {\n                return ''\n            }\n            attrs.href = url+ (type === 'thumb' ? thumbPath(data) : data[type])\n            return parseHTML\n                `<a ${attrs}>\n                    ${symbol}\n                </a>`\n        }\n    }\n\n\treturn templates\n})()\n\n/**\n * Render image search links in accordance to client settings\n * @param {Post} data\n * @returns {string}\n */\nfunction imageSearch(data) {\n\tlet html = '',\n        templates = searchTemplates\n\n\t// Only render google for PDFs and MP3s\n\tif (['.pdf', '.mp3'].indexOf(data.ext) > -1) {\n        if (options.get(\"google\")) {\n            return searchTemplates.google(data)\n        }\n        return ''\n    }\n    for (let engine in searchTemplates) {\n        html += searchTemplates[engine](data)\n    }\n\treturn html\n}\n\n/**\n * Get the thumbnail path of an image, accounting for not thumbnail of specific\n * type being present\n * @param {Image} data - Image data\n * @param {bool} mid - Request an extra quality medium thumbnail\n * @returns {string}\n */\nfunction thumbPath(data, mid) {\n    return imagePaths[type] + data[mid && data.mid ? 'mid' : 'thumb']\n}\n\n/**\n * Render a name + download link of an image\n * @param {Image} data\n * @returns {string}\n */\nfunction imageLink(data) {\n    let name = '',\n        imgnm = data.imgnm\n    const m = imgnm.match(/^(.*)\\.\\w{3,4}$/);\n    if (m) {\n        name = m[1]\n    }\n    const fullName = _.escape(imgnm),\n        tooLong = name.length >= 38\n    if (tooLong) {\n        imgnm = _.escape(name.slice(0, 30))\n            + '(&hellip;)'\n            + _.escape(data.ext)\n    }\n    const attrs = {\n        href: `${config.SECONDARY_MEDIA_URL}src/${data.src}`,\n        rel: 'nofollow',\n        download: fullName\n    }\n    if (tooLong) {\n        attrs.title = fullName\n    }\n    return parseHTML\n        `<a ${attrs}>\n            ${imgnm}\n        </a>`\n}\n\n/**\n * Render a hat on top of the thumbnail, if enabled\n * @param {bool} showThumb\n * @returns {string}\n */\nfunction renderHat(showThumb) {\n    if (showThumb && config.images.hats) {\n        return '<span class=\"hat\"></span>'\n    }\n    return ''\n}\n\n/**\n * Render the actual thumbnail image\n * @param {Image} data\n * @param {bool=true} showThumb\n * @returns {string}\n */\nexport function renderThumbnail(data, href) {\n    let src = imagePaths.src + data.src,\n        thumb,\n        [width, height, thumbWidth, thumbHeight] = data.dims\n\n    if (data.spoiler && options.get('spoilers')) {\n        // Spoilered and spoilers enabled\n        const sp = spoilerInfo(data)\n        thumb = sp.thumb\n        thumbWidth = sp.dims[0]\n        thumbHeight = sp.dims[1]\n    } else if (data.ext === '.gif' && options.get('autogif')) {\n        // Animated GIF thumbnails\n        thumb = src\n    } else {\n        thumb = this.thumbPath(data, options.get('thumbs') !== 'small')\n    }\n\n    const linkAttrs = {\n        target: '_blank',\n        rel: 'nofollow',\n        href: href || src\n    }\n    const imgAttrs = {\n        src: thumb,\n        width: thumbWidth,\n        height: thumbHeight\n    }\n\n    // Catalog pages\n    if (href) {\n        // Handle the thumbnails with the HTML5 History controller\n        linkAttrs.class = 'history'\n\n        // No image hover previews\n        imgAttrs.class = 'expanded'\n        if(this.thumbStyle == 'hide') {\n            imgAttrs.style = 'display: none'\n        }\n    }\n\n    return parseHTML\n        `<a ${linkAttrs}>\n            <img ${imgAttrs}>\n        </a>`\n}\n\n/**\n * Parse and return image spoiler information\n * @param {Image} data\n * @returns {Object}\n */\nfunction spoilerInfo({large, spoiler}) {\n    let thumb = imagePaths.spoil\n    if (large || options.get(\"thumbs\") !== 'small') {\n        thumb += 's'\n    }\n    html += spoiler + '.png'\n    return {\n        thumb,\n        dims: config.images.thumb[large ? 'midDims' : 'thumbDims']\n    }\n}\n"],"sourceRoot":"/source/"}