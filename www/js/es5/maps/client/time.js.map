{"version":3,"sources":["client/time.js"],"names":["System","register","_export","_context","batcTimeRender","source","rtime","arguments","length","undefined","options","get","state","posts","each","model","dispatch","renderTimer","clearTimeout","setTimeout","timer_from_el","el","serverTimeOffset","classList","add","start","getAttribute","end","maxh","common","pad","maxm","maxs","moumouikkai","document","body","contains","now","serverTime","textContent","main","lang","finished","countdown","Math","round","request","diff","hour","floor","min","sec","mouikkai","setInterval","els","getElementsByTagName","i","$","Backbone","oneeSama","setters","execute","require","dispatcher","GET_TIME","msg","Date","reply","on","defer","handler","seconds","this","removeAttribute","style","cursor","removeEventListener","render","innerHTML","readableUTCTime","getElementById","firstChild","addEventListener"],"mappings":"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","file":"client/time.js","sourcesContent":["/*\nTimezone corrections, batch timestamp updates, syncwatch, util.\n */\n\nlet main = require('./main'),\n\t{$, Backbone, common, oneeSama, options, state} = main;\n\n// Get a more accurate server-client time offset, for interclient syncing\n// Does not account for latency, but good enough for our purposes\nvar serverTimeOffset = 0;\nmain.dispatcher[common.GET_TIME] = function(msg){\n\tif (!msg[0])\n\t\treturn;\n\tserverTimeOffset = msg[0] - Date.now();\n};\nmain.reply('time:offset', () => serverTimeOffset);\n\nlet renderTimer;\nfunction batcTimeRender(source, rtime = options.get('relativeTime')) {\n\tstate.posts.each(model => model.dispatch('renderTime'));\n\tif (renderTimer)\n\t\tclearTimeout(renderTimer);\n\tif (rtime)\n\t\trenderTimer = setTimeout(batcTimeRender, 60000)\n}\nmain.reply('time:render', batcTimeRender);\noptions.on('change:relativeTime', batcTimeRender);\n\n/* syncwatch */\nfunction timer_from_el(el) {\n\tif (!serverTimeOffset)\n\t\treturn;\n\tel.classList.add('timerTicking');\n\tconst start = el.getAttribute('start'),\n\t\tend = el.getAttribute('end'),\n\t\tmaxh = common.pad(el.getAttribute('hour')),\n\t\tmaxm = common.pad(el.getAttribute('min')),\n\t\tmaxs = common.pad(el.getAttribute('sec'));\n\n\t(function moumouikkai() {\n\t\t// Prevent memory leak\n\t\tif (!document.body.contains(el))\n\t\t\treturn;\n\t\tconst now = common.serverTime();\n\t\tif (now > end)\n\t\t\treturn el.textContent = main.lang.finished;\n\n\t\t// If the start time is in the future\n\t\tif (start > now) {\n\t\t\tconst countdown = Math.round((start - now) / 1000);\n\t\t\tif(countdown === 10)\n\t\t\t\tmain.request('time:syncwatch');\n\t\t\tel.textContent = 'Countdown: ' + countdown;\n\t\t\treturn setTimeout(moumouikkai, 1000);\n\t\t}\n\n\t\tlet diff = now - start;\n\t\tconst hour = Math.floor(diff / 1000 /60 / 60);\n\t\tdiff -= hour * 1000 * 60 * 60;\n\t\tconst min = Math.floor( diff / 1000 / 60);\n\t\tdiff -= min * 1000 * 60;\n\t\tconst sec = Math.floor(diff / 1000);\n\t\tel.textContent = common.pad(hour) + \":\" + common.pad(min) + \":\"\n\t\t\t+ common.pad(sec) + \" / \" + maxh + \":\" + maxm + \":\" + maxs;\n\t\treturn setTimeout(moumouikkai, 1000);\n\t})();\n}\n\nfunction mouikkai() {\n\tsetInterval(function() {\n\t\tconst els = document.getElementsByTagName('syncwatch');\n\t\tfor (let i = 0; i < els.length; i++) {\n\t\t\tif (els[i].classList.contains('timerTicking'))\n\t\t\t\tcontinue;\n\t\t\ttimer_from_el(els[i]);\n\t\t}\n\t}, 1000);\n}\n\nmain.defer(batcTimeRender)\n\t.defer(mouikkai)\n\t.defer(function() {\n\t\t// Append UTC clock to the top of the schedule\n\t\tlet seconds;\n\t\tlet el = document.getElementById('UTCClock').firstChild;\n\t\tel.addEventListener('click', handler);\n\n\t\tfunction handler() {\n\t\t\tseconds = true;\n\t\t\tthis.removeAttribute('title');\n\t\t\tthis.style.cursor = 'default';\n\t\t\tthis.removeEventListener('click', handler);\n\t\t\trender();\n\t\t}\n\n\t\tfunction render() {\n\t\t\tif (!serverTimeOffset)\n\t\t\t\treturn setTimeout(render, 1000);\n\t\t\tel.innerHTML = oneeSama\n\t\t\t\t.readableUTCTime(new Date(common.serverTime()), seconds);\n\t\t\tsetTimeout(render, seconds ? 1000 : 60000);\n\t\t}\n\n\t\trender();\n\t});\n"],"sourceRoot":"/source/"}