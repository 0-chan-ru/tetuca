"use strict";System.register([],function(e){function t(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function i(e){function t(){e.stopImmediatePropagation(),e.preventDefault()}if(e.altKey){var i=y.attributes;switch(e.which){case i["new"]:var n=document.query("aside.posting");n&&(S.feed("new",n),t());break;case i.togglespoiler:w&&(w.onToggle(e),t());break;case i.done:w&&!w.$submit.attr("disabled")&&(w.finish(),t());break;case i.textSpoiler:if(w){var o=this.imouto.state2.spoiler,s=(o?"[/":" [")+"spoiler]";this.imouto.state2.spoiler=!o,this.$input.val(this.$input.val()+s),t()}break;case i.expandAll:u.massExpander.toggle(),t();break;case i.workMode:var r=a.oneeSama.workMode=!a.oneeSama.workMode;p.set("workModeTOG",r);var l=document.querySelector("h1 > img");null!=l&&(l.style.display=r?"none":""),document.getElementById("theme").setAttribute("href",f.MEDIA_URL+"css/"+(r?k.hotConfig.get("DEFAULT_CSS"):a.options.get("theme"))+".css?v="+a.cssHash),b.thumbStyle=r?"hide":a.options.get("thumbs"),a.options.trigger("workModeTOG"),window.addEventListener("beforeunload",function(){p.set("workModeTOG",!1)}),t()}}}function n(e){S.feed("new",document.query("#p"+e+" aside.posting"))}var o,s,a,r,l,u,d,h,c,p,m,f,g,v,$,b,y,S,k,w,I,x,_,T,M;return{setters:[],execute:function(){o=t(['<header>\n				<a class="name nope" target="_blank">\n					<b></b>\n				</a>\n			</header>\n			<span class="oi control" data-glyph="chevron-bottom"></span>\n			<div class="container">\n				<blockquote>\n					<p id="buffer" class="exclude"></p>\n					<p id="lineBuffer" class="exclude"></p>\n					<textarea ',"></textarea>\n				</blockquote>\n				<form ",">\n					<input ",">\n					<input ",">\n					<input ",'>\n					<strong id="uploadStatus"></strong>\n				</form>\n				<small></small>\n			</div>'],['<header>\n				<a class="name nope" target="_blank">\n					<b></b>\n				</a>\n			</header>\n			<span class="oi control" data-glyph="chevron-bottom"></span>\n			<div class="container">\n				<blockquote>\n					<p id="buffer" class="exclude"></p>\n					<p id="lineBuffer" class="exclude"></p>\n					<textarea ',"></textarea>\n				</blockquote>\n				<form ",">\n					<input ",">\n					<input ",">\n					<input ",'>\n					<strong id="uploadStatus"></strong>\n				</form>\n				<small></small>\n			</div>']),s=require("./article"),a=require("../main"),r=require("./embed"),l=require("./identity"),u=require("./imager"),d=a.$,h=a._,c=a.Backbone,p=a.Cookie,m=a.common,f=a.config,g=a.connSM,v=a.util,$=a.lang,b=a.oneeSama,y=a.options,S=a.postSM,k=a.state,w=void 0,I=void 0,a.reply("postForm",function(){return w}).reply("postModel",function(){return I}).reply("postForm:indentity",function(){return w&&w.renderIdentity()}),x=300,window.screen&&screen.width<=320&&(x=50),_=c.Model.extend({idAttribute:"num"}),g.on("synced",S.feeder("sync")),g.on("dropped",S.feeder("desync")),g.on("desynced",S.feeder("desync")),a.reply("postSM:feed",function(e){return S.feed(e)}),S.act("* + desync -> none",function(){w&&(w.el.classList.remove("editing"),w.$input.val(""),w.finish()),a.$threads.find("aside.posting").hide()}),S.act("none + sync, draft, alloc + done -> ready",function(){w&&(w.remove(),w=I=null);var e=!0,t=!1,i=void 0;try{for(var n,o=a.$threads[0].queryAll("aside.posting")[Symbol.iterator]();!(e=(n=o.next()).done);e=!0){var s=n.value;s.style.display=""}}catch(r){t=!0,i=r}finally{try{!e&&o["return"]&&o["return"]()}finally{if(t)throw i}}}),S.act("ready + new -> draft",function(e){var t=void 0,i=e.closest("section");i?t=v.getNum(i):i=document.createElement("section"),t&&!k.page.get("thread")&&k.posts.get(t).dispatch("shiftReplies",!0),w=new M({model:I=new _({op:t}),destination:e,section:i})}),S.preflight("draft",function(e){return e.matches("aside")}),S.act("draft + alloc -> alloc",function(e){return w.onAllocation(e)}),a.dispatcher[m.IMAGE_STATUS]=function(e){return w&&w.dispatch(e[0])},a.$doc.on("click","aside.posting a",function(){S.feed("new",this.parentNode)}),a.$doc.on("keydown",i),a.oneeSama.hook("insertOwnPost",function(e){var t=e.links;w&&t&&w.$buffer.find(".nope").each(function(){var e=d(this),i=e.text(),n=i.match(/^>>(\d+)/);if(n){var o=n[1],s=t[o];if(s){var a=d(m.join([w.imouto.postRef(o,s,!1)]));e.attr("href",a.attr("href")).attr("class","history");var r=a.text();r!=i&&e.text(r)}}})}),T=s.extend({events:{"click #cancel":"cancel","change #imageInput":"onImageChosen","input #trans":"onInput","keydown #trans":"onKeyDown","click #done":"finish","click #toggle":"onToggle"},initialize:function(e){s.prototype.initialize.call(this),this.listenTo(this.model,{change:this.renderButtons,"change:spoiler":this.renderSpoilerPane}),this.render(e).insertIntoDOM(e),this.model.set({spoiler:0,nextSpoiler:-1}),this.pending="",this.line_count=1,this.char_count=0;var t=this.imouto=new m.OneeSama({callback:inject,op:k.page.get("thread"),blockqoute:this.blockqoute,eLinkify:a.oneeSama.eLinkify,lang:a.lang,tamashii:function(e){var t=document.query("#p"+e);if(t=t&&t.closest("section")){var i=e in k.mine.readAll()&&$.you;return this.postRef(e,v.getNum(t),i)}return'<a class="nope">&gt;&gt;'+e+"</a>"}});t.setModel(this.model)},render:function(){var e={input:{name:"body",id:"input",rows:1,"class":"themed exclude",autocomplete:a.isMobile},form:{method:"post",enctype:"multipart/form-data",target:"upload",id:"uploadForm"},cancel:{type:"buttom",value:$.cancel,id:"cancel"},imageInput:{type:"file",id:"imageInput",name:"image",accept:"image/*;.webm;.pdf;.mp3"},toggle:{type:"button",id:"toggle"}};this.el.innerHTML=parseHTML(o,e.input,e.form,e.cancel,e.imageInput,e.toggle);var t=["buffer","lineBuffer","input","uploadForm","cancel","imageInput","toggle","uploadStatus","hiddenUpload","sizer"],i=!0,n=!1,s=void 0;try{for(var r,l=t[Symbol.iterator]();!(i=(r=l.next()).done);i=!0){var u=r.value;this[u]=document.query("#"+u)}}catch(d){n=!0,s=d}finally{try{!i&&l["return"]&&l["return"]()}finally{if(n)throw s}}return this.renderIdentity(),this},renderIdentity:function(){if(!this.model.get("num")){var e=m.parse_name(a.$name.val(),a.$email.val()),t=!(!e[1]&&!e[2]),i=this.el.query(".name"),n=i.query("a");e[0]?n.textContent=e[0]+" ":n.tetxContent=t?"":$.anon,t&&v.parseDOM(" <code>!?</code>").forEach(function(e){return n.after(e)}),a.oneeSama.trigger("fillMyName",n);var o=a.$email.val().trim();o?(i.setAttribute("href","mailto:"+o),i.classList.remove("nope"),i.classList.add("email")):(i.removeAttribute("href"),i.classList.add("nope"),i.classList.remove("email"))}},insertIntoDOM:function(e){var t=e.destination;t.before(this.el),this.resizeInput(),a.$threads.queryAll("aside.postsing").forEach(function(e){return e.style.display="none"}),this.fun()},resizeInput:function(e){var t=this.sizer,i=this.input;"string"!=typeof e&&(e=i.value),t.textContent=e;var n=t.width+m.INPUT_ROOM;n=Math.max(n,x-i.getBoundingClientRect().left-this.el.getBoundingClientRect().left),this.input.style.width=n+"px"},renderButtons:function(){var e=this.model.attributes,t=e.num,i=e.uploading,n=e.uploaded,o=e.uploadStatus,s=e.sentAllocRequest,a=s&&!t;this.submit.disabled=!(!i&&!a),n&&(this.submit.style.marginLeft=0),this.cancel.disabled=!!a,this.cancel.style.display=!t||i?"":"none",this.imageInput.disabled=!!i,this.uploadStatus.innerHTML=o},renderSpoilerPane:function(e,t){var i=t?f.MEDIA_URL+"spoil/spoil"+t+".png":f.MEDIA_URL+"css/ui/pane.png";this.toggle.style.backgroundImage='url("'+i+'")'}}),M=c.View.extend({events:{"input #trans":"onInput","keydown #trans":"onKeyDown","click #done":"finish","click #toggle":"onToggle"},initialize:function(e){this.listenTo(this.model,{change:this.renderButtons,"change:spoiler":this.renderSpoilerPane}),this.render(e),this.pending="",this.line_count=1,this.char_count=0;var t=this.imouto=new m.OneeSama({callback:inject,op:k.page.get("thread"),state:[m.S_BOL,0],state2:{spoiler:0},$buffer:this.$buffer,eLinkify:a.oneeSama.eLinkify,lang:a.lang,tamashii:function(e){var t=document.query("#p"+e);if(t=t&&t.closest("section")){var i=e in k.mine.readAll()&&this.lang.you;return this.postRef(e,v.getNum(t),i)}return'<a class="nope">&gt;&gt;'+e+"</a>"}});t.hook("spoilerTag",v.touchable_spoiler_tag),a.oneeSama.trigger("imouto",t)},render:function(e){var t=e.destination,i=e.section,n=this.model.get("op");this.setElement(n?document.createElement("article"):i),this.isThread=!n,this.$buffer=d("<p/>"),this.$lineBuffer=d("<p/>"),this.$meta=d('<header><a class="nope"><b/></a> <time/></header>'),this.$input=d("<textarea/>",{name:"body",id:"trans",rows:"1","class":"themed",autocomplete:a.isMobile}),this.$submit=d("<input/>",{id:"done",type:"button",value:a.lang.done}),this.$subject=d("<input/>",{id:"subject","class":"themed",maxlength:k.hotConfig.SUBJECT_MAX_LENGTH,width:"80%"}),this.$blockquote=d("<blockquote/>"),this.$sizer=d("<pre/>").appendTo("body"),this.$blockquote.append(this.$buffer,this.$lineBuffer,this.$input),this.$el.append(this.$meta,this.$blockquote,"<small/>"),this.isThread&&(this.$el.append('<label for="subject">'+$.subject+": </label>",this.$subject),this.$blockquote.hide()),this.$uploadForm=this.renderUploadForm(),this.$el.append(this.$uploadForm),a.oneeSama.trigger("draft",this.$el),this.renderIdentity(),t.style.display="none",this.isThread?(t.after(this.el),this.el.after(document.createElement("hr")),this.$subject.focus()):(t.before(this.el),this.resizeInput(),this.$input.focus()),a.$threads.find("aside.posting").hide(),this.fun()},renderIdentity:function(){if(!this.model.get("num")){var e=m.parse_name(a.$name.val(),a.$email.val()),t=!(!e[1]&&!e[2]),i=this.$meta.find("b");e[0]?i.text(e[0]+" "):i.text(t?"":a.lang.anon),t&&i.append(" <code>!?</code>"),a.oneeSama.trigger("fillMyName",i);var n=a.$email.val().trim(),o=this.$meta.children("a").first();n?o.attr({href:"mailto:"+n,target:"_blank","class":"email"}):o.removeAttr("href").removeAttr("target").attr("class","nope")}},renderButtons:function(){var e=this.model.attributes,t=e.sentAllocRequest&&!e.num,i=e.uploading||t;this.$submit.prop("disabled",!!i),e.uploaded&&this.$submit.css({"margin-left":"0"}),this.$cancel.prop("disabled",!!t),this.$cancel.toggle(!(e.num&&!e.uploading)),this.$imageInput.prop("disabled",!!e.uploading),this.$uploadStatus.html(e.uploadStatus)},renderSpoilerPane:function(e,t){var i=t?f.MEDIA_URL+"spoil/spoil"+t+".png":f.MEDIA_URL+"css/ui/pane.png";this.$toggle.css("background-image",'url("'+i+'")')},renderUploadForm:function(){var e=d('<form method="post" enctype="multipart/form-data" target="upload"></form>');return this.$cancel=d("<input/>",{type:"button",value:$.cancel,click:d.proxy(this,"cancel")}),this.$imageInput=d("<input/>",{type:"file",id:"image",name:"image",accept:f.WEBM?"imager/*;.webm":"image/*",change:d.proxy(this,"onImageChosen")}),this.$toggle=d("<input/>",{type:"button",id:"toggle"}),this.$uploadStatus=d("<strong/>"),e.append(this.$cancel,this.$imageInput,this.$toggle," ",this.$uploadStatus),this.$iframe=d("<iframe/>",{src:"",name:"upload",id:"hidden-upload"}).appendTo("body"),this.model.set({spoiler:0,nextSpoiler:-1}),e},cancel:function(){this.model.get("uploading")?(this.$iframe.remove(),this.$iframe=d("<iframe></iframe>",{src:"",name:"upload",id:"hidden-upload"}).appendTo("body"),this.uploadError(""),this.model.set({cancelled:!0})):this.finish()},onImageChosen:function(){if(!this.model.get("uploading")&&!this.model.get("uploaded")){if(!this.$imageInput.val())return void this.model.set("uploadStatus","");var e=this.prepareUpload();for(var t in e)d("<input type=hidden>").attr("name",t).val(e[t]).appendTo(this.$uploadForm);this.$uploadForm.prop("action",v.uploadURL()),this.$uploadForm.submit(),this.$iframe.load(function(){if(w){var e=this.contentWindow||this.contentDocument;if(e)try{var t=d(e.document||e).text();if(/legitimate imager response/.test(t))return;(t.length<5||t.length>100)&&(t=$.unknownUpload),w.uploadError(t)}catch(i){setTimeout(function(){w.uploadFallbackMessage()},500)}}}),this.notifyUploading()}},prepareUpload:function(){this.model.set("uploadStatus",$.uploading),this.$input.focus();var e=this.model.attributes;return{spoiler:e.spoiler,op:e.op||0}},uploadFallbackMessage:function(){var e=this.model.attributes,t=e.uploadStatus;e.cancelled||!e.uploading||t&&t!=$.uploading||this.model.set("uploadStatus",$.unknownResult)},notifyUploading:function(){this.model.set({uploading:!0,cancelled:!1}),this.$input.focus()},resizeInput:function(e){"string"!=typeof e&&(e=this.$input.val()),this.$sizer.text(e);var t=this.$sizer.width()+m.INPUT_ROOM;t=Math.max(t,x-this.$input.offset().left-this.$el.offset().left),this.$input.css("width",t+"px")},onInput:function(e){function t(t,i){var n=t[0].length,o=e.substr(0,t.index)+i+e.substr(t.index+n);if(l=!0,t.index<s){var r=n-i.length;s-=r,a-=r}return o}(void 0===e||e instanceof d.Event)&&(e=this.$input.val());for(var i,n,o,s=this.$input[0].selectionStart,a=this.$input[0].selectionEnd,l=!1;;){if(i=e.match(r.youtube_url_re),!i)break;n=this.findTimeArg(i[3])||this.findTimeArg(i[1])||i[4]||"",o=">>>/watch?v="+i[2]+n,e=t(i,o)}for(;;){if(i=e.match(r.youtube_short_re),!i)break;n=this.findTimeArg(i[2])||"",o=">>>/watch?v="+i[1]+n,e=t(i,o)}for(;;){if(i=e.match(r.soundcloud_url_re),!i)break;var u=">>>/soundcloud/"+i[1];e=t(i,u)}for(;;){if(i=e.match(r.pastebin_re),!i)break;var h=">>>/pastebin/"+i[1];e=t(i,h)}l&&this.$input.val(e);var c=e.lastIndexOf("\n");if(c>=0){var p=e.substr(0,c);e=e.substr(c+1),this.$input.val(e),(this.model.get("sentAllocRequest")||/[^ ]/.test(p))&&this.commit(p+"\n")}else if(i=e.split("").reverse().join("").match(/^(\s*\S+\s+\S+)\s+(?=\S)/)){var f=e.length-i[1].length;this.commit(e.substr(0,f)),e=e.substr(f),s-=f,a-=f,this.$input.val(e),this.$input[0].setSelectionRange(s,a)}this.$input.attr("maxlength",m.MAX_POST_CHARS-this.char_count),this.resizeInput(e)},findTimeArg:function(e){if(!e||e.indexOf("t=")<0)return!1;e=e.split("&");for(var t=0,i=e.length;i>t;t++){var n="#p"+e[t];if(r.youtube_time_re.test(n))return n}return!1},commit:function(e){var t;if(e.indexOf("\n")>=0){t=e.split("\n"),this.line_count+=t.length-1;var i=this.line_count-m.MAX_POST_LINES+1;if(i>0){for(var n=0;i>n;n++)t.pop();e=t.join("\n"),this.line_count=m.MAX_POST_LINES}}var o=m.MAX_POST_CHARS-this.char_count;if(o<e.length&&(e=e.substr(0,o)),e){this.char_count+=e.length;var s=this.model.attributes;if(s.num||s.sentAllocRequest?s.num?a.send(e):this.pending+=e:(a.send([m.INSERT_POST,this.allocationMessage(e,null)]),this.model.set({sentAllocRequest:!0})),t){t[0]=this.$lineBuffer.text()+t[0],this.$lineBuffer.text(t.pop());for(var r=0,l=t.length;l>r;r++)this.imouto.fragment(t[r]+"\n")}else this.$lineBuffer.append(document.createTextNode(e)),this.$lineBuffer[0].normalize()}},allocationMessage:function(e,t){function i(e,t){t&&(n[e]=t)}var n={nonce:a.request("nonce:create")};return i("name",a.$name.val().trim()),i("email",a.$email.val().trim()),i("subject",this.$subject.val().trim()),i("frag",e),i("image",t),i("op",this.model.get("op")),n},onKeyDown:function(e){var t=this;a.follow(function(){switch(e.which){case 13:e.preventDefault();case 32:var n=t.$input[0],o=t.$input.val();o=o.slice(0,n.selectionStart)+(13==e.which?"\n":" ")+o.slice(n.selectionEnd),t.onInput(o);break;default:i.bind(t)(e)}})},finish:function(){var e=this;if(this.model.get("num")){this.flushPending(),this.commit(this.$input.val()),this.$input.remove(),this.$submit.remove(),this.$uploadForm&&this.$uploadForm.remove(),this.$iframe&&(this.$iframe.remove(),this.$iframe=null),this.imouto.fragment(this.$lineBuffer.text()),this.$buffer.replaceWith(this.$buffer.contents()),this.$lineBuffer.remove(),this.$blockquote.css({"margin-left":"","padding-left":""}),a.send([m.FINISH_POST]),this.preserve=!0,this.isThread&&this.$el.append(a.oneeSama.replyBox());var t=this.imouto.allRolls.sent-this.imouto.allRolls.seen;t>0?!function(){var t=void 0;(t=function(i){setTimeout(function(){e.imouto.allRolls.seen==e.imouto.allRolls.sent||0==i?S.feed("done"):t(i-1)},100)})(5)}():S.feed("done")}else S.feed("done")},flushPending:function(){this.pending&&(a.send(this.pending),this.pending="")},onToggle:function(e){var t=this.model.attributes;if(!t.uploading&&!t.uploaded){if(e.preventDefault(),e.stopImmediatePropagation(),t.spoiler)return void this.model.set({spoiler:0});var i=m.pick_spoiler(t.nextSpoiler);this.model.set({spoiler:i.index,nextSpoiler:i.next})}},onAllocation:function(e){var t=e.num;k.ownPosts[t]=t,this.model.set({num:t}),this.flushPending();var i=d(a.oneeSama.header(e));this.$meta.replaceWith(i),this.$meta=i,this.isThread||this.$el.addClass("editing"),this.$el.attr("id","p"+t),e.image&&this.insertUploaded(e.image),this.$uploadForm?this.$uploadForm.append(this.$submit):this.$blockquote.after(this.$submit),this.isThread&&(this.$subject.siblings("label").andSelf().remove(),this.$blockquote.show(),this.resizeInput(),this.$input.focus()),window.onbeforeunload=function(){return"You have an unfinished post."}},insertUploaded:function(e){this.renderImage(null,e),this.$imageInput.siblings("strong").andSelf().remove(),this.$cancel.remove(),this.$uploadForm.find("#toggle").remove(),this.flushPending(),this.model.set({uploading:!1,uploaded:!0,sentAllocRequest:!0});var t=this.$el.find("img");this.$blockquote.css({"margin-left":t.css("margin-right"),"padding-left":t.width()}),this.resizeInput()},dispatch:function(e){var t=e.arg;switch(e.t){case"alloc":this.onImageAllocation(t);break;case"error":this.uploadError(t);break;case"status":this.uploadStatus(t)}},onImageAllocation:function(e){var t=this.model.attributes;t.cancelled||(t.num||t.sentAllocRequest?a.send([m.INSERT_IMAGE,e]):(a.send([m.INSERT_POST,this.allocationMessage(null,e)]),this.model.set({sentAllocRequest:!0})))},uploadError:function(e){this.model.get("cancelled")||(this.model.set({uploadStatus:e,uploading:!1}),this.$uploadForm&&this.$uploadForm.find("input[name=alloc]").remove())},uploadStatus:function(e){this.model.get("cancelled")||this.model.set("uploadStatus",e)},addReference:function(e,t){var i=this.$input.val();if(/^>>\d+$/.test(i)&&(this.$input.val(i+"\n"),this.onInput(),i=this.$input.val()),t){t=t.split("\n");for(var n=0,o=t.length;o>n;n++)t[n]=">"+t[n];e+="\n"+t.join("\n")+"\n"}this.$input.val(i+">>"+e),this.$input[0].selectionStart=this.$input.val().length,this.onInput(),this.$input.focus()},remove:function(){this.preserve||(this.isThread&&this.$el.next("hr").remove(),this.$el.remove()),this.$sizer.remove(),this.$iframe&&(this.$iframe.remove(),this.$iframe=null),this.stopListening(),window.onbeforeunload=null},renderImage:u.Hidamari.renderImage,autoExpandImage:function(){return this},fun:function(){}}),exports.ComposerView=M,a.reply("openPostBox",n),window.addEventListener("message",function(e){var t=e.data;"OK"!==t&&w&&w.uploadError(t)},!1),a.$threads.on("click","a.quote",function(e){function t(e){var t=o[e]&&o[e].parentElement;return t&&t.closest("blockquote")&&t.closest("article, section")===i}e.preventDefault();var i=e.target.closest("article, section"),o=getSelection(),s=v.getNum(i),a=void 0;t("baseNode")&&t("focusNode")&&(a=o.toString()),n(v.getNum(i.closest("section"))),w.addReference(s,a)})}}});
//# sourceMappingURL=../maps/posts/posting.js.map
