"use strict";System.register([],function(e){var t,s,r,i,o,a,n,c,h,d,u,l,m,g;return{setters:[],execute:function(){t=require("./main"),s=t.$,r=t.$script,i=t._,o=t.Backbone,a=t.common,n=t.lang,c=t.config.RECAPTCHA_PUBLIC_KEY,h=3e5,d=n.reports,u={},l=void 0,m=o.Model.extend({defaults:{status:"setup",hideAfter:!0},request_new:function(){var e=this;Recaptcha.create(c,"captcha",{theme:"clean",callback:function(){return e.set("status","ready")}}),this.get("timeout")&&clearTimeout(this.get("timeout")),this.set("timeout",setTimeout(function(){e.set("timeout",0),e.request_new()},h))},did_report:function(){var e=this;delete u[this.id],this.get("timeout")&&(clearTimeout(this.get("timeout")),this.set("timeout",0)),setTimeout(function(){return e.trigger("destroy")},1500),this.get("hideAfter")&&this.get("post").set("hide",!0)}}),g=o.View.extend({id:"report-panel",tagName:"form",className:"modal",events:{submit:"submit","click .close":"remove","click .hideAfter":"hide_after_changed"},initialize:function(){this.$captcha=s('<div id="captcha"/>'),this.$message=s('<div class="message"/>'),this.$submit=s("<input>",{type:"submit",val:"Report"});var e=s("<input>",{"class":"hideAfter",type:"checkbox",checked:this.model.get("hideAfter")}),r=s("<label>and hide</label>").append(e),i=this.model.get("post").get("num");this.$el.append(d.post+" ",t.oneeSama.postRef(i),'<a class="close" href="#">x</a>',this.$message,this.$captcha,this.$submit," ",r),window.x_csrf&&(this.model.set("hideAfter",!1),r.remove()),this.listenTo(this.model,{"change:error":this.error_changed,"change:status":this.status_changed,destroy:this.remove})},render:function(){return this.error_changed(),this.status_changed(),this},submit:function(){return"ready"!=this.model.get("status")?!1:(t.send([a.REPORT_POST,parseInt(this.model.get("post").get("num"),10),Recaptcha.get_challenge(),Recaptcha.get_response()]),this.model.set("status","reporting"),!1)},error_changed:function(){this.$message.text(this.model.get("error"))},status_changed:function(){var e=this.model.get("status");this.$submit.prop("disabled","ready"!=e).toggle("done"!==e).val("reporting"===e?d.reporting:n.report),this.$captcha.toggle(i.contains(["ready","reporting","error"],e)),"done"===e&&this.$("label").remove();var t=void 0;"done"===e?t=d.submitted:"setup"==e?t=d.setup:("error"==e||"ready"==e&&this.model.get("error"))&&(t="E"),this.$message.text("E"===t?this.model.get("error"):t),this.$message.toggle(!!t).toggleClass("error","E"==t),"ready"==e?this.focus():"done"==e?this.model.did_report():"error"==e&&this.model.request_new()},hide_after_changed:function(e){this.model.set("hideAfter",e.target.checked)},focus:function(){Recaptcha.focus_response_field()},remove:function(){return o.View.prototype.remove.call(this),l===this&&(l=null,Recaptcha.destroy()),!1}}),t.reply("report",function(e){var t="https://www.google.com/recaptcha/api/js/recaptcha_ajax.js";r(t,function(){var t=e.get("num"),s=u[t];if(s||(u[t]=s=new m({id:t,post:e})),l){if(l.model===s)return void l.focus();l.remove()}l=new g({model:s}),l.render().$el.appendTo("body"),window.Recaptcha?s.request_new():s.set({status:"error",error:d.loadError})})}),t.dispatcher[a.REPORT_POST]=function(e){var t=u[e[0]];t&&t.set(e[1]||{status:"done"})}}}});
//# sourceMappingURL=maps/report.js.map
