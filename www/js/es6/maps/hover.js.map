{"version":3,"sources":["hover.js"],"names":[],"mappings":"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","file":"hover.js","sourcesContent":["/*\n * Hover previews\n */\n\nlet main = require('./main'),\n\t{Article} = main.posts,\n\t{$, Backbone, etc, options, state} = main;\n\n// Centralised mousemove target tracking\n/*Logging only the target isn't a option because change:target doesn't seem\n to fire in some cases where the target is too similar for example changing\n between two post links (>>XXX) directly\n */\nconst mousemove = new Backbone.Model();\n\nlet ImageHoverView = Backbone.View.extend({\n\tinitialize() {\n\t\tthis.listenTo(this.model,'change:event', this.check);\n\t\tmain.reply('imager:clicked', () => this.$el.empty());\n\t},\n\tcheck(model, event) {\n\t\t// Disabled in options\n\t\tif (!options.get('imageHover'))\n\t\t\treturn;\n\t\tvar $target = $(event.target);\n\t\tif (!$target.is('img') || $target.hasClass('expanded'))\n\t\t\treturn this.$el.children().remove(\"img,video\");\n\t\tconst src = $target.closest('a').attr('href'),\n\t\t\tisWebm = /\\.webm$/.test(src);\n\t\t// Nothing to preview for PDF or MP3\n\t\tif (/\\.pdf$/.test(src)\n\t\t\t|| /\\.mp3$/.test(src)\n\t\t\t|| (isWebm && !options.get('webmHover'))\n\t\t)\n\t\t\treturn this.$el.empty();\n\t\t$(isWebm ? '<video/>' : '<img/>', {\n\t\t\tsrc: src,\n\t\t\tautoplay: true,\n\t\t\tloop: true\n\t\t}).appendTo(this.$el.empty());\n\t}\n});\n\nlet PostPreview = Article.extend({\n\tinitialize(args) {\n\t\tthis.parentNum = args.parentNum;\n\t\tthis.listenTo(this.model, 'dispatch', this.redirect)\n\t\t\t.render().$el.addClass('preview');\n\t\tthis.update();\n\t},\n\tupdate() {\n\t\tif (!this.num)\n\t\t\tthis.num = etc.getID(this.el);\n\t\tpostHover.render(this.$el, this.parentNum);\n\t}\n});\n\nlet HoverPostView = Backbone.View.extend({\n\tinitialize() {\n\t\tthis.listenTo(this.model,'change:event', this.check);\n\t},\n\tcheck(model, event) {\n\t\tlet $target = $(event.target);\n\t\tif (!$target.is('a.history'))\n\t\t\treturn;\n\t\tconst m = $target.text().match(/^>>(\\d+)/);\n\t\tif (!m)\n\t\t\treturn;\n\t\tlet post = state.posts.get(m[1]);\n\t\tif (!post)\n\t\t\treturn;\n\t\tthis.targetPos = $target.offset();\n\t\tthis.previewView = new PostPreview({\n\t\t\tmodel: post,\n\t\t\tparentNum: etc.getID(event.target)\n\t\t});\n\t\t$target.one('mouseleave click', () => this.remove());\n\t},\n\tremove() {\n\t\tif (!this.previewView)\n\t\t\treturn;\n\t\tthis.targetPos = null;\n\t\tthis.previewView.remove();\n\t\tthis.stopListening(this.previewView);\n\t\tthis.$el.children().remove('.preview');\n\t\tthis.previewView = null;\n\t},\n\trender($el, num) {\n\t\t// Striped underline links from the parent post\n\t\t$el.find('a.history')\n\t\t\t.filter(function () {\n\t\t\t\treturn this.text.includes('>>' + num);\n\t\t\t})\n\t\t\t.each(function () {\n\t\t\t\t$(this).addClass('referenced');\n\t\t\t});\n\t\t$el.css(this.position($el)).appendTo(this.$el.empty());\n\t},\n\tposition($el) {\n\t\t$el.hide();\n\t\t$(document.body).append($el);\n\t\tvar w = $el.width();\n\t\tvar h = $el.height();\n\t\t$el.detach().show();\n\n\t\tvar $w = $(window);\n\t\tvar l = this.targetPos.left -$w.scrollLeft();\n\t\tvar t = this.targetPos.top -$w.scrollTop()-h-17;\n\n\t\t//If it get cut at the top, put it below the link\n\t\tif(t<0)\n\t\t\tt+=h+34;\n\n\t\t//if it gets cut to the right push it to the left.\n\t\tvar overflowR = l+w-$w.innerWidth();\n\t\tif(overflowR>-30)\n\t\t\tl = Math.max(0,l-overflowR-30);\n\n\t\treturn {left: l,top: t};\n\t}\n});\n\nlet ltarget, postHover;\nif (!main.isMobile) {\n\tmain.defer(function() {\n\t\tmain.$doc.on('mousemove', function(e) {\n\t\t\tif(e.target!=ltarget) {\n\t\t\t\tmousemove.set('event', e);\n\t\t\t\tltarget= e.target;\n\t\t\t}\n\t\t});\n\t\tlet hover = document.getElementById('hover_overlay');\n\t\tnew ImageHoverView({\n\t\t\tmodel: mousemove,\n\t\t\tel: hover\n\t\t});\n\t\tpostHover = new HoverPostView({\n\t\t\tmodel: mousemove,\n\t\t\tel: hover\n\t\t});\n\t});\n}\n"],"sourceRoot":"/source/"}