{"version":3,"sources":["time.js"],"names":[],"mappings":"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","file":"time.js","sourcesContent":["/*\nTimezone corrections, batch timestamp updates, syncwatch, util.\n */\n\nlet main = require('./main'),\n\t{$, Backbone, common, oneeSama, options, state} = main;\n\n// Get a more accurate server-client time offset, for interclient syncing\n// Does not account for latency, but good enough for our purposes\nvar serverTimeOffset = 0;\nmain.dispatcher[common.GET_TIME] = function(msg){\n\tif (!msg[0])\n\t\treturn;\n\tserverTimeOffset = msg[0] - Date.now();\n};\nmain.reply('time:offset', () => serverTimeOffset);\n\nlet renderTimer;\nfunction batcTimeRender(source, rtime = options.get('relativeTime')) {\n\tstate.posts.each(model => model.dispatch('renderTime'));\n\tif (renderTimer)\n\t\tclearTimeout(renderTimer);\n\tif (rtime)\n\t\trenderTimer = setTimeout(batcTimeRender, 60000)\n}\nmain.reply('time:render', batcTimeRender);\noptions.on('change:relativeTime', batcTimeRender);\n\n/* syncwatch */\nfunction timer_from_el(el) {\n\tif (!serverTimeOffset)\n\t\treturn;\n\tel.classList.add('timerTicking');\n\tconst start = el.getAttribute('start'),\n\t\tend = el.getAttribute('end'),\n\t\tmaxh = common.pad(el.getAttribute('hour')),\n\t\tmaxm = common.pad(el.getAttribute('min')),\n\t\tmaxs = common.pad(el.getAttribute('sec'));\n\n\t(function moumouikkai() {\n\t\t// Prevent memory leak\n\t\tif (!document.body.contains(el))\n\t\t\treturn;\n\t\tconst now = common.serverTime();\n\t\tif (now > end)\n\t\t\treturn el.textContent = main.lang.finished;\n\n\t\t// If the start time is in the future\n\t\tif (start > now) {\n\t\t\tconst countdown = Math.round((start - now) / 1000);\n\t\t\tif(countdown === 10)\n\t\t\t\tmain.request('time:syncwatch');\n\t\t\tel.textContent = 'Countdown: ' + countdown;\n\t\t\treturn setTimeout(moumouikkai, 1000);\n\t\t}\n\n\t\tlet diff = now - start;\n\t\tconst hour = Math.floor(diff / 1000 /60 / 60);\n\t\tdiff -= hour * 1000 * 60 * 60;\n\t\tconst min = Math.floor( diff / 1000 / 60);\n\t\tdiff -= min * 1000 * 60;\n\t\tconst sec = Math.floor(diff / 1000);\n\t\tel.textContent = common.pad(hour) + \":\" + common.pad(min) + \":\"\n\t\t\t+ common.pad(sec) + \" / \" + maxh + \":\" + maxm + \":\" + maxs;\n\t\treturn setTimeout(moumouikkai, 1000);\n\t})();\n}\n\nfunction mouikkai() {\n\tsetInterval(function() {\n\t\tconst els = document.getElementsByTagName('syncwatch');\n\t\tfor (let i = 0; i < els.length; i++) {\n\t\t\tif (els[i].classList.contains('timerTicking'))\n\t\t\t\tcontinue;\n\t\t\ttimer_from_el(els[i]);\n\t\t}\n\t}, 1000);\n}\n\nmain.defer(batcTimeRender)\n\t.defer(mouikkai)\n\t.defer(function() {\n\t\t// Append UTC clock to the top of the schedule\n\t\tlet seconds;\n\t\tlet el = document.getElementById('UTCClock').firstChild;\n\t\tel.addEventListener('click', handler);\n\n\t\tfunction handler() {\n\t\t\tseconds = true;\n\t\t\tthis.removeAttribute('title');\n\t\t\tthis.style.cursor = 'default';\n\t\t\tthis.removeEventListener('click', handler);\n\t\t\trender();\n\t\t}\n\n\t\tfunction render() {\n\t\t\tif (!serverTimeOffset)\n\t\t\t\treturn setTimeout(render, 1000);\n\t\t\tel.innerHTML = oneeSama\n\t\t\t\t.readableUTCTime(new Date(common.serverTime()), seconds);\n\t\t\tsetTimeout(render, seconds ? 1000 : 60000);\n\t\t}\n\n\t\trender();\n\t});\n"],"sourceRoot":"/source/"}