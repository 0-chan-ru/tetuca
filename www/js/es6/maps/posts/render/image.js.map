{"version":3,"sources":["posts/render/image.js"],"names":[],"mappings":"6MAIO,sCACC,6CACA,+CACD,2CACC,0BAAW,4mBAGZ,SAAS,WAAT,CAAqB,IAArB,CAA2B,MAA3B,CAAmC,CACzC,MAAM,UAAY,QAAQ,GAAR,CAAY,QAAZ,IAA0B,MAA1B,EAAoC,MAApC,CADuB,OAElC,SACN,CAAC;GAAD,GACG,iBAAiB,IAAjB,CAAuB,MAAvB,CADH,EACkC;GADlC,GAEG,OAAO,MAAP,CAAc,GAAd,EAAqB,SAArB,CAAiC,2BAAjC,CAA8D,EAA9D,EAAiE;GAFpE,GAGG,UAAY,gBAAgB,IAAhB,CAAZ,CAAoC,EAApC,EAAuC;WAH1C,CADM,CAFkC,CAAnC,mCAWA,SAAS,gBAAT,CAA0B,IAA1B,CAAgC,MAAhC,CAAwC,CAC9C,MAAM,KAAO,UAAU,CACtB,KAAK,KAAL,CAAa,QAAb,CAAwB,EAAxB,CACA,KAAK,MAAL,CACA,iBAAiB,KAAK,IAAL,CAHK,CAItB,CAAC,GAAE,KAAK,IAAL,CAAU,CAAV,CAAH,EAAgB,CAAhB,GAAmB,KAAK,IAAL,CAAU,CAAV,CAAnB,EAAgC,CAJV,CAKtB,KAAK,IAAL,CAAY,MAAZ,CAAqB,EAArB,CALY,CAAP,CADwC,OAQvC,SACN,CAAC;GAAD,GACG,aAAa,MAAb,CADH,EACwB;GADxB,GAEG,YAAY,IAAZ,CAFH,EAEqB;;KAFrB,GAIK,IAJL,EAIU;;GAJV,GAMG,UAAU,IAAV,CANH,EAMmB;eANnB,CADM,CARuC,CAAxC,6CAoBP,SAAS,gBAAT,CAA0B,IAA1B,CAAgC,CAC/B,GAAI,KAAO,IAAP,CAAa,CAChB,OAAO,KAAO,IAAP,CADS,CAAjB,GAGI,KAAO,OAAP,CAAgB,CACnB,OAAO,KAAK,KAAL,CAAW,KAAO,IAAP,CAAX,CAA0B,KAA1B,CADY,CAApB,IAGA,CAAO,KAAK,KAAL,CAAW,KAAO,QAAP,CAAX,CAA4B,QAA5B,EAAP,CAP+B,OAQxB,KAAK,KAAL,CAAW,CAAX,CAAc,CAAC,CAAD,CAAd,CAAoB,GAApB,CAA0B,KAAK,KAAL,CAAW,CAAC,CAAD,CAArC,CAA2C,KAA3C,CARwB,CAAhC,SAYS,YAAT,CAAsB,MAAtB,CAA8B,CAC7B,GAAI,QAAQ,GAAR,CAAY,QAAZ,IAA0B,MAA1B,CAAkC,CACrC,OAAO,EAAP,CADqC,CAAtC,OAGO,SACN,CAAC;IAAD,GACI,KAAK,OAAS,MAAT,CAAkB,MAAlB,CADT,EACmC;MADnC,CADM,CAJsB,CAA9B,MAWM,WAAa,CAClB,IAAK,WAAL,CACA,MAAO,aAAP,CACA,IAAK,WAAL,CACA,MAAO,oBAAP,CAJK,CAQN,MAAM,gBAAkB,UAAY,CACnC,MAAM,OAAS,CACd,CACC,OAAQ,QAAR,CACA,IAAK,iDAAL,CACA,KAAM,OAAN,CACA,OAAQ,GAAR,CALa,CAOd,CACC,OAAQ,MAAR,CACA,IAAK,uBAAL,CACA,KAAM,OAAN,CACA,OAAQ,IAAR,CAXa,CAad,CACC,OAAQ,UAAR,CACA,IAAK,4CAAL,CACA,KAAM,OAAN,CACA,OAAQ,IAAR,CAjBa,CAmBd,CACC,OAAQ,aAAR,CACA,KAAM,KAAN,CACA,IAAK,yCAAL,CACA,OAAQ,IAAR,CAvBa,CAyBd,CACC,OAAQ,UAAR,CACA,KAAM,MAAN,CACA,IAAK,qDAAL,CACA,OAAQ,IAAR,CA7Ba,CAAT,CAD6B,MAkC7B,UAAY,EAAZ,CAlC6B,YAmCnC,IAAwC,MAAxC,CAAgD,KAAtC,mBAAsC,IAA9B,aAA8B,IAAzB,eAAyB,IAAnB,mBAAmB,MACzC,MAAQ,CACb,OAAQ,QAAR,CACA,IAAK,UAAL,CACA,MAAO,eAAiB,MAAjB,CAHF,CADyC,SAM/C,CAAU,MAAV,EAAoB,QAAQ,CAC3B,GAAI,CAAC,QAAQ,GAAR,CAAY,MAAZ,CAAD,CAAsB,CACzB,OAAO,EAAP,CADyB,CAA1B,KAGA,CAAM,IAAN,CAAa,KAAM,OAAS,OAAT,CAAmB,UAAU,IAAV,CAAnB,CAAqC,KAAK,IAAL,CAArC,CAAN,CAJc,OAKpB,SACN,CAAC,GAAD,GAAM,gBAAgB,KAAhB,CAAN,EAA6B;KAA7B,GACG,MADH,EACU;QADV,CADM,CALoB,CAAR,CAN2B,CAAhD,OAkBO,SAAP,CArDmC,CAAX,EAAnB,CAyDN,SAAS,WAAT,CAAqB,IAArB,CAA2B,CAC1B,IAAI,KAAO,EAAP,CADsB,GAItB,CAAC,MAAD,CAAS,MAAT,EAAiB,OAAjB,CAAyB,KAAK,GAAL,CAAzB,CAAqC,CAAC,CAAD,CAAI,CAC5C,GAAI,QAAQ,GAAR,CAAY,QAAZ,CAAJ,CAA2B,CAC1B,OAAO,gBAAgB,MAAhB,CAAuB,IAAvB,CAAP,CAD0B,CAA3B,OAGO,EAAP,CAJ4C,CAA7C,IAMK,IAAI,MAAJ,IAAc,eAAnB,CAAoC,CACnC,MAAQ,gBAAgB,MAAhB,EAAwB,IAAxB,CAAR,CADmC,CAApC,OAGO,IAAP,CAb0B,CAA3B,SAkBS,SAAT,CAAmB,IAAnB,CAAyB,GAAzB,CAA8B,CAC7B,OAAO,WAAW,IAAX,EAAmB,KAAK,KAAO,KAAK,GAAL,CAAW,KAAlB,CAA0B,OAA1B,CAAxB,CADsB,CAA9B,SAKS,SAAT,CAAmB,IAAnB,CAAyB,CACpB,SAAO,EAAP,CADoB,WAEb,MAFa,IAEtB,mBAFsB,MAGlB,EAAI,MAAM,KAAN,CAAY,iBAAZ,CAAJ,CAHkB,GAIpB,CAAJ,CAAO,CACN,KAAO,EAAE,CAAF,CAAP,CADM,CAAP,MAGM,SAAW,OAAO,KAAP,CAAX,CACL,QAAU,KAAK,MAAL,EAAe,EAAf,CARa,GASpB,OAAJ,CAAa,CACZ,MAAQ,OAAO,KAAK,KAAL,CAAW,CAAX,CAAc,EAAd,CAAP,EACL,YADK,CAEL,OAAO,KAAK,GAAL,CAFF,CADI,CAAb,MAKM,MAAQ,CACb,KAAM,CAAC,GAAE,OAAO,mBAAP,EAA2B,IAA9B,GAAoC,KAAK,GAAL,EAAS,CAAnD,CACA,IAAK,UAAL,CACA,SAAU,QAAV,CAHK,CAdkB,GAmBpB,OAAJ,CAAa,CACZ,MAAM,KAAN,CAAc,QAAd,CADY,CAAb,OAGO,SACN,CAAC,GAAD,GAAM,gBAAgB,KAAhB,CAAN,EAA6B;GAA7B,GACG,KADH,EACS;MADT,CADM,CAtBiB,CAAzB,SA6BS,SAAT,CAAmB,SAAnB,CAA8B,CAC7B,GAAI,WAAa,OAAO,MAAP,CAAc,IAAd,CAAoB,CACpC,OAAO,2BAAP,CADoC,CAArC,OAGO,EAAP,CAJ6B,CAA9B,SAQgB,eAAT,CAAyB,IAAzB,CAA+B,IAA/B,CAAqC,CACvC,QAAM,WAAW,GAAX,CAAiB,KAAK,GAAL,CADgB,IAE1C,MAF0C,8BAGC,KAAK,IAAL,IAHD,IAGzC,oBAHyC,IAGlC,qBAHkC,IAG1B,yBAH0B,IAGd,0BAHc,GAKvC,KAAK,OAAL,EAAgB,QAAQ,GAAR,CAAY,UAAZ,CAAhB,CAAyC,CAE5C,MAAM,GAAK,YAAY,IAAZ,CAAL,CAFsC,KAG5C,CAAQ,GAAG,KAAH,CAHoC,UAI5C,CAAa,GAAG,IAAH,CAAQ,CAAR,CAAb,CAJ4C,WAK5C,CAAc,GAAG,IAAH,CAAQ,CAAR,CAAd,CAL4C,CAA7C,KAMO,GAAI,KAAK,GAAL,GAAa,MAAb,EAAuB,QAAQ,GAAR,CAAY,SAAZ,CAAvB,CAA+C,CAEzD,MAAQ,GAAR,CAFyD,CAAnD,KAGA,CACN,MAAQ,UAAU,IAAV,CAAgB,QAAQ,GAAR,CAAY,QAAZ,IAA0B,OAA1B,CAAxB,CADM,CAHA,MAOD,UAAY,CACjB,OAAQ,QAAR,CACA,IAAK,UAAL,CACA,KAAM,MAAQ,GAAR,CAHD,CAlBqC,MAuBrC,SAAW,CAChB,IAAK,KAAL,CACA,MAAO,UAAP,CACA,OAAQ,WAAR,CAHK,CAvBqC,GA8BvC,IAAJ,CAAU,CAET,UAAU,KAAV,CAAkB,SAAlB,CAFS,QAKT,CAAS,KAAT,CAAiB,UAAjB,CALS,GAMN,KAAK,UAAL,EAAmB,MAAnB,CAA2B,CAC7B,SAAS,KAAT,CAAiB,eAAjB,CAD6B,CAA9B,CAND,OAWO,SACN,CAAC,GAAD,GAAM,gBAAgB,SAAhB,CAAN,EAAiC;QAAjC,GACQ,gBAAgB,QAAhB,CADR,EACkC;MADlC,CADM,CAzCoC,CAArC,2CAgDP,SAAS,WAAT,OAA4C,KAAtB,4BAAsB,IAAV,sBAAU,IACvC,MAAQ,WAAW,KAAX,CAD+B,GAEvC,YAAc,QAAQ,GAAR,CAAY,QAAZ,IAA0B,OAA1B,CAAmC,CACpD,OAAS,GAAT,CADoD,CAArD,IAGA,EAAQ,QAAU,MAAV,CALmC,OAMpC,CACN,KADM,CAEN,KAAM,OAAO,MAAP,CAAc,KAAd,CAAoB,WAAa,SAAb,CAAyB,WAAzB,CAA1B,CAFD,CAN2C,CAA5C","file":"posts/render/image.js","sourcesContent":["/*\n Image thumbnail HTML rendering\n*/\n\nimport lang from 'lang'\nimport {config} from '../../state'\nimport {escape} from 'underscore'\nimport options from '../../options'\nimport {parseHTML, commaList} from '../../util'\n\n// Render a thumbnail of an image, according to configuration settings\nexport function renderImage(data, reveal) {\n\tconst showThumb = options.get(\"thumbs\") !== 'hide' || reveal\n\treturn parseHTML\n\t\t`<figure>\n\t\t\t${renderFigcaption(data, reveal)}\n\t\t\t${config.images.hat && showThumb ? '<span class=\"hat\"></span>': ''}\n\t\t\t${showThumb ? renderThumbnail(data) : ''}\n\t\t</figure>`\n}\n\n// Render the information caption above the image\nexport function renderFigcaption(data, reveal) {\n\tconst list = commaList([\n\t\tdata.audio ? '\\u266B' : '',\n\t\tdata.length,\n\t\treadableFilesize(data.size),\n\t\t`${data.dims[0]}x${data.dims[1]}`,\n\t\tdata.apng ? 'APNG' : ''\n\t])\n\treturn parseHTML\n\t\t`<figcaption>\n\t\t\t${hiddenToggle(reveal)}\n\t\t\t${imageSearch(data)}\n\t\t\t<span>\n\t\t\t\t(${list})\n\t\t\t</span>\n\t\t\t${imageLink(data)}\n\t\t</figcaption>`\n}\n\n// Renders a human readable file size string\nfunction readableFilesize(size) {\n\tif (size < 1024) {\n\t\treturn size + ' B'\n\t}\n\tif (size < 1048576) {\n\t\treturn Math.round(size / 1024) + ' KB'\n\t}\n\tsize = Math.round(size / 104857.6).toString()\n\treturn size.slice(0, -1) + '.' + size.slice(-1) + ' MB'\n}\n\n// Render the button for toggling hidden thumbnails\nfunction hiddenToggle(reveal) {\n\tif (options.get('thumbs') !== 'hide') {\n\t\treturn ''\n\t}\n\treturn parseHTML\n\t\t`<a class=\"imageToggle\">\n\t\t\t[${lang[reveal ? 'hide' : 'show']}]\n\t\t</a>`\n}\n\n// Base URLs of image addresses\nconst imagePaths = {\n\tsrc: '/img/src/',\n\tthumb: '/img/thumb/',\n\tmid: '/img/mid/',\n\tspoil: '/ass/spoil/spoiler'\n}\n\n// Generate template functions for each image search engine\nconst searchTemplates = (function() {\n\tconst models = [\n\t\t{\n\t\t\tengine: 'google',\n\t\t\turl: 'https://www.google.com/searchbyimage?image_url=',\n\t\t\ttype: 'thumb',\n\t\t\tsymbol: 'G'\n\t\t},\n\t\t{\n\t\t\tengine: 'iqdb',\n\t\t\turl: 'http://iqdb.org/?url=',\n\t\t\ttype: 'thumb',\n\t\t\tsymbol: 'Iq'\n\t\t},\n\t\t{\n\t\t\tengine: 'saucenao',\n\t\t\turl: 'http://saucenao.com/search.php?db=999&url=',\n\t\t\ttype: 'thumb',\n\t\t\tsymbol: 'Sn'\n\t\t},\n\t\t{\n\t\t\tengine: 'desustorage',\n\t\t\ttype: 'MD5',\n\t\t\turl: 'https://desustorage.org/_/search/image/',\n\t\t\tsymbol: 'Ds'\n\t\t},\n\t\t{\n\t\t\tengine: 'exhentai',\n\t\t\ttype: 'SHA1',\n\t\t\turl: 'http://exhentai.org/?fs_similar=1&fs_exp=1&f_shash=',\n\t\t\tsymbol: 'Ex'\n\t\t}\n\t]\n\n\tconst templates = {}\n\tfor (let {engine, url, type, symbol} of models) {\n\t\tconst attrs = {\n\t\t\ttarget: '_blank',\n\t\t\trel: 'nofollow',\n\t\t\tclass: 'imageSearch ' + engine\n\t\t}\n\t\ttemplates[engine] = data => {\n\t\t\tif (!options.get(engine)) {\n\t\t\t\treturn ''\n\t\t\t}\n\t\t\tattrs.href = url+ (type === 'thumb' ? thumbPath(data) : data[type])\n\t\t\treturn parseHTML\n\t\t\t\t`<a ${parseAttributes(attrs)}>\n\t\t\t\t\t${symbol}\n\t\t\t\t</a>`\n\t\t}\n\t}\n\n\treturn templates\n})()\n\n// Render image search links in accordance to client settings\nfunction imageSearch(data) {\n\tlet html = ''\n\n\t// Only render google for PDFs and MP3s\n\tif (['.pdf', '.mp3'].indexOf(data.ext) > -1) {\n\t\tif (options.get(\"google\")) {\n\t\t\treturn searchTemplates.google(data)\n\t\t}\n\t\treturn ''\n\t}\n\tfor (let engine in searchTemplates) {\n\t\thtml += searchTemplates[engine](data)\n\t}\n\treturn html\n}\n\n// Get the thumbnail path of an image, accounting for not thumbnail of specific\n// type being present\nfunction thumbPath(data, mid) {\n\treturn imagePaths[type] + data[mid && data.mid ? 'mid' : 'thumb']\n}\n\n// Render a name + download link of an image\nfunction imageLink(data) {\n\tlet name = '',\n\t\t{imgnm} = imgnm\n\tconst m = imgnm.match(/^(.*)\\.\\w{3,4}$/);\n\tif (m) {\n\t\tname = m[1]\n\t}\n\tconst fullName = escape(imgnm),\n\t\ttooLong = name.length >= 38\n\tif (tooLong) {\n\t\timgnm = escape(name.slice(0, 30))\n\t\t\t+ '(&hellip;)'\n\t\t\t+ escape(data.ext)\n\t}\n\tconst attrs = {\n\t\thref: `${config.SECONDARY_MEDIA_URL}src/${data.src}`,\n\t\trel: 'nofollow',\n\t\tdownload: fullName\n\t}\n\tif (tooLong) {\n\t\tattrs.title = fullName\n\t}\n\treturn parseHTML\n\t\t`<a ${parseAttributes(attrs)}>\n\t\t\t${imgnm}\n\t\t</a>`\n}\n\n// Render a hat on top of the thumbnail, if enabled\nfunction renderHat(showThumb) {\n\tif (showThumb && config.images.hats) {\n\t\treturn '<span class=\"hat\"></span>'\n\t}\n\treturn ''\n}\n\n// Render the actual thumbnail image\nexport function renderThumbnail(data, href) {\n\tlet src = imagePaths.src + data.src,\n\t\tthumb,\n\t\t[width, height, thumbWidth, thumbHeight] = data.dims\n\n\tif (data.spoiler && options.get('spoilers')) {\n\t\t// Spoilered and spoilers enabled\n\t\tconst sp = spoilerInfo(data)\n\t\tthumb = sp.thumb\n\t\tthumbWidth = sp.dims[0]\n\t\tthumbHeight = sp.dims[1]\n\t} else if (data.ext === '.gif' && options.get('autogif')) {\n\t\t// Animated GIF thumbnails\n\t\tthumb = src\n\t} else {\n\t\tthumb = thumbPath(data, options.get('thumbs') !== 'small')\n\t}\n\n\tconst linkAttrs = {\n\t\ttarget: '_blank',\n\t\trel: 'nofollow',\n\t\thref: href || src\n\t}\n\tconst imgAttrs = {\n\t\tsrc: thumb,\n\t\twidth: thumbWidth,\n\t\theight: thumbHeight\n\t}\n\n\t// Catalog pages\n\tif (href) {\n\t\t// Handle the thumbnails with the HTML5 History controller\n\t\tlinkAttrs.class = 'history'\n\n\t\t// No image hover previews\n\t\timgAttrs.class = 'expanded'\n\t\tif(this.thumbStyle == 'hide') {\n\t\t\timgAttrs.style = 'display: none'\n\t\t}\n\t}\n\n\treturn parseHTML\n\t\t`<a ${parseAttributes(linkAttrs)}>\n\t\t\t<img ${parseAttributes(imgAttrs)}>\n\t\t</a>`\n}\n\n// Parse and return image spoiler information\nfunction spoilerInfo({largeThumb, spoiler}) {\n\tlet thumb = imagePaths.spoil\n\tif (largeThumb || options.get(\"thumbs\") !== 'small') {\n\t\tthumb += 's'\n\t}\n\thtml += spoiler + '.png'\n\treturn {\n\t\tthumb,\n\t\tdims: config.images.thumb[largeThumb ? 'midDims' : 'thumbDims']\n\t}\n}\n"],"sourceRoot":"/source/"}