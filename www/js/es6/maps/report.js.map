{"version":3,"sources":["report.js"],"names":[],"mappings":"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","file":"report.js","sourcesContent":["/*\n Report posts you don't like\n */\n\nconst main = require('./main'),\n\t{$, $script, _, Backbone, common, lang} = main;\n\n// TODO: Rewrite this and move to API v2\n\nconst pubKey = main.config.RECAPTCHA_PUBLIC_KEY,\n\tcaptchaTimeout = 5 * 60 * 1000,\n\trepLang = lang.reports,\n\treports = {};\nlet panel;\n\nlet Report = Backbone.Model.extend({\n\tdefaults: {\n\t\tstatus: 'setup',\n\t\thideAfter: true\n\t},\n\trequest_new() {\n\t\tRecaptcha.create(pubKey, 'captcha', {\n\t\t\ttheme: 'clean',\n\t\t\tcallback: () => this.set('status', 'ready')\n\t\t});\n\n\t\tif (this.get('timeout'))\n\t\t\tclearTimeout(this.get('timeout'));\n\n\t\tthis.set('timeout', setTimeout(() => {\n\t\t\tthis.set('timeout', 0);\n\t\t\tthis.request_new();\n\t\t}, captchaTimeout));\n\t},\n\tdid_report() {\n\t\tdelete reports[this.id];\n\t\tif (this.get('timeout')) {\n\t\t\tclearTimeout(this.get('timeout'));\n\t\t\tthis.set('timeout', 0);\n\t\t}\n\n\t\tsetTimeout(() => this.trigger('destroy'), 1500);\n\n\t\tif (this.get('hideAfter'))\n\t\t\tthis.get('post').set('hide', true);\n\t}\n});\n\nvar ReportPanel = Backbone.View.extend({\n\tid: 'report-panel',\n\ttagName: 'form',\n\tclassName: 'modal',\n\tevents: {\n\t\tsubmit: 'submit',\n\t\t'click .close': 'remove',\n\t\t'click .hideAfter': 'hide_after_changed'\n\t},\n\tinitialize() {\n\t\tthis.$captcha = $('<div id=\"captcha\"/>');\n\t\tthis.$message = $('<div class=\"message\"/>');\n\t\tthis.$submit = $('<input>', {\n\t\t\ttype: 'submit',\n\t\t\tval: 'Report'\n\t\t});\n\t\tlet $hideAfter = $('<input>', {\n\t\t\tclass: 'hideAfter',\n\t\t\ttype: 'checkbox',\n\t\t\tchecked: this.model.get('hideAfter')\n\t\t});\n\t\tlet $hideLabel = $('<label>and hide</label>').append($hideAfter);\n\n\t\tconst num = this.model.get('post').get('num');\n\n\t\tthis.$el.append(\n\t\t\trepLang.post + ' ',\n\t\t\tmain.oneeSama.postRef(num),\n\t\t\t'<a class=\"close\" href=\"#\">x</a>',\n\t\t\tthis.$message,\n\t\t\tthis.$captcha,\n\t\t\tthis.$submit,\n\t\t\t' ',\n\t\t\t$hideLabel\n\t\t);\n\n\t\t/* HACK */\n\t\tif (window.x_csrf) {\n\t\t\tthis.model.set('hideAfter', false);\n\t\t\t$hideLabel.remove();\n\t\t}\n\n\t\tthis.listenTo(this.model, {\n\t\t\t'change:error': this.error_changed,\n\t\t\t'change:status': this.status_changed,\n\t\t\tdestroy: this.remove\n\t\t});\n\t},\n\trender() {\n\t\tthis.error_changed();\n\t\tthis.status_changed();\n\t\treturn this;\n\t},\n\tsubmit() {\n\t\tif (this.model.get('status') != 'ready')\n\t\t\treturn false;\n\t\tmain.send([\n\t\t\tcommon.REPORT_POST,\n\t\t\tparseInt(this.model.get('post').get('num'), 10),\n\t\t\tRecaptcha.get_challenge(),\n\t\t\tRecaptcha.get_response()\n\t\t]);\n\t\tthis.model.set('status', 'reporting');\n\t\treturn false;\n\t},\n\terror_changed() {\n\t\tthis.$message.text(this.model.get('error'));\n\t},\n\tstatus_changed() {\n\t\tconst status = this.model.get('status');\n\t\tthis.$submit\n\t\t\t.prop('disabled', status != 'ready')\n\t\t\t.toggle(status !== 'done')\n\t\t\t.val(status === 'reporting' ? repLang.reporting : lang.report);\n\t\tthis.$captcha.toggle(\n\t\t\t_.contains(['ready', 'reporting', 'error'], status)\n\t\t);\n\t\tif (status === 'done')\n\t\t\tthis.$('label').remove();\n\n\t\tlet msg;\n\t\tif (status === 'done')\n\t\t\tmsg = repLang.submitted;\n\t\telse if (status == 'setup')\n\t\t\tmsg = repLang.setup;\n\t\telse if (status == 'error'\n\t\t\t|| (status == 'ready' && this.model.get('error')))\n\t\t\t\tmsg = 'E';\n\n\t\tthis.$message.text(msg === 'E' ? this.model.get('error') : msg);\n\t\tthis.$message.toggle(!!msg).toggleClass('error', msg == 'E');\n\n\t\t// not strictly view logic, but only relevant when visible\n\t\tif (status == 'ready')\n\t\t\tthis.focus();\n\t\telse if (status == 'done')\n\t\t\tthis.model.did_report();\n\t\telse if (status == 'error')\n\t\t\tthis.model.request_new();\n\t},\n\thide_after_changed(e) {\n\t\tthis.model.set('hideAfter', e.target.checked);\n\t},\n\tfocus() {\n\t\tRecaptcha.focus_response_field();\n\t},\n\tremove() {\n\t\tBackbone.View.prototype.remove.call(this);\n\t\tif (panel === this) {\n\t\t\tpanel = null;\n\t\t\tRecaptcha.destroy();\n\t\t}\n\t\treturn false;\n\t}\n});\n\nmain.reply('report', function(post) {\n\tconst url = 'https://www.google.com/recaptcha/api/js/recaptcha_ajax.js';\n\t$script(url, function () {\n\t\tconst num = post.get('num');\n\t\tlet model = reports[num];\n\t\tif (!model) {\n\t\t\treports[num] = model = new Report({\n\t\t\t\tid: num,\n\t\t\t\tpost: post\n\t\t\t});\n\t\t}\n\t\tif (panel) {\n\t\t\tif (panel.model === model) {\n\t\t\t\tpanel.focus();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tpanel.remove();\n\t\t}\n\t\tpanel = new ReportPanel({model: model});\n\t\tpanel.render().$el.appendTo('body');\n\t\tif (window.Recaptcha)\n\t\t\tmodel.request_new();\n\t\telse {\n\t\t\tmodel.set({\n\t\t\t\tstatus: 'error',\n\t\t\t\terror: repLang.loadError\n\t\t\t});\n\t\t}\n\t});\n});\n\nmain.dispatcher[common.REPORT_POST] = function(msg) {\n\tconst report = reports[msg[0]];\n\tif (report)\n\t\treport.set(msg[1] || {status: 'done'});\n};\n"],"sourceRoot":"/source/"}