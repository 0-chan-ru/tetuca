{"version":3,"sources":["background.js"],"names":[],"mappings":"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","file":"background.js","sourcesContent":["/*\n * Background controller. Wallpapers, proper fitting and video backgrounds\n */\n\nconst main = require('./main'),\n\t{Backbone, common, etc, oneeSama, options, stackBlur, state} = main;\n\nconst BackgroundView = Backbone.View.extend({\n\ttagName: 'style',\n\tcolourMap: {\n\t\tglass: {\n\t\t\tnormal: 'rgba(40, 42, 46, 0.5)',\n\t\t\tediting: 'rgba(145, 145, 145, 0.5)'\n\t\t},\n\t\tocean: {\n\t\t\tnormal: 'rgba(28, 29, 34, 0.781)',\n\t\t\tediting: 'rgba(44, 57, 71, 0.88)'\n\t\t}\n\t},\n\tinitialize() {\n\t\tdocument.head.append(this.el);\n\t\tdocument.body.append(etc.parseDOM('<div id=\"user_bg\"></div>'));\n\t\tthis.render();\n\n\t\tmain.reply('background:store', this.store, this);\n\t\tthis.listenTo(options, {\n\t\t\t'change:userBG': this.render,\n\t\t\t'change:illyaBGToggle': this.render,\n\t\t\t'change:illyaMuteToggle': this.render,\n\t\t\t'change:theme': this.render,\n\t\t\t'workModeTOG': this.render\n\t\t});\n\t},\n\t// Store image as dataURL in localStorage\n\tstore(target) {\n\t\t// This could take a while, so loading animation\n\t\tmain.request('loading:show');\n\t\tlet reader = new FileReader();\n\t\treader.readAsDataURL(target.files[0]);\n\t\treader.onload = event => {\n\t\t\tlet img = new Image();\n\t\t\timg.onload = () => {\n\t\t\t\t// Convert to JPEG\n\t\t\t\tlet canvas = document.createElement(\"canvas\");\n\t\t\t\tcanvas.width = img.width;\n\t\t\t\tcanvas.height = img.height;\n\t\t\t\tcanvas\n\t\t\t\t\t.getContext('2d')\n\t\t\t\t\t.drawImage(img, 0, 0, img.width, img.height);\n\t\t\t\tlocalStorage.background = canvas.toDataURL('image/jpeg', 0.95);\n\n\t\t\t\t// Generate a blurred version of the background to use for\n\t\t\t\t// posts, modals, etc.\n\t\t\t\tstackBlur.canvas(canvas, 0, 0, img.width, img.height, 10);\n\t\t\t\tlocalStorage.blurred = canvas.toDataURL('image/jpeg', 0.95);\n\n\t\t\t\tmain.request('loading:hide');\n\n\t\t\t\t// Apply new background\n\t\t\t\tif (options.get('userBG'))\n\t\t\t\t\tthis.render();\n\t\t\t};\n\t\t\timg.src = event.target.result;\n\t\t};\n\t},\n\trender() {\n\t\tconst {el} = this;\n\t\tel.innerHTML = '';\n\t\tif (options.get('illyaBGToggle') && state.hotConfig.get('ILLYA_DANCE'))\n\t\t\tthis.renderIllya();\n\t\telse if (options.get('userBG') && !main.oneeSama.workMode)\n\t\t\tthis.renderBackground();\n\t},\n\trenderBackground() {\n\t\tconst bg = localStorage.background;\n\t\tif (!bg)\n\t\t\treturn;\n\t\tlet html = common.parseHTML\n\t\t\t`#user_bg {\n\t\t\t\tbackground: url(${bg}) no-repeat fixed center;\n\t\t\t\tbackground-size: cover;\n\t\t\t}`;\n\n\t\t// Add blurred background image to elements, if theme is glass or ocean\n\t\tconst theme = main.oneeSama.workMode\n\t\t\t? state.hotConfig.get('DEFAULT_CSS') : options.get('theme')\n\t\tif (theme === 'glass' || theme === 'ocean') {\n\t\t\tconst {blurred} = localStorage;\n\t\t\tif (blurred)\n\t\t\t\thtml += ' ' + this.renderGlass(theme, blurred);\n\t\t}\n\t\tthis.el.innerHTML = html;\n\t},\n\trenderGlass(theme, blurred) {\n\t\tconst {normal, editing} = this.colourMap[theme];\n\t\treturn common.parseHTML\n\t\t\t`.glass {\n\t\t\t\tbackground:\n\t\t\t\t\tlinear-gradient(${normal}, ${normal}),\n\t\t\t\t\turl(${blurred}) center fixed no-repeat;\n\t\t\t\tbackground-size: cover;\n\t\t\t}\n\t\t\t.glass.editing, .editing .background {\n\t\t\t\tbackground:\n\t\t\t\t\tlinear-gradient(${editing}, ${editing}),\n\t\t\t\t\turl(${blurred}) center fixed no-repeat;\n\t\t\t\tbackground-size: cover;\n\t\t\t}\n\t\t\t.background {\n\t\t\t\tpadding: 10px;\n\t\t\t\tmargin: 2px;\n\t\t\t}`;\n\t},\n\trenderIllya() {\n\t\tconst urlBase = main.config.MEDIA_URL + 'illya.';\n\t\tthis.el.innerHTML = common.parseHTML\n\t\t\t`<video autoplay loop ${options.get('illyaMuteToggle') && 'muted'}>\n\t\t\t\t<source src=\"${urlBase + 'webm'}\" type=\"video/webm\">\n\t\t\t\t<source src=\"${urlBase + 'mp4'}\" type=\"video/mp4\">\n\t\t\t</video>`;\n\t}\n});\n\nmain.defer(() => module.exports = new BackgroundView());\n"],"sourceRoot":"/source/"}