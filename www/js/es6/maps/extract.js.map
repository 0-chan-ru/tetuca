{"version":3,"sources":["extract.js"],"names":[],"mappings":"iGAIM,WAAO,QAAQ,QAAR,CAAP,OACJ,EAAkC,KAAlC,QAAG,KAA+B,KAA/B,WAAM,QAAyB,KAAzB,cAAS,MAAgB,KAAhB,YAAO,MAAS,KAAT,MAE3B,MAAM,OAAN,CACC,YAAY,OAAZ,CAAqB,CACpB,MAAM,GAAK,KAAK,QAAL,CAAc,CAAd,CAAL,CADc,MAId,KAAO,KAAK,KAAL,CAAW,SAAS,cAAT,CAAwB,UAAxB,EAAoC,SAApC,CAAlB,CAJc,IAKpB,CAAK,OAAL,CAAa,cAAb,CAA6B,KAAK,KAAL,CAA7B,CALoB,GAQhB,OAAJ,CACC,OADD,MAGM,KAAO,KAAK,IAAL,CAAY,MAAM,IAAN,CAAW,OAAX,EAAZ,CACZ,MAAQ,KAAK,KAAL,CAAa,KAAK,KAAL,CAZF,IAapB,CAAK,cAAL,CAAoB,EAApB,EAboB,IAcpB,CAAK,cAAL,CAAoB,EAApB,EAdoB,KAgBpB,CAAM,QAAN,CAAe,KAAK,KAAL,CAAf,CAhBoB,IAkBf,IAAI,IAAJ,IAAY,KAAjB,CAAwB,CACvB,MAAM,MAAQ,MAAM,IAAN,EAAY,KAAZ,CADS,GAEnB,CAAC,KAAD,CACH,SADD,IAEK,IAAI,GAAJ,IAAW,KAAhB,CAAuB,CACtB,GAAI,OAAO,IAAP,CACH,KAAK,OAAL,CAAa,aAAb,CAA4B,MAAM,IAAN,EAAY,GAAZ,CAA5B,CADD,CADD,CAJD,GAWI,QAAQ,GAAR,CAAY,WAAZ,CAAJ,CACC,KAAK,OAAL,CAAa,gBAAb,EADD,IAEA,CAAK,OAAL,CAAa,aAAb,EA/BoB,CAArB,cAiCA,CAAe,EAAf,CAAmB,CAClB,IAAI,SAAW,GAAG,oBAAH,CAAwB,SAAxB,CAAX,CADc,IAEb,IAAI,EAAI,CAAJ,CAAO,EAAI,SAAS,MAAT,CAAiB,EAAI,CAAJ,CAAO,GAA5C,CAAiD,CAChD,IAAI,QAAU,SAAS,CAAT,CAAV,CAD4C,IAE5C,MAAM,OAAN,CAAc,CACjB,MAAO,IAAI,MAAM,MAAN,CAAa,IAAb,CAAkB,KAAK,YAAL,CAAkB,OAAlB,CAAtB,CAAP,CACA,GAAI,OAAJ,CAFD,EAFgD,CAAjD,CAFD,cAUA,CAAe,EAAf,CAAmB,CAClB,IAAI,SAAW,GAAG,oBAAH,CAAwB,SAAxB,CAAX,CADc,IAEb,IAAI,EAAI,CAAJ,CAAO,EAAI,SAAS,MAAT,CAAkB,GAAtC,CAA2C,CAC1C,IAAI,QAAU,SAAS,CAAT,CAAV,CADsC,MAEpC,MAAQ,KAAK,YAAL,CAAkB,OAAlB,CAAR,CAFoC,IAGtC,MAAM,OAAN,CAAc,CACjB,MAAO,IAAI,MAAM,MAAN,CAAa,MAAb,CAAoB,KAAxB,CAAP,CACA,GAAI,OAAJ,CAFD,EAIG,UAJH,GAH0C,KAU1C,CAAM,KAAN,CAAY,MAAM,GAAN,CAAZ,CAAyB,MAAM,IAAN,CAViB,CAA3C,CAFD,YAeA,CAAa,EAAb,CAAiB,CAChB,IAAI,KAAO,KAAK,KAAL,CAAW,KAAK,MAAL,CAAY,EAAZ,CAAX,CAAP,CADY,GAGZ,KAAK,GAAL,IAAY,KAAK,IAAL,CACf,KAAK,IAAL,CAAY,IAAZ,CADD,OAEO,IAAP,CALgB,CAAjB,CA3DD,MAmEA,CAAO,OAAP,CAAiB,OAAjB,CAGA,IAAI,OAAJ,CAAY,MAAM,IAAN,CAAW,GAAX,CAAe,SAAf,CAAZ","file":"extract.js","sourcesContent":["/*\n * Extact model data from the thread tree HTML and populate models and views\n */\n\nconst main = require('./main'),\n\t{_, util, options, state, posts} = main;\n\nclass Extract {\n\tconstructor(catalog) {\n\t\tconst el = main.$threads[0];\n\n\t\t// Read serialised model data\n\t\tconst json = JSON.parse(document.getElementById('postData').innerHTML);\n\t\tmain.request('notify:title', json.title);\n\n\t\t// We don't need models on catalog pages\n\t\tif (catalog)\n\t\t\treturn;\n\n\t\tconst mine = this.mine = state.mine.readAll(),\n\t\t\tposts = this.posts = json.posts;\n\t\tthis.extractReplies(el);\n\t\tthis.extractThreads(el);\n\n\t\tstate.addLinks(json.links);\n\t\t// Forward posts that replied to my post\n\t\tfor (let post in posts) {\n\t\t\tconst links = posts[post].links;\n\t\t\tif (!links)\n\t\t\t\tcontinue;\n\t\t\tfor (let num in links) {\n\t\t\t\tif (num in mine)\n\t\t\t\t\tmain.request('repliedToMe', posts[post].num);\n\t\t\t}\n\t\t}\n\n\t\t// Apply various client-only DOM modifications\n\t\tif (options.get('anonymise'))\n\t\t\tmain.request('loop:anonymise');\n\t\tmain.request('time:render');\n\t}\n\textractReplies(el) {\n\t\tlet articles = el.getElementsByTagName('article');\n\t\tfor (let i = 0, l = articles.length; i < l; i++) {\n\t\t\tlet article = articles[i];\n\t\t\tnew posts.Article({\n\t\t\t\tmodel: new posts.models.Post(this.extractModel(article)),\n\t\t\t\tel: article\n\t\t\t});\n\t\t}\n\t}\n\textractThreads(el) {\n\t\tlet sections = el.getElementsByTagName('section');\n\t\tfor (let i = 0; i < sections.length ; i++) {\n\t\t\tlet section = sections[i];\n\t\t\tconst model = this.extractModel(section);\n\t\t\tnew posts.Section({\n\t\t\t\tmodel: new posts.models.Thread(model),\n\t\t\t\tel: section\n\t\t\t})\n\t\t\t\t .renderOmit();\n\t\t\t// Read the sync ID of the thread. Used later for syncronising\n\t\t\t// with the server.\n\t\t\tstate.syncs[model.num] = model.hctr;\n\t\t}\n\t}\n\textractModel(el) {\n\t\tlet info = this.posts[util.getNum(el)];\n\t\t// Did I make this post?\n\t\tif (info.num in this.mine)\n\t\t\tinfo.mine = true;\n\t\treturn info;\n\t}\n}\nmodule.exports = Extract;\n\n// Initial extraction. No need to defer, as we actually want it to hit ASAP.\nnew Extract(state.page.get('catalog'));\n"],"sourceRoot":"/source/"}