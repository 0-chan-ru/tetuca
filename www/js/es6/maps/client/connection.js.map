{"version":3,"sources":["client/connection.js"],"names":[],"mappings":"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","file":"client/connection.js","sourcesContent":["/*\n * Websocket controller and connection notifier\n */\n\n/**\n * Websocket call handler map\n */\nexport const dispatcher = {}\n\nconst main = require('./main'),\n\t{_, common, config, connSM, state, SockJS} = main,\n\tlang = main.lang.sync;\n\nlet socket, attempts, attemptTimer;\n\nfunction send(msg) {\n\t// need deferral or reporting on these lost messages...\n\tif (connSM.state != 'synced' && connSM.state != 'syncing')\n\t\treturn;\n\tif (socket.readyState != SockJS.OPEN) {\n\t\tif (console)\n\t\t\tconsole.warn(\"Attempting to send while socket closed\");\n\t\treturn;\n\t}\n\n\tmsg = JSON.stringify(msg);\n\tif (config.DEBUG)\n\t\tconsole.log('<', msg);\n\tsocket.send(msg);\n}\nmain.reply('send', send);\n\nfunction on_message(e) {\n\tif (config.DEBUG)\n\t\tconsole.log('>', e.data);\n\n\tconst msg = JSON.parse(e.data)[0],\n\t\top = msg.shift(),\n\t\ttype = msg.shift(),\n\t\tisPubSub = common.is_pubsub(type);\n\n\tif (isPubSub && connSM.state === 'locked')\n\t\treturn;\n\n\t// Some handlers are optional and/or dynamic. Ignore them silently.\n\tconst handler = main.dispatcher[type];\n\tif (!handler)\n\t\treturn;\n\tif (isPubSub && op in state.syncs)\n\t\tstate.syncs[op]++;\n\tmain.follow(() => handler(msg, op));\n}\n\nconst sync = document.getElementById('sync');\nfunction sync_status(msg) {\n\tsync.textContent = msg;\n}\n\nconnSM.act('load + start -> conn', function () {\n\tsync_status(lang.connecting);\n\tattempts = 0;\n\tconnect();\n});\n\nfunction connect() {\n\tif (socket) {\n\t\tsocket.onclose = null;\n\t\tsocket.onmessage = null;\n\t}\n\tif (window.location.protocol == 'file:') {\n\t\tconsole.log(\"Page downloaded locally; refusing to sync.\");\n\t\treturn;\n\t}\n\tsocket = new_socket();\n\tsocket.onopen = connSM.feeder('open');\n\tsocket.onclose = connSM.feeder('close');\n\tsocket.onmessage = on_message;\n\tif (config.DEBUG)\n\t\twindow.socket = socket;\n}\n\nfunction new_socket() {\n\tconst transports = ['xdr-streaming', 'xhr-streaming', 'iframe-eventsource',\n\t\t'iframe-htmlfile', 'xdr-polling', 'xhr-polling', 'iframe-xhr-polling',\n\t\t'jsonp-polling'];\n\tif (config.USE_WEBSOCKETS)\n\t\ttransports.unshift('websocket');\n\treturn new SockJS(config.SOCKET_URL || config.SOCKET_PATH, null, {\n\t\ttransports\n\t});\n}\n\nconnSM.act('conn, reconn + open -> syncing', () => {\n\tsync_status(lang.syncing);\n\tconst connID = common.randomID(32),\n\t\t{page} = state;\n\tpage.set('connID', connID);\n\tsend([common.SYNCHRONIZE, connID, page.get('board'), state.syncs,\n\t\tpage.get('live'), document.cookie]);\n});\n\nconnSM.act('syncing + sync -> synced', function () {\n\tsync_status(lang.synced);\n\tattemptTimer = setTimeout(function () {\n\t\tattemptTimer = 0;\n\t\treset_attempts();\n\t}, 10000);\n});\n\nfunction reset_attempts() {\n\tif (attemptTimer) {\n\t\tclearTimeout(attemptTimer);\n\t\tattemptTimer = 0;\n\t}\n\tattempts = 0;\n}\n\n// Prevent pub/sub mesages from being handled\nconnSM.act('synced, syncing + lock -> locked');\nconnSM.act('locked + unlock -> synced');\nmain.reply('connection:lock', () => send([common.DESYNC]), connSM.feed('lock'));\nmain.reply('connection:unlock', msg => send(msg), connSM.feed('unlock'));\n\nconnSM.act('* + close -> dropped',  error => {\n\tif (socket) {\n\t\tsocket.onclose = null;\n\t\tsocket.onmessage = null;\n\t}\n\tif (config.DEBUG)\n\t\tconsole.error('E:', error);\n\tif (attemptTimer) {\n\t\tclearTimeout(attemptTimer);\n\t\tattemptTimer = 0;\n\t}\n\tsync_status(lang.dropped);\n\n\t// Wait maxes out at ~1min\n\tconst wait = 500 * Math.pow(1.5, Math.min(Math.floor(++attempts / 2), 12));\n\tsetTimeout(connSM.feeder('retry'), wait);\n});\n\nconnSM.act('dropped + retry -> reconn', function () {\n\tconnect();\n\t/* Don't show this immediately so we don't thrash on network loss */\n\tsetTimeout(function () {\n\t\tif (connSM.state == 'reconn')\n\t\t\tsync_status(lang.reconnecting);\n\t}, 100);\n});\n\nconnSM.act('* + invalid, desynced + close -> desynced', msg => {\n\tmsg = (msg && msg[0]) ? 'Out of sync: ' + msg[0] : 'Out of sync';\n\tsync_status(msg);\n\tif (attemptTimer) {\n\t\tclearTimeout(attemptTimer);\n\t\tattemptTimer = 0;\n\t}\n\tsocket.onclose = null;\n\tsocket.onmessage = null;\n\tsocket.close();\n\tsocket = null;\n\tif (config.DEBUG)\n\t\twindow.socket = null;\n});\n\nfunction window_focused() {\n\tswitch (connSM.state) {\n\t\tcase 'desynced':\n\t\t\treturn;\n\t\t// might have just been suspended;\n\t\t// try to get our FSM up to date if possible\n\t\tcase 'synced':\n\t\tcase 'syncing':\n\t\tcase 'conn':\n\t\t\tconst rs = socket.readyState;\n\t\t\tif (rs != SockJS.OPEN && rs != SockJS.CONNECTING) {\n\t\t\t\tconnSM.feed('close');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\telse if (navigator.onLine === false) {\n\t\t\t\tconnSM.feed('close');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tbreak;\n\t}\n\tconnSM.feed('retry');\n}\n\n// Connect to server\nconnSM.feed('start');\n\n// Check for connectivity each time tab visibility changes to visible\n// A bit of an overhead, but should prevent unregistered disconnects,\n// especially on mobile.\ndocument.addEventListener('visibilitychange', e => {\n\tif (e.target.hidden)\n\t\treturn;\n\tsetTimeout(window_focused, 20);\n});\nwindow.addEventListener('online', () => reset_attempts(), connSM.feed('retry'));\nwindow.addEventListener('offline', connSM.feeder('close'));\n"],"sourceRoot":"/source/"}