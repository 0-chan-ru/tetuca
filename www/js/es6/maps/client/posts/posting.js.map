{"version":3,"sources":["client/posts/posting.js"],"names":[],"mappings":"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","file":"client/posts/posting.js","sourcesContent":["/*\n * Evertything related to writing and commiting posts\n */\n\nconst Article = require('./article'),\n\tmain = require('../main'),\n\tembed = require('./embed'),\n\tident = require('./identity'),\n\timager = require('./imager'),\n\t{$, _, Backbone, Cookie, common, config, connSM, util, lang, oneeSama,\n\t\toptions, postSM, state} = main;\n\nlet postForm, postModel;\n/*\n The variable gets overwritten, so a simple refference will not do. Calling a\n fucntion to retrieve the var each time solves the problem.\n */\nmain.reply('postForm', () => postForm)\n\t.reply('postModel', () => postModel)\n\t.reply('postForm:indentity', () => postForm && postForm.renderIdentity());\n\n// Minimal size of the input buffer\nlet\tinputMinSize = 300;\n// For mobile\nif (window.screen && screen.width <= 320)\n\tinputMinSize = 50;\n\nconst ComposerModel = Backbone.Model.extend({idAttribute: 'num'});\n\n// Synchronyse postform state with websocket connectivity\nconnSM.on('synced', postSM.feeder('sync'));\nconnSM.on('dropped', postSM.feeder('desync'));\nconnSM.on('desynced', postSM.feeder('desync'));\n\n// Allow remotely altering posting FSM state\nmain.reply('postSM:feed', state => postSM.feed(state));\n\npostSM.act('* + desync -> none', () => {\n\t// TODO: Desync logic\n\tif (postForm) {\n\t\tpostForm.el.classList.remove('editing');\n\t\tpostForm.$input.val('');\n\t\tpostForm.finish();\n\t}\n\tmain.$threads.find('aside.posting').hide();\n});\n\npostSM.act('none + sync, draft, alloc + done -> ready', () => {\n\t// TODO: Add unfinished post checking\n\n\tif (postForm) {\n\t\tpostForm.remove();\n\t\tpostForm = postModel = null;\n\t}\n\tfor (let el of main.$threads[0].queryAll('aside.posting')) {\n\t\tel.style.display = '';\n\t}\n});\n\n// Make new postform\npostSM.act('ready + new -> draft', aside => {\n\tlet op,\n\t\tsection = aside.closest('section');\n\tif (section)\n\t\top = util.getNum(section);\n\telse\n\t\tsection = document.createElement('section');\n\n\t// Shift OP's replies on board pages\n\tif (op && !state.page.get('thread'))\n\t\tstate.posts.get(op).dispatch('shiftReplies', true);\n\n\tpostForm = new ComposerView({\n\t\tmodel: postModel = new ComposerModel({op}),\n\t\tdestination: aside,\n\t\tsection\n\t});\n});\n\npostSM.preflight('draft', aside => aside.matches('aside'));\n\npostSM.act('draft + alloc -> alloc', msg => postForm.onAllocation(msg));\n\n// Render image upload status messages\nmain.dispatcher[common.IMAGE_STATUS] = msg =>\n\tpostForm && postForm.dispatch(msg[0]);\n\nmain.$doc.on('click', 'aside.posting a', function () {\n\tpostSM.feed('new', this.parentNode);\n});\n\nmain.$doc.on('keydown', handle_shortcut);\n\nfunction handle_shortcut(event) {\n\tif (!event.altKey)\n\t\treturn;\n\n\tconst opts = options.attributes;\n\tswitch(event.which) {\n\t\tcase opts.new:\n\t\t\tconst aside = document.query('aside.posting');\n\t\t\tif (aside) {\n\t\t\t\tpostSM.feed('new', aside);\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\tcase opts.togglespoiler:\n\t\t\tif (postForm) {\n\t\t\t\tpostForm.onToggle(event);\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\tcase opts.done:\n\t\t\tif (postForm && !postForm.$submit.attr('disabled')) {\n\t\t\t\tpostForm.finish();\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\t// Insert text spoiler\n\t\tcase opts.textSpoiler:\n\t\t\tif (postForm) {\n\t\t\t\tvar postState = this.imouto.state2.spoiler;\n\t\t\t\t// Was spoiler already started?\n\t\t\t\tvar sp = (postState ? '[/' : ' [') + 'spoiler]';\n\t\t\t\tthis.imouto.state2.spoiler = !postState;\n\t\t\t\tthis.$input.val(this.$input.val() + sp);\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\tcase opts.expandAll:\n\t\t\timager.massExpander.toggle();\n\t\t\tprevent();\n\t\t\tbreak;\n\t\tcase opts.workMode:\n\t\t\tconst val = main.oneeSama.workMode = !main.oneeSama.workMode;\n\t\t\tCookie.set('workModeTOG', val);\n\t\t\tconst banner = document.querySelector(\"h1 > img\");\n\t\t\tif(banner!=null)\n\t\t\t\tbanner.style.display =  val? 'none':'';\n\t\t\tdocument.getElementById('theme').setAttribute('href',\n\t\t\t\t\t`${config.MEDIA_URL}css/${val? state.hotConfig.get('DEFAULT_CSS'): main.options.get(\"theme\")}.css?v=${main.cssHash}`);\n\t\t\toneeSama.thumbStyle = val? 'hide': main.options.get('thumbs');\n\t\t\tmain.options.trigger(\"workModeTOG\");\n\t\t\twindow.addEventListener('beforeunload', function () {\n\t\t\t\tCookie.set(\"workModeTOG\",false);\n\t\t\t});\n\t\t\tprevent()\n\t\t\tbreak;\n\t}\n\n\tfunction prevent() {\n\t\tevent.stopImmediatePropagation();\n\t\tevent.preventDefault();\n\t}\n}\n\n// TODO: Unify self-updates with OneeSama; this is redundant\nmain.oneeSama.hook('insertOwnPost', ({links}) => {\n\tif (!postForm || !links)\n\t\treturn;\n\tpostForm.$buffer.find('.nope').each(function () {\n\t\tvar $a = $(this);\n\t\tconst text = $a.text(),\n\t\t\tm = text.match(/^>>(\\d+)/);\n\t\tif (!m)\n\t\t\treturn;\n\t\tconst num = m[1],\n\t\t\top = links[num];\n\t\tif (!op)\n\t\t\treturn;\n\t\tlet $ref = $(common.join([postForm.imouto.postRef(num, op, false)]));\n\t\t$a.attr('href', $ref.attr('href')).attr('class', 'history');\n\t\tconst refText = $ref.text();\n\t\tif (refText != text)\n\t\t\t$a.text(refText);\n\t});\n});\n\nconst ArticleComposer = Article.extend({\n\tevents: {\n\t\t'click #cancel': 'cancel',\n\t\t'change #imageInput': 'onImageChosen',\n\t\t'input #trans': 'onInput',\n\t\t'keydown #trans': 'onKeyDown',\n\t\t'click #done': 'finish',\n\t\t'click #toggle': 'onToggle'\n\t},\n\tinitialize(args) {\n\t\t// super() call\n\t\tArticle.prototype.initialize.call(this);\n\t\tthis.listenTo(this.model, {\n\t\t\t'change': this.renderButtons,\n\t\t\t'change:spoiler': this.renderSpoilerPane\n\t\t});\n\t\tthis.render(args).insertIntoDOM(args);\n\t\tthis.model.set({\n\t\t\tspoiler: 0,\n\t\t\tnextSpoiler: -1\n\t\t});\n\n\t\tthis.pending = '';\n\t\tthis.line_count = 1;\n\t\tthis.char_count = 0;\n\n\t\t// Initialize the form's private rendering singleton instance\n\t\tconst imouto = this.imouto = new common.OneeSama({\n\t\t\tcallback: inject,\n\t\t\top: state.page.get('thread'),\n\t\t\tblockqoute: this.blockqoute,\n\t\t\teLinkify: main.oneeSama.eLinkify,\n\t\t\tlang: main.lang,\n\t\t\ttamashii(num) {\n\t\t\t\tlet section = document.query('#p' + num);\n\t\t\t\tsection = section && section.closest('section');\n\t\t\t\tif (section) {\n\t\t\t\t\tconst desc = num in state.mine.readAll() && lang.you;\n\t\t\t\t\treturn this.postRef(num, util.getNum(section), desc);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\treturn `<a class=\"nope\">&gt;&gt;${num}</a>`;\n\t\t\t}\n\t\t});\n\t\timouto.setModel(this.model);\n\t},\n\t// Initial render\n\trender() {\n\t\t// Define attributes separatly for readbility\n\t\tconst attrs = {\n\t\t\tinput: {\n\t\t\t\tname: 'body',\n\t\t\t\tid: 'input',\n\t\t\t\trows: 1,\n\t\t\t\tclass: 'themed exclude',\n\t\t\t\tautocomplete: main.isMobile\n\t\t\t},\n\t\t\tform: {\n\t\t\t\tmethod: 'post',\n\t\t\t\tenctype: 'multipart/form-data',\n\t\t\t\ttarget: 'upload',\n\t\t\t\tid: 'uploadForm'\n\t\t\t},\n\t\t\tcancel: {\n\t\t\t\ttype: 'buttom',\n\t\t\t\tvalue: lang.cancel,\n\t\t\t\tid: 'cancel'\n\t\t\t},\n\t\t\timageInput: {\n\t\t\t\ttype:'file',\n\t\t\t\tid: 'imageInput',\n\t\t\t\tname: 'image',\n\t\t\t\taccept: 'image/*;.webm;.pdf;.mp3'\n\t\t\t},\n\t\t\ttoggle: {\n\t\t\t\ttype: 'button',\n\t\t\t\tid: 'toggle'\n\t\t\t}\n\t\t};\n\n\t\tthis.el.innerHTML = parseHTML\n\t\t\t`<header>\n\t\t\t\t<a class=\"name nope\" target=\"_blank\">\n\t\t\t\t\t<b></b>\n\t\t\t\t</a>\n\t\t\t</header>\n\t\t\t<span class=\"oi control\" data-glyph=\"chevron-bottom\"></span>\n\t\t\t<div class=\"container\">\n\t\t\t\t<blockquote>\n\t\t\t\t\t<p id=\"buffer\" class=\"exclude\"></p>\n\t\t\t\t\t<p id=\"lineBuffer\" class=\"exclude\"></p>\n\t\t\t\t\t<textarea ${attrs.input}></textarea>\n\t\t\t\t</blockquote>\n\t\t\t\t<form ${attrs.form}>\n\t\t\t\t\t<input ${attrs.cancel}>\n\t\t\t\t\t<input ${attrs.imageInput}>\n\t\t\t\t\t<input ${attrs.toggle}>\n\t\t\t\t\t<strong id=\"uploadStatus\"></strong>\n\t\t\t\t</form>\n\t\t\t\t<small></small>\n\t\t\t</div>`;\n\n\t\t// Cache elements to avoid lookup\n\t\tconst els = ['buffer', 'lineBuffer', 'input', 'uploadForm', 'cancel',\n\t\t\t'imageInput', 'toggle', 'uploadStatus', 'hiddenUpload', 'sizer'];\n\t\tfor (let el of els) {\n\t\t\tthis[el] = document.query('#' + el);\n\t\t}\n\t\tthis.renderIdentity();\n\t\treturn this;\n\t},\n\t// Name, emaail and tripcode field\n\trenderIdentity() {\n\t\t// Model has already been alocated and has a proper identity rendered\n\t\tif (this.model.get('num'))\n\t\t\treturn;\n\t\tconst parsed = common.parse_name(main.$name.val(), main.$email.val()),\n\t\t\thaveTrip = !!(parsed[1] || parsed[2]);\n\t\tconst el = this.el.query('.name'),\n\t\t\tname = el.query('a');\n\t\tif (parsed[0])\n\t\t\tname.textContent = parsed[0] + ' ';\n\t\telse\n\t\t\tname.tetxContent = haveTrip ? '' : lang.anon;\n\t\tif (haveTrip)\n\t\t\tutil.parseDOM(' <code>!?</code>').forEach(el => name.after(el));\n\n\t\t// Insert staff title\n\t\tmain.oneeSama.trigger('fillMyName', name);\n\t\tconst email = main.$email.val().trim();\n\t\tif (email) {\n\t\t\tel.setAttribute('href', 'mailto:' + email);\n\t\t\tel.classList.remove('nope');\n\t\t\tel.classList.add('email');\n\t\t}\n\t\telse {\n\t\t\tel.removeAttribute('href');\n\t\t\tel.classList.add('nope');\n\t\t\tel.classList.remove('email');\n\t\t}\n\t},\n\tinsertIntoDOM({destination}) {\n\t\tdestination.before(this.el);\n\t\tthis.resizeInput();\n\t\tmain.$threads.queryAll('aside.postsing').forEach(el =>\n\t\t\tel.style.display = 'none');\n\t\tthis.fun();\n\t},\n\t/*\n\t Allows keeping the input buffer sized as if the text was monospace,\n\t without actually displaying monospace font. Keeps the input buffer from\n\t shifting around needlessly.\n\t */\n\tresizeInput(val) {\n\t\tconst {sizer, input} = this;\n\t\tif (typeof val !== 'string')\n\t\t\tval = input.value;\n\t\tsizer.textContent = val;\n\t\tlet size = sizer.width + common.INPUT_ROOM;\n\t\tsize = Math.max(size, inputMinSize\n\t\t\t- input.getBoundingClientRect().left\n\t\t\t- this.el.getBoundingClientRect().left);\n\t\tthis.input.style.width = size + 'px';\n\t},\n\trenderButtons() {\n\t\tconst {num, uploading, uploaded, uploadStatus, sentAllocRequest}\n\t\t\t= this.model.attributes;\n\t\tconst allocWait = sentAllocRequest && !num;\n\t\tthis.submit.disabled = !!(uploading || allocWait);\n\t\tif (uploaded)\n\t\t\tthis.submit.style.marginLeft = 0;\n\t\tthis.cancel.disabled = !!allocWait;\n\t\tthis.cancel.style.display = (!num || uploading) ? '' : 'none';\n\t\tthis.imageInput.disabled = !!uploading;\n\t\tthis.uploadStatus.innerHTML = uploadStatus;\n\t},\n\trenderSpoilerPane(model, spoiler) {\n\t\tconst background = spoiler\n\t\t\t? `${config.MEDIA_URL}spoil/spoil${spoiler}.png`\n\t\t\t: config.MEDIA_URL + 'css/ui/pane.png';\n\t\tthis.toggle.style.backgroundImage = `url(\"${background}\")`;\n\t}\n});\n\nconst ComposerView = Backbone.View.extend({\n\tevents: {\n\t\t'input #trans': 'onInput',\n\t\t'keydown #trans': 'onKeyDown',\n\t\t'click #done': 'finish',\n\t\t'click #toggle': 'onToggle'\n\t},\n\tinitialize(args) {\n\t\tthis.listenTo(this.model, {\n\t\t\t'change': this.renderButtons,\n\t\t\t'change:spoiler': this.renderSpoilerPane\n\t\t});\n\n\t\tthis.render(args);\n\n\t\tthis.pending = '';\n\t\tthis.line_count = 1;\n\t\tthis.char_count = 0;\n\n\t\t// Initialize the form's private rendering singleton instance\n\t\tlet imouto = this.imouto = new common.OneeSama({\n\t\t\tcallback: inject,\n\t\t\top: state.page.get('thread'),\n\t\t\tstate: [common.S_BOL, 0],\n\n\t\t\t// TODO: Convert current OneeSama.state array to more flexible\n\t\t\t// object\n\t\t\tstate2: {spoiler: 0},\n\t\t\t$buffer: this.$buffer,\n\t\t\teLinkify: main.oneeSama.eLinkify,\n\t\t\tlang: main.lang,\n\t\t\ttamashii(num) {\n\t\t\t\tlet section = document.query('#p' + num);\n\t\t\t\tsection = section && section.closest('section');\n\t\t\t\tif (section) {\n\t\t\t\t\tconst desc = num in state.mine.readAll() && this.lang.you;\n\t\t\t\t\treturn this.postRef(num, util.getNum(section), desc);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\treturn `<a class=\"nope\">&gt;&gt;${num}</a>`;\n\t\t\t}\n\t\t});\n\t\timouto.hook('spoilerTag', util.touchable_spoiler_tag);\n\t\tmain.oneeSama.trigger('imouto', imouto);\n\t},\n\t// Initial render\n\trender({destination, section}) {\n\t\tconst op = this.model.get('op');\n\t\tthis.setElement((op ? document.createElement('article') : section));\n\n\t\t// A defined op means the post is a reply, not a new thread\n\t\tthis.isThread = !op;\n\n\t\tthis.$buffer = $('<p/>');\n\t\tthis.$lineBuffer = $('<p/>');\n\t\tthis.$meta = $('<header><a class=\"nope\"><b/></a> <time/></header>');\n\t\tthis.$input = $('<textarea/>', {\n\t\t\tname: 'body',\n\t\t\tid: 'trans',\n\t\t\trows: '1',\n\t\t\tclass: 'themed',\n\t\t\tautocomplete: main.isMobile\n\t\t});\n\t\tthis.$submit = $('<input/>', {\n\t\t\tid: 'done',\n\t\t\ttype: 'button',\n\t\t\tvalue: main.lang.done\n\t\t});\n\t\tthis.$subject = $('<input/>', {\n\t\t\tid: 'subject',\n\t\t\tclass: 'themed',\n\t\t\tmaxlength: state.hotConfig.SUBJECT_MAX_LENGTH,\n\t\t\twidth: '80%'\n\t\t});\n\t\tthis.$blockquote = $('<blockquote/>');\n\n\t\t/*\n\t\t Allows keeping the input buffer sized as if the text was monospace,\n\t\t without actually displaying monospace font. Keeps the input buffer from\n\t\t shifting around needlessly.\n\t\t */\n\t\tthis.$sizer = $('<pre/>').appendTo('body');\n\n\t\tthis.$blockquote.append(this.$buffer, this.$lineBuffer, this.$input);\n\t\tthis.$el.append(this.$meta, this.$blockquote, '<small/>');\n\t\tif (this.isThread) {\n\t\t\tthis.$el.append(`<label for=\"subject\">${lang.subject}: </label>`,\n\t\t\t\tthis.$subject);\n\t\t\tthis.$blockquote.hide();\n\t\t}\n\t\tthis.$uploadForm = this.renderUploadForm();\n\t\tthis.$el.append(this.$uploadForm);\n\n\t\t// Add a menu to the postform\n\t\tmain.oneeSama.trigger('draft', this.$el);\n\t\tthis.renderIdentity();\n\n\t\t// Insert into the DOM\n\t\tdestination.style.display = 'none';\n\t\tif (this.isThread) {\n\t\t\tdestination.after(this.el);\n\t\t\tthis.el.after(document.createElement('hr'));\n\t\t\tthis.$subject.focus();\n\t\t}\n\t\telse {\n\t\t\tdestination.before(this.el);\n\t\t\tthis.resizeInput();\n\t\t\tthis.$input.focus();\n\t\t}\n\n\t\tmain.$threads.find('aside.posting').hide();\n\t\tthis.fun();\n\t},\n\t// Render the name, email, and admin title, if any\n\trenderIdentity() {\n\t\t// Model has already been alocated and has a proper identity rendered\n\t\tif (this.model.get('num'))\n\t\t\treturn;\n\t\tconst parsed = common.parse_name(main.$name.val(), main.$email.val()),\n\t\t\thaveTrip = !!(parsed[1] || parsed[2]);\n\t\tlet $b = this.$meta.find('b');\n\t\tif (parsed[0])\n\t\t\t$b.text(parsed[0] + ' ');\n\t\telse\n\t\t\t$b.text(haveTrip ? '' : main.lang.anon);\n\t\tif (haveTrip)\n\t\t\t$b.append(' <code>!?</code>');\n\t\t\n\t\t// Insert staff title\n\t\tmain.oneeSama.trigger('fillMyName', $b);\n\t\tconst email = main.$email.val().trim();\n\t\tlet $tag = this.$meta.children('a').first();\n\t\tif (email) {\n\t\t\t$tag.attr({\n\t\t\t\thref: 'mailto:' + email,\n\t\t\t\ttarget: '_blank',\n\t\t\t\tclass: 'email'\n\t\t\t});\n\t\t}\n\t\telse\n\t\t\t$tag.removeAttr('href').removeAttr('target').attr('class', 'nope');\n\t},\n\trenderButtons() {\n\t\tconst attrs = this.model.attributes,\n\t\t\tallocWait = attrs.sentAllocRequest && !attrs.num,\n\t\t\td = attrs.uploading || allocWait;\n\t\t// Beware of undefined!\n\t\tthis.$submit.prop('disabled', !!d);\n\t\tif (attrs.uploaded)\n\t\t\tthis.$submit.css({'margin-left': '0'});\n\t\tthis.$cancel.prop('disabled', !!allocWait);\n\t\tthis.$cancel.toggle(!!(!attrs.num || attrs.uploading));\n\t\tthis.$imageInput.prop('disabled', !!attrs.uploading);\n\t\tthis.$uploadStatus.html(attrs.uploadStatus);\n\t},\n\trenderSpoilerPane(model, sp) {\n\t\tconst background = sp ? `${config.MEDIA_URL}spoil/spoil${sp}.png`\n\t\t\t: config.MEDIA_URL + 'css/ui/pane.png';\n\t\tthis.$toggle.css('background-image', `url(\"${background}\")`);\n\t},\n\trenderUploadForm() {\n\t\tvar $form = $('<form method=\"post\" enctype=\"multipart/form-data\" '\n\t\t\t+ 'target=\"upload\"></form>');\n\t\tthis.$cancel = $('<input/>', {\n\t\t\ttype: 'button',\n\t\t\tvalue: lang.cancel,\n\t\t\tclick: $.proxy(this, 'cancel')\n\t\t});\n\t\tthis.$imageInput = $('<input/>', {\n\t\t\ttype: 'file',\n\t\t\tid: 'image',\n\t\t\tname: 'image',\n\t\t\taccept: config.WEBM ? 'imager/*;.webm' : 'image/*',\n\t\t\tchange: $.proxy(this, 'onImageChosen')\n\t\t});\n\t\tthis.$toggle = $('<input/>', {\n\t\t\ttype: 'button',\n\t\t\tid: 'toggle'\n\t\t});\n\t\tthis.$uploadStatus = $('<strong/>');\n\t\t$form.append(this.$cancel,\n\t\t\tthis.$imageInput,\n\t\t\tthis.$toggle, ' ',\n\t\t\tthis.$uploadStatus);\n\t\tthis.$iframe = $('<iframe/>', {\n\t\t\tsrc: '',\n\t\t\tname: 'upload',\n\t\t\tid: 'hidden-upload'\n\t\t}).appendTo('body');\n\t\tthis.model.set({\n\t\t\tspoiler: 0,\n\t\t\tnextSpoiler: -1\n\t\t});\n\t\treturn $form;\n\t},\n\t// Cancel file upload\n\tcancel() {\n\t\tif (this.model.get('uploading')) {\n\t\t\tthis.$iframe.remove();\n\t\t\tthis.$iframe = $('<iframe></iframe>', {\n\t\t\t\tsrc: '',\n\t\t\t\tname: 'upload',\n\t\t\t\tid: 'hidden-upload'\n\t\t\t}).appendTo('body');\n\t\t\tthis.uploadError('');\n\t\t\tthis.model.set({cancelled: true});\n\t\t}\n\t\telse\n\t\t\tthis.finish();\n\t},\n\tonImageChosen() {\n\t\tif (this.model.get('uploading') || this.model.get('uploaded'))\n\t\t\treturn;\n\t\tif (!this.$imageInput.val()) {\n\t\t\tthis.model.set('uploadStatus', '');\n\t\t\treturn;\n\t\t}\n\t\tconst extra = this.prepareUpload();\n\t\tfor (var k in extra) {\n\t\t\t$('<input type=hidden>')\n\t\t\t\t.attr('name', k)\n\t\t\t\t.val(extra[k])\n\t\t\t\t.appendTo(this.$uploadForm);\n\t\t}\n\t\tthis.$uploadForm.prop('action', util.uploadURL());\n\t\tthis.$uploadForm.submit();\n\t\tthis.$iframe.load(function() {\n\t\t\tif (!postForm)\n\t\t\t\treturn;\n\t\t\tvar doc = this.contentWindow || this.contentDocument;\n\t\t\tif (!doc)\n\t\t\t\treturn;\n\t\t\ttry {\n\t\t\t\tvar error = $(doc.document || doc).text();\n\t\t\t\t/*\n\t\t\t\t if it's a real response, it'll postMessage to us, so we don't have\n\t\t\t\t to do anything.\n\t\t\t\t */\n\t\t\t\tif (/legitimate imager response/.test(error))\n\t\t\t\t\treturn;\n\t\t\t\t// sanity check for weird browser responses\n\t\t\t\tif (error.length < 5 || error.length > 100)\n\t\t\t\t\terror = lang.unknownUpload;\n\t\t\t\tpostForm.uploadError(error);\n\t\t\t}\n\t\t\tcatch(e) {\n\t\t\t\t/*\n\t\t\t\t likely cross-origin restriction\n\t\t\t\t wait before erroring in case the message shows up\n\t\t\t\t */\n\t\t\t\tsetTimeout(function() {\n\t\t\t\t\tpostForm.uploadFallbackMessage();\n\t\t\t\t}, 500);\n\t\t\t}\n\t\t});\n\t\tthis.notifyUploading();\n\t},\n\tprepareUpload() {\n\t\tthis.model.set('uploadStatus', lang.uploading);\n\t\tthis.$input.focus();\n\t\tconst attrs = this.model.attributes;\n\t\treturn {spoiler: attrs.spoiler, op: attrs.op || 0};\n\t},\n\t/*\n\t this is just a fallback message for when we can't tell, if there was an\n\t error due to cross-origin restrictions\n\t */\n\tuploadFallbackMessage() {\n\t\tvar a = this.model.attributes,\n\t\t\tstat = a.uploadStatus;\n\t\tif (!a.cancelled && a.uploading && (!stat || stat == lang.uploading))\n\t\t\tthis.model.set('uploadStatus', lang.unknownResult);\n\t},\n\tnotifyUploading() {\n\t\tthis.model.set({uploading: true, cancelled: false});\n\t\tthis.$input.focus();\n\t},\n\tresizeInput(val) {\n\t\tif (typeof val !== 'string')\n\t\t\tval = this.$input.val();\n\t\tthis.$sizer.text(val);\n\t\tvar size = this.$sizer.width() + common.INPUT_ROOM;\n\t\tsize = Math.max(size, inputMinSize\n\t\t\t- this.$input.offset().left - this.$el.offset().left);\n\t\tthis.$input.css('width', size + 'px');\n\t},\n\tonInput(val) {\n\t\tif (val === undefined || val instanceof $.Event)\n\t\t\tval = this.$input.val();\n\t\tvar start = this.$input[0].selectionStart,\n\t\t\tend = this.$input[0].selectionEnd;\n\n\t\tvar changed = false,\n\t\t\tm, time, video;\n\n\t\t// Turn YouTube links into proper refs\n\t\twhile(true) {\n\t\t\tm = val.match(embed.youtube_url_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\t// Substitute\n\t\t\ttime = this.findTimeArg(m[3])\n\t\t\t\t|| this.findTimeArg(m[1])\n\t\t\t\t|| m[4]\n\t\t\t\t|| '';\n\t\t\tvideo = '>>>/watch?v=' + m[2] + time;\n\t\t\tval = embedRewrite(m, video);\n\t\t}\n\n\t\t//Youtu.be links\n\t\twhile(true) {\n\t\t\tm = val.match(embed.youtube_short_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\t// Substitute\n\t\t\ttime = this.findTimeArg(m[2]) || '';\n\t\t\tvideo = '>>>/watch?v=' + m[1] + time;\n\t\t\tval = embedRewrite(m, video);\n\t\t}\n\n\t\t// SoundCloud links\n\t\twhile(true) {\n\t\t\tm = val.match(embed.soundcloud_url_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\tvar sc = '>>>/soundcloud/' + m[1];\n\t\t\tval = embedRewrite(m, sc);\n\t\t}\n\n\t\t// Pastebin links\n\t\twhile(true) {\n\t\t\tm = val.match(embed.pastebin_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\tvar pbin = '>>>/pastebin/' + m[1];\n\t\t\tval = embedRewrite(m, pbin);\n\t\t}\n\n\t\t// Rewite embedable URLs to native embed URL syntax\n\t\tfunction embedRewrite(m, rw) {\n\t\t\tvar old = m[0].length;\n\t\t\tvar newVal = val.substr(0, m.index) + rw + val.substr(m.index + old);\n\t\t\tchanged = true;\n\t\t\tif (m.index < start) {\n\t\t\t\tvar diff = old - rw.length;\n\t\t\t\tstart -= diff;\n\t\t\t\tend -= diff;\n\t\t\t}\n\t\t\treturn newVal;\n\t\t}\n\n\t\tif (changed)\n\t\t\tthis.$input.val(val);\n\n\t\tvar nl = val.lastIndexOf('\\n');\n\t\tif (nl >= 0) {\n\t\t\tvar ok = val.substr(0, nl);\n\t\t\tval = val.substr(nl + 1);\n\t\t\tthis.$input.val(val);\n\t\t\tif (this.model.get('sentAllocRequest') || /[^ ]/.test(ok))\n\t\t\t\tthis.commit(ok + '\\n');\n\t\t}\n\t\telse {\n\t\t\tm = val\n\t\t\t\t.split('')\n\t\t\t\t.reverse()\n\t\t\t\t.join('')\n\t\t\t\t.match(/^(\\s*\\S+\\s+\\S+)\\s+(?=\\S)/);\n\t\t\tif (m) {\n\t\t\t\tvar lim = val.length - m[1].length;\n\t\t\t\tthis.commit(val.substr(0, lim));\n\t\t\t\tval = val.substr(lim);\n\t\t\t\tstart -= lim;\n\t\t\t\tend -= lim;\n\t\t\t\tthis.$input.val(val);\n\t\t\t\tthis.$input[0].setSelectionRange(start, end);\n\t\t\t}\n\t\t}\n\n\t\tthis.$input.attr('maxlength', common.MAX_POST_CHARS - this.char_count);\n\t\tthis.resizeInput(val);\n\t},\n\tfindTimeArg(params) {\n\t\tif (!params || params.indexOf('t=') < 0)\n\t\t\treturn false;\n\t\tparams = params.split('&');\n\t\tfor (let i = 0, len = params.length; i < len; i++) {\n\t\t\tlet pair = '#p' + params[i];\n\t\t\tif (embed.youtube_time_re.test(pair))\n\t\t\t\treturn pair;\n\t\t}\n\t\treturn false;\n\t},\n\t// Commit any staged words to the server\n\tcommit(text) {\n\t\tvar lines;\n\t\tif (text.indexOf('\\n') >= 0) {\n\t\t\tlines = text.split('\\n');\n\t\t\tthis.line_count += lines.length - 1;\n\t\t\tconst breach = this.line_count - common.MAX_POST_LINES + 1;\n\t\t\tif (breach > 0) {\n\t\t\t\tfor (var i = 0; i < breach; i++)\n\t\t\t\t\tlines.pop();\n\t\t\t\ttext = lines.join('\\n');\n\t\t\t\tthis.line_count = common.MAX_POST_LINES;\n\t\t\t}\n\t\t}\n\t\tconst left = common.MAX_POST_CHARS - this.char_count;\n\t\tif (left < text.length)\n\t\t\ttext = text.substr(0, left);\n\t\tif (!text)\n\t\t\treturn;\n\t\tthis.char_count += text.length;\n\n\t\t// Either get an allocation or send the committed text\n\t\tconst attrs = this.model.attributes;\n\t\tif (!attrs.num && !attrs.sentAllocRequest) {\n\t\t\tmain.send([common.INSERT_POST, this.allocationMessage(text, null)]);\n\t\t\tthis.model.set({sentAllocRequest: true});\n\t\t}\n\t\telse if (attrs.num)\n\t\t\tmain.send(text);\n\t\telse\n\t\t\tthis.pending += text;\n\n\t\t// Add it to the user's display\n\t\tif (lines) {\n\t\t\tlines[0] = this.$lineBuffer.text() + lines[0];\n\t\t\tthis.$lineBuffer.text(lines.pop());\n\t\t\tfor (let o = 0, len = lines.length; o < len; o++)\n\t\t\t\tthis.imouto.fragment(lines[o] + '\\n');\n\t\t}\n\t\telse {\n\t\t\tthis.$lineBuffer.append(document.createTextNode(text));\n\t\t\tthis.$lineBuffer[0].normalize();\n\t\t}\n\t},\n\t// Construct the message for post allocation in the database\n\tallocationMessage(text, image) {\n\t\tvar msg = {nonce: main.request('nonce:create')};\n\n\t\tfunction opt(key, val) {\n\t\t\tif (val)\n\t\t\t\tmsg[key] = val;\n\t\t}\n\n\t\topt('name', main.$name.val().trim());\n\t\topt('email', main.$email.val().trim());\n\t\topt('subject', this.$subject.val().trim());\n\t\topt('frag', text);\n\t\topt('image', image);\n\t\topt('op', this.model.get('op'));\n\n\t\treturn msg;\n\t},\n\tonKeyDown(event) {\n\t\tmain.follow(() => {\n\t\t\tswitch(event.which) {\n\t\t\t\tcase 13:\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t// fall-through\n\t\t\t\tcase 32:\n\t\t\t\t\t// predict result\n\t\t\t\t\tvar input = this.$input[0];\n\t\t\t\t\tvar val = this.$input.val();\n\t\t\t\t\tval = val.slice(0, input.selectionStart)\n\t\t\t\t\t\t+ (event.which == 13 ? '\\n' : ' ')\n\t\t\t\t\t\t+ val.slice(input.selectionEnd);\n\t\t\t\t\tthis.onInput(val);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\thandle_shortcut.bind(this)(event);\n\t\t\t}\n\t\t});\n\t},\n\tfinish() {\n\t\tif (this.model.get('num')) {\n\t\t\tthis.flushPending();\n\t\t\tthis.commit(this.$input.val());\n\t\t\tthis.$input.remove();\n\t\t\tthis.$submit.remove();\n\t\t\tif (this.$uploadForm)\n\t\t\t\tthis.$uploadForm.remove();\n\t\t\tif (this.$iframe) {\n\t\t\t\tthis.$iframe.remove();\n\t\t\t\tthis.$iframe = null;\n\t\t\t}\n\t\t\tthis.imouto.fragment(this.$lineBuffer.text());\n\t\t\tthis.$buffer.replaceWith(this.$buffer.contents());\n\t\t\tthis.$lineBuffer.remove();\n\t\t\tthis.$blockquote.css({\n\t\t\t\t'margin-left': '', 'padding-left': ''\n\t\t\t}\n\t\t\t);\n\t\t\tmain.send([common.FINISH_POST]);\n\t\t\tthis.preserve = true;\n\t\t\tif (this.isThread)\n\t\t\t\tthis.$el.append(main.oneeSama.replyBox());\n\n\t\t\tlet missing = this.imouto.allRolls.sent - this.imouto.allRolls.seen;\n\t\t\t//if missing>0 we have to wait until insertOwnPosts \"sees\" the\n\t\t\t// dice\n\t\t\tif (missing > 0) {\n\t\t\t\tlet checkAgain;\n\t\t\t\t(checkAgain= (n) => {\n\t\t\t\t\tsetTimeout(()=> {\n\t\t\t\t\t\tif (this.imouto.allRolls.seen == this.imouto.allRolls.sent || n ==0)\n\t\t\t\t\t\t\tpostSM.feed('done');\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tcheckAgain(n - 1);\n\t\t\t\t\t}, 100);\n\t\t\t\t})(5); //retry 5 times\n\t\t\t}\n\t\t\telse\n\t\t\t\tpostSM.feed('done');\n\t\t}else\n\t\t\tpostSM.feed('done');\n\t},\n\t// Send any unstaged words\n\tflushPending() {\n\t\tif (this.pending) {\n\t\t\tmain.send(this.pending);\n\t\t\tthis.pending = '';\n\t\t}\n\t},\n\tonToggle(event) {\n\t\tconst attrs = this.model.attributes;\n\t\tif (attrs.uploading || attrs.uploaded)\n\t\t\treturn;\n\t\tevent.preventDefault();\n\t\tevent.stopImmediatePropagation();\n\t\tif (attrs.spoiler) {\n\t\t\tthis.model.set({spoiler: 0});\n\t\t\treturn;\n\t\t}\n\t\tconst pick = common.pick_spoiler(attrs.nextSpoiler);\n\t\tthis.model.set({\n\t\t\tspoiler: pick.index,\n\t\t\tnextSpoiler: pick.next\n\t\t});\n\t},\n\tonAllocation(msg) {\n\t\tconst num = msg.num;\n\t\tstate.ownPosts[num] = num;\n\t\tthis.model.set({num: num});\n\t\tthis.flushPending();\n\t\tvar header = $(main.oneeSama.header(msg));\n\t\tthis.$meta.replaceWith(header);\n\t\tthis.$meta = header;\n\t\tif (!this.isThread)\n\t\t\tthis.$el.addClass('editing');\n\n\t\t/*\n\t\t TODO: Hide threads that are over THREADS_PER_PAGE. Also would need to be\n\t\t removed from syncs client and server-side. Hmm.\n\t\t */\n\n\t\tthis.$el.attr('id', 'p' + num);\n\n\t\tif (msg.image)\n\t\t\tthis.insertUploaded(msg.image);\n\n\t\tif (this.$uploadForm)\n\t\t\tthis.$uploadForm.append(this.$submit);\n\t\telse\n\t\t\tthis.$blockquote.after(this.$submit);\n\t\tif (this.isThread) {\n\t\t\tthis.$subject.siblings('label').andSelf().remove();\n\t\t\tthis.$blockquote.show();\n\t\t\tthis.resizeInput();\n\t\t\tthis.$input.focus();\n\t\t}\n\n\t\t/*\n\t\t Ensures you are nagged at by the browser, when navigating away from an\n\t\t unfinished allocated post.\n\t\t */\n\t\twindow.onbeforeunload = function() {\n\t\t\treturn \"You have an unfinished post.\";\n\t\t};\n\t},\n\t// Insert an image that has been uploaded and processed by the server\n\tinsertUploaded(info) {\n\t\tthis.renderImage(null, info);\n\t\tthis.$imageInput\n\t\t\t.siblings('strong')\n\t\t\t.andSelf()\n\t\t\t.remove();\n\t\tthis.$cancel.remove();\n\t\tthis.$uploadForm.find('#toggle').remove();\n\t\tthis.flushPending();\n\t\tthis.model.set({\n\t\t\tuploading: false,\n\t\t\tuploaded: true,\n\t\t\tsentAllocRequest: true\n\t\t});\n\n\t\t// Stop obnoxious wrap-around-image behaviour\n\t\tvar $img = this.$el.find('img');\n\t\tthis.$blockquote.css({\n\t\t\t'margin-left': $img.css('margin-right'),\n\t\t\t'padding-left': $img.width()\n\t\t});\n\n\t\tthis.resizeInput();\n\t},\n\t// Handle image upload status\n\tdispatch(msg) {\n\t\tconst a = msg.arg;\n\t\tswitch(msg.t) {\n\t\t\tcase 'alloc':\n\t\t\t\tthis.onImageAllocation(a);\n\t\t\t\tbreak;\n\t\t\tcase 'error':\n\t\t\t\tthis.uploadError(a);\n\t\t\t\tbreak;\n\t\t\tcase 'status':\n\t\t\t\tthis.uploadStatus(a);\n\t\t\t\tbreak;\n\t\t}\n\t},\n\tonImageAllocation(msg) {\n\t\tconst attrs = this.model.attributes;\n\t\tif (attrs.cancelled)\n\t\t\treturn;\n\t\tif (!attrs.num && !attrs.sentAllocRequest) {\n\t\t\tmain.send([common.INSERT_POST, this.allocationMessage(null, msg)]);\n\t\t\tthis.model.set({sentAllocRequest: true});\n\t\t}\n\t\telse\n\t\t\tmain.send([common.INSERT_IMAGE, msg]);\n\t},\n\tuploadError(msg) {\n\t\tif (this.model.get('cancelled'))\n\t\t\treturn;\n\t\tthis.model.set({\n\t\t\tuploadStatus: msg,\n\t\t\tuploading: false\n\t\t});\n\t\tif (this.$uploadForm)\n\t\t\tthis.$uploadForm.find('input[name=alloc]').remove();\n\t},\n\tuploadStatus(msg) {\n\t\tif (this.model.get('cancelled'))\n\t\t\treturn;\n\t\tthis.model.set('uploadStatus', msg);\n\t},\n\taddReference(num, sel) {\n\t\t// If a >>link exists, put this one on the next line\n\t\tvar val = this.$input.val();\n\t\tif (/^>>\\d+$/.test(val)) {\n\t\t\tthis.$input.val(val + '\\n');\n\t\t\tthis.onInput();\n\t\t\tval = this.$input.val();\n\t\t}\n\t\t// Quote selected text automatically\n\t\tif (sel) {\n\t\t\tsel = sel.split('\\n');\n\t\t\t// Prepend > to each line\n\t\t\tfor (let i = 0, len = sel.length; i < len; i++)\n\t\t\t\tsel[i] = '>' + sel[i];\n\t\t\tnum += '\\n' + sel.join('\\n') + '\\n';\n\t\t}\n\t\tthis.$input.val(val + '>>' + num);\n\t\tthis.$input[0].selectionStart = this.$input.val().length;\n\t\tthis.onInput();\n\t\tthis.$input.focus();\n\t},\n\tremove() {\n\t\tif (!this.preserve) {\n\t\t\tif (this.isThread)\n\t\t\t\tthis.$el.next('hr').remove();\n\t\t\tthis.$el.remove();\n\t\t}\n\t\tthis.$sizer.remove();\n\t\tif (this.$iframe) {\n\t\t\tthis.$iframe.remove();\n\t\t\tthis.$iframe = null;\n\t\t}\n\t\tthis.stopListening();\n\t\twindow.onbeforeunload = null;\n\t},\n\t// Extend with imager.js methods\n\trenderImage: imager.Hidamari.renderImage,\n\t// Overrides automatic image expansion, if any\n\tautoExpandImage() {\n\t\treturn this;\n\t},\n\tfun() {\n\t\t\n\t}\n});\nexports.ComposerView = ComposerView;\n\nfunction openPostBox(num) {\n\tpostSM.feed('new', document.query(`#p${num} aside.posting`));\n}\nmain.reply('openPostBox', openPostBox);\n\nwindow.addEventListener('message', function(event) {\n\tconst msg = event.data;\n\tif (msg !== 'OK' && postForm)\n\t\tpostForm.uploadError(msg);\n}, false);\n\nmain.$threads.on('click', 'a.quote', function(e) {\n\te.preventDefault();\n\n\t// TODO: Set highlighted post\n\n\t/*\n\t Make sure the selection both starts and ends in the quoted post's\n\t blockquote\n\t */\n\tconst post = e.target.closest('article, section'),\n\t\tgsel = getSelection(),\n\t\tnum = util.getNum(post);\n\n\tfunction isInside(prop) {\n\t\tconst el = gsel[prop] && gsel[prop].parentElement;\n\t\treturn  el\n\t\t\t&& el.closest('blockquote')\n\t\t\t&& el.closest('article, section') === post;\n\t}\n\n\tlet sel;\n\tif (isInside('baseNode') && isInside('focusNode'))\n\t\tsel = gsel.toString();\n\topenPostBox(util.getNum(post.closest('section')));\n\tpostForm.addReference(num, sel);\n});\n"],"sourceRoot":"/source/"}