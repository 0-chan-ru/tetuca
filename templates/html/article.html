<article id="p{{.ID}}" class="glass{{if .Editing}} editing{{end}}">
	<header class="spaced">
		{{with .Subject}}
			<h3>
				「{{.}}」
			</h3>
		{{end}}
		<b class="name"{{if .Auth}} class="admin"{{end}}>
			{{if (or .Name (eq .Trip ""))}}
				{{if .Name}}
					{{.Name}}
				{{else}}
					Anonymous
				{{end}}
				{{if .Trip}}
					&nbsp;
				{{end}}
			{{end}}
			{{with .Trip}}
				<code>
					!{{.}}
				</code>
			{{end}}
			{{with .Auth}}
				## {{.}}
			{{end}}
		</b>
		<time>
			{{formatTime .Time}}
		</time>
		<nav>
			<a href="#p{{.ID}}">
				No.
			</a>
			<a class="quote" href="#p{{.ID}}">
				{{.ID}}
			</a>
		</nav>
		<a class="control">
			<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
				<path d="M1.5 0l-1.5 1.5 4 4 4-4-1.5-1.5-2.5 2.5-2.5-2.5z" transform="translate(0 1)" />
			</svg>
		</a>
	</header>
	{{with .Image}}
		{{$src := urlquery (print $.Root "/" (sourcePath .FileType .SHA1))}}
		<figcaption class="spaced">
			<a class="image-toggle act" hidden></a>
			<span class="spaced image-search-container">
				<a class="image-search google" target="_blank" rel="nofollow" href="https://www.google.com/searchbyimage?image_url={{$src}}">
					G
				</a>
				<a class="image-search iqdb" target="_blank" rel="nofollow" href="http://iqdb.org/?url={{$src}}">
					Iq
				</a>
				<a class="image-search saucenao" target="_blank" rel="nofollow" href="http://saucenao.com/search.php?db=999&url={{$src}}">
					Sn
				</a>
				<a class="image-search desustorage" target="_blank" rel="nofollow" href="https://desuarchive.org/_/search/image/{{.MD5}}">
					Ds
				</a>
				<a class="image-search exhentai" target="_blank" rel="nofollow" href="http://exhentai.org/?fs_similar=1&fs_exp=1&f_shash={{.SHA1}}">
					Ex
				</a>
			</span>
			<span>
				(
				{{if .Audio}}
					♫,&nbsp;
				{{end}}
				{{if .Length}}
					{{readableLength .Length}},&nbsp;
				{{end}}
				{{if .APNG}}
					APNG,&nbsp;
				{{end}}
				{{readableFileSize .Size}},&nbsp;
				{{index .Dims 0}}x{{index .Dims 1}}
				)
			</span>
			{{$name := print .Name "." (extension .FileType)}}
			<a href="{{sourcePath .FileType .SHA1}}" download="{{$name}}">
				{{$name}}
			</a>
		</figcaption>
	{{end}}
	<div class="post-container">
		{{with .Image}}
			<figure>
				<!-- We are actually calling sourcePath twice, but there does not seem to be a way to store it in an outher scope variable, without calling sourcePath even on posts without images -->
				<a target="_blank" href="{{sourcePath .FileType .SHA1}}">
					{{if .Spoiler}}
						<!-- TODO: board-specific server-side spoiler rendering -->
						<img src="/assets/spoil/default.jpg">
					{{else}}
						<img src="{{thumbPath .FileType .SHA1}}">
					{{end}}
				</a>
			</figure>
		{{end}}
		<blockquote>
			{{renderBody .}}
		</blockquote>
	</div>
	{{if .Omit}}
		<span class="omit" data-omit="{{.Omit}}" data-image-omit="{{.ImageOmit}}">
			{{.Omit}} post{{if gt .Omit 1}}s{{end}}
			{{if .ImageOmit}}
				 and {{.ImageOmit}} image{{if gt .ImageOmit 1}}s{{end}}
			{{end}}
			 omitted&nbsp;
			<span class="act">
				<a href="{{.OP}}" class="history">
					See All
				</a>
			</span>
		</span>
	{{end}}
	{{with .Backlinks}}
		<small>
			{{range $id, $link := .}}
				{{renderPostLink $id $link.OP $link.Board (ne $link.OP $.OP)}}
			{{end}}
		</small>
	{{end}}
</article>
